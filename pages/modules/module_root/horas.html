<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hojas de Horas - Sistema Recurrente Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <!-- ===== M√ìDULO HOJAS DE HORAS CON SISTEMA RECURRENTE COMPLETO ===== -->
    <div class="horas-module">
        <!-- HEADER DEL M√ìDULO -->
        <div class="module-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-calendar-alt header-icon"></i>
                    <h1>Hojas de Horas - Sistema Recurrente</h1>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" id="btn-dashboard-horas">
                        <i class="fas fa-chart-pie"></i> Dashboard
                    </button>
                    <button class="btn-primary" id="btn-nueva-asignacion">
                        <i class="fas fa-plus"></i> Nuevo Contrato
                    </button>
                    <button class="btn-primary" id="btn-generar-horarios">
                        <i class="fas fa-sync-alt"></i> Actualizar Vista
                    </button>
                </div>
            </div>
        </div>
        <br>
        <!-- NAVEGACI√ìN POR PESTA√ëAS -->
        <div class="tabs-navigation">
            <div class="tab-item active" data-tab="calendario">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendario</span>
            </div>
            <div class="tab-item" data-tab="asignaciones">
                <i class="fas fa-list"></i>
                <span>Filtros Tiendas</span>
            </div>
            <div class="tab-item" data-tab="dashboard">
                <i class="fas fa-chart-pie"></i>
                <span>Dashboard</span>
            </div>
            <div class="tab-item" data-tab="reportes">
                <i class="fas fa-file-alt"></i>
                <span>Reportes</span>
            </div>
        </div>

        <!-- LOADING DEPENDENCIES -->
        <div class="dependencies-loading" id="dependencies-loading">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <h3>Cargando datos autom√°ticamente...</h3>
                <p id="loading-progress">Conectando con base de datos...</p>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL - CONTAINER PARA TODAS LAS PESTA√ëAS -->
        <div class="main-content" id="main-content-horas" style="display: none;">

            <!-- PESTA√ëA CALENDARIO -->
            <div class="tab-content active" id="tab-calendario">
                <!-- SIDEBAR DE RELACIONES CON BOT√ìN TOGGLE -->
                <div class="relationships-sidebar" id="relationships-sidebar">
                    <!-- PROMOTOR FIJO -->
                    <div class="promotor-card promotor-fijo">
                        <div class="promotor-header">
                            <i class="fas fa-user-tie"></i>
                            PROMOTOR FIJO
                        </div>
                        <div class="promotor-info" id="promotor-fijo-info">
                            <div class="promotor-name">Cargando...</div>
                            <div class="promotor-details">Obteniendo datos...</div>

                            <div class="tienda-principal">
                                <div class="tienda-principal-label">TIENDA PRINCIPAL</div>
                                <div class="tienda-principal-name">Cargando...</div>
                                <div style="font-size: 0.8rem; color: #666;">Obteniendo ubicaci√≥n...</div>
                            </div>
                        </div>
                    </div>

                    <!-- PROMOTOR CUBREDESCANSOS -->
                    <div class="promotor-card promotor-cubredescansos">
                        <div class="promotor-header">
                            <i class="fas fa-user-plus"></i>
                            CUBREDESCANSOS
                        </div>
                        <div class="promotor-info" id="promotor-cubredescansos-info">
                            <div class="promotor-name">Cargando...</div>
                            <div class="promotor-details">Obteniendo datos...</div>

                            <div class="tienda-principal" style="background: #fff3e0;">
                                <div class="tienda-principal-label" style="color: #f57c00;">ASIGNACI√ìN PRINCIPAL</div>
                                <div class="tienda-principal-name">Apoyo y rotaci√≥n</div>
                                <div style="font-size: 0.8rem; color: #666;">M√∫ltiples tiendas</div>
                            </div>
                        </div>
                    </div>

                    <!-- LEYENDAS EN SIDEBAR -->
                    <div class="sidebar-legends">
                        <div class="sidebar-legend-section">
                            <div class="sidebar-legend-title">Leyenda de Contratos</div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #1976d2, #1565c0);"></div>
                                <span>Promotor Fijo - Tienda Principal</span>
                            </div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #7b1fa2, #6a1b9a);"></div>
                                <span>Promotor Fijo - Rotaci√≥n</span>
                            </div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #f57c00, #ef6c00);"></div>
                                <span>Cubredescansos - Apoyo</span>
                            </div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #388e3c, #2e7d32);"></div>
                                <span>Cubredescansos - Otras</span>
                            </div>
                        </div>

                        <div class="sidebar-legend-section">
                            <div class="sidebar-legend-title">Indicadores de Estado</div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #4CAF50, #2e7d32); box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);">
                                </div>
                                <span>‚úÖ Contrato Activo</span>
                            </div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #f57c00, #ef6c00); border: 2px solid #FF9800;">
                                </div>
                                <span>‚ö†Ô∏è Pr√≥ximo a finalizar</span>
                            </div>
                            <div class="sidebar-legend-item">
                                <div class="sidebar-legend-color"
                                    style="background: linear-gradient(135deg, #f44336, #d32f2f); border: 2px solid #F44336;">
                                </div>
                                <span>üî¥ Cr√≠tico</span>
                            </div>
                        </div>
                    </div>

                    <!-- BOT√ìN TOGGLE SIDEBAR EN LA PARTE INFERIOR -->
                    <!-- BOT√ìN TOGGLE SIDEBAR EN LA PARTE INFERIOR -->
                    <div class="sidebar-toggle-container">
                        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" onclick="toggleSidebar()">
                            <i class="fas fa-chevron-left" id="toggle-icon"></i>
                            <span class="toggle-text" id="toggle-text">Ocultar men√∫</span>
                        </button>
                    </div>
                </div>

                <!-- BOT√ìN FLOTANTE PARA ABRIR SIDEBAR CUANDO EST√Å OCULTO -->
                <div class="sidebar-floating-btn" id="sidebar-floating-btn" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-right"></i>
                    <span class="floating-text">Abrir men√∫</span>
                </div>

                <!-- √ÅREA DEL CALENDARIO -->
                <div class="calendar-area">
                    <div class="calendar-header">
                        <div class="calendar-title">
                            <i class="fas fa-calendar-alt"></i>
                            Calendario de Contratos Recurrentes
                        </div>
                        <div class="calendar-controls">
                            <button class="view-btn active" data-view="dayGridMonth">Mes</button>
                            <button class="view-btn" data-view="timeGridWeek">Semana</button>
                            <button class="view-btn" data-view="timeGridDay">D√≠a</button>
                            <button class="view-btn" data-view="listWeek">Lista</button>

                            <!-- NUEVO: Filtro de tienda -->
                            <div class="store-filter-container">
                                <select id="calendar-store-filter" class="store-filter-select">
                                    <option value="">üè™ Todas las tiendas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div id="calendar-horas"></div>

                    </div>

                    <div class="loading-overlay" id="calendar-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Cargando eventos...</p>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA ASIGNACIONES - VISTA DETALLADA POR TIENDA -->
            <div class="tab-content" id="tab-asignaciones">
                <div class="tienda-detail-view">

                    <!-- HEADER -->
                    <div class="tienda-header">
                        <div class="tienda-info">
                            <div>
                                <div class="tienda-nombre" id="tienda-seleccionada-nombre">Selecciona una tienda</div>
                                <div class="tienda-ubicacion" id="tienda-seleccionada-ubicacion">-</div>
                            </div>
                        </div>

                        <div class="tienda-horarios" id="tienda-horarios-container">
                            <div class="horario-item">
                                <div class="horario-label">Apertura</div>
                                <div class="horario-time">09:00</div>
                            </div>
                            <div class="horario-item">
                                <div class="horario-label">Horario Comida</div>
                                <div class="horario-time">14:00 - 15:00</div>
                            </div>
                            <div class="horario-item">
                                <div class="horario-label">Cierre</div>
                                <div class="horario-time">19:00</div>
                            </div>
                        </div>
                    </div>

                    <!-- FILTRO DE TIENDA -->
                    <div class="selector-tienda-section">
                        <label for="selector-tienda-detalle">Selecciona una tienda para ver detalles:</label>
                        <select id="selector-tienda-detalle" class="form-select">
                            <option value="">Seleccionar tienda...</option>
                        </select>
                    </div>

                    <!-- PROMOTORES ASIGNADOS (M√öLTIPLES) -->
                    <div class="promotor-asignado-section" id="promotor-asignado-section" style="display: none;">
                        <!-- Se llenar√° din√°micamente con todos los promotores -->
                    </div>

                    <!-- LEYENDA -->
                    <div class="leyenda-section" id="leyenda-section" style="display: none;">
                        <div class="leyenda-title">Tipos de Asignaci√≥n</div>
                        <div class="leyenda-grid">
                            <div class="leyenda-item">
                                <div class="leyenda-color" style="background: var(--color-trabajo);"></div>
                                <div class="leyenda-text"><strong>D√≠a de Trabajo</strong> - Seg√∫n contrato activo</div>
                            </div>
                            <div class="leyenda-item">
                                <div class="leyenda-color" style="background: var(--color-descanso);"></div>
                                <div class="leyenda-text"><strong>Descanso Configurado</strong> - D√≠a de descanso del
                                    promotor</div>
                            </div>
                            <div class="leyenda-item">
                                <div class="leyenda-color" style="background: #fafafa; border: 2px solid #e0e0e0;">
                                </div>
                                <div class="leyenda-text"><strong>Sin Contrato</strong> - No hay contratos activos</div>
                            </div>
                        </div>
                    </div>

                    <!-- CALENDARIO SEMANAL -->
                    <div class="calendario-section" id="calendario-section" style="display: none;">
                        <div class="calendario-header">
                            <div class="semana-titulo" id="semana-titulo">Semana Actual</div>
                        </div>

                        <div class="calendario-grid" id="calendarioGrid">
                            <!-- Los d√≠as se generan din√°micamente -->
                        </div>

                        <!-- RESUMEN -->
                        <div class="resumen-cobertura">
                            <h3>Resumen de la Semana</h3>
                            <div class="resumen-grid">
                                <div class="resumen-item">
                                    <div class="resumen-valor" id="diasTrabajados">0</div>
                                    <div class="resumen-label">D√≠as Trabajados</div>
                                </div>
                                <div class="resumen-item">
                                    <div class="resumen-valor" id="diasDescanso">0</div>
                                    <div class="resumen-label">D√≠as Descanso</div>
                                </div>
                                <div class="resumen-item">
                                    <div class="resumen-valor" id="horasTotales">0h</div>
                                    <div class="resumen-label">Horas Totales</div>
                                </div>
                                <div class="resumen-item">
                                    <div class="resumen-valor" id="contratosActivos">0</div>
                                    <div class="resumen-label">Contratos Activos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA DASHBOARD -->
            <div class="tab-content" id="tab-dashboard">
                <div class="tab-section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-pie"></i> Dashboard Operativo</h2>
                        <p>M√©tricas y an√°lisis en tiempo real</p>
                    </div>

                    <div class="dashboard-grid">
                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--primary-color);">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="total-assignments">0</div>
                                <div class="metric-label">Contratos Activos</div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--success-color);">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="coverage-percentage">0%</div>
                                <div class="metric-label">Cobertura Efectiva</div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--warning-color);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="total-hours">0h</div>
                                <div class="metric-label">Horas Semanales</div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--info-color);">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="active-stores">0</div>
                                <div class="metric-label">Tiendas Activas</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <h3>Distribuci√≥n por Promotor</h3>
                        <div class="chart-placeholder">
                            <div class="chart-visual" id="chart-visual-container">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="summary-section">
                        <h3>Resumen Operativo</h3>
                        <div class="summary-grid" id="summary-grid">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA REPORTES -->
            <div class="tab-content" id="tab-reportes">
                <div class="tab-section">
                    <div class="section-header">
                        <h2><i class="fas fa-file-alt"></i> Centro de Reportes</h2>
                        <p>Genera y consulta reportes detallados</p>
                    </div>

                    <div class="report-controls">
                        <div class="control-group">
                            <label>Tipo de Reporte:</label>
                            <select id="report-type" class="form-select">
                                <option value="general">Reporte General</option>
                                <option value="promotor">Por Promotor</option>
                                <option value="tienda">Por Tienda</option>
                                <option value="horario">An√°lisis de Horarios</option>
                                <option value="cobertura">An√°lisis de Cobertura</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Periodo:</label>
                            <select id="report-period" class="form-select">
                                <option value="semana">√öltima Semana</option>
                                <option value="mes">√öltimo Mes</option>
                                <option value="trimestre">√öltimo Trimestre</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Formato:</label>
                            <select id="report-format" class="form-select">
                                <option value="html">Ver en pantalla</option>
                                <option value="pdf">Exportar PDF</option>
                                <option value="excel">Exportar Excel</option>
                                <option value="csv">Exportar CSV</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="generarReporte()">
                            <i class="fas fa-chart-line"></i> Generar Reporte
                        </button>
                    </div>

                    <div class="report-output" id="report-output">
                        <div class="report-placeholder">
                            <i class="fas fa-file-alt" style="font-size: 3rem; color: #ccc;"></i>
                            <h3>Selecciona los par√°metros y genera tu reporte</h3>
                            <p>Los reportes aparecer√°n aqu√≠ una vez generados</p>
                        </div>
                    </div>

                    <div class="reports-history">
                        <h3>Reportes Recientes</h3>
                        <div class="history-list">
                            <div class="history-item">
                                <i class="fas fa-file-pdf"></i>
                                <span>Reporte General - Septiembre 2025.pdf</span>
                                <small>Generado hace 2 horas</small>
                            </div>
                            <div class="history-item">
                                <i class="fas fa-file-excel"></i>
                                <span>An√°lisis Promotores - Agosto 2025.xlsx</span>
                                <small>Generado hace 1 d√≠a</small>
                            </div>
                            <div class="history-item">
                                <i class="fas fa-file-csv"></i>
                                <span>Cobertura Tiendas - Q3 2025.csv</span>
                                <small>Generado hace 3 d√≠as</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ERROR STATE -->
        <div class="error-state" id="error-state" style="display: none;">
            <div class="error-container">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error cargando datos</h3>
                <p id="error-message">No se pudieron cargar los datos desde la base de datos.</p>
                <button class="btn-primary" onclick="location.reload()">
                    <i class="fas fa-redo"></i> Reintentar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EVENTO MEJORADO - AHORA PARA CONTRATOS -->
    <div id="modal-evento-horas" class="modal-horas">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nuevo Contrato Laboral</h2>
                <button class="close-horas">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Promotor:</label>
                    <select class="form-select" id="event-promotor-horas">
                        <option value="">Seleccionar promotor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tienda:</label>
                    <select class="form-select" id="event-tienda-horas">
                        <option value="">Seleccionar tienda...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Asignaci√≥n:</label>
                    <select class="form-select" id="event-tipo-horas">
                        <option value="fijo-principal">Principal (Fijo)</option>
                        <option value="fijo-rotacion">Rotaci√≥n (Fijo)</option>
                        <option value="cubredescansos-apoyo">Apoyo Directo</option>
                        <option value="cubredescansos-otros">Otras Asignaciones</option>
                    </select>
                </div>

                <!-- RANGO DE FECHAS DEL CONTRATO -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-check"></i> Fecha de Inicio del Contrato:
                    </label>
                    <input type="date" class="form-input" id="event-fecha-inicio">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-times"></i> Fecha de Fin del Contrato (opcional):
                    </label>
                    <input type="date" class="form-input" id="event-fecha-fin">
                    <small class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        Si se deja vac√≠o, el contrato ser√° indefinido (sin fecha de fin)
                    </small>
                </div>

                <!-- HORARIOS -->
                <div class="horario-section">
                    <div class="horario-section-header">
                        <i class="fas fa-clock"></i>
                        <h3>Configuraci√≥n de Horario Laboral</h3>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">
                                <i class="fas fa-sign-in-alt"></i> Hora de Entrada:
                            </label>
                            <input type="time" class="form-input" id="event-hora-entrada" value="09:00">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">
                                <i class="fas fa-sign-out-alt"></i> Hora de Salida:
                            </label>
                            <input type="time" class="form-input" id="event-hora-salida" value="19:00">
                        </div>
                    </div>

                    <div class="horario-comida-section">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-utensils"></i> Horario de Comida:
                            </label>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label class="form-sublabel">Inicio de comida:</label>
                                    <input type="time" class="form-input" id="event-hora-comida-inicio" value="14:00">
                                </div>
                                <div style="flex: 1;">
                                    <label class="form-sublabel">Duraci√≥n:</label>
                                    <select class="form-select" id="event-duracion-comida">
                                        <option value="60">1 hora</option>
                                        <option value="120">2 horas</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-user-clock"></i> Promotor que cubre durante la comida:
                            </label>
                            <select class="form-select" id="event-promotor-cobertura-comida">
                                <option value="">Sin cobertura / No aplica</option>
                            </select>
                            <small class="form-hint">
                                <i class="fas fa-info-circle"></i>
                                Selecciona otro promotor disponible para cubrir durante el horario de comida
                            </small>
                        </div>
                    </div>

                    <div class="horario-resumen">
                        <div class="resumen-header">Resumen del Horario:</div>
                        <div class="resumen-content" id="horario-resumen-content">
                            <div class="resumen-item">
                                <i class="fas fa-hourglass-half"></i>
                                <span id="total-horas-trabajo">8 horas</span> de trabajo
                            </div>
                            <div class="resumen-item">
                                <i class="fas fa-utensils"></i>
                                <span id="tiempo-comida">1 hora</span> de comida
                            </div>
                            <div class="resumen-item">
                                <i class="fas fa-clock"></i>
                                Total en tienda: <strong id="total-tiempo-tienda">10 horas</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notas del Contrato:</label>
                    <input type="text" class="form-input" id="event-notas-horas" placeholder="Notas adicionales...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel-horas" id="btn-cancelar-horas">Cancelar</button>
                <button class="btn-primary" id="btn-guardar-horas">Crear Contrato</button>
                <button class="btn-primary" id="btn-eliminar-horas" style="background: #f44336; display: none;">Eliminar
                    Contrato</button>
            </div>
        </div>
    </div>

    <style>
        /* ===== VARIABLES CSS ===== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196F3;
            --background: #f5f7fa;
            --surface: rgba(255, 255, 255, 0.95);
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e0e0e0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --radius: 12px;

            /* COLORES PARA VISTA DETALLADA */
            --color-apertura: #2196F3;
            --color-comida: #FF9800;
            --color-cierre: #9C27B0;
            --color-trabajo: #4CAF50;
            --color-descanso: #9E9E9E;
            --color-incidencia: #F44336;
            --color-cobertura-comida: #FFC107;
            --color-cobertura-total: #E91E63;
        }

        /* ===== RESET Y BASE ===== */
        .horas-module * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .horas-module {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ===== HEADER STYLES ===== */
        .horas-module .module-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px 0;
            box-shadow: var(--shadow);
        }

        .horas-module .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .horas-module .header-title {
            display: flex;
            align-items: center;
            color: white;
        }

        .horas-module .header-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .horas-module .header-title h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .horas-module .header-actions {
            display: flex;
            gap: 15px;
        }

        .horas-module .btn-primary,
        .horas-module .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .horas-module .btn-primary {
            background-color: var(--success-color);
            color: white;
        }

        .horas-module .btn-primary:hover:not(:disabled) {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .horas-module .btn-secondary {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .horas-module .btn-secondary:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .horas-module .btn-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* ===== NAVEGACI√ìN POR PESTA√ëAS ===== */
        .horas-module .tabs-navigation {
            background: var(--surface);
            border-radius: 0;
            padding: 0;
            margin: 0;
            box-shadow: var(--shadow);
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
        }

        .horas-module .tab-item {
            flex: 1;
            padding: 16px 20px;
            background: #f8f9fa;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
        }

        .horas-module .tab-item:hover {
            background: #e9ecef;
            color: var(--primary-color);
        }

        .horas-module .tab-item.active {
            background: var(--primary-color);
            color: white;
            border-bottom-color: var(--secondary-color);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .horas-module .tab-item i {
            font-size: 1.1rem;
        }

        /* ===== LOADING DEPENDENCIES ===== */
        .horas-module .dependencies-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 40px;
        }

        .horas-module .loading-container {
            text-align: center;
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .horas-module .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .horas-module .loading-container h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .horas-module .loading-container p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* ===== ERROR STATE ===== */
        .horas-module .error-state {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 40px;
        }

        .horas-module .error-container {
            text-align: center;
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            border: 2px solid var(--danger-color);
        }

        .horas-module .error-container i {
            font-size: 4rem;
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .horas-module .error-container h3 {
            color: var(--danger-color);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .horas-module .error-container p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* ===== SISTEMA DE PESTA√ëAS CORREGIDO ===== */
        .horas-module .main-content {
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
        }

        .horas-module .tab-content {
            display: none !important;
            width: 100%;
            min-height: 500px;
            animation: fadeInTab 0.3s ease;
        }

        .horas-module .tab-content.active {
            display: block !important;
        }

        @keyframes fadeInTab {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== PESTA√ëA CALENDARIO - LAYOUT CORREGIDO ===== */
        .horas-module #tab-calendario {
            display: none;
            padding: 30px 20px;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }

        .horas-module #tab-calendario.active {
            display: grid !important;
        }

        /* ===== SIDEBAR ESTILO IMAGEN 2 - EXACTO ===== */
        .horas-module .relationships-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 330px;
            min-width: 330px;
            max-width: 330px;
            position: sticky;
            top: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
            opacity: 1;
            overflow: visible;
            align-self: flex-start;
        }

        .horas-module .relationships-sidebar.collapsed {
            width: 0;
            min-width: 0;
            max-width: 0;
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
        }

        /* ===== PROMOTOR CARDS - EXACTO IMAGEN 2 ===== */
        .horas-module .promotor-card {
            background: rgb(101, 217, 226);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            overflow: hidden;
            border: none;
        }

        .horas-module .promotor-header {
            padding: 12px 16px;
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horas-module .promotor-fijo .promotor-header {
            background: #2196F3;
        }

        .horas-module .promotor-cubredescansos .promotor-header {
            background: #FF9800;
        }

        .horas-module .promotor-header i {
            font-size: 0.9rem;
        }

        .horas-module .promotor-info {
            padding: 16px;
            background: white;
        }

        .horas-module .promotor-name {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
            line-height: 1.3;
            letter-spacing: 0.3px;
        }

        .horas-module .promotor-details {
            color: #666;
            margin-bottom: 12px;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .horas-module .tienda-principal {
            background: transparent;
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
            border: 2px solid #e0e0e0;
            border-left-width: 4px;
        }

        .horas-module .promotor-fijo .tienda-principal {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .horas-module .promotor-cubredescansos .tienda-principal {
            background: #fff3e0;
            border-left-color: #FF9800;
        }

        .horas-module .tienda-principal-label {
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horas-module .promotor-fijo .tienda-principal-label {
            color: #1976d2;
        }

        .horas-module .promotor-cubredescansos .tienda-principal-label {
            color: #f57c00;
        }

        .horas-module .tienda-principal-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        /* ===== BOT√ìN TOGGLE SIDEBAR ===== */
        .horas-module .sidebar-toggle-container {
            margin-top: 20px;
            padding: 0;
        }

        .horas-module .sidebar-toggle-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            font-size: 0.9rem;
        }

        .horas-module .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .horas-module .sidebar-toggle-btn i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .horas-module .toggle-text {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* ===== BOT√ìN FLOTANTE ===== */
        .horas-module .sidebar-floating-btn {
            position: fixed;
            left: -60px;
            bottom: 100px;
            width: 160px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 0 25px 25px 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            gap: 10px;
            box-shadow: 2px 4px 15px rgba(102, 126, 234, 0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            font-size: 0.9rem;
        }

        .horas-module .sidebar-floating-btn.visible {
            left: 0;
            opacity: 1;
            pointer-events: all;
        }

        .horas-module .sidebar-floating-btn:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateX(10px);
            box-shadow: 2px 8px 25px rgba(102, 126, 234, 0.4);
        }

        .horas-module .sidebar-floating-btn i {
            font-size: 1rem;
        }

        .horas-module .floating-text {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .horas-module .calendar-area {
            width: 100%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .horas-module #tab-calendario.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        /* ===== CALENDAR AREA ===== */
        .horas-module .calendar-area {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .horas-module .calendar-header {
            background: linear-gradient(135deg, #26c6da, #00acc1);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .horas-module .calendar-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .horas-module .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .horas-module .view-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: rgb(0, 0, 0);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .horas-module .view-btn.active {
            background: rgba(255, 255, 255, 0.4);
        }

        .horas-module .view-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .horas-module .store-filter-container {
            margin-left: 15px;
            min-width: 250px;
        }

        .horas-module .store-filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: rgb(0, 0, 0);
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .horas-module .store-filter-select:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .horas-module .store-filter-select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
        }

        .horas-module .calendar-container {
            padding: 20px;
            padding-bottom: 30px;
            overflow: visible;
        }

        .horas-module #calendar-horas {
            height: 700px;
            margin-bottom: 60px !important;
        }

        /* ===== LEGEND ===== */
        .horas-module .legend {
            margin-top: 80px !important;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e0e0e0;
            clear: both;
        }

        .horas-module .legend-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .horas-module .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .horas-module .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .horas-module .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        .horas-module .temporal-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        /* ===== VISTA DETALLADA POR TIENDA ===== */
        .horas-module .tienda-detail-view {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin: 20px;
        }

        .horas-module .tienda-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .horas-module .tienda-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .horas-module .tienda-nombre {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .horas-module .tienda-ubicacion {
            opacity: 0.9;
            font-size: 1rem;
        }

        .horas-module .tienda-horarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .horas-module .horario-item {
            text-align: center;
        }

        .horas-module .horario-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .horas-module .horario-time {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .horas-module .selector-tienda-section {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e0e0e0;
        }

        .horas-module .selector-tienda-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .horas-module .promotor-asignado-section {
            background: #4db4e4;
            padding: 0;
            border-bottom: 3px solid #4fdce1;
        }

        .horas-module .leyenda-section {
            padding: 20px 30px;
            background: #fff;
            border-bottom: 2px solid #e0e0e0;
        }

        .horas-module .leyenda-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .horas-module .leyenda-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .horas-module .leyenda-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .horas-module .leyenda-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .horas-module .calendario-section {
            padding: 30px;
        }

        .horas-module .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .horas-module .semana-titulo {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .horas-module .calendario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .horas-module .dia-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
            min-height: 300px;
        }

        .horas-module .dia-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .horas-module .dia-header {
            padding: 12px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
        }

        .horas-module .dia-nombre {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horas-module .dia-numero {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-top: 5px;
        }

        .horas-module .dia-contenido {
            padding: 15px;
            min-height: 250px;
        }

        .horas-module .dia-card.dia-trabajo {
            border-color: var(--color-trabajo);
        }

        .horas-module .dia-card.dia-trabajo .dia-header {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-bottom-color: var(--color-trabajo);
        }

        .horas-module .dia-card.dia-descanso {
            border-color: var(--color-descanso);
            opacity: 0.7;
        }

        .horas-module .dia-card.dia-descanso .dia-header {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border-bottom-color: var(--color-descanso);
        }

        .horas-module .dia-card.dia-sin_contrato {
            border-color: #e0e0e0;
            opacity: 0.5;
            background: #fafafa;
        }

        .horas-module .dia-card.dia-sin_contrato .dia-header {
            background: #fafafa;
            border-bottom-color: #e0e0e0;
        }

        .horas-module .bloque-horario {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            position: relative;
        }

        .horas-module .bloque-apertura {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid var(--color-apertura);
        }

        .horas-module .bloque-comida {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 4px solid var(--color-comida);
        }

        .horas-module .bloque-cierre {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-left: 4px solid var(--color-cierre);
        }

        .horas-module .bloque-horario-label {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .horas-module .bloque-horario-time {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .horas-module .bloque-horario-promotor {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            color: #555;
        }

        .horas-module .estado-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .horas-module .badge-descanso {
            background: var(--color-descanso);
            color: white;
        }

        .horas-module .resumen-cobertura {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .horas-module .resumen-cobertura h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.2rem;
        }

        .horas-module .resumen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .horas-module .resumen-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .horas-module .resumen-valor {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .horas-module .resumen-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }

        /* ===== DASHBOARD ===== */
        .horas-module .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .horas-module .metric-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .horas-module .metric-card:hover {
            transform: translateY(-3px);
        }

        .horas-module .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .horas-module .metric-content {
            flex: 1;
        }

        .horas-module .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .horas-module .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* ===== DISTRIBUCI√ìN POR PROMOTOR CON RESPONSIVE ===== */
        .horas-module .chart-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .horas-module .chart-section h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .horas-module .chart-placeholder {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
        }

        .horas-module .chart-placeholder::-webkit-scrollbar {
            width: 8px;
        }

        .horas-module .chart-placeholder::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .horas-module .chart-placeholder::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .horas-module .chart-placeholder::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        .horas-module .chart-visual {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .horas-module .promotor-chart-item {
            width: 100%;
            display: block;
        }

        .horas-module .chart-bar {
            height: 50px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .horas-module .chart-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .horas-module .juan-bar {
            background: linear-gradient(135deg, #1976d2, #1565c0) !important;
        }

        .horas-module .maria-bar {
            background: linear-gradient(135deg, #f57c00, #ef6c00) !important;
        }

        .horas-module .chart-bar:not(.juan-bar):not(.maria-bar) {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
        }

        .horas-module .summary-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .horas-module .summary-grid {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .horas-module .summary-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        /* ===== REPORTES ===== */
        .horas-module .tab-section {
            padding: 30px 20px;
            width: 100%;
        }

        .horas-module .section-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .horas-module .section-header h2 {
            font-size: 1.8rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .horas-module .section-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .horas-module .report-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .horas-module .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .horas-module .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .horas-module .report-output {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            min-height: 300px;
        }

        .horas-module .report-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .horas-module .report-placeholder h3 {
            margin: 15px 0 10px;
        }

        .horas-module .reports-history {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .horas-module .history-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .horas-module .history-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.3s ease;
        }

        .horas-module .history-item:hover {
            background: #e9ecef;
            cursor: pointer;
        }

        .horas-module .history-item i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .horas-module .history-item span {
            flex: 1;
            font-weight: 500;
        }

        .horas-module .history-item small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* ===== FULLCALENDAR CUSTOMIZATION ===== */
        .horas-module .fc-event {
            border: none !important;
            border-radius: 6px !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            padding: 2px 6px !important;
            margin: 1px 0 !important;
            transition: all 0.2s ease !important;
        }

        .horas-module .fc-event:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
            z-index: 100 !important;
        }

        .horas-module .fc-daygrid-day:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }

        .horas-module .fc-daygrid-day:hover .fc-daygrid-day-number {
            color: var(--primary-color) !important;
            font-weight: 700 !important;
            transform: scale(1.1) !important;
            transition: all 0.2s ease !important;
        }

        .horas-module .fc-timegrid-slot:hover {
            background: rgba(102, 126, 234, 0.08) !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .horas-module .fc-col-header-cell:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)) !important;
            transition: all 0.3s ease !important;
        }

        .horas-module .fc-list-day:hover {
            background: rgba(102, 126, 234, 0.1) !important;
            transition: all 0.7s ease !important;
        }

        /* ===== TOOLTIP HOVER ===== */
        .event-tooltip {
            position: absolute;
            pointer-events: none;
            z-index: 10001;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .event-tooltip * {
            pointer-events: none;
        }

        .horas-module .event-fijo-principal {
            background: linear-gradient(135deg, #1976d2, #1565c0) !important;
            color: white !important;
            border-left: 4px solid #0d47a1 !important;
            cursor: pointer !important;
        }

        .horas-module .event-fijo-rotacion {
            background: linear-gradient(135deg, #7b1fa2, #6a1b9a) !important;
            color: white !important;
            border-left: 4px solid #4a148c !important;
            cursor: pointer !important;
        }

        .horas-module .event-cubredescansos-apoyo {
            background: linear-gradient(135deg, #f57c00, #ef6c00) !important;
            color: white !important;
            border-left: 4px solid #e65100 !important;
            cursor: pointer !important;
        }

        .horas-module .event-cubredescansos-otros {
            background: linear-gradient(135deg, #388e3c, #2e7d32) !important;
            color: white !important;
            border-left: 4px solid #1b5e20 !important;
            cursor: pointer !important;
        }

        /* INDICADORES DE PROXIMIDAD AL FIN */
        .horas-module .fc-event.event-proximo-fin {
            border: 3px solid #FF9800 !important;
            border-left-width: 6px !important;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.4) !important;
        }

        .horas-module .fc-event.event-fin-critico {
            border: 3px solid #F44336 !important;
            border-left-width: 6px !important;
            box-shadow: 0 0 12px rgba(244, 67, 54, 0.5) !important;
            animation: pulse-critico 1.5s infinite !important;
        }

        @keyframes pulse-critico {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(244, 67, 54, 0.8);
            }
        }

        /* ===== MODAL STYLES ===== */
        .modal-horas {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: var(--radius);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-horas {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-horas:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-footer {
            padding: 20px;
            text-align: right;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel-horas {
            padding: 10px 20px;
            background: #ccc;
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel-horas:hover {
            background: #bbb;
        }

        /* HORARIOS */
        .horas-module .horario-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: var(--radius);
            margin: 20px 0;
            border: 2px solid var(--border-color);
        }

        .horas-module .horario-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .horas-module .horario-section-header i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .horas-module .horario-section-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .horas-module .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .horas-module .form-sublabel {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: block;
        }

        .horas-module .horario-comida-section {
            background: rgba(255, 152, 0, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
            margin: 15px 0;
        }

        .horas-module .form-hint {
            display: block;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .horas-module .form-hint i {
            color: var(--info-color);
            margin-right: 5px;
        }

        .horas-module .horario-resumen {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--success-color);
        }

        .horas-module .resumen-header {
            font-weight: 600;
            color: var(--success-color);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .horas-module .resumen-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .horas-module .resumen-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .horas-module .resumen-item i {
            color: var(--success-color);
            width: 20px;
        }

        .horas-module .resumen-item strong {
            color: var(--success-color);
            font-weight: 700;
        }

        /* ===== RESPONSIVE: Ajustes para tablets ===== */
        @media (max-width: 1024px) and (min-width: 769px) {
            .horas-module #tab-calendario.active {
                grid-template-columns: 1fr;
                padding: 20px 10px;
            }

            .horas-module .relationships-sidebar {
                flex-direction: row;
                overflow-x: auto;
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                gap: 15px;
                position: relative;
                top: 0;
            }

            .horas-module .promotor-card {
                min-width: 300px;
                flex-shrink: 0;
            }

            .horas-module .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .horas-module .report-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .horas-module .sidebar-floating-btn {
                bottom: 80px;
                width: 140px;
                height: 45px;
                font-size: 0.8rem;
            }

            .horas-module .store-filter-container {
                width: 100%;
                min-width: auto;
                margin-left: 0;
                margin-top: 10px;
            }

            .horas-module .calendar-controls {
                width: 100%;
                justify-content: space-between;
            }

            .horas-module .calendario-grid {
                grid-template-columns: 1fr;
            }

            .horas-module .tienda-horarios {
                grid-template-columns: 1fr;
            }

            .horas-module .chart-visual {
                grid-template-columns: repeat(2, 1fr);
            }

            .horas-module .chart-bar {
                height: 48px;
                font-size: 0.85rem;
                padding: 0 18px;
            }

            .horas-module .chart-section {
                padding: 18px;
            }
        }

        /* ===== RESPONSIVE: Ajustes para m√≥viles ===== */
        @media (max-width: 768px) {
            .horas-module .header-content {
                flex-direction: column;
                text-align: center;
            }

            .horas-module .header-actions {
                width: 100%;
                justify-content: center;
            }

            .horas-module .tabs-navigation {
                flex-direction: column;
            }

            .horas-module .tab-item {
                padding: 12px 15px;
            }

            .horas-module .calendar-header {
                flex-direction: column;
                text-align: center;
            }

            .horas-module #calendar-horas {
                height: 500px;
            }

            .horas-module .tab-section {
                padding: 20px 10px;
            }

            .horas-module .metric-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .modal-content {
                margin: 5% 5%;
                max-width: calc(100% - 20px);
            }

            .horas-module .form-row {
                flex-direction: column;
            }

            .horas-module .promotor-meta {
                flex-direction: column;
                gap: 10px;
            }

            .horas-module .relationships-sidebar {
                flex-direction: column;
            }

            .horas-module .chart-visual {
                grid-template-columns: 1fr;
            }

            .horas-module .chart-bar {
                height: 45px;
                font-size: 0.8rem;
                padding: 0 15px;
                border-radius: 22px;
            }

            .horas-module .chart-section {
                padding: 15px;
            }

            .horas-module .chart-section h3 {
                font-size: 1.1rem;
            }
        }

        /* ===== RESPONSIVE: Ajustes para pantallas muy peque√±as ===== */
        @media (max-width: 480px) {
            .modal-content {
                margin: 2% 5%;
                max-width: calc(100% - 10px);
            }

            .modal-footer {
                flex-direction: column;
            }

            .btn-primary,
            .btn-cancel-horas {
                width: 100%;
                margin-bottom: 10px;
            }

            .horas-module .tab-item span {
                display: none;
            }

            .horas-module .chart-bar {
                height: 42px;
                font-size: 0.75rem;
                padding: 0 12px;
                border-radius: 20px;
            }

            .horas-module .chart-section {
                padding: 12px;
            }

            .horas-module .chart-placeholder {
                max-height: 400px;
            }
        }

        /* ESTILO PARA CONTRATOS ACTIVOS (VERDE) */
        .horas-module .fc-event.event-activo-recurrente {
            border: 3px solid #4CAF50 !important;
            border-left-width: 6px !important;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5) !important;
        }


        /* SCROLLBAR PARA LISTA DE EVENTOS EN CADA D√çA */
        .horas-module .fc-daygrid-day-events {
            max-height: 120px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding-right: 4px !important;
        }

        /* Estilo del scrollbar para la lista de eventos */
        .horas-module .fc-daygrid-day-events::-webkit-scrollbar {
            width: 6px;
        }

        .horas-module .fc-daygrid-day-events::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .horas-module .fc-daygrid-day-events::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }

        .horas-module .fc-daygrid-day-events::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        /* Para Firefox */
        .horas-module .fc-daygrid-day-events {
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.5) rgba(0, 0, 0, 0.05);
        }

        /* Ajustar el contenedor del d√≠a para mejor visualizaci√≥n */
        .horas-module .fc-daygrid-day-frame {
            min-height: 120px !important;
        }

        /* Asegurar que "more" link sea visible */
        .horas-module .fc-daygrid-more-link {
            position: sticky !important;
            bottom: 0 !important;
            background: white !important;
            z-index: 2 !important;
            padding: 2px 4px !important;
            margin-top: 2px !important;
            border-top: 1px solid #e0e0e0 !important;
        }

        /* ESPACIADOR ENTRE CALENDARIO Y LEYENDAS */
        .horas-module #calendar-horas::after {
            content: "";
            display: block;
            height: 60px;
        }

        .horas-module .calendar-container .legend {
            margin-top: 80px !important;
            position: relative;
            z-index: 1;
        }

        /* ===== LEYENDAS EN SIDEBAR ===== */
        .horas-module .sidebar-legends {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .horas-module .sidebar-legend-section {
            margin-bottom: 20px;
        }

        .horas-module .sidebar-legend-section:last-child {
            margin-bottom: 0;
        }

        .horas-module .sidebar-legend-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 6px;
        }

        .horas-module .sidebar-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .horas-module .sidebar-legend-item:last-child {
            margin-bottom: 0;
        }

        .horas-module .sidebar-legend-color {
            width: 24px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .horas-module .sidebar-legend-item span {
            color: #555;
            font-weight: 500;
        }
    </style>

    <script>
        (function () {
            'use strict';

            console.log('INICIANDO M√ìDULO HOJAS DE HORAS - SISTEMA RECURRENTE COMPLETO');

            // ===== VARIABLES GLOBALES =====
            let calendar = null;
            let currentEvent = null;
            let isFullCalendarLoaded = false;
            let loadingPromise = null;
            let cleanupListeners = [];
            let currentTab = 'calendario';
            let promotoresData = [];
            let tiendasData = [];
            let datosAutomaticosExitosos = false;
            let todosLosEventos = [];
            let tiendaSeleccionada = '';
            let sidebarCollapsed = false;
            let tooltipTimeout = null;
            let currentTooltip = null;


            // ===== VARIABLES PARA OPTIMIZACI√ìN =====
            let eventCache = new Map();
            let isLoadingEvents = false;
            let visibleDateRange = { start: null, end: null };
            let renderTimeout = null;

            // VARIABLES PARA VISTA DETALLADA
            let tiendaSeleccionadaDetalle = null;
            let semanaActual = [];

            // ===== ELEMENTOS DOM =====
            const elements = {
                dependenciesLoading: document.getElementById('dependencies-loading'),
                mainContentHoras: document.getElementById('main-content-horas'),
                errorState: document.getElementById('error-state'),
                errorMessage: document.getElementById('error-message'),
                loadingProgress: document.getElementById('loading-progress')
            };

            // ===== REGISTRAR CLEANUP EN EL SISTEMA SPA =====
            if (window.registerModuleCleanup) {
                window.registerModuleCleanup(function () {
                    console.log('Limpiando m√≥dulo Hojas de Horas...');

                    eliminarTooltip();

                    if (calendar) {
                        try {
                            calendar.destroy();
                        } catch (error) {
                            console.warn('Error destruyendo calendar:', error);
                        }
                        calendar = null;
                    }

                    cleanupListeners.forEach(cleanup => {
                        try {
                            cleanup();
                        } catch (e) {
                            console.warn('Error limpiando listener:', e);
                        }
                    });
                    cleanupListeners = [];

                    const modal = document.getElementById('modal-evento-horas');
                    if (modal) modal.style.display = 'none';

                    currentEvent = null;
                    isFullCalendarLoaded = false;
                    loadingPromise = null;
                    currentTab = 'calendario';
                    promotoresData = [];
                    tiendasData = [];
                    sidebarCollapsed = false;
                    datosAutomaticosExitosos = false;
                    todosLosEventos = [];
                    tiendaSeleccionada = '';
                    tiendaSeleccionadaDetalle = null;
                    semanaActual = [];
                    tooltipTimeout = null;
                    currentTooltip = null;

                    console.log('M√≥dulo Hojas de Horas limpiado');
                });
            }

            // ===== HELPER PARA EVENT LISTENERS =====
            function addListener(element, event, handler, options) {
                if (!element) return;
                element.addEventListener(event, handler, options);
                cleanupListeners.push(() => element.removeEventListener(event, handler, options));
            }

            // ===== FUNCIONES DE TOOLTIP =====
            function crearTooltip(event, element) {
                eliminarTooltip();

                const props = event.extendedProps;

                const tooltip = document.createElement('div');
                tooltip.className = 'event-tooltip';
                tooltip.id = 'event-tooltip-hover';

                // Detectar proximidad al fin
                const proximidad = detectarProximidadFin(event);

                let estadoBadge = 'Contrato Activo';
                let estadoColor = '#4CAF50';

                if (proximidad === 'critico') {
                    estadoBadge = 'CONTRATO ACTIVO - CR√çTICO (3 d√≠as)';
                    estadoColor = '#F44336';
                } else if (proximidad === 'proximo') {
                    estadoBadge = 'CONTRATO ACTIVO - PR√ìXIMO A FINALIZAR';
                    estadoColor = '#FF9800';
                }

                const horaEntrada = props.hora_entrada ? props.hora_entrada.substring(0, 5) : '09:00';
                const horaSalida = props.hora_salida ? props.hora_salida.substring(0, 5) : '19:00';
                const horaComida = props.hora_comida_inicio ? props.hora_comida_inicio.substring(0, 5) : '14:00';
                const duracionComida = props.duracion_comida_minutos || 60;

                const [entradaH, entradaM] = horaEntrada.split(':').map(Number);
                const [salidaH, salidaM] = horaSalida.split(':').map(Number);
                const minutosTotal = (salidaH * 60 + salidaM) - (entradaH * 60 + entradaM);
                const horasTrabajo = Math.floor((minutosTotal - duracionComida) / 60);
                const minutosTrabajo = (minutosTotal - duracionComida) % 60;

                // Determinar d√≠as laborales
                const diasSemana = props.dias_semana || [1, 2, 3, 4, 5, 6];
                const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const diasTexto = diasSemana.map(d => diasNombres[d]).join(', ');

                let fechaFinHTML = '';
                if (props.fecha_fin) {
                    const fechaFin = new Date(props.fecha_fin);
                    fechaFinHTML = `
                        <div style="padding: 8px 12px; background: rgba(255, 152, 0, 0.1); border-left: 3px solid #FF9800; border-radius: 4px; margin-top: 8px;">
                            <strong style="color: #FF9800;">Fecha fin:</strong> ${fechaFin.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}
                        </div>
                    `;
                } else {
                    fechaFinHTML = `
                        <div style="padding: 8px 12px; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4CAF50; border-radius: 4px; margin-top: 8px;">
                            <strong style="color: #4CAF50;">Contrato indefinido</strong> (sin fecha de fin)
                        </div>
                    `;
                }

                tooltip.innerHTML = `
                    <div style="background: white; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); padding: 0; min-width: 320px; max-width: 400px; overflow: hidden; border: 2px solid ${estadoColor};">
                        
                        <div style="background: linear-gradient(135deg, ${estadoColor} 0%, ${estadoColor}dd 100%); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="font-weight: 700; font-size: 0.95rem;">${estadoBadge}</div>
                        </div>
                        
                        <div style="padding: 15px;">
                            
                            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0;">
                                <div style="color: #999; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Promotor</div>
                                <div style="font-weight: 700; font-size: 1.1rem; color: #333;">${props.nombre_promotor || 'Sin asignar'}</div>
                                <div style="color: #666; font-size: 0.85rem; margin-top: 3px;">
                                    <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; font-weight: 600; color: #1976d2;">
                                        ${props.tipo_trabajo === 'fijo' ? 'Fijo' : 'Cubredescansos'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0;">
                                <div style="color: #999; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Tienda</div>
                                <div style="font-weight: 600; font-size: 1rem; color: #333;">${props.cadena || ''} #${props.numero_tienda || ''}</div>
                                <div style="color: #666; font-size: 0.85rem;">${props.nombre_tienda || 'Sin nombre'}</div>
                            </div>
                            
                            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0;">
                                <div style="color: #999; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Horario Laboral</div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <div style="background: #e3f2fd; padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 0.7rem; color: #1976d2; margin-bottom: 3px;">Entrada</div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #1565c0;">${horaEntrada}</div>
                                    </div>
                                    <div style="background: #f3e5f5; padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 0.7rem; color: #7b1fa2; margin-bottom: 3px;">Salida</div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #6a1b9a;">${horaSalida}</div>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 8px 10px; border-radius: 6px; border-left: 3px solid #FF9800;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="font-size: 0.8rem; color: #ef6c00; font-weight: 600;">Comida: ${horaComida}</span>
                                        <span style="font-size: 0.75rem; color: #f57c00;">(${duracionComida} min)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 10px 12px; border-radius: 6px; border-left: 3px solid #4CAF50; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.85rem; color: #2e7d32; font-weight: 600;">Total trabajo:</span>
                                    <span style="font-size: 1.1rem; color: #1b5e20; font-weight: 700;">${horasTrabajo}h ${minutosTrabajo}min</span>
                                </div>
                            </div>
                            
                            <div style="padding: 8px 12px; background: rgba(33, 150, 243, 0.1); border-left: 3px solid #2196F3; border-radius: 4px; margin-bottom: 8px;">
                                <strong style="color: #1976d2;">D√≠as laborales:</strong> ${diasTexto}
                            </div>
                            
                            ${fechaFinHTML}
                            
                            ${props.motivo_asignacion ? `
                                <div style="margin-top: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">
                                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">Notas:</div>
                                    <div style="font-size: 0.85rem; color: #555; font-style: italic;">${props.motivo_asignacion}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 10px 15px; text-align: center; border-top: 1px solid #e0e0e0;">
                            <div style="font-size: 0.75rem; color: #999;">Haz clic en el evento para editarlo</div>
                        </div>
                    </div>
                `;

                document.body.appendChild(tooltip);

                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();

                let top = rect.top + window.scrollY - tooltipRect.height - 10;
                let left = rect.left + window.scrollX + (rect.width / 2) - (tooltipRect.width / 2);

                if (top < window.scrollY + 10) {
                    top = rect.bottom + window.scrollY + 10;
                }

                if (left < window.scrollX + 10) {
                    left = window.scrollX + 10;
                } else if (left + tooltipRect.width > window.scrollX + window.innerWidth - 10) {
                    left = window.scrollX + window.innerWidth - tooltipRect.width - 10;
                }

                tooltip.style.position = 'absolute';
                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.style.zIndex = '10001';
                tooltip.style.animation = 'tooltipFadeIn 0.2s ease';

                currentTooltip = tooltip;
            }

            function eliminarTooltip() {
                if (currentTooltip) {
                    currentTooltip.remove();
                    currentTooltip = null;
                }
                if (tooltipTimeout) {
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = null;
                }
            }

            // ===== FUNCIONALIDAD SIDEBAR COLAPSIBLE =====
            function toggleSidebar() {
                const sidebar = document.getElementById('relationships-sidebar');
                const floatingBtn = document.getElementById('sidebar-floating-btn');
                const calendarTab = document.getElementById('tab-calendario');
                const toggleIcon = document.getElementById('toggle-icon');
                const toggleText = document.getElementById('toggle-text');

                if (!sidebar || !floatingBtn || !calendarTab) {
                    console.error('Elementos del sidebar no encontrados');
                    return;
                }

                sidebarCollapsed = !sidebarCollapsed;

                if (sidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                    calendarTab.classList.add('sidebar-collapsed');
                    floatingBtn.classList.add('visible');

                    if (toggleIcon) toggleIcon.className = 'fas fa-chevron-right';
                    if (toggleText) toggleText.textContent = 'Mostrar men√∫';

                    setTimeout(() => {
                        if (window.calendar && calendar.updateSize) {
                            calendar.updateSize();
                        }
                    }, 450);

                } else {
                    sidebar.classList.remove('collapsed');
                    calendarTab.classList.remove('sidebar-collapsed');
                    floatingBtn.classList.remove('visible');

                    if (toggleIcon) toggleIcon.className = 'fas fa-chevron-left';
                    if (toggleText) toggleText.textContent = 'Ocultar men√∫';

                    setTimeout(() => {
                        if (window.calendar && calendar.updateSize) {
                            calendar.updateSize();
                        }
                    }, 450);
                }

                localStorage.setItem('sidebarCollapsed', sidebarCollapsed.toString());
            }

            window.toggleSidebar = toggleSidebar;

            // ===== FUNCI√ìN PARA CALCULAR Y ACTUALIZAR RESUMEN DE HORARIO =====
            function actualizarResumenHorario() {
                const horaEntrada = document.getElementById('event-hora-entrada')?.value || '09:00';
                const horaSalida = document.getElementById('event-hora-salida')?.value || '19:00';
                const duracionComida = parseInt(document.getElementById('event-duracion-comida')?.value || '60');

                const [entradaH, entradaM] = horaEntrada.split(':').map(Number);
                const [salidaH, salidaM] = horaSalida.split(':').map(Number);

                const minutosEntrada = entradaH * 60 + entradaM;
                const minutosSalida = salidaH * 60 + salidaM;

                const totalMinutosTienda = minutosSalida - minutosEntrada;
                const totalMinutosTrabajo = totalMinutosTienda - duracionComida;

                const horasTrabajo = Math.floor(totalMinutosTrabajo / 60);
                const minutosTrabajo = totalMinutosTrabajo % 60;

                const horasTienda = Math.floor(totalMinutosTienda / 60);
                const minutosTienda = totalMinutosTienda % 60;

                const totalHorasTrabajoEl = document.getElementById('total-horas-trabajo');
                const tiempoComidaEl = document.getElementById('tiempo-comida');
                const totalTiempoTiendaEl = document.getElementById('total-tiempo-tienda');

                if (totalHorasTrabajoEl) {
                    totalHorasTrabajoEl.textContent = `${horasTrabajo}h ${minutosTrabajo}min`;
                }
                if (tiempoComidaEl) {
                    const horasComida = Math.floor(duracionComida / 60);
                    const minutosComida = duracionComida % 60;
                    tiempoComidaEl.textContent = horasComida > 0 ? `${horasComida}h ${minutosComida}min` : `${minutosComida} min`;
                }
                if (totalTiempoTiendaEl) {
                    totalTiempoTiendaEl.textContent = `${horasTienda}h ${minutosTienda}min`;
                }
            }

            // ===== FUNCI√ìN PARA LLENAR SELECT DE COBERTURA DE COMIDA =====
            function llenarPromotoresCoberturaComida(promotorActualId = null) {
                const selectCobertura = document.getElementById('event-promotor-cobertura-comida');
                if (!selectCobertura || promotoresData.length === 0) {
                    console.warn('No se puede llenar select de cobertura');
                    return;
                }

                selectCobertura.innerHTML = '<option value="">Sin cobertura / No aplica</option>';

                if (!promotorActualId) {
                    promotoresData.forEach(promotor => {
                        const option = document.createElement('option');
                        option.value = promotor.id_promotor;
                        const emoji = promotor.tipo_trabajo === 'fijo' ? 'üëî' : 'üîÑ';
                        option.textContent = `${emoji} ${promotor.nombre} ${promotor.apellido} (${promotor.tipo_trabajo})`;
                        selectCobertura.appendChild(option);
                    });
                    return;
                }

                const promotorActual = promotoresData.find(p => p.id_promotor == promotorActualId);

                if (!promotorActual) {
                    console.warn('Promotor no encontrado:', promotorActualId);
                    return;
                }

                let promotoresDisponibles = 0;

                promotoresData.forEach(promotor => {
                    if (promotor.id_promotor == promotorActualId) return;

                    let puedeCoberturar = false;

                    if (promotorActual.tipo_trabajo === 'fijo') {
                        puedeCoberturar = (promotor.tipo_trabajo === 'fijo' || promotor.tipo_trabajo === 'cubredescansos');
                    } else if (promotorActual.tipo_trabajo === 'cubredescansos') {
                        puedeCoberturar = (promotor.tipo_trabajo === 'cubredescansos');
                    }

                    if (puedeCoberturar) {
                        const option = document.createElement('option');
                        option.value = promotor.id_promotor;
                        const emoji = promotor.tipo_trabajo === 'fijo' ? 'üëî' : 'üîÑ';
                        option.textContent = `${emoji} ${promotor.nombre} ${promotor.apellido} (${promotor.tipo_trabajo})`;
                        selectCobertura.appendChild(option);
                        promotoresDisponibles++;
                    }
                });

                if (promotoresDisponibles === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.disabled = true;
                    option.textContent = 'No hay promotores disponibles para cobertura';
                    selectCobertura.appendChild(option);
                }
            }

            // ===== FUNCI√ìN FETCHFROMAPI =====
            async function fetchFromAPI(endpoint, options = {}) {
                const possiblePaths = [
                    '/promotoria/api/hoja_horario.php',
                    '/api/hoja_horario.php',
                    '/hoja_horario.php'
                ];

                const baseURL = window.location.origin;

                for (let i = 0; i < possiblePaths.length; i++) {
                    const path = possiblePaths[i];
                    const url = `${baseURL}${path}?resource=${endpoint}`;

                    try {
                        console.log(`INTENTANDO RUTA ${i + 1}/${possiblePaths.length}: ${url}`);

                        const requestOptions = {
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                ...options.headers
                            },
                            ...options
                        };

                        const response = await fetch(url, requestOptions);

                        if (!response.ok) {
                            console.warn(`HTTP ${response.status} en ${path}, probando siguiente ruta...`);
                            continue;
                        }

                        const responseText = await response.text();

                        if (!responseText.trim()) {
                            console.warn('Respuesta vac√≠a, probando siguiente ruta...');
                            continue;
                        }

                        let result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('Error parseando JSON:', parseError.message);
                            continue;
                        }

                        if (result && typeof result === 'object') {
                            if (result.success === true) {
                                return result.data || result;
                            } else if (result.success === false) {
                                throw new Error(result.message || 'Error en la API');
                            } else if (Array.isArray(result)) {
                                return result;
                            } else if (result.data && Array.isArray(result.data)) {
                                return result.data;
                            } else {
                                return result;
                            }
                        }

                        console.warn('Estructura de respuesta no reconocida, probando siguiente ruta...');
                        continue;

                    } catch (fetchError) {
                        console.error(`ERROR EN ${path}:`, fetchError.message);
                        if (i === possiblePaths.length - 1) {
                            throw fetchError;
                        }
                        continue;
                    }
                }

                throw new Error('No se pudo conectar con ninguna ruta de la API');
            }

            // ===== FUNCI√ìN PARA CREAR ASIGNACI√ìN EN BD =====
            async function crearAsignacionBD(datos) {
                try {
                    console.log('üì° ENVIANDO DATOS A API:', datos);

                    const datosConDefaults = {
                        ...datos,
                        hora_entrada: datos.hora_entrada || '09:00',
                        hora_salida: datos.hora_salida || '19:00',
                        hora_comida_inicio: datos.hora_comida_inicio || '14:00',
                        duracion_comida_minutos: datos.duracion_comida_minutos || 60,
                        id_promotor_cobertura_comida: datos.id_promotor_cobertura_comida || null,
                        notas_horario: datos.notas_horario || datos.motivo_asignacion || ''
                    };

                    const response = await fetch(`${window.location.origin}/promotoria/api/hoja_horario.php?resource=asignaciones`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(datosConDefaults)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå HTTP Error Response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const responseText = await response.text();

                    if (!responseText.trim()) {
                        throw new Error('Respuesta vac√≠a del servidor');
                    }

                    let resultado;
                    try {
                        resultado = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('‚ùå Error parseando JSON:', parseError);
                        throw new Error('Respuesta del servidor no es JSON v√°lido');
                    }

                    if (resultado && typeof resultado === 'object') {
                        if (resultado.success === true) {
                            return resultado;
                        }
                        else if (resultado.success === false) {
                            throw new Error(resultado.message || 'Error reportado por la API');
                        }
                        else if (resultado.id || resultado.data?.id_asignacion) {
                            return {
                                success: true,
                                id: resultado.id || resultado.data?.id_asignacion,
                                data: resultado.data || resultado,
                                message: resultado.message || 'Creado exitosamente'
                            };
                        }
                        else {
                            return {
                                success: true,
                                data: resultado,
                                message: 'Operaci√≥n completada'
                            };
                        }
                    } else {
                        throw new Error('Formato de respuesta inv√°lido');
                    }

                } catch (error) {
                    console.error('‚ùå ERROR EN crearAsignacionBD:', error);
                    throw error;
                }
            }


            // ===== ACTUALIZAR PROGRESO DE CARGA =====
            function updateLoadingProgress(mensaje) {
                const progressEl = elements.loadingProgress;
                if (progressEl) {
                    progressEl.textContent = mensaje;
                }
                console.log(`‚è≥ ${mensaje}`);
            }

            // ===== CARGAR PROMOTORES DESDE BASE DE DATOS =====
            async function cargarPromotoresReales() {
                try {
                    updateLoadingProgress('Cargando promotores...');
                    const data = await fetchFromAPI('promotores');

                    if (!data) return [];

                    let promotoresArray = [];
                    if (Array.isArray(data)) {
                        promotoresArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        promotoresArray = data.data;
                    }

                    promotoresData = promotoresArray;
                    console.log(`${promotoresData.length} PROMOTORES CARGADOS`);

                    const promotorFijo = promotoresData.find(p => p.tipo_trabajo === 'fijo') || promotoresData[0];
                    const promotorCubre = promotoresData.find(p => p.tipo_trabajo === 'cubredescansos');

                    if (promotorFijo) updatePromotorSidebar('fijo', promotorFijo);
                    if (promotorCubre) updatePromotorSidebar('cubredescansos', promotorCubre);

                    updateLoadingProgress(`${promotoresData.length} promotores cargados`);
                    return promotoresData;

                } catch (error) {
                    console.error('ERROR cargando promotores:', error);
                    throw error;
                }
            }

            // ===== CARGAR TIENDAS DESDE BASE DE DATOS =====
            async function cargarTiendasReales() {
                try {
                    updateLoadingProgress('Cargando tiendas...');
                    const data = await fetchFromAPI('tiendas');

                    if (!data) return [];

                    let tiendasArray = [];
                    if (Array.isArray(data)) {
                        tiendasArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        tiendasArray = data.data;
                    }

                    tiendasData = tiendasArray;
                    console.log(`${tiendasData.length} TIENDAS CARGADAS`);

                    updateLoadingProgress(`${tiendasData.length} tiendas cargadas`);
                    return tiendasData;

                } catch (error) {
                    console.error('ERROR cargando tiendas:', error);
                    throw error;
                }
            }

            // ===== CARGAR CONTRATOS RECURRENTES =====
            async function cargarAsignacionesReales() {
                try {
                    updateLoadingProgress('üîÑ Cargando asignaciones activas...');
                    const data = await fetchFromAPI('asignaciones');

                    if (!data) return [];

                    let asignacionesArray = [];
                    if (Array.isArray(data)) {
                        asignacionesArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        asignacionesArray = data.data;
                    }

                    if (asignacionesArray.length === 0) {
                        console.log('‚ÑπÔ∏è Sin asignaciones activas en BD');
                        return [];
                    }

                    const eventos = asignacionesArray.map((asignacion) => {
                        if (!asignacion.id_asignacion || !asignacion.fecha_inicio) {
                            return null;
                        }

                        // Determinar d√≠as de la semana laborales
                        let diasSemana = null;

                        if (asignacion.dias_semana) {
                            // Ya tiene dias_semana guardados
                            diasSemana = asignacion.dias_semana.split(',').map(d => parseInt(d));
                        } else {
                            // Calcular basado en el d√≠a de descanso del promotor
                            const promotor = promotoresData.find(p => p.id_promotor == asignacion.id_promotor);

                            if (promotor && promotor.dia_descanso) {
                                let diaDescansoNum = -1;

                                // MANEJAR FORMATO DEL D√çA DE DESCANSO
                                if (typeof promotor.dia_descanso === 'number') {
                                    diaDescansoNum = promotor.dia_descanso === 7 ? 0 : promotor.dia_descanso;
                                } else if (typeof promotor.dia_descanso === 'string') {
                                    const diaStr = promotor.dia_descanso.trim();

                                    if (/^[1-7]$/.test(diaStr)) {
                                        const diaNum = parseInt(diaStr);
                                        diaDescansoNum = diaNum === 7 ? 0 : diaNum;
                                    } else {
                                        const diasSemanaTexto = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
                                        diaDescansoNum = diasSemanaTexto.indexOf(diaStr.toLowerCase());
                                    }
                                }

                                if (diaDescansoNum >= 0 && diaDescansoNum <= 6) {
                                    diasSemana = [0, 1, 2, 3, 4, 5, 6].filter(d => d !== diaDescansoNum);
                                } else {
                                    diasSemana = [1, 2, 3, 4, 5, 6];
                                }
                            } else {
                                diasSemana = [1, 2, 3, 4, 5, 6];
                            }
                        }

                        const evento = {
                            id: `asig_real_${asignacion.id_asignacion}`,
                            title: `${asignacion.nombre_promotor || 'Sin promotor'} - ${asignacion.cadena || 'Sin cadena'} #${asignacion.numero_tienda || asignacion.num_tienda || 'S/N'}`,
                            startRecur: asignacion.fecha_inicio,
                            endRecur: asignacion.fecha_fin || null,
                            daysOfWeek: diasSemana,
                            startTime: asignacion.hora_entrada || '09:00:00',
                            endTime: asignacion.hora_salida || '19:00:00',
                            extendedProps: {
                                id_asignacion: asignacion.id_asignacion,
                                id_promotor: asignacion.id_promotor,
                                id_tienda: asignacion.id_tienda,
                                nombre_promotor: asignacion.nombre_promotor,
                                nombre_tienda: asignacion.nombre_tienda,
                                numero_tienda: asignacion.numero_tienda || asignacion.num_tienda,
                                cadena: asignacion.cadena,
                                motivo_asignacion: asignacion.motivo_asignacion,
                                activo: asignacion.activo,
                                tipo_trabajo: asignacion.tipo_trabajo,
                                hora_entrada: asignacion.hora_entrada || '09:00:00',
                                hora_salida: asignacion.hora_salida || '19:00:00',
                                hora_comida_inicio: asignacion.hora_comida_inicio || '14:00:00',
                                duracion_comida_minutos: asignacion.duracion_comida_minutos || 60,
                                id_promotor_cobertura_comida: asignacion.id_promotor_cobertura_comida || null,
                                notas_horario: asignacion.notas_horario || null,
                                fecha_inicio: asignacion.fecha_inicio,
                                fecha_fin: asignacion.fecha_fin || null,
                                dias_semana: diasSemana
                            }
                        };

                        if (asignacion.tipo_trabajo === 'fijo') {
                            evento.className = 'event-fijo-principal';
                        } else if (asignacion.tipo_trabajo === 'cubredescansos') {
                            evento.className = 'event-cubredescansos-apoyo';
                        } else {
                            evento.className = 'event-cubredescansos-otros';
                        }

                        return evento;
                    }).filter(evento => evento !== null);

                    console.log(`üéØ ${eventos.length} contratos recurrentes cargados`);
                    return eventos;

                } catch (error) {
                    console.error('‚ùå ERROR cargando asignaciones:', error);
                    throw error;
                }
            }

            // ===== CARGAR EVENTOS SOLO DEL RANGO VISIBLE =====
            function obtenerEventosDelRango(fechaInicio, fechaFin) {
                const cacheKey = `${fechaInicio}_${fechaFin}`;

                if (eventCache.has(cacheKey)) {
                    console.log('üì¶ Usando eventos cacheados');
                    return eventCache.get(cacheKey);
                }

                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);

                const eventosFiltrados = todosLosEventos.filter(evento => {
                    const eventoInicio = new Date(evento.startRecur || evento.start);
                    const eventoFin = evento.endRecur ? new Date(evento.endRecur) : new Date('2099-12-31');

                    return eventoInicio <= fin && eventoFin >= inicio;
                });

                eventCache.set(cacheKey, eventosFiltrados);
                console.log(`üìä ${eventosFiltrados.length} eventos en rango ${fechaInicio} - ${fechaFin}`);

                return eventosFiltrados;
            }

            // ===== ACTUALIZAR SIDEBAR PROMOTORES =====
            function updatePromotorSidebar(tipo, promotor) {
                const sidebarId = tipo === 'fijo' ? 'promotor-fijo-info' : 'promotor-cubredescansos-info';
                const sidebar = document.getElementById(sidebarId);

                if (!sidebar || !promotor) return;

                const nombreEl = sidebar.querySelector('.promotor-name');
                const detallesEl = sidebar.querySelector('.promotor-details');
                const tiendaEl = sidebar.querySelector('.tienda-principal-name');

                if (nombreEl) nombreEl.textContent = `${promotor.nombre} ${promotor.apellido}`;
                if (detallesEl) {
                    detallesEl.innerHTML = `RFC: ${promotor.rfc || 'N/A'}<br>Tel: ${promotor.telefono || 'N/A'}`;
                }
                if (tiendaEl && tipo === 'fijo') {
                    tiendaEl.textContent = 'Contratos din√°micos';
                }
            }

            // ===== LLENAR SELECTS CON DATOS REALES =====
            function llenarSelectsModal() {
                const promotorSelect = document.getElementById('event-promotor-horas');
                if (promotorSelect && promotoresData.length > 0) {
                    promotorSelect.innerHTML = '<option value="">Seleccionar promotor...</option>';
                    promotoresData.forEach(promotor => {
                        const option = document.createElement('option');
                        option.value = promotor.id_promotor;
                        option.textContent = `${promotor.nombre} ${promotor.apellido} (${promotor.tipo_trabajo})`;
                        promotorSelect.appendChild(option);
                    });
                }

                const tiendaSelect = document.getElementById('event-tienda-horas');
                if (tiendaSelect && tiendasData.length > 0) {
                    tiendaSelect.innerHTML = '<option value="">Seleccionar tienda...</option>';
                    tiendasData.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id_tienda;
                        option.textContent = `${tienda.cadena} #${tienda.num_tienda} - ${tienda.nombre_tienda}`;
                        tiendaSelect.appendChild(option);
                    });
                }

                const calendarStoreFilter = document.getElementById('calendar-store-filter');
                if (calendarStoreFilter && tiendasData.length > 0) {
                    calendarStoreFilter.innerHTML = '<option value="">Todas las tiendas</option>';
                    tiendasData.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id_tienda;
                        option.textContent = `${tienda.cadena} #${tienda.num_tienda} - ${tienda.nombre_tienda}`;
                        calendarStoreFilter.appendChild(option);
                    });
                }

                // LLENAR SELECT DE TIENDA PARA VISTA DETALLADA
                const selectorTiendaDetalle = document.getElementById('selector-tienda-detalle');
                if (selectorTiendaDetalle && tiendasData.length > 0) {
                    selectorTiendaDetalle.innerHTML = '<option value="">Seleccionar tienda...</option>';
                    tiendasData.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id_tienda;
                        option.textContent = `${tienda.cadena} #${tienda.num_tienda} - ${tienda.nombre_tienda}`;
                        selectorTiendaDetalle.appendChild(option);
                    });

                    // EVENT LISTENER PARA CAMBIO DE TIENDA
                    selectorTiendaDetalle.addEventListener('change', function () {
                        const idTienda = this.value;
                        if (idTienda) {
                            cargarVistaDetalleTienda(idTienda);
                        } else {
                            document.getElementById('promotor-asignado-section').style.display = 'none';
                            document.getElementById('leyenda-section').style.display = 'none';
                            document.getElementById('calendario-section').style.display = 'none';
                        }
                    });
                }
            }

            // ===== FUNCIONES DE CARGA DE DEPENDENCIAS =====
            async function loadCSS(url) {
                return new Promise((resolve, reject) => {
                    const existingLink = document.querySelector(`link[href="${url}"]`);
                    if (existingLink) {
                        resolve();
                        return;
                    }

                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = url;
                    link.onload = resolve;
                    link.onerror = reject;
                    document.head.appendChild(link);
                });
            }

            async function loadJS(url) {
                return new Promise((resolve, reject) => {
                    if (window.FullCalendar) {
                        resolve();
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => {
                        setTimeout(() => {
                            if (window.FullCalendar) {
                                resolve();
                            } else {
                                reject(new Error('FullCalendar no disponible'));
                            }
                        }, 300);
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            async function loadFullCalendarDependencies() {
                if (loadingPromise) return loadingPromise;
                if (isFullCalendarLoaded && window.FullCalendar) return Promise.resolve();

                updateLoadingProgress('Cargando FullCalendar...');

                loadingPromise = Promise.all([
                    loadCSS('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css'),
                    loadJS('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js')
                ]).then(() => {
                    isFullCalendarLoaded = true;
                    updateLoadingProgress('FullCalendar cargado exitosamente');
                    return true;
                });

                return loadingPromise;
            }

            // ===== FUNCI√ìN: DETECTAR SI EL CONTRATO EST√Å CERCA DE SU FIN =====
            function detectarProximidadFin(evento) {
                const fechaFin = evento.extendedProps?.fecha_fin;

                if (!fechaFin) {
                    return null; // No tiene fecha fin (contrato indefinido)
                }

                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);

                const fin = new Date(fechaFin);
                fin.setHours(0, 0, 0, 0);

                const diffTime = fin - hoy;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    return null; // Ya pas√≥
                } else if (diffDays <= 3) {
                    return 'critico'; // Quedan 3 d√≠as o menos
                } else if (diffDays <= 7) {
                    return 'proximo'; // Quedan 7 d√≠as o menos
                }

                return null;
            }

            // ===== FUNCI√ìN: APLICAR FILTRO DE TIENDA Y FECHA CON DEBOUNCING =====
            function aplicarFiltroTienda() {
                if (!calendar) {
                    console.warn('Calendario no inicializado');
                    return;
                }

                // Cancelar renderizado pendiente
                if (renderTimeout) {
                    clearTimeout(renderTimeout);
                }

                // Debouncing para evitar m√∫ltiples renderizados
                renderTimeout = setTimeout(() => {
                    console.log(`üîç Aplicando filtro de tienda: ${tiendaSeleccionada || 'Todas las tiendas'}`);

                    // Limpiar cach√© antes de refrescar
                    limpiarCache();

                    // Refrescar eventos del calendario
                    // Esto llamar√° autom√°ticamente a la funci√≥n 'events' definida en initializeCalendar
                    // donde se aplica el filtro basado en tiendaSeleccionada
                    calendar.refetchEvents();

                    console.log(`‚úÖ Filtro aplicado correctamente`);

                }, 150); // Debounce de 150ms
            }

            // ===== FUNCI√ìN: ACTUALIZAR VISTA DIARIAMENTE =====
            function iniciarActualizacionDiaria() {
                // Actualizar a medianoche de cada d√≠a
                const ahora = new Date();
                const ma√±ana = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() + 1, 0, 0, 1);
                const tiempoHastaMedianoche = ma√±ana - ahora;

                setTimeout(() => {
                    console.log('üïê Nuevo d√≠a - Actualizando calendario...');
                    aplicarFiltroTienda();

                    // Repetir cada 24 horas
                    setInterval(() => {
                        console.log('üïê Nuevo d√≠a - Actualizando calendario...');
                        aplicarFiltroTienda();
                    }, 24 * 60 * 60 * 1000);
                }, tiempoHastaMedianoche);

                console.log(`‚è∞ Actualizaci√≥n autom√°tica programada para medianoche (en ${Math.round(tiempoHastaMedianoche / 1000 / 60)} minutos)`);
            }

            async function initializeCalendar(eventosRecurrentes = []) {
                if (!window.FullCalendar) throw new Error('FullCalendar no disponible');

                const calendarEl = document.getElementById('calendar-horas');
                if (!calendarEl) throw new Error('Elemento calendario no encontrado');

                console.log(`INICIALIZANDO CALENDARIO CON ${eventosRecurrentes.length} CONTRATOS RECURRENTES`);

                todosLosEventos = eventosRecurrentes;

                try {
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'es',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: ''
                        },

                        // OPTIMIZACIONES DE RENDIMIENTO
                        lazyFetching: true,
                        eventMaxStack: 3,
                        progressiveEventRendering: true,

                        events: function (info, successCallback, failureCallback) {
                            try {
                                const eventosRango = obtenerEventosDelRango(
                                    info.startStr.split('T')[0],
                                    info.endStr.split('T')[0]
                                );

                                let eventosFiltrados = eventosRango;
                                if (tiendaSeleccionada && tiendaSeleccionada !== '') {
                                    eventosFiltrados = eventosRango.filter(evento =>
                                        String(evento.extendedProps.id_tienda) === String(tiendaSeleccionada)
                                    );
                                }

                                const hoy = new Date();
                                hoy.setHours(23, 59, 59, 999);

                                const eventosLimitados = eventosFiltrados.map(evento => {
                                    const eventoModificado = { ...evento };

                                    if (eventoModificado.startRecur) {
                                        if (!eventoModificado.endRecur) {
                                            eventoModificado.endRecur = hoy.toISOString().split('T')[0];
                                        } else {
                                            const fechaFin = new Date(eventoModificado.endRecur);
                                            if (fechaFin > hoy) {
                                                eventoModificado.endRecur = hoy.toISOString().split('T')[0];
                                            }
                                        }
                                    }

                                    return eventoModificado;
                                });

                                successCallback(eventosLimitados);
                            } catch (error) {
                                console.error('Error cargando eventos:', error);
                                failureCallback(error);
                            }
                        },

                        datesSet: function (info) {
                            visibleDateRange = {
                                start: info.startStr,
                                end: info.endStr
                            };
                            console.log(`Vista cambiada: ${info.startStr} - ${info.endStr}`);
                        },

                        editable: false,
                        droppable: false,
                        selectable: true,

                        eventClick: function (info) {
                            eliminarTooltip();
                            openEventModal(info.event);
                        },

                        select: function (info) {
                            openEventModal(null, info.start, null);
                        },

                        eventMouseEnter: function (info) {
                            tooltipTimeout = setTimeout(() => {
                                crearTooltip(info.event, info.el);
                            }, 300);
                        },

                        eventMouseLeave: function (info) {
                            eliminarTooltip();
                        },

                        dayMaxEvents: true,
                        dayMaxEventRows: 4,
                        moreLinkClick: 'popover',
                        slotMinTime: '06:00:00',
                        slotMaxTime: '24:00:00',
                        allDaySlot: false,
                        firstDay: 1,
                        height: 'auto',
                        aspectRatio: 1.35,

                        eventDidMount: function (info) {
                            const proximidad = detectarProximidadFin(info.event);

                            if (proximidad === 'critico') {
                                info.el.classList.add('event-fin-critico');
                            } else if (proximidad === 'proximo') {
                                info.el.classList.add('event-proximo-fin');
                            } else {
                                info.el.classList.add('event-activo-recurrente');
                            }

                            info.el.style.cursor = 'pointer';
                        }
                    });

                    await calendar.render();
                    console.log('CALENDARIO RENDERIZADO EXITOSAMENTE');

                    window.calendar = calendar;

                    const storeFilterSelect = document.getElementById('calendar-store-filter');
                    if (storeFilterSelect) {
                        storeFilterSelect.addEventListener('change', function (e) {
                            tiendaSeleccionada = e.target.value;
                            console.log('üîç Filtro cambiado a tienda:', tiendaSeleccionada || 'Todas');
                            limpiarCache();

                            // Forzar actualizaci√≥n del calendario
                            if (calendar) {
                                calendar.refetchEvents();
                            }
                        });
                    }

                } catch (error) {
                    console.error('ERROR en initializeCalendar:', error);
                    throw error;
                }
            }

            // ===== FUNCIONES PARA VISTA DETALLADA POR TIENDA =====
            function cargarVistaDetalleTienda(idTienda) {
                console.log('Cargando vista detallada para tienda:', idTienda);

                tiendaSeleccionadaDetalle = tiendasData.find(t => t.id_tienda == idTienda);

                if (!tiendaSeleccionadaDetalle) {
                    console.error('Tienda no encontrada');
                    return;
                }

                // ACTUALIZAR HEADER DE TIENDA
                document.getElementById('tienda-seleccionada-nombre').textContent =
                    `${tiendaSeleccionadaDetalle.cadena} #${tiendaSeleccionadaDetalle.num_tienda}`;
                document.getElementById('tienda-seleccionada-ubicacion').textContent =
                    tiendaSeleccionadaDetalle.direccion || 'Sin direcci√≥n';

                // FILTRAR CONTRATOS ACTIVOS DE ESTA TIENDA
                const contratosActivosTienda = todosLosEventos.filter(e =>
                    e.extendedProps.id_tienda == idTienda &&
                    (e.extendedProps.activo === 1 || e.extendedProps.activo === '1' || e.extendedProps.activo === true)
                );

                console.log(`${contratosActivosTienda.length} contratos activos encontrados para esta tienda`);

                // ACTUALIZAR HORARIOS EN EL HEADER
                actualizarHorariosHeader(contratosActivosTienda);

                // OBTENER TODOS LOS PROMOTORES √öNICOS DE ESTA TIENDA
                const promotoresUnicos = new Map();
                contratosActivosTienda.forEach(contrato => {
                    const idPromotor = contrato.extendedProps.id_promotor;
                    if (!promotoresUnicos.has(idPromotor)) {
                        promotoresUnicos.set(idPromotor, {
                            id: idPromotor,
                            count: 0,
                            diasSemana: contrato.extendedProps.dias_semana
                        });
                    }
                    promotoresUnicos.get(idPromotor).count++;
                });

                // Obtener datos completos de cada promotor
                const promotoresCompletos = [];
                promotoresUnicos.forEach((info, idPromotor) => {
                    const promotor = promotoresData.find(p => p.id_promotor == idPromotor);
                    if (promotor) {
                        promotoresCompletos.push({
                            ...promotor,
                            numContratos: info.count,
                            diasSemana: info.diasSemana
                        });
                    }
                });

                if (promotoresCompletos.length > 0) {
                    mostrarPromotoresAsignados(promotoresCompletos);
                }

                // GENERAR SEMANA ACTUAL
                generarSemanaActual(idTienda);

                // MOSTRAR SECCIONES
                document.getElementById('promotor-asignado-section').style.display = 'block';
                document.getElementById('leyenda-section').style.display = 'block';
                document.getElementById('calendario-section').style.display = 'block';

                renderizarCalendario();
            }

            function mostrarPromotoresAsignados(promotores) {
                const section = document.getElementById('promotor-asignado-section');
                if (!section) return;

                // Limpiar el contenido actual
                section.innerHTML = '';

                // Crear un grid de promotores
                const grid = document.createElement('div');
                grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; padding: 20px 30px; background: #f8f9fa; border-bottom: 3px solid #e0e0e0;';

                promotores.forEach(promotor => {
                    const card = document.createElement('div');
                    card.className = 'promotor-card';
                    card.style.cssText = 'display: flex; align-items: center; gap: 15px; background: #4db4e4; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';

                    const iniciales = `${promotor.nombre.charAt(0)}${promotor.apellido.charAt(0)}`;

                    // Determinar d√≠as laborales
                    const diasSemana = promotor.diasSemana || [1, 2, 3, 4, 5, 6];
                    const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                    const diasTexto = diasSemana.map(d => diasNombres[d]).join(', ');

                    card.innerHTML = `
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700; flex-shrink: 0;">
                            ${iniciales}
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 5px; color: #333;">${promotor.nombre} ${promotor.apellido}</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px; color: #666; font-size: 0.85rem;">
                                <span><strong>Tipo:</strong> ${promotor.tipo_trabajo}</span>
                                <span><strong>D√≠as:</strong> ${diasTexto}</span>
                            </div>
                            <div style="margin-top: 8px; padding: 6px 12px; background: #e3f2fd; border-radius: 4px; display: inline-block; font-size: 0.8rem; color: #1976d2; font-weight: 600;">
                                ${promotor.numContratos} contrato${promotor.numContratos !== 1 ? 's' : ''} activo${promotor.numContratos !== 1 ? 's' : ''}
                            </div>
                        </div>
                    `;

                    grid.appendChild(card);
                });

                section.appendChild(grid);
                section.style.display = 'block';
            }

            function actualizarHorariosHeader(contratos) {
                // Valores por defecto
                let horaApertura = '09:00';
                let horaCierre = '19:00';
                let horaComidaInicio = '14:00';
                let horaComidaFin = '15:00';

                // Si hay contratos, tomar los horarios del primero
                if (contratos.length > 0) {
                    const contrato = contratos[0];
                    const props = contrato.extendedProps;

                    if (props.hora_entrada) {
                        horaApertura = props.hora_entrada.substring(0, 5);
                    }
                    if (props.hora_salida) {
                        horaCierre = props.hora_salida.substring(0, 5);
                    }
                    if (props.hora_comida_inicio) {
                        horaComidaInicio = props.hora_comida_inicio.substring(0, 5);

                        // Calcular hora fin de comida
                        const duracionComidaMinutos = props.duracion_comida_minutos || 60;
                        const [horaH, horaM] = horaComidaInicio.split(':').map(Number);
                        const minutosInicio = horaH * 60 + horaM;
                        const minutosFin = minutosInicio + duracionComidaMinutos;
                        const horaFinH = Math.floor(minutosFin / 60);
                        const horaFinM = minutosFin % 60;
                        horaComidaFin = `${String(horaFinH).padStart(2, '0')}:${String(horaFinM).padStart(2, '0')}`;
                    }
                }

                // Actualizar el DOM
                const horariosContainer = document.getElementById('tienda-horarios-container');
                if (horariosContainer) {
                    horariosContainer.innerHTML = `
                        <div class="horario-item">
                            <div class="horario-label">Apertura</div>
                            <div class="horario-time">${horaApertura}</div>
                        </div>
                        <div class="horario-item">
                            <div class="horario-label">Horario Comida</div>
                            <div class="horario-time">${horaComidaInicio} - ${horaComidaFin}</div>
                        </div>
                        <div class="horario-item">
                            <div class="horario-label">Cierre</div>
                            <div class="horario-time">${horaCierre}</div>
                        </div>
                    `;
                }

                console.log(`Horarios actualizados: ${horaApertura} - ${horaComidaInicio}/${horaComidaFin} - ${horaCierre}`);
            }

            function generarSemanaActual(idTienda) {
                const hoy = new Date();
                hoy.setHours(12, 0, 0, 0);

                const diaSemana = hoy.getDay();
                const domingo = new Date(hoy);
                domingo.setDate(hoy.getDate() - diaSemana);
                domingo.setHours(12, 0, 0, 0);

                semanaActual = [];
                const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

                // Obtener contratos recurrentes ACTIVOS de esta tienda
                const contratosActivosTienda = todosLosEventos.filter(e =>
                    e.extendedProps.id_tienda == idTienda &&
                    (e.extendedProps.activo === 1 || e.extendedProps.activo === '1' || e.extendedProps.activo === true)
                );

                console.log(`üìä ${contratosActivosTienda.length} contratos activos encontrados para tienda ${idTienda}`);

                for (let i = 0; i < 7; i++) {
                    const fecha = new Date(domingo);
                    fecha.setDate(domingo.getDate() + i);
                    fecha.setHours(12, 0, 0, 0);
                    const fechaStr = fecha.toISOString().split('T')[0];

                    let tipoDia = 'sin_programar';
                    let promotor = null;
                    let promotorComida = null;

                    // Verificar si alg√∫n contrato recurrente cubre este d√≠a
                    for (const contrato of contratosActivosTienda) {
                        const diasSemanaContrato = contrato.extendedProps.dias_semana || [];

                        console.log(`D√≠a ${i} (${diasSemana[i]}):`, {
                            tipoDia: tipoDia,
                            promotor: promotor,
                            diasSemanaContrato: diasSemanaContrato
                        });

                        // i es el d√≠a de la semana (0=Domingo, 1=Lunes, etc.)
                        const esDiaLaboral = Array.isArray(diasSemanaContrato)
                            ? diasSemanaContrato.includes(i)
                            : false;

                        // Verificar que la fecha est√© dentro del rango del contrato
                        const fechaInicio = new Date(contrato.extendedProps.fecha_inicio);
                        fechaInicio.setHours(0, 0, 0, 0);

                        const fechaFin = contrato.extendedProps.fecha_fin ? new Date(contrato.extendedProps.fecha_fin) : null;
                        if (fechaFin) fechaFin.setHours(23, 59, 59, 999);

                        const fechaActual = new Date(fechaStr);
                        fechaActual.setHours(12, 0, 0, 0);

                        const dentroDelRango = fechaActual >= fechaInicio && (!fechaFin || fechaActual <= fechaFin);

                        if (dentroDelRango) {
                            if (esDiaLaboral) {
                                // Es d√≠a de trabajo
                                tipoDia = 'trabajo';
                                promotor = contrato.extendedProps.id_promotor;
                                promotorComida = contrato.extendedProps.id_promotor_cobertura_comida;
                                break;
                            } else {
                                // Es d√≠a de descanso configurado
                                tipoDia = 'descanso';
                                promotor = contrato.extendedProps.id_promotor;
                            }
                        }
                    }

                    semanaActual.push({
                        fecha: fechaStr,
                        dia: diasSemana[i],
                        numero: fecha.getDate(),
                        tipo: tipoDia,
                        promotor: promotor,
                        promotorComida: promotorComida
                    });
                }

                // Actualizar t√≠tulo (c√≥digo existente...)
                const fechaInicio = new Date(semanaActual[0].fecha);
                const fechaFin = new Date(semanaActual[6].fecha);
                const primerDia = semanaActual[0].numero;
                const ultimoDia = semanaActual[6].numero;
                const mesInicio = fechaInicio.getMonth();
                const mesFin = fechaFin.getMonth();
                const a√±oInicio = fechaInicio.getFullYear();
                const a√±oFin = fechaFin.getFullYear();

                let tituloSemana;
                if (mesInicio !== mesFin || a√±oInicio !== a√±oFin) {
                    const mesNombreInicio = fechaInicio.toLocaleDateString('es-ES', { month: 'long' });
                    const mesNombreFin = fechaFin.toLocaleDateString('es-ES', { month: 'long' });
                    if (a√±oInicio !== a√±oFin) {
                        tituloSemana = `Semana del ${primerDia} de ${mesNombreInicio} de ${a√±oInicio} al ${ultimoDia} de ${mesNombreFin} de ${a√±oFin}`;
                    } else {
                        tituloSemana = `Semana del ${primerDia} de ${mesNombreInicio} al ${ultimoDia} de ${mesNombreFin} de ${a√±oFin}`;
                    }
                } else {
                    const mesNombre = fechaInicio.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    tituloSemana = `Semana del ${primerDia} al ${ultimoDia} de ${mesNombre}`;
                }

                document.getElementById('semana-titulo').textContent = tituloSemana;
                console.log('üìÖ Semana generada:', semanaActual);
            }

            function renderizarCalendario() {
                const grid = document.getElementById('calendarioGrid');
                grid.innerHTML = '';

                semanaActual.forEach(dia => {
                    const diaCard = crearTarjetaDia(dia);
                    grid.appendChild(diaCard);
                });

                actualizarResumenSemana();
            }

            function crearTarjetaDia(dia) {
                const card = document.createElement('div');

                // Asignar clase seg√∫n el tipo de d√≠a
                if (dia.tipo === 'descanso') {
                    card.className = 'dia-card dia-descanso';
                } else if (dia.tipo === 'trabajo') {
                    card.className = 'dia-card dia-trabajo';
                } else {
                    card.className = 'dia-card dia-sin_contrato';
                }

                let contenidoHTML = `
        <div class="dia-header">
            <div class="dia-nombre">${dia.dia}</div>
            <div class="dia-numero">${dia.numero}</div>
    `;

                if (dia.tipo === 'descanso') {
                    contenidoHTML += '<span class="estado-badge badge-descanso">DESCANSO</span>';
                }

                contenidoHTML += '</div><div class="dia-contenido">';

                if (dia.tipo === 'descanso') {
                    // D√çA DE DESCANSO CONFIGURADO
                    contenidoHTML += `
            <div style="text-align: center; padding: 40px 10px; color: #999;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üåô</div>
                <div style="font-weight: 600;">D√≠a de descanso</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">Sin actividades programadas</div>
            </div>
        `;
                } else if (dia.tipo === 'sin_contrato') {
                    // D√çA SIN CONTRATO
                    contenidoHTML += `
            <div style="text-align: center; padding: 40px 10px; color: #bbb;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üìã</div>
                <div style="font-weight: 600; color: #999;">Sin contrato activo</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">No hay asignaciones</div>
            </div>
        `;
                } else {
                    // D√çA DE TRABAJO
                    const promotorPrincipal = promotoresData.find(p => p.id_promotor == dia.promotor);

                    // BUSCAR PROMOTOR DE COBERTURA DE COMIDA
                    const promotorComida = dia.promotorComida ?
                        promotoresData.find(p => p.id_promotor == dia.promotorComida) : null;

                    if (promotorPrincipal) {
                        // Buscar el contrato activo para obtener horarios
                        const contratoActivo = todosLosEventos.find(e =>
                            e.extendedProps.id_tienda == tiendaSeleccionadaDetalle.id_tienda &&
                            e.extendedProps.id_promotor == dia.promotor &&
                            (e.extendedProps.activo === 1 || e.extendedProps.activo === '1' || e.extendedProps.activo === true)
                        );

                        if (contratoActivo) {
                            const props = contratoActivo.extendedProps;

                            const horaEntrada = props.hora_entrada ? props.hora_entrada.substring(0, 5) : '09:00';
                            const horaSalida = props.hora_salida ? props.hora_salida.substring(0, 5) : '19:00';
                            const horaComidaInicio = props.hora_comida_inicio ? props.hora_comida_inicio.substring(0, 5) : '14:00';
                            const duracionComidaMinutos = props.duracion_comida_minutos || 60;

                            const [horaInicioH, horaInicioM] = horaComidaInicio.split(':').map(Number);
                            const minutosInicio = horaInicioH * 60 + horaInicioM;
                            const minutosFin = minutosInicio + duracionComidaMinutos;
                            const horaFinH = Math.floor(minutosFin / 60);
                            const horaFinM = minutosFin % 60;
                            const horaComidaFin = `${String(horaFinH).padStart(2, '0')}:${String(horaFinM).padStart(2, '0')}`;

                            // BLOQUE APERTURA
                            contenidoHTML += `
                    <div class="bloque-horario bloque-apertura">
                        <div class="bloque-horario-label">Apertura</div>
                        <div class="bloque-horario-time">${horaEntrada} - ${horaComidaInicio}</div>
                        <div class="bloque-horario-promotor">${promotorPrincipal.nombre} ${promotorPrincipal.apellido}</div>
                    </div>
                `;

                            // BLOQUE COMIDA - MOSTRAR PROMOTOR DE COBERTURA SI EXISTE
                            const nombrePromotorComida = promotorComida ?
                                `${promotorComida.nombre} ${promotorComida.apellido}` :
                                `${promotorPrincipal.nombre} ${promotorPrincipal.apellido}`;

                            contenidoHTML += `
                    <div class="bloque-horario bloque-comida">
                        <div class="bloque-horario-label">Comida</div>
                        <div class="bloque-horario-time">${horaComidaInicio} - ${horaComidaFin}</div>
                        <div class="bloque-horario-promotor">${nombrePromotorComida}</div>
                    </div>
                `;

                            // BLOQUE CIERRE
                            contenidoHTML += `
                    <div class="bloque-horario bloque-cierre">
                        <div class="bloque-horario-label">Cierre</div>
                        <div class="bloque-horario-time">${horaComidaFin} - ${horaSalida}</div>
                        <div class="bloque-horario-promotor">${promotorPrincipal.nombre} ${promotorPrincipal.apellido}</div>
                    </div>
                `;
                        }
                    }
                }

                contenidoHTML += '</div>';
                card.innerHTML = contenidoHTML;
                return card;
            }

            function actualizarResumenSemana() {
                let diasTrabajados = 0;
                let diasDescanso = 0;
                let horasTotales = 0;
                const contratosActivos = new Set();

                semanaActual.forEach(dia => {
                    if (dia.tipo === 'trabajo') {
                        diasTrabajados++;
                        horasTotales += 10; // Aproximado
                        if (dia.promotor) contratosActivos.add(dia.promotor);
                    } else if (dia.tipo === 'descanso') {
                        diasDescanso++;
                    }
                });

                document.getElementById('diasTrabajados').textContent = diasTrabajados;
                document.getElementById('diasDescanso').textContent = diasDescanso;
                document.getElementById('horasTotales').textContent = horasTotales + 'h';
                document.getElementById('contratosActivos').textContent = contratosActivos.size;
            }

            // ===== DASHBOARD - FUNCI√ìN ACTUALIZADA =====
            function actualizarDashboard() {
                // Usar requestAnimationFrame para no bloquear UI
                requestAnimationFrame(() => {
                    const events = calendar ? calendar.getEvents() : todosLosEventos.slice(0, 100);
                    const totalAssignments = todosLosEventos.length;

                    let totalHorasSemanales = 0;
                    const tiendasUnicas = new Set();

                    // Procesar en lotes para no bloquear
                    const batchSize = 50;
                    let processed = 0;

                    const processBatch = () => {
                        const end = Math.min(processed + batchSize, events.length);

                        for (let i = processed; i < end; i++) {
                            const event = events[i];
                            const diasSemana = event.extendedProps?.dias_semana || [1, 2, 3, 4, 5, 6];
                            totalHorasSemanales += diasSemana.length * 10;

                            const props = event.extendedProps;
                            if (props && props.numero_tienda && props.cadena) {
                                tiendasUnicas.add(`${props.cadena}_#${props.numero_tienda}`);
                            }
                        }

                        processed = end;

                        if (processed < events.length) {
                            requestAnimationFrame(processBatch);
                        } else {
                            // Actualizar UI cuando termine
                            const activeStores = tiendasUnicas.size;
                            const coverage = Math.min(100, Math.round((totalAssignments / 10) * 100));

                            const elementos = {
                                'total-assignments': totalAssignments,
                                'total-hours': Math.round(totalHorasSemanales / (totalAssignments || 1)) + 'h/sem',
                                'active-stores': activeStores,
                                'coverage-percentage': coverage + '%'
                            };

                            Object.entries(elementos).forEach(([id, value]) => {
                                const el = document.getElementById(id);
                                if (el) el.textContent = value;
                            });

                            actualizarGraficoDistribucion(events);
                            actualizarResumenOperativo(events);
                        }
                    };

                    processBatch();
                });
            }

            // ===== FUNCI√ìN ACTUALIZADA: GR√ÅFICO DE DISTRIBUCI√ìN =====
            function actualizarGraficoDistribucion(events) {
                const chartContainer = document.getElementById('chart-visual-container');
                if (!chartContainer) return;

                const distributionMap = {};
                events.forEach(event => {
                    const promotor = event.extendedProps?.nombre_promotor || 'Sin asignar';
                    distributionMap[promotor] = (distributionMap[promotor] || 0) + 1;
                });

                let html = '';
                const total = events.length || 1;

                Object.entries(distributionMap).forEach(([promotor, count]) => {
                    const percentage = Math.round((count / total) * 100);

                    let barClass = 'chart-bar';

                    const promotorData = promotoresData.find(p =>
                        `${p.nombre} ${p.apellido}`.trim() === promotor.trim()
                    );

                    if (promotorData && promotorData.tipo_trabajo === 'cubredescansos') {
                        barClass += ' maria-bar';
                    } else {
                        barClass += ' juan-bar';
                    }

                    html += `
                        <div class="promotor-chart-item">
                            <div class="${barClass}">
                                <span>${promotor} - ${percentage}%</span>
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No hay datos para mostrar</div>';
                }

                chartContainer.innerHTML = html;
            }

            function actualizarResumenOperativo(events) {
                const summaryContainer = document.getElementById('summary-grid');
                if (!summaryContainer) return;

                const totalPromotores = new Set(events.map(e => e.extendedProps?.id_promotor).filter(p => p)).size;
                const totalTiendas = new Set(events.map(e => e.extendedProps?.numero_tienda).filter(t => t)).size;
                const promedioAsignaciones = totalPromotores > 0 ? Math.round(events.length / totalPromotores) : 0;

                const html = `
                    <div class="summary-item">
                        <strong>Promotores Activos:</strong> ${totalPromotores} con contratos
                    </div>
                    <div class="summary-item">
                        <strong>Tiendas Cubiertas:</strong> ${totalTiendas} tiendas con cobertura
                    </div>
                    <div class="summary-item">
                        <strong>Promedio de Contratos:</strong> ${promedioAsignaciones} por promotor
                    </div>
                    <div class="summary-item">
                        <strong>Estado:</strong> ${datosAutomaticosExitosos ? 'Contratos Recurrentes Activos' : 'Sin datos'}
                    </div>
                `;

                summaryContainer.innerHTML = html;
            }

            // ===== FUNCIONES DE NAVEGACI√ìN Y CONTROLES =====
            function switchTab(tabName) {
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.classList.remove('active');
                });

                const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedTab) selectedTab.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                const targetTab = document.getElementById(`tab-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                currentTab = tabName;

                setTimeout(() => {
                    switch (tabName) {
                        case 'calendario':
                            if (calendar) calendar.updateSize();
                            break;
                        case 'asignaciones':
                            break;
                        case 'dashboard':
                            actualizarDashboard();
                            break;
                    }
                }, 100);
            }

            // ===== FUNCIONES DE MODAL =====
            function openEventModal(event = null, startDate = null, endDate = null) {
                const modal = document.getElementById('modal-evento-horas');
                if (!modal) return;

                console.log('Abriendo modal de contrato');
                currentEvent = event;

                limpiarModal();

                if (event) {
                    llenarDatosEvento(event);
                    document.getElementById('btn-eliminar-horas').style.display = 'block';
                } else {
                    document.getElementById('event-hora-entrada').value = '09:00';
                    document.getElementById('event-hora-salida').value = '19:00';
                    document.getElementById('event-hora-comida-inicio').value = '14:00';
                    document.getElementById('event-duracion-comida').value = '60';
                    document.getElementById('event-promotor-cobertura-comida').value = '';

                    if (startDate) {
                        document.getElementById('event-fecha-inicio').value = startDate.toISOString().split('T')[0];
                    }
                    document.getElementById('btn-eliminar-horas').style.display = 'none';

                    llenarPromotoresCoberturaComida(null);
                }

                actualizarResumenHorario();
                modal.style.display = 'block';
            }

            function limpiarModal() {
                document.getElementById('event-promotor-horas').value = '';
                document.getElementById('event-tienda-horas').value = '';
                document.getElementById('event-tipo-horas').value = 'fijo-principal';
                document.getElementById('event-fecha-inicio').value = '';
                document.getElementById('event-fecha-fin').value = '';
                document.getElementById('event-notas-horas').value = '';

                document.getElementById('event-hora-entrada').value = '09:00';
                document.getElementById('event-hora-salida').value = '19:00';
                document.getElementById('event-hora-comida-inicio').value = '14:00';
                document.getElementById('event-duracion-comida').value = '60';
                document.getElementById('event-promotor-cobertura-comida').value = '';

                llenarPromotoresCoberturaComida(null);
            }

            function llenarDatosEvento(event) {
                const props = event.extendedProps;

                if (props.id_promotor) {
                    document.getElementById('event-promotor-horas').value = props.id_promotor;
                    llenarPromotoresCoberturaComida(props.id_promotor);
                }
                if (props.id_tienda) {
                    document.getElementById('event-tienda-horas').value = props.id_tienda;
                }
                if (props.fecha_inicio) {
                    document.getElementById('event-fecha-inicio').value = props.fecha_inicio.split('T')[0];
                }
                if (props.fecha_fin) {
                    document.getElementById('event-fecha-fin').value = props.fecha_fin.split('T')[0];
                }
                if (props.motivo_asignacion) {
                    document.getElementById('event-notas-horas').value = props.motivo_asignacion;
                }

                if (props.hora_entrada) {
                    const horaEntrada = props.hora_entrada.substring(0, 5);
                    document.getElementById('event-hora-entrada').value = horaEntrada;
                }
                if (props.hora_salida) {
                    const horaSalida = props.hora_salida.substring(0, 5);
                    document.getElementById('event-hora-salida').value = horaSalida;
                }
                if (props.hora_comida_inicio) {
                    const horaComida = props.hora_comida_inicio.substring(0, 5);
                    document.getElementById('event-hora-comida-inicio').value = horaComida;
                }
                if (props.duracion_comida_minutos) {
                    document.getElementById('event-duracion-comida').value = props.duracion_comida_minutos;
                }
                if (props.id_promotor_cobertura_comida) {
                    document.getElementById('event-promotor-cobertura-comida').value = props.id_promotor_cobertura_comida;
                }

                actualizarResumenHorario();
            }

            function closeModal() {
                const modal = document.getElementById('modal-evento-horas');
                if (modal) modal.style.display = 'none';
                currentEvent = null;
                limpiarModal();
            }

            function limpiarCache() {
                eventCache.clear();
                console.log('üßπ Cach√© limpiada');
            }

            // ===== FUNCI√ìN PARA GUARDAR EVENTO =====
            async function guardarEvento() {
                try {
                    console.log('üíæ Iniciando guardado de evento...');

                    // Obtener valores o usar defaults
                    const promotorId = document.getElementById('event-promotor-horas')?.value || null;
                    const tiendaId = document.getElementById('event-tienda-horas')?.value || null;
                    const tipo = document.getElementById('event-tipo-horas')?.value || 'fijo-principal';
                    const notas = document.getElementById('event-notas-horas')?.value || '';
                    const fecha = document.getElementById('event-fecha-horas')?.value || new Date().toISOString().split('T')[0];

                    // Campos con valores por defecto
                    const horaEntrada = document.getElementById('event-hora-entrada')?.value || '09:00';
                    const horaSalida = document.getElementById('event-hora-salida')?.value || '19:00';
                    const horaComidaInicio = document.getElementById('event-hora-comida-inicio')?.value || '14:00';
                    const duracionComida = parseInt(document.getElementById('event-duracion-comida')?.value || '60');
                    const promotorCoberturaComida = document.getElementById('event-promotor-cobertura-comida')?.value || null;

                    const selectorTipoAsignacion = document.getElementById('assignment-type-selector');
                    const tipoAsignacion = selectorTipoAsignacion ? selectorTipoAsignacion.value : 'single';

                    // SIN VALIDACIONES - solo advertencia si faltan datos importantes
                    if (!promotorId || !tiendaId) {
                        console.warn('‚ö†Ô∏è Guardando sin promotor o tienda definidos');
                    }

                    if (tipoAsignacion === 'multiple') {
                        await guardarAsignacionMultiple(promotorId, tiendaId, tipo, notas, horaEntrada, horaSalida, horaComidaInicio, duracionComida, promotorCoberturaComida);
                    } else {
                        const promotor = promotorId ? promotoresData.find(p => p.id_promotor == promotorId) : null;
                        const tienda = tiendaId ? tiendasData.find(t => t.id_tienda == tiendaId) : null;

                        // Calcular d√≠as laborales
                        let diasSemana = [1, 2, 3, 4, 5, 6]; // Lunes a S√°bado por defecto

                        if (promotor && promotor.dia_descanso) {
                            let diaDescansoNum = -1;

                            if (typeof promotor.dia_descanso === 'number') {
                                diaDescansoNum = promotor.dia_descanso === 7 ? 0 : promotor.dia_descanso;
                            } else if (typeof promotor.dia_descanso === 'string') {
                                const diaStr = promotor.dia_descanso.trim();

                                if (/^[1-7]$/.test(diaStr)) {
                                    const diaNum = parseInt(diaStr);
                                    diaDescansoNum = diaNum === 7 ? 0 : diaNum;
                                } else {
                                    const diasSemanaTexto = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
                                    diaDescansoNum = diasSemanaTexto.indexOf(diaStr.toLowerCase());
                                }
                            }

                            if (diaDescansoNum >= 0 && diaDescansoNum <= 6) {
                                diasSemana = [0, 1, 2, 3, 4, 5, 6].filter(d => d !== diaDescansoNum);
                            }
                        }

                        const datosCompletos = {
                            id_promotor: promotorId,
                            id_tienda: tiendaId,
                            fecha_inicio: fecha,
                            dias_semana: diasSemana.join(','),
                            fecha_fin: null,
                            motivo_asignacion: notas || 'Asignaci√≥n desde calendario',
                            tipo_asignacion: tipo && tipo.includes('fijo') ? 'Principal' : 'Individual',
                            hora_entrada: horaEntrada,
                            hora_salida: horaSalida,
                            hora_comida_inicio: horaComidaInicio,
                            duracion_comida_minutos: duracionComida,
                            id_promotor_cobertura_comida: promotorCoberturaComida,
                            notas_horario: notas || 'Asignaci√≥n desde calendario de horas'
                        };

                        console.log('üì° Guardando con datos:', datosCompletos);

                        if (currentEvent && currentEvent.extendedProps && currentEvent.extendedProps.id_asignacion) {
                            await actualizarEventoExistente(currentEvent, datosCompletos);
                        } else {
                            await crearAsignacionBD(datosCompletos);

                            const asignacionesActualizadas = await cargarAsignacionesReales();
                            todosLosEventos = asignacionesActualizadas;
                            // Despu√©s de la l√≠nea: todosLosEventos = asignacionesActualizadas;
                            limpiarCache();
                            aplicarFiltroTienda();
                            actualizarDashboard();

                            if (currentTab === 'asignaciones' && tiendaSeleccionadaDetalle) {
                                setTimeout(() => {
                                    cargarVistaDetalleTienda(tiendaSeleccionadaDetalle.id_tienda);
                                }, 300);
                            }

                            alert('‚úÖ Guardado exitosamente');
                        }
                    }

                    closeModal();

                } catch (error) {
                    console.error('‚ùå Error guardando:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }

            // ===== ELIMINAR EVENTO =====
            async function eliminarEvento() {
                if (!currentEvent || !currentEvent.extendedProps.id_asignacion) {
                    alert('No se puede eliminar este evento');
                    return;
                }

                if (!confirm('¬øEst√°s seguro de que deseas eliminar esta asignaci√≥n?')) {
                    return;
                }

                try {
                    const idPromotorActual = currentEvent.extendedProps.id_promotor;

                    const response = await fetch(`${window.location.origin}/promotoria/api/hoja_horario.php?resource=asignaciones&id=${currentEvent.extendedProps.id_asignacion}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const resultado = await response.json();
                    if (!resultado.success) throw new Error(resultado.message);

                    // Eliminar de la lista local
                    todosLosEventos = todosLosEventos.filter(e => e.id !== currentEvent.id);

                    limpiarCache();
                    // Actualizar vista
                    aplicarFiltroTienda();
                    actualizarDashboard();
                    closeModal();

                    alert('‚úÖ Asignaci√≥n eliminada exitosamente');
                    console.log('‚úÖ Evento eliminado correctamente');

                    // Si estamos en la pesta√±a de filtros tienda, recargar la vista
                    if (currentTab === 'asignaciones' && tiendaSeleccionadaDetalle) {
                        setTimeout(() => {
                            cargarVistaDetalleTienda(tiendaSeleccionadaDetalle.id_tienda);
                        }, 300);
                    }

                } catch (error) {
                    console.error('‚ùå Error eliminando evento:', error);
                    alert('Error eliminando el evento: ' + error.message);
                }
            }

            function configurarEventListenersModal() {
                const btnGuardar = document.getElementById('btn-guardar-horas');
                if (btnGuardar) {
                    btnGuardar.replaceWith(btnGuardar.cloneNode(true));
                    const newBtnGuardar = document.getElementById('btn-guardar-horas');
                    newBtnGuardar.addEventListener('click', guardarEvento);
                }

                const btnCancelar = document.getElementById('btn-cancelar-horas');
                if (btnCancelar) {
                    btnCancelar.replaceWith(btnCancelar.cloneNode(true));
                    const newBtnCancelar = document.getElementById('btn-cancelar-horas');
                    newBtnCancelar.addEventListener('click', closeModal);
                }

                const btnEliminar = document.getElementById('btn-eliminar-horas');
                if (btnEliminar) {
                    btnEliminar.replaceWith(btnEliminar.cloneNode(true));
                    const newBtnEliminar = document.getElementById('btn-eliminar-horas');
                    newBtnEliminar.addEventListener('click', eliminarEvento);
                }

                const btnCerrar = document.querySelector('.close-horas');
                if (btnCerrar) {
                    btnCerrar.replaceWith(btnCerrar.cloneNode(true));
                    const newBtnCerrar = document.querySelector('.close-horas');
                    newBtnCerrar.addEventListener('click', closeModal);
                }

                const horaEntrada = document.getElementById('event-hora-entrada');
                const horaSalida = document.getElementById('event-hora-salida');
                const duracionComida = document.getElementById('event-duracion-comida');

                if (horaEntrada) horaEntrada.addEventListener('change', actualizarResumenHorario);
                if (horaSalida) horaSalida.addEventListener('change', actualizarResumenHorario);
                if (duracionComida) duracionComida.addEventListener('change', actualizarResumenHorario);

                const promotorSelect = document.getElementById('event-promotor-horas');
                if (promotorSelect) {
                    promotorSelect.addEventListener('change', function () {
                        llenarPromotoresCoberturaComida(this.value);
                    });
                }
            }

            // ===== EVENT LISTENERS =====
            function initializeEventListeners() {
                document.querySelectorAll('.tab-item').forEach(tab => {
                    addListener(tab, 'click', function () {
                        switchTab(this.dataset.tab);
                    });
                });

                const btnNueva = document.getElementById('btn-nueva-asignacion');
                if (btnNueva) addListener(btnNueva, 'click', () => openEventModal());

                const btnGenerar = document.getElementById('btn-generar-horarios');
                if (btnGenerar) {
                    addListener(btnGenerar, 'click', () => {
                        aplicarFiltroTienda();
                        actualizarDashboard();
                        alert(`‚úÖ Vista actualizada\n\nüìÖ Mostrando contratos hasta: ${new Date().toLocaleDateString('es-ES')}\nüìä Total visible: ${calendar.getEvents().length} eventos`);
                    });
                }

                const btnDashboard = document.getElementById('btn-dashboard-horas');
                if (btnDashboard) addListener(btnDashboard, 'click', () => switchTab('dashboard'));

                document.querySelectorAll('.view-btn').forEach(btn => {
                    addListener(btn, 'click', function () {
                        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        if (calendar) calendar.changeView(this.dataset.view);
                    });
                });

                addListener(window, 'click', function (event) {
                    const modal = document.getElementById('modal-evento-horas');
                    if (event.target === modal) closeModal();
                });

                // Cerrar tooltip en scroll o resize
                addListener(window, 'scroll', eliminarTooltip, { passive: true });
                addListener(window, 'resize', eliminarTooltip);

                configurarEventListenersModal();
            }

            // ===== FUNCIONES GLOBALES PARA COMPATIBILIDAD =====
            window.generarReporte = function () {
                const reportOutput = document.getElementById('report-output');
                if (!reportOutput) return;

                const events = todosLosEventos || [];
                const totalHoras = events.length * 8;

                const reportContent = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-color);">Reporte del Sistema de Contratos Recurrentes</h2>
                        <p style="color: ${datosAutomaticosExitosos ? 'var(--success-color)' : 'var(--warning-color)'};">
                            ${datosAutomaticosExitosos ? 'Datos desde BD' : 'Sin datos'}
                        </p>
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid var(--border-color);">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #1976d2;">Contratos Activos</h4>
                            <div style="font-size: 2rem; font-weight: bold;">${events.length}</div>
                            <small>Con recurrencia semanal</small>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: var(--success-color);">Horas Programadas</h4>
                            <div style="font-size: 2rem; font-weight: bold;">${totalHoras}h</div>
                            <small>Incluye horarios configurados</small>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: var(--warning-color);">Sistema</h4>
                            <div style="font-size: 1.2rem; font-weight: bold;">${datosAutomaticosExitosos ? 'ACTIVO' : 'SIN DATOS'}</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <h3 style="color: var(--success-color);">Sistema de Contratos Recurrentes Completo</h3>
                        <ul style="line-height: 1.8;">
                            <li>Calendario con eventos recurrentes semanales</li>
                            <li>Vista detallada por tienda con semana actual</li>
                            <li>Horarios laborales configurables</li>
                            <li>Tooltips informativos mejorados</li>
                            <li>Dashboard con m√©tricas en tiempo real</li>
                            <li>Respeto autom√°tico de d√≠as de descanso</li>
                            <li>Contratos indefinidos o con fecha de fin</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                        <small>
                            ${new Date().toLocaleString('es-ES')}<br>
                            SISTEMA RECURRENTE COMPLETO INTEGRADO
                        </small>
                    </div>
                `;

                reportOutput.innerHTML = reportContent;
            };

            // ===== INICIALIZACI√ìN DEL M√ìDULO PRINCIPAL =====
            async function initModule() {
                try {
                    console.log('INICIANDO SISTEMA RECURRENTE COMPLETO');

                    elements.dependenciesLoading.style.display = 'flex';
                    elements.mainContentHoras.style.display = 'none';
                    elements.errorState.style.display = 'none';

                    await loadFullCalendarDependencies();

                    updateLoadingProgress('Cargando todos los datos autom√°ticamente...');

                    let eventosRecurrentes = [];

                    const promesasCarga = [
                        cargarPromotoresReales().catch(err => []),
                        cargarTiendasReales().catch(err => []),
                        cargarAsignacionesReales().catch(err => [])
                    ];

                    const [promotoresResult, tiendasResult, asignacionesResult] = await Promise.all(promesasCarga);

                    if (promotoresResult.length > 0) promotoresData = promotoresResult;
                    if (tiendasResult.length > 0) tiendasData = tiendasResult;
                    if (asignacionesResult.length > 0) eventosRecurrentes = asignacionesResult;

                    datosAutomaticosExitosos = eventosRecurrentes.length > 0;

                    llenarSelectsModal();
                    await initializeCalendar(eventosRecurrentes);

                    elements.dependenciesLoading.style.display = 'none';
                    elements.mainContentHoras.style.display = 'block';

                    // AGREGAR ESTA L√çNEA INMEDIATAMENTE DESPU√âS:
                    iniciarActualizacionDiaria();

                    initializeEventListeners();

                    setTimeout(() => {
                        actualizarDashboard();
                        switchTab('calendario');

                        // APLICAR FILTRO DE FECHA AL CARGAR POR PRIMERA VEZ
                        aplicarFiltroTienda();

                        console.log('INICIALIZACI√ìN COMPLETADA');
                    }, 200);;

                } catch (error) {
                    console.error('ERROR CR√çTICO EN INICIALIZACI√ìN:', error);
                    showError(`Error cr√≠tico cargando el m√≥dulo: ${error.message}`);
                }
            }

            function showError(message) {
                elements.dependenciesLoading.style.display = 'none';
                elements.mainContentHoras.style.display = 'none';
                elements.errorState.style.display = 'flex';
                if (elements.errorMessage) elements.errorMessage.textContent = message;
            }

            // ===== INICIAR M√ìDULO =====
            initModule();

        })();
    </script>

</body>

</html>