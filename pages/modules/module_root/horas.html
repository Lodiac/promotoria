<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hojas de Horas - Sistema Interactivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <!-- ===== M√ìDULO HOJAS DE HORAS CON FULLCALENDAR SPA CORREGIDO ===== -->
    <div class="horas-module">
        <!-- HEADER DEL M√ìDULO -->
        <div class="module-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-calendar-alt header-icon"></i>
                    <h1>Hojas de Horas - Sistema Interactivo</h1>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" id="btn-dashboard-horas">
                        <i class="fas fa-chart-pie"></i> Dashboard
                    </button>
                    <button class="btn-primary" id="btn-nueva-asignacion">
                        <i class="fas fa-plus"></i> Nueva Asignaci√≥n
                    </button>
                    <button class="btn-primary" id="btn-generar-horarios">
                        <i class="fas fa-sync-alt"></i> Generar Horarios Adicionales
                    </button>
                </div>
            </div>
        </div>
        <br>
        <!-- NAVEGACI√ìN POR PESTA√ëAS -->
        <div class="tabs-navigation">
            <div class="tab-item active" data-tab="calendario">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendario</span>
            </div>
            <div class="tab-item" data-tab="asignaciones">
                <i class="fas fa-list"></i>
                <span>Asignaciones</span>
            </div>
            <div class="tab-item" data-tab="dashboard">
                <i class="fas fa-chart-pie"></i>
                <span>Dashboard</span>
            </div>
            <div class="tab-item" data-tab="reportes">
                <i class="fas fa-file-alt"></i>
                <span>Reportes</span>
            </div>
        </div>

        <!-- LOADING DEPENDENCIES -->
        <div class="dependencies-loading" id="dependencies-loading">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <h3>Cargando datos autom√°ticamente...</h3>
                <p id="loading-progress">Conectando con base de datos...</p>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL - CONTAINER PARA TODAS LAS PESTA√ëAS -->
        <div class="main-content" id="main-content-horas" style="display: none;">

            <!-- PESTA√ëA CALENDARIO -->
            <div class="tab-content active" id="tab-calendario">
                <!-- SIDEBAR DE RELACIONES CON BOT√ìN TOGGLE -->
                <div class="relationships-sidebar" id="relationships-sidebar">
                    <!-- PROMOTOR FIJO -->
                    <div class="promotor-card promotor-fijo">
                        <div class="promotor-header">
                            <i class="fas fa-user-tie"></i>
                            PROMOTOR FIJO
                        </div>
                        <div class="promotor-info" id="promotor-fijo-info">
                            <div class="promotor-name">Cargando...</div>
                            <div class="promotor-details">Obteniendo datos...</div>

                            <div class="tienda-principal">
                                <div class="tienda-principal-label">TIENDA PRINCIPAL</div>
                                <div class="tienda-principal-name">Cargando...</div>
                                <div style="font-size: 0.8rem; color: #666;">Obteniendo ubicaci√≥n...</div>
                            </div>
                        </div>
                    </div>

                    <!-- PROMOTOR CUBREDESCANSOS -->
                    <div class="promotor-card promotor-cubredescansos">
                        <div class="promotor-header">
                            <i class="fas fa-user-plus"></i>
                            CUBREDESCANSOS
                        </div>
                        <div class="promotor-info" id="promotor-cubredescansos-info">
                            <div class="promotor-name">Cargando...</div>
                            <div class="promotor-details">Obteniendo datos...</div>

                            <div class="tienda-principal" style="background: #fff3e0;">
                                <div class="tienda-principal-label" style="color: #f57c00;">ASIGNACI√ìN PRINCIPAL</div>
                                <div class="tienda-principal-name">Apoyo y rotaci√≥n</div>
                                <div style="font-size: 0.8rem; color: #666;">M√∫ltiples tiendas</div>
                            </div>
                        </div>
                    </div>

                    <!-- BOT√ìN TOGGLE SIDEBAR EN LA PARTE INFERIOR -->
                    <div class="sidebar-toggle-container">
                        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" onclick="toggleSidebar()">
                            <i class="fas fa-chevron-left" id="toggle-icon"></i>
                            <span class="toggle-text" id="toggle-text">Ocultar men√∫</span>
                        </button>
                    </div>
                </div>

                <!-- BOT√ìN FLOTANTE PARA ABRIR SIDEBAR CUANDO EST√Å OCULTO -->
                <div class="sidebar-floating-btn" id="sidebar-floating-btn" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-right"></i>
                    <span class="floating-text">Abrir men√∫</span>
                </div>

                <!-- √ÅREA DEL CALENDARIO -->
                <div class="calendar-area">
                    <div class="calendar-header">
                        <div class="calendar-title">
                            <i class="fas fa-calendar-alt"></i>
                            Calendario de Asignaciones
                        </div>
                        <div class="calendar-controls">
                            <button class="view-btn active" data-view="dayGridMonth">Mes</button>
                            <button class="view-btn" data-view="timeGridWeek">Semana</button>
                            <button class="view-btn" data-view="timeGridDay">D√≠a</button>
                            <button class="view-btn" data-view="listWeek">Lista</button>

                            <!-- NUEVO: Filtro de tienda -->
                            <div class="store-filter-container">
                                <select id="calendar-store-filter" class="store-filter-select">
                                    <option value="">üè™ Todas las tiendas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div id="calendar-horas"></div>

                        <!-- LEYENDA -->
                        <div class="legend">
                            <div class="legend-title">Leyenda de Asignaciones</div>
                            <div class="legend-grid">
                                <div class="legend-item">
                                    <div class="legend-color"
                                        style="background: linear-gradient(135deg, #1976d2, #1565c0);"></div>
                                    <span>Promotor Fijo - Tienda Principal</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color"
                                        style="background: linear-gradient(135deg, #7b1fa2, #6a1b9a);"></div>
                                    <span>Promotor Fijo - Rotaci√≥n</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color"
                                        style="background: linear-gradient(135deg, #f57c00, #ef6c00);"></div>
                                    <span>Cubredescansos - Apoyo</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color"
                                        style="background: linear-gradient(135deg, #388e3c, #2e7d32);"></div>
                                    <span>Cubredescansos - Otras</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #f5f5f5; border: 1px solid #ccc;">
                                    </div>
                                    <span>D√≠as de descanso</span>
                                </div>
                            </div>

                            <!-- LEYENDA TEMPORAL (SOLO PASADO Y PRESENTE) -->
                            <div class="temporal-legend">
                                <div class="legend-title"
                                    style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                    Indicadores Temporales
                                </div>
                                <div class="legend-grid">
                                    <div class="legend-item">
                                        <div class="legend-color"
                                            style="background: linear-gradient(135deg, #9e9e9e, #757575); opacity: 0.6;">
                                        </div>
                                        <span>‚èÆÔ∏è Historial (ya trabaj√≥)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color"
                                            style="background: linear-gradient(135deg, #4CAF50, #2e7d32); box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);">
                                        </div>
                                        <span>‚ñ∂Ô∏è Trabajando hoy</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA ASIGNACIONES -->
            <div class="tab-content" id="tab-asignaciones">
                <div class="tab-section">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Gesti√≥n de Asignaciones por Promotor</h2>
                        <p>Administra todas las asignaciones agrupadas por promotor</p>
                    </div>

                    <div class="filters-bar">
                        <div class="filter-group">
                            <label>Promotor:</label>
                            <select id="filter-promotor" class="form-select">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Tienda:</label>
                            <select id="filter-tienda" class="form-select">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Periodo:</label>
                            <select id="filter-periodo" class="form-select">
                                <option value="semana">Esta semana</option>
                                <option value="mes">Este mes</option>
                                <option value="trimestre">Trimestre</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="actualizarListaAsignaciones()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>

                    <div class="assignments-list" id="assignments-list">
                        <!-- Las asignaciones se cargan din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA DASHBOARD -->
            <div class="tab-content" id="tab-dashboard">
                <div class="tab-section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-pie"></i> Dashboard Operativo</h2>
                        <p>M√©tricas y an√°lisis en tiempo real</p>
                    </div>

                    <div class="dashboard-grid">
                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--primary-color);">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="total-assignments">0</div>
                                <div class="metric-label">Asignaciones Total</div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--success-color);">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="coverage-percentage">0%</div>
                                <div class="metric-label">Cobertura Efectiva</div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--warning-color);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="total-hours">0h</div>
                                <div class="metric-label">Horas Programadas</div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--info-color);">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="active-stores">0</div>
                                <div class="metric-label">Tiendas Activas</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <h3>Distribuci√≥n por Promotor</h3>
                        <div class="chart-placeholder">
                            <div class="chart-visual" id="chart-visual-container">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="summary-section">
                        <h3>Resumen Operativo</h3>
                        <div class="summary-grid" id="summary-grid">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA REPORTES -->
            <div class="tab-content" id="tab-reportes">
                <div class="tab-section">
                    <div class="section-header">
                        <h2><i class="fas fa-file-alt"></i> Centro de Reportes</h2>
                        <p>Genera y consulta reportes detallados</p>
                    </div>

                    <div class="report-controls">
                        <div class="control-group">
                            <label>Tipo de Reporte:</label>
                            <select id="report-type" class="form-select">
                                <option value="general">Reporte General</option>
                                <option value="promotor">Por Promotor</option>
                                <option value="tienda">Por Tienda</option>
                                <option value="horario">An√°lisis de Horarios</option>
                                <option value="cobertura">An√°lisis de Cobertura</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Periodo:</label>
                            <select id="report-period" class="form-select">
                                <option value="semana">√öltima Semana</option>
                                <option value="mes">√öltimo Mes</option>
                                <option value="trimestre">√öltimo Trimestre</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Formato:</label>
                            <select id="report-format" class="form-select">
                                <option value="html">Ver en pantalla</option>
                                <option value="pdf">Exportar PDF</option>
                                <option value="excel">Exportar Excel</option>
                                <option value="csv">Exportar CSV</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="generarReporte()">
                            <i class="fas fa-chart-line"></i> Generar Reporte
                        </button>
                    </div>

                    <div class="report-output" id="report-output">
                        <div class="report-placeholder">
                            <i class="fas fa-file-alt" style="font-size: 3rem; color: #ccc;"></i>
                            <h3>Selecciona los par√°metros y genera tu reporte</h3>
                            <p>Los reportes aparecer√°n aqu√≠ una vez generados</p>
                        </div>
                    </div>

                    <div class="reports-history">
                        <h3>Reportes Recientes</h3>
                        <div class="history-list">
                            <div class="history-item">
                                <i class="fas fa-file-pdf"></i>
                                <span>Reporte General - Septiembre 2025.pdf</span>
                                <small>Generado hace 2 horas</small>
                            </div>
                            <div class="history-item">
                                <i class="fas fa-file-excel"></i>
                                <span>An√°lisis Promotores - Agosto 2025.xlsx</span>
                                <small>Generado hace 1 d√≠a</small>
                            </div>
                            <div class="history-item">
                                <i class="fas fa-file-csv"></i>
                                <span>Cobertura Tiendas - Q3 2025.csv</span>
                                <small>Generado hace 3 d√≠as</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ERROR STATE -->
        <div class="error-state" id="error-state" style="display: none;">
            <div class="error-container">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error cargando datos</h3>
                <p id="error-message">No se pudieron cargar los datos desde la base de datos.</p>
                <button class="btn-primary" onclick="location.reload()">
                    <i class="fas fa-redo"></i> Reintentar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EVENTO MEJORADO -->
    <div id="modal-evento-horas" class="modal-horas">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalles de Asignaci√≥n</h2>
                <button class="close-horas">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Promotor:</label>
                    <select class="form-select" id="event-promotor-horas">
                        <option value="">Seleccionar promotor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tienda:</label>
                    <select class="form-select" id="event-tienda-horas">
                        <option value="">Seleccionar tienda...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Asignaci√≥n:</label>
                    <select class="form-select" id="event-tipo-horas">
                        <option value="fijo-principal">Principal (Fijo)</option>
                        <option value="fijo-rotacion">Rotaci√≥n (Fijo)</option>
                        <option value="cubredescansos-apoyo">Apoyo Directo</option>
                        <option value="cubredescansos-otros">Otras Asignaciones</option>
                        <option value="descanso">D√≠a de Descanso</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Horario:</label>
                    <select class="form-select" id="event-horario-horas">
                        <option value="6-14">Matutino (6:00 - 14:00)</option>
                        <option value="14-22">Vespertino (14:00 - 22:00)</option>
                        <option value="22-6">Nocturno (22:00 - 6:00)</option>
                    </select>
                </div>

                <!-- SELECTOR DE TIPO DE ASIGNACI√ìN MEJORADO -->
                <div class="form-group">
                    <label class="form-label">Modalidad de Asignaci√≥n:</label>
                    <select class="form-select" id="assignment-type-selector">
                        <option value="single">Asignaci√≥n Individual (Una fecha espec√≠fica)</option>
                        <option value="multiple">Asignaci√≥n M√∫ltiple (Varios d√≠as en rango)</option>
                    </select>
                </div>

                <!-- ASIGNACI√ìN INDIVIDUAL -->
                <div class="form-group" id="single-date-group">
                    <label class="form-label">Fecha:</label>
                    <input type="date" class="form-input" id="event-fecha-horas">
                </div>

                <!-- ASIGNACI√ìN M√öLTIPLE -->
                <div id="multiple-assignment-group" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Rango de Fechas:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label
                                    style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; display: block;">Fecha
                                    inicio:</label>
                                <input type="date" class="form-input" id="fecha-inicio-multiple">
                            </div>
                            <div>
                                <label
                                    style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; display: block;">Fecha
                                    fin:</label>
                                <input type="date" class="form-input" id="fecha-fin-multiple">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">D√≠as de la Semana:</label>
                        <div id="days-selector"
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer;">
                                <input type="checkbox" value="1" style="margin: 0;"> Lunes
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer;">
                                <input type="checkbox" value="2" style="margin: 0;"> Martes
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer;">
                                <input type="checkbox" value="3" style="margin: 0;"> Mi√©rcoles
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer;">
                                <input type="checkbox" value="4" style="margin: 0;"> Jueves
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer;">
                                <input type="checkbox" value="5" style="margin: 0;"> Viernes
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer;">
                                <input type="checkbox" value="6" style="margin: 0;"> S√°bado
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; grid-column: span 2;">
                                <input type="checkbox" value="0" style="margin: 0;"> Domingo
                            </label>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button type="button" id="select-all-days" class="btn-day-selector">
                                <i class="fas fa-check-double"></i> Todos
                            </button>
                            <button type="button" id="select-weekdays" class="btn-day-selector">
                                <i class="fas fa-briefcase"></i> L-V
                            </button>
                            <button type="button" id="select-weekend" class="btn-day-selector">
                                <i class="fas fa-calendar-weekend"></i> Fin de semana
                            </button>
                            <button type="button" id="clear-days" class="btn-day-selector btn-clear">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="multiple-info-box">
                            <div class="info-header">
                                <i class="fas fa-info-circle"></i>
                                <strong>Asignaci√≥n M√∫ltiple</strong>
                            </div>
                            <p class="info-text">
                                Se crear√° una asignaci√≥n individual para cada d√≠a seleccionado dentro del rango de
                                fechas.
                                <br><strong>Ejemplo:</strong> Si seleccionas Lunes-Viernes del 1 al 31, se crear√°n
                                asignaciones solo para esos d√≠as espec√≠ficos.
                            </p>
                            <div class="preview-container" id="assignment-preview" style="display: none;">
                                <div class="preview-title">Vista previa:</div>
                                <div class="preview-content" id="preview-dates"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notas:</label>
                    <input type="text" class="form-input" id="event-notas-horas" placeholder="Notas adicionales...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel-horas" id="btn-cancelar-horas">Cancelar</button>
                <button class="btn-primary" id="btn-guardar-horas">Guardar</button>
                <button class="btn-primary" id="btn-eliminar-horas"
                    style="background: #f44336; display: none;">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ASIGNAR TIENDA -->
    <div id="modal-asignar-tienda" class="modal-horas">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Asignar Nueva Tienda</h2>
                <button class="close-horas" onclick="cerrarModalAsignarTienda()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="promotor-selected-info" id="promotor-selected-info">
                    <!-- Se llena din√°micamente -->
                </div>
                <div class="form-group">
                    <label class="form-label">Tienda a asignar:</label>
                    <select class="form-select" id="nueva-tienda-select">
                        <option value="">Seleccionar tienda disponible...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de inicio:</label>
                    <input type="date" class="form-input" id="nueva-fecha-inicio">
                </div>
                <div class="form-group">
                    <label class="form-label">Motivo de asignaci√≥n:</label>
                    <input type="text" class="form-input" id="nuevo-motivo"
                        placeholder="Describe el motivo de la asignaci√≥n...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel-horas" onclick="cerrarModalAsignarTienda()">Cancelar</button>
                <button class="btn-primary" onclick="confirmarAsignarTienda()">
                    <i class="fas fa-plus"></i> Asignar Tienda
                </button>
            </div>
        </div>
    </div>

    <style>
        /* ===== VARIABLES CSS ===== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196F3;
            --background: #f5f7fa;
            --surface: rgba(255, 255, 255, 0.95);
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e0e0e0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        /* ===== RESET Y BASE ===== */
        .horas-module * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .horas-module {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ===== HEADER STYLES ===== */
        .horas-module .module-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px 0;
            box-shadow: var(--shadow);
        }

        .horas-module .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .horas-module .header-title {
            display: flex;
            align-items: center;
            color: white;
        }

        .horas-module .header-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .horas-module .header-title h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .horas-module .header-actions {
            display: flex;
            gap: 15px;
        }

        .horas-module .btn-primary,
        .horas-module .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .horas-module .btn-primary {
            background-color: var(--success-color);
            color: white;
        }

        .horas-module .btn-primary:hover:not(:disabled) {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .horas-module .btn-secondary {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .horas-module .btn-secondary:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .horas-module .btn-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* ===== ESTILOS PARA BOTONES DE SELECCI√ìN DE D√çAS ===== */
        .horas-module .btn-day-selector {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            color: white;
        }

        .horas-module .btn-day-selector:nth-child(1) {
            background: var(--info-color);
        }

        .horas-module .btn-day-selector:nth-child(2) {
            background: var(--success-color);
        }

        .horas-module .btn-day-selector:nth-child(3) {
            background: var(--warning-color);
        }

        .horas-module .btn-day-selector.btn-clear {
            background: var(--danger-color);
        }

        .horas-module .btn-day-selector:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ===== ESTILOS PARA LA CAJA DE INFORMACI√ìN M√öLTIPLE ===== */
        .horas-module .multiple-info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
            margin: 10px 0;
        }

        .horas-module .info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--info-color);
            font-weight: 600;
        }

        .horas-module .info-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin: 0;
        }

        .horas-module .preview-container {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .horas-module .preview-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 6px;
        }

        .horas-module .preview-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.3;
        }

        /* ===== NAVEGACI√ìN POR PESTA√ëAS ===== */
        .horas-module .tabs-navigation {
            background: var(--surface);
            border-radius: 0;
            padding: 0;
            margin: 0;
            box-shadow: var(--shadow);
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
        }

        .horas-module .tab-item {
            flex: 1;
            padding: 16px 20px;
            background: #f8f9fa;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
        }

        .horas-module .tab-item:hover {
            background: #e9ecef;
            color: var(--primary-color);
        }

        .horas-module .tab-item.active {
            background: var(--primary-color);
            color: white;
            border-bottom-color: var(--secondary-color);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .horas-module .tab-item i {
            font-size: 1.1rem;
        }

        /* ===== SISTEMA DE PESTA√ëAS CORREGIDO ===== */
        .horas-module .main-content {
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
        }

        /* IMPORTANTE: Cada pesta√±a debe ocupar todo el espacio disponible */
        .horas-module .tab-content {
            display: none !important;
            width: 100%;
            min-height: 500px;
            animation: fadeInTab 0.3s ease;
        }

        .horas-module .tab-content.active {
            display: block !important;
        }

        @keyframes fadeInTab {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== PESTA√ëA CALENDARIO - GRID LAYOUT CORREGIDO ===== */
        .horas-module #tab-calendario {
            display: none;
            padding: 30px 20px;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }

        .horas-module #tab-calendario.active {
            display: grid !important;
        }

        .horas-module .relationships-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            position: relative;
            width: 350px;
            min-width: 350px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
            opacity: 1;
            overflow: hidden;
        }

        .horas-module .calendar-area {
            width: 100%;
        }

        /* ===== OTRAS PESTA√ëAS - PADDING CONSISTENTE ===== */
        .horas-module .tab-section {
            padding: 30px 20px;
            width: 100%;
        }

        .horas-module .section-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .horas-module .section-header h2 {
            font-size: 1.8rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .horas-module .section-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* ===== LOADING DEPENDENCIES ===== */
        .horas-module .dependencies-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 40px;
        }

        .horas-module .loading-container {
            text-align: center;
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .horas-module .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .horas-module .loading-container h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .horas-module .loading-container p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* ===== ERROR STATE ===== */
        .horas-module .error-state {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 40px;
        }

        .horas-module .error-container {
            text-align: center;
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            border: 2px solid var(--danger-color);
        }

        .horas-module .error-container i {
            font-size: 4rem;
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .horas-module .error-container h3 {
            color: var(--danger-color);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .horas-module .error-container p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* ===== PROMOTOR CARDS ===== */
        .horas-module .promotor-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .horas-module .promotor-header {
            padding: 20px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .horas-module .promotor-fijo .promotor-header {
            background: linear-gradient(135deg, #1976d2, #1565c0);
        }

        .horas-module .promotor-cubredescansos .promotor-header {
            background: linear-gradient(135deg, #f57c00, #ef6c00);
        }

        .horas-module .promotor-info {
            padding: 20px;
        }

        .horas-module .promotor-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .horas-module .promotor-details {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .horas-module .tienda-principal {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .horas-module .tienda-principal-label {
            font-size: 0.8rem;
            color: #1976d2;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .horas-module .tienda-principal-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ===== ESTILOS PARA SIDEBAR COLAPSIBLE ===== */

        /* Estado colapsado del sidebar */
        .horas-module .relationships-sidebar.collapsed {
            width: 0;
            min-width: 0;
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        /* Container del bot√≥n toggle en la parte inferior del sidebar */
        .horas-module .sidebar-toggle-container {
            margin-top: 20px;
            padding: 0;
        }

        /* Bot√≥n para ocultar/mostrar sidebar */
        .horas-module .sidebar-toggle-btn {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow);
            font-size: 0.9rem;
        }

        .horas-module .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .horas-module .sidebar-toggle-btn:active {
            transform: translateY(0);
        }

        /* Icono del bot√≥n toggle */
        .horas-module .sidebar-toggle-btn i {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        /* Texto del bot√≥n toggle */
        .horas-module .toggle-text {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Bot√≥n flotante que aparece cuando el sidebar est√° oculto */
        .horas-module .sidebar-floating-btn {
            position: fixed;
            left: -60px;
            bottom: 100px;
            width: 160px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 0 25px 25px 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            gap: 10px;
            box-shadow: 2px 4px 15px rgba(102, 126, 234, 0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            font-size: 0.9rem;
        }

        /* Estado visible del bot√≥n flotante */
        .horas-module .sidebar-floating-btn.visible {
            left: 0;
            opacity: 1;
            pointer-events: all;
        }

        .horas-module .sidebar-floating-btn:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateX(10px);
            box-shadow: 2px 8px 25px rgba(102, 126, 234, 0.4);
        }

        .horas-module .sidebar-floating-btn i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .horas-module .sidebar-floating-btn:hover i {
            transform: translateX(3px);
        }

        /* Texto del bot√≥n flotante */
        .horas-module .floating-text {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Ajustar el √°rea del calendario cuando el sidebar est√° colapsado */
        .horas-module #tab-calendario {
            transition: grid-template-columns 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .horas-module #tab-calendario.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        /* Ajustar el calendario para que ocupe todo el espacio */
        .horas-module .calendar-area {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .horas-module #tab-calendario.sidebar-collapsed .calendar-area {
            margin-left: 0;
        }

        /* Efecto de pulse sutil para llamar la atenci√≥n al bot√≥n flotante */
        .horas-module .sidebar-floating-btn.visible {
            animation: subtle-pulse 3s infinite;
        }

        @keyframes subtle-pulse {

            0%,
            100% {
                box-shadow: 2px 4px 15px rgba(102, 126, 234, 0.3);
            }

            50% {
                box-shadow: 2px 4px 20px rgba(102, 126, 234, 0.5);
            }
        }

        /* Prevenir overflow cuando el sidebar se est√° colapsando */
        .horas-module #tab-calendario {
            overflow: hidden;
        }

        /* ===== NUEVOS ESTILOS PARA CARDS AGRUPADOS ===== */
        .horas-module .promotor-assignment-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .horas-module .promotor-assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .horas-module .promotor-header-card {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .horas-module .promotor-header-card:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }

        .horas-module .promotor-info-main {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .horas-module .promotor-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .horas-module .promotor-details-card h3 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .horas-module .promotor-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .horas-module .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .horas-module .tipo-fijo {
            color: #1976d2;
            font-weight: 600;
        }

        .horas-module .tipo-cubredescansos {
            color: #f57c00;
            font-weight: 600;
        }

        .horas-module .promotor-contact {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .horas-module .expand-indicator {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .horas-module .promotor-assignment-card.expanded .expand-indicator {
            transform: rotate(180deg);
        }

        .horas-module .promotor-asignaciones-detalle {
            padding: 0;
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
        }

        .horas-module .seccion-tiendas-asignadas,
        .horas-module .seccion-tiendas-disponibles {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .horas-module .seccion-tiendas-asignadas h4,
        .horas-module .seccion-tiendas-disponibles h4 {
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .horas-module .seccion-tiendas-asignadas h4 i {
            color: var(--success-color);
        }

        .horas-module .seccion-tiendas-disponibles h4 i {
            color: var(--info-color);
        }

        .horas-module .tiendas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .horas-module .tienda-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .horas-module .tienda-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .horas-module .tienda-asignada {
            border-left: 4px solid var(--success-color);
        }

        .horas-module .tienda-disponible {
            border-left: 4px solid var(--info-color);
        }

        .horas-module .tienda-info h5 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .horas-module .tienda-info small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .horas-module .tienda-actions {
            display: flex;
            gap: 8px;
        }

        .horas-module .btn-tienda {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .horas-module .btn-asignar {
            background: var(--success-color);
            color: white;
        }

        .horas-module .btn-asignar:hover {
            background: #45a049;
        }

        .horas-module .btn-desasignar {
            background: var(--danger-color);
            color: white;
        }

        .horas-module .btn-desasignar:hover {
            background: #d32f2f;
        }

        .horas-module .acciones-promotor {
            padding: 20px;
            background: white;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* ===== MODAL ASIGNAR TIENDA ===== */
        .horas-module .promotor-selected-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }

        .horas-module .promotor-selected-info h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
        }

        .horas-module .promotor-selected-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* ===== RELATIONSHIP INDICATOR ===== */
        .horas-module .relationship-indicator {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .horas-module .relationship-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .horas-module .relationship-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .horas-module .promotor-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .horas-module .fijo-icon {
            background: linear-gradient(135deg, #1976d2, #1565c0);
        }

        .horas-module .cubredescansos-icon {
            background: linear-gradient(135deg, #f57c00, #ef6c00);
        }

        .horas-module .arrow {
            font-size: 2rem;
            color: var(--success-color);
        }

        /* ===== CALENDAR AREA ===== */
        .horas-module .calendar-area {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .horas-module .calendar-header {
            background: linear-gradient(135deg, #26c6da, #00acc1);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .horas-module .calendar-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .horas-module .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .horas-module .view-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .horas-module .view-btn.active {
            background: rgba(255, 255, 255, 0.4);
        }

        .horas-module .view-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ===== NUEVO: FILTRO DE TIENDA EN CALENDARIO ===== */
        .horas-module .store-filter-container {
            margin-left: 15px;
            min-width: 250px;
        }

        .horas-module .store-filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .horas-module .store-filter-select:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .horas-module .store-filter-select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
        }

        .horas-module .store-filter-select option {
            background: #26c6da;
            color: white;
            padding: 10px;
        }

        /* ===== COLORES SEG√öN PER√çODO TEMPORAL (SOLO PASADO Y PRESENTE) ===== */
        .horas-module .event-past {
            opacity: 0.6 !important;
            background: linear-gradient(135deg, #9e9e9e, #757575) !important;
            border-left: 4px solid #616161 !important;
        }

        .horas-module .event-present {
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5) !important;
            animation: pulse-present 2s infinite !important;
        }

        @keyframes pulse-present {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
            }
        }

        /* ===== LEYENDA TEMPORAL ===== */
        .horas-module .temporal-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        /* ===== CALENDAR CONTAINER ===== */
        .horas-module .calendar-container {
            padding: 20px;
        }

        .horas-module #calendar-horas {
            height: 700px;
        }

        /* ===== FILTROS Y CONTROLES ===== */
        .horas-module .filters-bar {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .horas-module .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .horas-module .filter-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* ===== LISTA DE ASIGNACIONES ===== */
        .horas-module .assignments-list {
            display: grid;
            gap: 15px;
        }

        .horas-module .assignment-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .horas-module .assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        /* ===== DASHBOARD ===== */
        .horas-module .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .horas-module .metric-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .horas-module .metric-card:hover {
            transform: translateY(-3px);
        }

        .horas-module .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .horas-module .metric-content {
            flex: 1;
        }

        .horas-module .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .horas-module .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .horas-module .chart-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .horas-module .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .horas-module .chart-visual {
            width: 100%;
            max-width: 400px;
        }

        .horas-module .promotor-chart-item {
            margin-bottom: 15px;
        }

        .horas-module .chart-bar {
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            color: white;
            font-weight: 600;
            transition: width 0.8s ease;
        }

        .horas-module .juan-bar {
            background: linear-gradient(135deg, #1976d2, #1565c0);
        }

        .horas-module .maria-bar {
            background: linear-gradient(135deg, #f57c00, #ef6c00);
        }

        .horas-module .summary-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .horas-module .summary-grid {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .horas-module .summary-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        /* ===== REPORTES ===== */
        .horas-module .report-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .horas-module .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .horas-module .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .horas-module .report-output {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            min-height: 300px;
        }

        .horas-module .report-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .horas-module .report-placeholder h3 {
            margin: 15px 0 10px;
        }

        .horas-module .reports-history {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .horas-module .history-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .horas-module .history-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.3s ease;
        }

        .horas-module .history-item:hover {
            background: #e9ecef;
            cursor: pointer;
        }

        .horas-module .history-item i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .horas-module .history-item span {
            flex: 1;
            font-weight: 500;
        }

        .horas-module .history-item small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* ===== FULLCALENDAR CUSTOMIZATION ===== */
        .horas-module .fc-event {
            border: none !important;
            border-radius: 6px !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            padding: 2px 6px !important;
            margin: 1px 0 !important;
        }

        /* Eventos del promotor fijo - tienda principal */
        .horas-module .event-fijo-principal {
            background: linear-gradient(135deg, #1976d2, #1565c0) !important;
            color: white !important;
            border-left: 4px solid #0d47a1 !important;
        }

        /* Eventos del promotor fijo - rotaci√≥n */
        .horas-module .event-fijo-rotacion {
            background: linear-gradient(135deg, #7b1fa2, #6a1b9a) !important;
            color: white !important;
            border-left: 4px solid #4a148c !important;
        }

        /* Eventos cubredescansos - apoyo */
        .horas-module .event-cubredescansos-apoyo {
            background: linear-gradient(135deg, #f57c00, #ef6c00) !important;
            color: white !important;
            border-left: 4px solid #e65100 !important;
        }

        /* Eventos cubredescansos - otros */
        .horas-module .event-cubredescansos-otros {
            background: linear-gradient(135deg, #388e3c, #2e7d32) !important;
            color: white !important;
            border-left: 4px solid #1b5e20 !important;
        }

        /* D√≠as de descanso */
        .horas-module .event-descanso {
            background: #f5f5f5 !important;
            color: #999 !important;
            border-left: 4px solid #ccc !important;
        }

        /* ===== LEGEND ===== */
        .horas-module .legend {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .horas-module .legend-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .horas-module .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .horas-module .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .horas-module .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        /* ===== MODAL STYLES ===== */
        .modal-horas {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-horas {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-horas:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-footer {
            padding: 20px;
            text-align: right;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel-horas {
            padding: 10px 20px;
            background: #ccc;
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel-horas:hover {
            background: #bbb;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .horas-module #tab-calendario.active {
                grid-template-columns: 1fr;
                padding: 20px 10px;
            }

            .horas-module .relationships-sidebar {
                flex-direction: row;
                overflow-x: auto;
                width: 100%;
                gap: 15px;
            }

            .horas-module .promotor-card {
                min-width: 280px;
                flex-shrink: 0;
            }

            .horas-module .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .horas-module .filters-bar,
            .horas-module .report-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .horas-module .tiendas-grid {
                grid-template-columns: 1fr;
            }

            .horas-module .sidebar-floating-btn {
                bottom: 80px;
                width: 140px;
                height: 45px;
                font-size: 0.8rem;
            }

            .horas-module .sidebar-floating-btn:hover {
                transform: translateX(5px);
            }

            .horas-module .store-filter-container {
                width: 100%;
                min-width: auto;
                margin-left: 0;
                margin-top: 10px;
            }

            .horas-module .calendar-controls {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            .horas-module .header-content {
                flex-direction: column;
                text-align: center;
            }

            .horas-module .header-actions {
                width: 100%;
                justify-content: center;
            }

            .horas-module .tabs-navigation {
                flex-direction: column;
            }

            .horas-module .tab-item {
                padding: 12px 15px;
            }

            .horas-module .calendar-header {
                flex-direction: column;
                text-align: center;
            }

            .horas-module #calendar-horas {
                height: 500px;
            }

            .horas-module .tab-section {
                padding: 20px 10px;
            }

            .horas-module .metric-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .horas-module .promotor-stats {
                flex-direction: column;
                gap: 8px;
            }

            .horas-module .acciones-promotor {
                flex-direction: column;
            }

            .modal-content {
                margin: 5% 5%;
                max-width: calc(100% - 20px);
            }

            .horas-module #days-selector {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 2% 5%;
                max-width: calc(100% - 10px);
            }

            .modal-footer {
                flex-direction: column;
            }

            .btn-primary,
            .btn-cancel-horas {
                width: 100%;
                margin-bottom: 10px;
            }

            .horas-module .relationships-sidebar {
                flex-direction: column;
            }

            .horas-module .tab-item span {
                display: none;
            }

            .horas-module .chart-visual {
                font-size: 0.8rem;
            }

            .horas-module .promotor-info-main {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* ===== ESTILOS HOVER PARA D√çAS DEL CALENDARIO FULLCALENDAR ===== */

        /* Efecto hover b√°sico para d√≠as del calendario */
        .horas-module .fc-day {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .horas-module .fc-day:hover {
            background-color: rgba(102, 126, 234, 0.1) !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        /* Hover espec√≠fico para d√≠as en vista mensual */
        .horas-module .fc-daygrid-day:hover {
            background-color: rgba(102, 126, 234, 0.08) !important;
        }

        /* Hover para el d√≠a actual */
        .horas-module .fc-day-today:hover {
            background-color: rgba(102, 126, 234, 0.2) !important;
        }

        /* Hover para las celdas de d√≠as en vista semanal */
        .horas-module .fc-timegrid-col:hover {
            background-color: rgba(102, 126, 234, 0.05) !important;
        }

        /* Hover para d√≠as en vista de lista */
        .horas-module .fc-list-day:hover {
            background-color: rgba(102, 126, 234, 0.1) !important;
        }

        /* Efecto suave para el n√∫mero del d√≠a */
        .horas-module .fc-daygrid-day-number {
            transition: all 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .horas-module .fc-day:hover .fc-daygrid-day-number {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            transform: scale(1.1);
        }

        /* Hover para el contenido de la celda del d√≠a */
        .horas-module .fc-daygrid-day-frame:hover {
            border-color: var(--primary-color) !important;
        }

        /* Asegurar que el hover no afecte d√≠as deshabilitados */
        .horas-module .fc-day.fc-day-disabled:hover {
            background-color: transparent !important;
            transform: none !important;
            box-shadow: none !important;
            cursor: not-allowed;
        }

        /* Hover para d√≠as de otros meses (grises) */
        .horas-module .fc-day.fc-day-other:hover {
            background-color: rgba(102, 126, 234, 0.05) !important;
        }

        /* Efecto hover para la parte superior de los d√≠as */
        .horas-module .fc-daygrid-day-top:hover {
            background-color: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }

        /* Hover m√°s sutil para vista de semana/d√≠a */
        .horas-module .fc-timegrid-slot:hover {
            background-color: rgba(102, 126, 234, 0.03) !important;
        }

        /* Responsive: Reducir efectos en dispositivos m√≥viles */
        @media (max-width: 768px) {
            .horas-module .fc-day:hover {
                transform: scale(1.01);
                box-shadow: 0 1px 4px rgba(102, 126, 234, 0.1);
            }

            .horas-module .fc-day:hover .fc-daygrid-day-number {
                transform: scale(1.05);
            }
        }

        /* Hover para botones de navegaci√≥n del calendario */
        .horas-module .fc-button:hover {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        /* Hover para el t√≠tulo del calendario */
        .horas-module .fc-toolbar-title:hover {
            color: var(--primary-color);
            cursor: default;
        }

        /* Asegurar que el layout de grid se ajuste correctamente */
        @media (min-width: 1025px) {
            .horas-module #tab-calendario.active {
                display: grid !important;
                grid-template-columns: 350px 1fr;
                gap: 30px;
                align-items: start;
            }

            .horas-module #tab-calendario.active.sidebar-collapsed {
                grid-template-columns: 0px 1fr;
                gap: 0;
            }
        }
    </style>

    <script>
        (function () {
            'use strict';

            console.log('üöÄ INICIANDO M√ìDULO HOJAS DE HORAS CON FILTRO DE TIENDA');

            // ===== VARIABLES GLOBALES =====
            let calendar = null;
            let currentEvent = null;
            let isFullCalendarLoaded = false;
            let loadingPromise = null;
            let cleanupListeners = [];
            let currentTab = 'calendario';
            let promotoresData = [];
            let tiendasData = [];
            let currentPromotorAsignar = null;
            let datosAutomaticosExitosos = false;
            let todosLosEventos = []; // NUEVO: Almacena TODOS los eventos sin filtro
            let tiendaSeleccionada = ''; // NUEVO: ID de tienda seleccionada

            // ===== FUNCIONALIDAD SIDEBAR COLAPSIBLE =====
            let sidebarCollapsed = false;

            function toggleSidebar() {
                const sidebar = document.getElementById('relationships-sidebar');
                const floatingBtn = document.getElementById('sidebar-floating-btn');
                const calendarTab = document.getElementById('tab-calendario');
                const toggleIcon = document.getElementById('toggle-icon');
                const toggleText = document.getElementById('toggle-text');

                if (!sidebar || !floatingBtn || !calendarTab) {
                    console.error('‚ùå Elementos del sidebar no encontrados');
                    return;
                }

                sidebarCollapsed = !sidebarCollapsed;

                if (sidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                    calendarTab.classList.add('sidebar-collapsed');
                    floatingBtn.classList.add('visible');

                    if (toggleIcon) toggleIcon.className = 'fas fa-chevron-right';
                    if (toggleText) toggleText.textContent = 'Mostrar men√∫';

                    setTimeout(() => {
                        if (window.calendar && calendar.updateSize) {
                            calendar.updateSize();
                        }
                    }, 450);

                } else {
                    sidebar.classList.remove('collapsed');
                    calendarTab.classList.remove('sidebar-collapsed');
                    floatingBtn.classList.remove('visible');

                    if (toggleIcon) toggleIcon.className = 'fas fa-chevron-left';
                    if (toggleText) toggleText.textContent = 'Ocultar men√∫';

                    setTimeout(() => {
                        if (window.calendar && calendar.updateSize) {
                            calendar.updateSize();
                        }
                    }, 450);
                }

                localStorage.setItem('sidebarCollapsed', sidebarCollapsed.toString());
            }

            // Hacer la funci√≥n global
            window.toggleSidebar = toggleSidebar;

            // ===== ELEMENTOS DOM =====
            const elements = {
                dependenciesLoading: document.getElementById('dependencies-loading'),
                mainContentHoras: document.getElementById('main-content-horas'),
                errorState: document.getElementById('error-state'),
                errorMessage: document.getElementById('error-message'),
                loadingProgress: document.getElementById('loading-progress')
            };

            // ===== REGISTRAR CLEANUP EN EL SISTEMA SPA =====
            if (window.registerModuleCleanup) {
                window.registerModuleCleanup(function () {
                    console.log('üßπ Limpiando m√≥dulo Hojas de Horas...');

                    // Destruir FullCalendar
                    if (calendar) {
                        try {
                            calendar.destroy();
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error destruyendo calendar:', error);
                        }
                        calendar = null;
                    }

                    // Limpiar event listeners
                    cleanupListeners.forEach(cleanup => {
                        try { cleanup(); } catch (e) { console.warn('Error limpiando listener:', e); }
                    });
                    cleanupListeners = [];

                    // Cerrar modales
                    const modal = document.getElementById('modal-evento-horas');
                    const modalAsignar = document.getElementById('modal-asignar-tienda');
                    if (modal) modal.style.display = 'none';
                    if (modalAsignar) modalAsignar.style.display = 'none';

                    // Reset variables
                    currentEvent = null;
                    isFullCalendarLoaded = false;
                    loadingPromise = null;
                    currentTab = 'calendario';
                    promotoresData = [];
                    tiendasData = [];
                    currentPromotorAsignar = null;
                    sidebarCollapsed = false;
                    datosAutomaticosExitosos = false;
                    todosLosEventos = [];
                    tiendaSeleccionada = '';

                    console.log('‚úÖ M√≥dulo Hojas de Horas limpiado');
                });
            }

            // ===== HELPER PARA EVENT LISTENERS =====
            function addListener(element, event, handler, options) {
                if (!element) return;
                element.addEventListener(event, handler, options);
                cleanupListeners.push(() => element.removeEventListener(event, handler, options));
            }

            // ===== FUNCI√ìN FETCHFROMAPI COMPLETAMENTE CORREGIDA =====
            async function fetchFromAPI(endpoint, options = {}) {
                const possiblePaths = [
                    '/promotoria/api/hoja_horario.php',
                    '/api/hoja_horario.php',
                    '/hoja_horario.php'
                ];

                const baseURL = window.location.origin;
                console.log(`üîç BASE URL DETECTADA: ${baseURL}`);

                for (let i = 0; i < possiblePaths.length; i++) {
                    const path = possiblePaths[i];
                    const url = `${baseURL}${path}?resource=${endpoint}`;

                    try {
                        console.log(`üîó INTENTANDO RUTA ${i + 1}/${possiblePaths.length}: ${url}`);

                        const requestOptions = {
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                ...options.headers
                            },
                            ...options
                        };

                        console.log('üì¶ REQUEST OPTIONS:', JSON.stringify(requestOptions, null, 2));

                        const response = await fetch(url, requestOptions);

                        console.log(`üì° RESPONSE STATUS: ${response.status} ${response.statusText}`);
                        console.log('üì° RESPONSE HEADERS:', JSON.stringify([...response.headers.entries()], null, 2));

                        if (!response.ok) {
                            console.warn(`‚ö†Ô∏è HTTP ${response.status} en ${path}, probando siguiente ruta...`);
                            continue;
                        }

                        // Leer texto completo primero
                        const responseText = await response.text();
                        console.log(`üìÑ RESPONSE TEXT (primeros 300 chars): ${responseText.substring(0, 300)}${responseText.length > 300 ? '...' : ''}`);

                        if (!responseText.trim()) {
                            console.warn('‚ö†Ô∏è Respuesta vac√≠a, probando siguiente ruta...');
                            continue;
                        }

                        // Intentar parsear JSON
                        let result;
                        try {
                            result = JSON.parse(responseText);
                            console.log('‚úÖ JSON PARSEADO EXITOSAMENTE:', result);
                        } catch (parseError) {
                            console.error('‚ùå Error parseando JSON:', parseError.message);
                            console.error('‚ùå Texto que caus√≥ error:', responseText.substring(0, 500));
                            continue;
                        }

                        // ===== VERIFICACI√ìN MEJORADA DE RESPUESTA EXITOSA =====
                        if (result && typeof result === 'object') {
                            // Verificar diferentes estructuras de respuesta posibles
                            if (result.success === true) {
                                console.log('‚úÖ RESPUESTA EXITOSA CON success=true');
                                return result.data || result;
                            }
                            else if (result.success === false) {
                                console.warn('‚ö†Ô∏è Respuesta con success=false:', result.message);
                                throw new Error(result.message || 'Error en la API');
                            }
                            else if (Array.isArray(result)) {
                                console.log('‚úÖ RESPUESTA EXITOSA - ARRAY DIRECTO');
                                return result;
                            }
                            else if (result.data && Array.isArray(result.data)) {
                                console.log('‚úÖ RESPUESTA EXITOSA CON DATA ARRAY');
                                return result.data;
                            }
                            else {
                                console.log('‚úÖ RESPUESTA EXITOSA - OBJETO DIRECTO');
                                return result;
                            }
                        }

                        console.warn('‚ö†Ô∏è Estructura de respuesta no reconocida, probando siguiente ruta...');
                        continue;

                    } catch (fetchError) {
                        console.error(`‚ùå ERROR EN ${path}:`, fetchError.message);
                        if (i === possiblePaths.length - 1) {
                            throw fetchError;
                        }
                        continue;
                    }
                }

                throw new Error('No se pudo conectar con ninguna ruta de la API');
            }

            // ===== FUNCI√ìN CORREGIDA PARA CREAR ASIGNACI√ìN EN BD =====
            async function crearAsignacionBD(datos) {
                try {
                    console.log('üì° ENVIANDO DATOS A API:', datos);

                    const response = await fetch(`${window.location.origin}/promotoria/api/hoja_horario.php?resource=asignaciones`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(datos)
                    });

                    console.log('üì° RESPONSE STATUS:', response.status, response.statusText);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå HTTP Error Response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const responseText = await response.text();
                    console.log('üìÑ RAW RESPONSE:', responseText);

                    if (!responseText.trim()) {
                        throw new Error('Respuesta vac√≠a del servidor');
                    }

                    let resultado;
                    try {
                        resultado = JSON.parse(responseText);
                        console.log('‚úÖ JSON PARSEADO:', resultado);
                    } catch (parseError) {
                        console.error('‚ùå Error parseando JSON:', parseError);
                        console.error('üìÑ Texto que caus√≥ error:', responseText.substring(0, 500));
                        throw new Error('Respuesta del servidor no es JSON v√°lido');
                    }

                    // VERIFICACI√ìN MEJORADA DE √âXITO
                    if (resultado && typeof resultado === 'object') {
                        // Caso 1: success = true expl√≠cito
                        if (resultado.success === true) {
                            console.log('‚úÖ √âXITO CONFIRMADO por success=true');
                            return resultado;
                        }
                        // Caso 2: success = false expl√≠cito
                        else if (resultado.success === false) {
                            console.warn('‚ö†Ô∏è API report√≥ error:', resultado.message);
                            throw new Error(resultado.message || 'Error reportado por la API');
                        }
                        // Caso 3: Respuesta con ID (indica √©xito aunque no tenga success=true)
                        else if (resultado.id || resultado.data?.id_asignacion) {
                            console.log('‚úÖ √âXITO INFERIDO por presencia de ID');
                            return {
                                success: true,
                                id: resultado.id || resultado.data?.id_asignacion,
                                data: resultado.data || resultado,
                                message: resultado.message || 'Creado exitosamente'
                            };
                        }
                        // Caso 4: Respuesta que parece exitosa (tiene data)
                        else if (resultado.data && typeof resultado.data === 'object') {
                            console.log('‚úÖ √âXITO INFERIDO por presencia de data');
                            return {
                                success: true,
                                data: resultado.data,
                                message: resultado.message || 'Operaci√≥n exitosa'
                            };
                        }
                        // Caso 5: Objeto directo que parece v√°lido
                        else if (resultado.id_asignacion || Object.keys(resultado).length > 0) {
                            console.log('‚úÖ √âXITO INFERIDO por estructura v√°lida');
                            return {
                                success: true,
                                data: resultado,
                                message: 'Operaci√≥n completada'
                            };
                        }
                        else {
                            console.warn('‚ö†Ô∏è Respuesta sin indicadores claros de √©xito:', resultado);
                            throw new Error('Respuesta del servidor ambigua');
                        }
                    } else {
                        console.error('‚ùå Respuesta no es un objeto v√°lido:', resultado);
                        throw new Error('Formato de respuesta inv√°lido');
                    }

                } catch (error) {
                    console.error('‚ùå ERROR EN crearAsignacionBD:', error);
                    throw error;
                }
            }

            // ===== FUNCI√ìN CORREGIDA PARA CREAR NUEVO EVENTO =====
            async function crearNuevoEvento(datos, promotor, tienda, tipo) {
                try {
                    console.log('‚ûï Creando nuevo evento en BD...', datos);

                    const response = await crearAsignacionBD(datos);

                    // VERIFICACI√ìN MEJORADA - ACEPTAR M√öLTIPLES FORMATOS DE RESPUESTA EXITOSA
                    let esExitoso = false;
                    let nuevoId = null;

                    if (response) {
                        // Verificar √©xito por diferentes m√©todos
                        if (response.success === true) {
                            esExitoso = true;
                            nuevoId = response.id || response.data?.id_asignacion || response.data?.id;
                        } else if (response.id || response.data?.id_asignacion) {
                            esExitoso = true;
                            nuevoId = response.id || response.data?.id_asignacion;
                        } else if (response.data && typeof response.data === 'object') {
                            esExitoso = true;
                            nuevoId = response.data.id_asignacion || response.data.id || Date.now();
                        }
                    }

                    console.log('üîç AN√ÅLISIS DE RESPUESTA:', {
                        response: response,
                        esExitoso: esExitoso,
                        nuevoId: nuevoId
                    });

                    if (esExitoso) {
                        console.log('‚úÖ Evento creado en BD exitosamente');

                        // Crear evento en el calendario
                        // Crear evento en el calendario
                        const nuevoEvento = {
                            id: `asig_nuevo_${nuevoId || Date.now()}`,
                            title: `${promotor.nombre} ${promotor.apellido} - ${tienda.cadena} #${tienda.num_tienda}`,
                            start: datos.fecha_inicio,
                            className: determinarClaseEvento(tipo),
                            extendedProps: {
                                id_asignacion: nuevoId,
                                id_promotor: datos.id_promotor,
                                id_tienda: datos.id_tienda,
                                nombre_promotor: `${promotor.nombre} ${promotor.apellido}`,
                                nombre_tienda: tienda.nombre_tienda,
                                numero_tienda: tienda.num_tienda,
                                cadena: tienda.cadena,
                                motivo_asignacion: datos.motivo_asignacion,
                                tipo_trabajo: promotor.tipo_trabajo
                            }
                        };

                        // Agregar evento tanto al calendario como al array global
                        todosLosEventos.push(nuevoEvento);
                        aplicarFiltroTienda(); // Reaplicar filtro para mostrar u ocultar seg√∫n selecci√≥n
                        actualizarDashboard();

                        console.log('üéâ Evento agregado exitosamente');

                    } else {
                        console.error('‚ùå La respuesta no indica √©xito claro:', response);
                        setTimeout(async () => {
                            try {
                                const eventosActualizados = await cargarAsignacionesReales();
                                if (eventosActualizados && eventosActualizados.length > 0) {
                                    console.log('üéâ Se detectaron nuevos eventos, refrescando calendario...');
                                    todosLosEventos = eventosActualizados;
                                    aplicarFiltroTienda();
                                    actualizarDashboard();
                                }
                            } catch (refreshError) {
                                console.warn('‚ö†Ô∏è Error refrescando eventos:', refreshError);
                            }
                        }, 1000);

                        console.warn('‚ö†Ô∏è Respuesta ambigua pero el evento podr√≠a haberse creado');
                    }

                } catch (error) {
                    console.error('‚ùå Error en crearNuevoEvento:', error);

                    setTimeout(async () => {
                        try {
                            const eventosActualizados = await cargarAsignacionesReales();
                            const eventoAnterior = todosLosEventos.length;

                            if (eventosActualizados && eventosActualizados.length > eventoAnterior) {
                                console.log('üéâ ¬°El evento S√ç se cre√≥ a pesar del error! Refrescando calendario...');
                                todosLosEventos = eventosActualizados;
                                aplicarFiltroTienda();
                                actualizarDashboard();
                                alert('‚úÖ El evento se cre√≥ exitosamente (a pesar del error de comunicaci√≥n)');
                            } else {
                                throw error;
                            }
                        } catch (refreshError) {
                            console.error('‚ùå Error confirmado y no se cre√≥ el evento:', refreshError);
                            throw error;
                        }
                    }, 1500);
                }
            }

            // ===== FUNCI√ìN CORREGIDA PARA GUARDAR EVENTO =====
            async function guardarEvento() {
                try {
                    console.log('üíæ Iniciando guardado de evento...');

                    const promotorId = document.getElementById('event-promotor-horas').value;
                    const tiendaId = document.getElementById('event-tienda-horas').value;
                    const fecha = document.getElementById('event-fecha-horas').value;
                    const tipo = document.getElementById('event-tipo-horas').value;
                    const notas = document.getElementById('event-notas-horas').value;

                    // Validaciones b√°sicas
                    if (!promotorId) {
                        alert('Por favor selecciona un promotor');
                        return;
                    }
                    if (!tiendaId) {
                        alert('Por favor selecciona una tienda');
                        return;
                    }
                    if (!fecha) {
                        alert('Por favor selecciona una fecha');
                        return;
                    }

                    // Obtener datos de promotor y tienda
                    const promotor = promotoresData.find(p => p.id_promotor == promotorId);
                    const tienda = tiendasData.find(t => t.id_tienda == tiendaId);

                    if (!promotor || !tienda) {
                        alert('Error: No se encontraron los datos del promotor o tienda');
                        return;
                    }

                    // Determinar si es actualizaci√≥n o creaci√≥n
                    if (currentEvent && currentEvent.extendedProps.id_asignacion) {
                        // ACTUALIZAR evento existente
                        await actualizarEventoExistente(currentEvent, {
                            id_promotor: promotorId,
                            id_tienda: tiendaId,
                            fecha_inicio: fecha,
                            motivo_asignacion: notas || 'Actualizaci√≥n desde calendario'
                        });
                    } else {
                        // CREAR nuevo evento
                        await crearNuevoEvento({
                            id_promotor: promotorId,
                            id_tienda: tiendaId,
                            fecha_inicio: fecha,
                            motivo_asignacion: notas || 'Asignaci√≥n desde calendario',
                            tipo_asignacion: tipo.includes('fijo') ? 'Principal' : 'Individual'
                        }, promotor, tienda, tipo);
                    }

                    console.log('‚úÖ Operaci√≥n completada, cerrando modal...');
                    closeModal();

                } catch (error) {
                    console.error('‚ùå Error guardando evento:', error);

                    const esErrorComunicacion = error.message.includes('Error desconocido') ||
                        error.message.includes('Respuesta del servidor');

                    if (esErrorComunicacion) {
                        alert('‚ö†Ô∏è Hubo un problema de comunicaci√≥n con el servidor.\n\nEl evento podr√≠a haberse creado exitosamente.\n\n‚úÖ Revisa el calendario para confirmar.\n\nSi no aparece, intenta nuevamente.');
                    } else {
                        alert('‚ùå Error guardando el evento: ' + error.message);
                    }
                }
            }

            // ===== ACTUALIZAR PROGRESO DE CARGA =====
            function updateLoadingProgress(mensaje) {
                const progressEl = elements.loadingProgress;
                if (progressEl) {
                    progressEl.textContent = mensaje;
                }
                console.log(`‚è≥ ${mensaje}`);
            }

            // ===== CARGAR PROMOTORES DESDE BASE DE DATOS - VERSI√ìN CORREGIDA =====
            async function cargarPromotoresReales() {
                try {
                    updateLoadingProgress('üîÑ Cargando promotores...');
                    console.log('üöÄ INICIANDO CARGA DE PROMOTORES...');

                    const data = await fetchFromAPI('promotores');

                    console.log('üìä PROMOTORES RAW DATA:', data);

                    if (!data) {
                        console.warn('‚ö†Ô∏è No se recibieron datos de promotores');
                        return [];
                    }

                    let promotoresArray = [];

                    // Manejar diferentes estructuras de respuesta
                    if (Array.isArray(data)) {
                        promotoresArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        promotoresArray = data.data;
                    } else {
                        console.warn('‚ö†Ô∏è Estructura de promotores no reconocida:', data);
                        return [];
                    }

                    promotoresData = promotoresArray;
                    console.log(`‚úÖ ${promotoresData.length} PROMOTORES CARGADOS:`, promotoresData);

                    // Actualizar sidebar
                    const promotorFijo = promotoresData.find(p => p.tipo_trabajo === 'fijo') || promotoresData[0];
                    const promotorCubre = promotoresData.find(p => p.tipo_trabajo === 'cubredescansos');

                    if (promotorFijo) updatePromotorSidebar('fijo', promotorFijo);
                    if (promotorCubre) updatePromotorSidebar('cubredescansos', promotorCubre);

                    updateLoadingProgress(`‚úÖ ${promotoresData.length} promotores cargados`);
                    return promotoresData;

                } catch (error) {
                    console.error('‚ùå ERROR CR√çTICO cargando promotores:', error);
                    updateLoadingProgress('‚ùå Error cargando promotores');
                    throw error;
                }
            }

            // ===== CARGAR TIENDAS DESDE BASE DE DATOS - VERSI√ìN CORREGIDA =====
            async function cargarTiendasReales() {
                try {
                    updateLoadingProgress('üîÑ Cargando tiendas...');
                    console.log('üöÄ INICIANDO CARGA DE TIENDAS...');

                    const data = await fetchFromAPI('tiendas');

                    console.log('üìä TIENDAS RAW DATA:', data);

                    if (!data) {
                        console.warn('‚ö†Ô∏è No se recibieron datos de tiendas');
                        return [];
                    }

                    let tiendasArray = [];

                    // Manejar diferentes estructuras de respuesta
                    if (Array.isArray(data)) {
                        tiendasArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        tiendasArray = data.data;
                    } else {
                        console.warn('‚ö†Ô∏è Estructura de tiendas no reconocida:', data);
                        return [];
                    }

                    tiendasData = tiendasArray;
                    console.log(`‚úÖ ${tiendasData.length} TIENDAS CARGADAS:`, tiendasData.slice(0, 3));

                    updateLoadingProgress(`‚úÖ ${tiendasData.length} tiendas cargadas`);
                    return tiendasData;

                } catch (error) {
                    console.error('‚ùå ERROR CR√çTICO cargando tiendas:', error);
                    updateLoadingProgress('‚ùå Error cargando tiendas');
                    throw error;
                }
            }

            // ===== CARGAR ASIGNACIONES REALES - VERSI√ìN COMPLETAMENTE CORREGIDA =====
            async function cargarAsignacionesReales() {
                try {
                    updateLoadingProgress('üîÑ Cargando asignaciones activas...');
                    console.log('üöÄ INICIANDO CARGA DE ASIGNACIONES...');

                    const data = await fetchFromAPI('asignaciones');

                    console.log('üìä ASIGNACIONES RAW DATA:', data);

                    if (!data) {
                        console.warn('‚ö†Ô∏è No se recibieron datos de asignaciones');
                        return [];
                    }

                    let asignacionesArray = [];

                    // Manejo robusto de diferentes estructuras
                    if (Array.isArray(data)) {
                        asignacionesArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        asignacionesArray = data.data;
                    } else if (data.success && data.data && Array.isArray(data.data)) {
                        asignacionesArray = data.data;
                    } else {
                        console.warn('‚ö†Ô∏è Estructura de asignaciones no reconocida:', data);
                        return [];
                    }

                    console.log(`üìä ${asignacionesArray.length} ASIGNACIONES ENCONTRADAS EN BD`);

                    if (asignacionesArray.length === 0) {
                        console.log('‚ÑπÔ∏è La base de datos no contiene asignaciones activas');
                        updateLoadingProgress('‚úÖ Sin asignaciones activas en BD - Calendario vac√≠o');
                        return [];
                    }

                    // Conversi√≥n a formato FullCalendar
                    const eventos = asignacionesArray.map((asignacion, index) => {
                        if (!asignacion.id_asignacion || !asignacion.fecha_inicio) {
                            console.warn(`‚ö†Ô∏è Asignaci√≥n ${index + 1} con datos faltantes:`, asignacion);
                            return null;
                        }

                        const evento = {
                            id: `asig_real_${asignacion.id_asignacion}`,
                            title: `${asignacion.nombre_promotor || 'Sin promotor'} - ${asignacion.cadena || 'Sin cadena'} #${asignacion.numero_tienda || asignacion.num_tienda || 'S/N'}`,
                            start: asignacion.fecha_inicio,
                            end: asignacion.fecha_fin || null,
                            extendedProps: {
                                id_asignacion: asignacion.id_asignacion,
                                id_promotor: asignacion.id_promotor,
                                id_tienda: asignacion.id_tienda,
                                nombre_promotor: asignacion.nombre_promotor,
                                nombre_tienda: asignacion.nombre_tienda,
                                numero_tienda: asignacion.numero_tienda || asignacion.num_tienda,
                                cadena: asignacion.cadena,
                                motivo_asignacion: asignacion.motivo_asignacion,
                                activo: asignacion.activo,
                                tipo_trabajo: asignacion.tipo_trabajo
                            }
                        };

                        // Determinar className basado en tipo de trabajo
                        if (asignacion.tipo_trabajo === 'fijo') {
                            evento.className = 'event-fijo-principal';
                        } else if (asignacion.tipo_trabajo === 'cubredescansos') {
                            evento.className = 'event-cubredescansos-apoyo';
                        } else {
                            evento.className = 'event-cubredescansos-otros';
                        }

                        return evento;
                    }).filter(evento => evento !== null);

                    console.log(`üéØ EVENTOS FINALES PARA FULLCALENDAR: ${eventos.length}`);

                    updateLoadingProgress(`üéâ ${eventos.length} asignaciones listas para el calendario`);
                    return eventos;

                } catch (error) {
                    console.error('‚ùå ERROR CR√çTICO cargando asignaciones:', error);
                    updateLoadingProgress('‚ùå Error cr√≠tico cargando asignaciones');
                    throw error;
                }
            }

            // ===== ACTUALIZAR SIDEBAR PROMOTORES =====
            function updatePromotorSidebar(tipo, promotor) {
                const sidebarId = tipo === 'fijo' ? 'promotor-fijo-info' : 'promotor-cubredescansos-info';
                const sidebar = document.getElementById(sidebarId);

                if (!sidebar || !promotor) return;

                const nombreEl = sidebar.querySelector('.promotor-name');
                const detallesEl = sidebar.querySelector('.promotor-details');
                const tiendaEl = sidebar.querySelector('.tienda-principal-name');

                if (nombreEl) nombreEl.textContent = `${promotor.nombre} ${promotor.apellido}`;
                if (detallesEl) {
                    detallesEl.innerHTML = `RFC: ${promotor.rfc || 'N/A'}<br>Tel: ${promotor.telefono || 'N/A'}`;
                }
                if (tiendaEl && tipo === 'fijo') {
                    tiendaEl.textContent = 'Asignaciones din√°micas';
                }
            }

            // ===== LLENAR SELECTS CON DATOS REALES =====
            function llenarSelectsModal() {
                // Llenar select de promotores
                const promotorSelect = document.getElementById('event-promotor-horas');
                if (promotorSelect && promotoresData.length > 0) {
                    promotorSelect.innerHTML = '<option value="">Seleccionar promotor...</option>';
                    promotoresData.forEach(promotor => {
                        const option = document.createElement('option');
                        option.value = promotor.id_promotor;
                        option.textContent = `${promotor.nombre} ${promotor.apellido} (${promotor.tipo_trabajo})`;
                        promotorSelect.appendChild(option);
                    });
                }

                // Llenar select de tiendas
                const tiendaSelect = document.getElementById('event-tienda-horas');
                if (tiendaSelect && tiendasData.length > 0) {
                    tiendaSelect.innerHTML = '<option value="">Seleccionar tienda...</option>';
                    tiendasData.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id_tienda;
                        option.textContent = `${tienda.cadena} #${tienda.num_tienda} - ${tienda.nombre_tienda}`;
                        tiendaSelect.appendChild(option);
                    });
                }

                // Llenar filtros
                const filterPromotor = document.getElementById('filter-promotor');
                if (filterPromotor) {
                    filterPromotor.innerHTML = '<option value="">Todos</option>';
                    promotoresData.forEach(promotor => {
                        const option = document.createElement('option');
                        option.value = promotor.id_promotor;
                        option.textContent = `${promotor.nombre} ${promotor.apellido}`;
                        filterPromotor.appendChild(option);
                    });
                }

                const filterTienda = document.getElementById('filter-tienda');
                if (filterTienda) {
                    filterTienda.innerHTML = '<option value="">Todas</option>';
                    tiendasData.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id_tienda;
                        option.textContent = `${tienda.cadena} #${tienda.num_tienda}`;
                        filterTienda.appendChild(option);
                    });
                }

                // ===== NUEVO: Llenar selector de tienda en calendario =====
                const calendarStoreFilter = document.getElementById('calendar-store-filter');
                if (calendarStoreFilter && tiendasData.length > 0) {
                    calendarStoreFilter.innerHTML = '<option value="">üè™ Todas las tiendas</option>';
                    tiendasData.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id_tienda;
                        option.textContent = `${tienda.cadena} #${tienda.num_tienda} - ${tienda.nombre_tienda}`;
                        calendarStoreFilter.appendChild(option);
                    });
                }
            }

            // ===== FUNCIONES DE CARGA DE DEPENDENCIAS =====
            async function loadCSS(url) {
                return new Promise((resolve, reject) => {
                    const existingLink = document.querySelector(`link[href="${url}"]`);
                    if (existingLink) {
                        resolve();
                        return;
                    }

                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = url;
                    link.onload = resolve;
                    link.onerror = reject;
                    document.head.appendChild(link);
                });
            }

            async function loadJS(url) {
                return new Promise((resolve, reject) => {
                    if (window.FullCalendar) {
                        resolve();
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => {
                        setTimeout(() => {
                            if (window.FullCalendar) {
                                resolve();
                            } else {
                                reject(new Error('FullCalendar no disponible'));
                            }
                        }, 300);
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            async function loadFullCalendarDependencies() {
                if (loadingPromise) return loadingPromise;
                if (isFullCalendarLoaded && window.FullCalendar) return Promise.resolve();

                updateLoadingProgress('üìö Cargando FullCalendar...');

                loadingPromise = Promise.all([
                    loadCSS('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css'),
                    loadJS('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js')
                ]).then(() => {
                    isFullCalendarLoaded = true;
                    updateLoadingProgress('‚úÖ FullCalendar cargado exitosamente');
                    return true;
                });

                return loadingPromise;
            }

            // ===== FUNCI√ìN: DETERMINAR PER√çODO TEMPORAL DEL EVENTO (SOLO PASADO Y PRESENTE) =====
            // ===== FUNCI√ìN: DETERMINAR PER√çODO TEMPORAL DEL EVENTO (SOLO PASADO Y PRESENTE) =====
            function determinarPeriodoTemporal(fechaEvento) {
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const hoy = new Date();
                const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;

                // Convertir fechaEvento a formato YYYY-MM-DD
                let fechaEventoStr;
                if (typeof fechaEvento === 'string') {
                    fechaEventoStr = fechaEvento.split('T')[0]; // Si viene con hora, quitarla
                } else {
                    const fechaObj = new Date(fechaEvento);
                    fechaEventoStr = `${fechaObj.getFullYear()}-${String(fechaObj.getMonth() + 1).padStart(2, '0')}-${String(fechaObj.getDate()).padStart(2, '0')}`;
                }

                console.log('üîç Comparando fechas:', {
                    hoy: hoyStr,
                    evento: fechaEventoStr,
                    sonIguales: fechaEventoStr === hoyStr
                });

                if (fechaEventoStr === hoyStr) {
                    return 'present'; // Presente (hoy - trabajando actualmente)
                } else {
                    return 'past'; // Pasado (historial - ya trabaj√≥)
                }
            }

            // ===== FUNCI√ìN: APLICAR CLASES TEMPORALES A EVENTOS (SOLO PASADO Y PRESENTE) =====
            function aplicarClasesTemporal(evento) {
                const periodo = determinarPeriodoTemporal(evento.start);
                const classesOriginales = Array.isArray(evento.className) ? evento.className : [evento.className];

                // Remover clases temporales anteriores
                const classesFiltradas = classesOriginales.filter(c =>
                    c !== 'event-past' && c !== 'event-present'
                );

                // Agregar nueva clase temporal
                classesFiltradas.push(`event-${periodo}`);

                return classesFiltradas;
            }

            // ===== FUNCI√ìN: APLICAR FILTRO DE TIENDA =====
            function aplicarFiltroTienda() {
                if (!calendar) return;

                console.log(`üîç Aplicando filtro de tienda: ${tiendaSeleccionada || 'Todas'}`);

                // Limpiar eventos actuales
                calendar.removeAllEvents();

                // Filtrar eventos
                let eventosFiltrados;
                if (tiendaSeleccionada && tiendaSeleccionada !== '') {
                    eventosFiltrados = todosLosEventos.filter(evento =>
                        String(evento.extendedProps.id_tienda) === String(tiendaSeleccionada)
                    );
                    console.log(`‚úÖ Mostrando ${eventosFiltrados.length} eventos de tienda ${tiendaSeleccionada}`);
                } else {
                    eventosFiltrados = todosLosEventos;
                    console.log(`‚úÖ Mostrando todos los ${eventosFiltrados.length} eventos`);
                }

                // Aplicar clases temporales a cada evento
                const eventosConClasesTemporal = eventosFiltrados.map(evento => {
                    return {
                        ...evento,
                        className: aplicarClasesTemporal(evento)
                    };
                });

                // Agregar eventos filtrados al calendario
                calendar.addEventSource(eventosConClasesTemporal);

                console.log(`üìä ${eventosConClasesTemporal.length} eventos renderizados con indicadores temporales`);
            }

            // ===== INICIALIZAR CALENDARIO CON DATOS AUTOM√ÅTICOS - VERSI√ìN CORREGIDA =====
            async function initializeCalendar(eventosAutomaticos = []) {
                if (!window.FullCalendar) throw new Error('FullCalendar no disponible');

                const calendarEl = document.getElementById('calendar-horas');
                if (!calendarEl) throw new Error('Elemento calendario no encontrado');

                console.log(`üìÖ INICIALIZANDO CALENDARIO CON ${eventosAutomaticos.length} EVENTOS AUTOM√ÅTICOS`);

                // Guardar eventos en variable global
                todosLosEventos = eventosAutomaticos;

                // Aplicar clases temporales iniciales
                const eventosConTemporal = eventosAutomaticos.map(evento => ({
                    ...evento,
                    className: aplicarClasesTemporal(evento)
                }));

                try {
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'es',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: ''
                        },
                        events: eventosConTemporal,
                        editable: true,
                        droppable: true,
                        selectable: true,

                        eventClick: function (info) {
                            console.log('üñ±Ô∏è Click en evento:', info.event.title);
                            openEventModal(info.event);
                        },

                        select: function (info) {
                            console.log('üñ±Ô∏è Selecci√≥n en calendario:', info.start);
                            openEventModal(null, info.start, info.end);
                        },

                        eventDrop: async function (info) {
                            console.log('üîÑ Evento movido:', info.event.title);
                            await actualizarEventoEnBD(info.event);

                            // Actualizar tambi√©n en el array global
                            const index = todosLosEventos.findIndex(e => e.id === info.event.id);
                            if (index !== -1) {
                                todosLosEventos[index].start = info.event.start;
                                todosLosEventos[index].end = info.event.end;
                            }

                            aplicarFiltroTienda();
                            actualizarDashboard();
                            if (currentTab === 'asignaciones') cargarListaAsignaciones();
                        },

                        eventResize: async function (info) {
                            console.log('üîÑ Evento redimensionado:', info.event.title);
                            await actualizarEventoEnBD(info.event);

                            // Actualizar tambi√©n en el array global
                            const index = todosLosEventos.findIndex(e => e.id === info.event.id);
                            if (index !== -1) {
                                todosLosEventos[index].start = info.event.start;
                                todosLosEventos[index].end = info.event.end;
                            }

                            aplicarFiltroTienda();
                            actualizarDashboard();
                            if (currentTab === 'asignaciones') cargarListaAsignaciones();
                        },

                        dayMaxEvents: 3,
                        moreLinkClick: 'popover',
                        slotMinTime: '06:00:00',
                        slotMaxTime: '24:00:00',
                        allDaySlot: true,
                        firstDay: 1,
                        height: 'auto',
                        aspectRatio: 1.35,

                        eventDidMount: function (info) {
                            const periodo = determinarPeriodoTemporal(info.event.start);
                            let emoji = '';

                            // Solo agregar emoji para presente (trabajando hoy)
                            // El pasado ya tiene su estilo visual distintivo (gris opaco)
                            if (periodo === 'present') {
                                emoji = '‚ñ∂Ô∏è ';
                            } else if (periodo === 'past') {
                                emoji = '‚èÆÔ∏è ';
                            }

                            // Agregar emoji al t√≠tulo
                            const titleEl = info.el.querySelector('.fc-event-title');
                            if (titleEl) {
                                titleEl.textContent = emoji + titleEl.textContent;
                            }
                        }
                    });

                    await calendar.render();

                    const renderedEvents = calendar.getEvents();
                    console.log(`‚úÖ CALENDARIO RENDERIZADO EXITOSAMENTE`);
                    console.log(`üìä Eventos renderizados: ${renderedEvents.length}`);

                    // Hacer calendario global para debugging
                    window.calendar = calendar;

                    // ===== CONFIGURAR EVENT LISTENER DEL FILTRO DE TIENDA =====
                    const storeFilterSelect = document.getElementById('calendar-store-filter');
                    if (storeFilterSelect) {
                        storeFilterSelect.addEventListener('change', function (e) {
                            tiendaSeleccionada = e.target.value;
                            console.log(`üè™ Filtro de tienda cambiado a: ${tiendaSeleccionada || 'Todas'}`);
                            aplicarFiltroTienda();
                        });
                        console.log('‚úÖ Event listener de filtro de tienda configurado');
                    }

                } catch (error) {
                    console.error('‚ùå ERROR CR√çTICO en initializeCalendar:', error);
                    throw error;
                }
            }

            // ===== INICIALIZACI√ìN DEL M√ìDULO PRINCIPAL - VERSI√ìN MEJORADA =====
            async function initModule() {
                try {
                    console.log('üöÄ ===== INICIANDO CARGA AUTOM√ÅTICA COMPLETA (PASADO Y PRESENTE) =====');

                    // Mostrar loading
                    elements.dependenciesLoading.style.display = 'flex';
                    elements.mainContentHoras.style.display = 'none';
                    elements.errorState.style.display = 'none';

                    // PASO 1: Cargar FullCalendar
                    console.log('üìö PASO 1: Cargando dependencias FullCalendar...');
                    await loadFullCalendarDependencies();

                    // PASO 2: CARGA AUTOM√ÅTICA DE TODOS LOS DATOS
                    console.log('üìä PASO 2: Cargando datos desde base de datos...');
                    updateLoadingProgress('üîÑ Cargando todos los datos autom√°ticamente...');

                    let eventosAutomaticos = [];
                    let datosResumen = {
                        promotores: 0,
                        tiendas: 0,
                        asignaciones: 0,
                        errores: []
                    };

                    // Carga en paralelo
                    console.log('‚ö° Ejecutando carga en paralelo...');

                    const promesasCarga = [
                        cargarPromotoresReales().catch(err => {
                            console.error('‚ùå Error promotores:', err.message);
                            datosResumen.errores.push('Promotores: ' + err.message);
                            return [];
                        }),
                        cargarTiendasReales().catch(err => {
                            console.error('‚ùå Error tiendas:', err.message);
                            datosResumen.errores.push('Tiendas: ' + err.message);
                            return [];
                        }),
                        cargarAsignacionesReales().catch(err => {
                            console.error('‚ùå Error asignaciones:', err.message);
                            datosResumen.errores.push('Asignaciones: ' + err.message);
                            return [];
                        })
                    ];

                    const [promotoresResult, tiendasResult, asignacionesResult] = await Promise.all(promesasCarga);

                    // Actualizar datos globales y contadores
                    if (promotoresResult.length > 0) {
                        promotoresData = promotoresResult;
                        datosResumen.promotores = promotoresResult.length;
                    }
                    if (tiendasResult.length > 0) {
                        tiendasData = tiendasResult;
                        datosResumen.tiendas = tiendasResult.length;
                    }
                    if (asignacionesResult.length > 0) {
                        eventosAutomaticos = asignacionesResult;
                        datosResumen.asignaciones = asignacionesResult.length;
                    }

                    // Evaluaci√≥n de √©xito
                    const cargaExitosa = eventosAutomaticos.length > 0;
                    datosAutomaticosExitosos = cargaExitosa;

                    console.log('üìä RESUMEN DE CARGA:');
                    console.log(`  - Promotores: ${datosResumen.promotores}`);
                    console.log(`  - Tiendas: ${datosResumen.tiendas}`);
                    console.log(`  - Asignaciones: ${datosResumen.asignaciones}`);

                    if (cargaExitosa) {
                        updateLoadingProgress(`üéâ ¬°√âXITO! ${datosResumen.asignaciones} asignaciones cargadas autom√°ticamente`);
                    } else {
                        updateLoadingProgress('‚ö†Ô∏è Calendario listo - Sin asignaciones activas en BD');
                    }

                    // PASO 3: Llenar selects
                    console.log('üìù PASO 3: Llenando selects de formularios...');
                    llenarSelectsModal();

                    // PASO 4: Inicializar calendario CON datos autom√°ticos
                    console.log(`üìÖ PASO 4: Inicializando calendario con ${eventosAutomaticos.length} eventos...`);
                    await initializeCalendar(eventosAutomaticos);

                    // PASO 5: Mostrar interfaz
                    console.log('üé® PASO 5: Mostrando interfaz...');
                    elements.dependenciesLoading.style.display = 'none';
                    elements.mainContentHoras.style.display = 'block';

                    // PASO 6: Configurar eventos y finalizar
                    console.log('üéØ PASO 6: Configurando event listeners...');
                    initializeEventListeners();

                    // PASO 7: Activar funcionalidades adicionales
                    setTimeout(() => {
                        console.log('üöÄ PASO 7: Activando funcionalidades finales...');

                        actualizarDashboard();
                        switchTab('calendario');

                        if (datosAutomaticosExitosos) {
                            console.log('üéâ ===== M√ìDULO INICIADO (HISTORIAL Y PRESENTE) =====');
                            console.log('üè™ Filtro de tienda disponible en calendario');
                            console.log('‚èÆÔ∏è‚ñ∂Ô∏è Indicadores temporales activos (historial/trabajando hoy)');
                        }

                        console.log('üèÅ ===== INICIALIZACI√ìN COMPLETADA =====');

                    }, 200);

                } catch (error) {
                    console.error('‚ùå ERROR CR√çTICO EN INICIALIZACI√ìN:', error);
                    showError(`Error cr√≠tico cargando el m√≥dulo: ${error.message}`);
                }
            }

            function showError(message) {
                elements.dependenciesLoading.style.display = 'none';
                elements.mainContentHoras.style.display = 'none';
                elements.errorState.style.display = 'flex';
                if (elements.errorMessage) elements.errorMessage.textContent = message;
            }

            // ===== FUNCIONES DE NAVEGACI√ìN Y CONTROLES =====
            function switchTab(tabName) {
                // Remover clase active de todas las pesta√±as
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Agregar clase active a la pesta√±a seleccionada
                const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedTab) selectedTab.classList.add('active');

                // Ocultar todo el contenido primero
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Mostrar solo el contenido seleccionado
                const targetTab = document.getElementById(`tab-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                currentTab = tabName;

                // Acciones espec√≠ficas por pesta√±a
                setTimeout(() => {
                    switch (tabName) {
                        case 'calendario':
                            if (calendar) calendar.updateSize();
                            break;
                        case 'asignaciones':
                            cargarListaAsignaciones();
                            break;
                        case 'dashboard':
                            actualizarDashboard();
                            break;
                    }
                }, 100);
            }

            // ===== ACTUALIZAR EVENTO EN BD - VERSI√ìN CORREGIDA PARA HISTORIAL =====
            async function actualizarEventoEnBD(event) {
                if (!event.extendedProps?.id_asignacion) {
                    console.warn('‚ö†Ô∏è Evento sin ID de asignaci√≥n');
                    return;
                }

                try {
                    const datos = {
                        fecha_inicio: event.start.toISOString().split('T')[0],
                        fecha_fin: event.end ? event.end.toISOString().split('T')[0] : null,
                        id_tienda_nueva: event.extendedProps?.id_tienda,
                        manejar_cambio_tienda: true
                    };

                    console.log('üîÑ Actualizando evento con manejo de historial:', datos);

                    const response = await fetch(`${window.location.origin}/promotoria/api/hoja_horario.php?resource=asignaciones&id=${event.extendedProps.id_asignacion}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(datos)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const resultado = await response.json();
                    if (!resultado.success) throw new Error(resultado.message);

                    console.log('‚úÖ Evento actualizado en BD con historial');

                    if (resultado.cambio_tienda) {
                        console.log('üè™ Cambio de tienda registrado en historial');
                    }

                } catch (error) {
                    console.error('‚ùå Error actualizando evento:', error);
                    alert('Error actualizando en la base de datos');
                    aplicarFiltroTienda(); // Refrescar vista
                }
            }

            // ===== DASHBOARD Y REPORTES =====
            function actualizarDashboard() {
                // Usar todosLosEventos en lugar de calendar.getEvents()
                const events = todosLosEventos || [];
                const totalAssignments = events.length;
                const totalHours = events.reduce((total, event) => {
                    if (event.end && event.start) {
                        return total + (new Date(event.end) - new Date(event.start)) / (1000 * 60 * 60);
                    }
                    return total + 8;
                }, 0);

                // Conteo mejorado de tiendas √∫nicas
                const tiendasUnicas = new Set();

                events.forEach((event) => {
                    const props = event.extendedProps;

                    if (props) {
                        let tiendaIdentificador = null;

                        if (props.numero_tienda && props.cadena) {
                            tiendaIdentificador = `${props.cadena}_#${props.numero_tienda}`;
                        }
                        else if (props.numero_tienda) {
                            tiendaIdentificador = `tienda_${props.numero_tienda}`;
                        }
                        else if (props.id_tienda) {
                            tiendaIdentificador = `id_${props.id_tienda}`;
                        }
                        else if (props.nombre_tienda && props.cadena) {
                            tiendaIdentificador = `${props.cadena}_${props.nombre_tienda}`;
                        }
                        else if (props.nombre_tienda) {
                            tiendaIdentificador = props.nombre_tienda;
                        }

                        if (tiendaIdentificador) {
                            tiendasUnicas.add(tiendaIdentificador);
                        }
                    }
                });

                const activeStores = Math.max(tiendasUnicas.size, 0);
                const coverage = Math.min(100, Math.round((totalAssignments / 30) * 100));

                // Actualizar m√©tricas en la interfaz
                const elementos = {
                    'total-assignments': totalAssignments,
                    'total-hours': Math.round(totalHours) + 'h',
                    'active-stores': activeStores,
                    'coverage-percentage': coverage + '%'
                };

                Object.entries(elementos).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                });

                // Actualizar gr√°fico y resumen
                actualizarGraficoDistribucion(events);
                actualizarResumenOperativo(events);
            }

            function actualizarGraficoDistribucion(events) {
                const chartContainer = document.getElementById('chart-visual-container');
                if (!chartContainer) return;

                const distributionMap = {};
                events.forEach(event => {
                    const promotor = event.extendedProps?.nombre_promotor || 'Sin asignar';
                    distributionMap[promotor] = (distributionMap[promotor] || 0) + 1;
                });

                let html = '';
                const total = events.length || 1;

                Object.entries(distributionMap).forEach(([promotor, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const className = promotor.toLowerCase().includes('cubredescansos') ? 'maria-bar' : 'juan-bar';

                    html += `
                        <div class="promotor-chart-item">
                            <div class="chart-bar ${className}" style="width: ${percentage}%;">
                                <span>${promotor} - ${percentage}%</span>
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = '<div style="text-align: center; color: var(--text-secondary);">No hay datos para mostrar</div>';
                }

                chartContainer.innerHTML = html;
            }

            function actualizarResumenOperativo(events) {
                const summaryContainer = document.getElementById('summary-grid');
                if (!summaryContainer) return;

                const totalPromotores = new Set(events.map(e => e.extendedProps?.id_promotor).filter(p => p)).size;
                const totalTiendas = new Set(events.map(e => e.extendedProps?.numero_tienda).filter(t => t)).size;
                const promedioAsignaciones = totalPromotores > 0 ? Math.round(events.length / totalPromotores) : 0;

                const html = `
                    <div class="summary-item">
                        <strong>Promotores Activos:</strong> ${totalPromotores} con asignaciones
                    </div>
                    <div class="summary-item">
                        <strong>Tiendas Cubiertas:</strong> ${totalTiendas} tiendas con cobertura
                    </div>
                    <div class="summary-item">
                        <strong>Promedio de Asignaciones:</strong> ${promedioAsignaciones} por promotor
                    </div>
                    <div class="summary-item">
                        <strong>Estado:</strong> ${datosAutomaticosExitosos ? '‚úÖ Datos cargados autom√°ticamente desde BD' : '‚ö†Ô∏è Datos de ejemplo o vac√≠os'}
                    </div>
                `;

                summaryContainer.innerHTML = html;
            }

            // ===== FUNCIONES PLACEHOLDER PARA OTRAS FUNCIONALIDADES =====
            // ===== CARGAR LISTA DE ASIGNACIONES CON DESCANSOS AUTOM√ÅTICOS =====
            function cargarListaAsignaciones() {
                const assignmentsList = document.getElementById('assignments-list');
                if (!assignmentsList) return;

                // Usar todosLosEventos en lugar de calendar.getEvents()
                const events = todosLosEventos || [];

                if (events.length === 0) {
                    assignmentsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-calendar" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>No hay asignaciones en el calendario</h3>
            </div>
        `;
                    return;
                }

                const filtroTienda = document.getElementById('filter-tienda')?.value || '';
                const filtroPeriodo = document.getElementById('filter-periodo')?.value || 'mes';

                if (!filtroTienda) {
                    assignmentsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-store" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>Selecciona una tienda del filtro</h3>
            </div>
        `;
                    return;
                }

                // CALCULAR RANGO DE FECHAS SEG√öN PERIODO
                const hoy = new Date();
                let fechaInicio, fechaFin;

                switch (filtroPeriodo) {
                    case 'semana':
                        fechaInicio = new Date(hoy);
                        fechaInicio.setDate(hoy.getDate() - hoy.getDay());
                        fechaFin = new Date(fechaInicio);
                        fechaFin.setDate(fechaInicio.getDate() + 6);
                        break;
                    case 'trimestre':
                        fechaInicio = new Date(hoy.getFullYear(), Math.floor(hoy.getMonth() / 3) * 3, 1);
                        fechaFin = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth() + 3, 0);
                        break;
                    case 'mes':
                    default:
                        fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                        fechaFin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
                        break;
                }

                // FILTRAR EVENTOS POR TIENDA
                let eventosTienda = events.filter(e => e.extendedProps.id_tienda == filtroTienda);

                if (eventosTienda.length === 0) {
                    assignmentsList.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--warning-color);"></i>
                <h3>Esta tienda no tiene asignaciones en el calendario</h3>
            </div>
        `;
                    return;
                }

                // AGRUPAR POR PROMOTOR Y A√ëADIR D√çAS DE DESCANSO
                const promotores = {};
                let tiendaNombre = '';

                eventosTienda.forEach(event => {
                    const props = event.extendedProps;

                    if (!tiendaNombre) {
                        tiendaNombre = props.cadena ? `${props.cadena} #${props.numero_tienda}` : props.nombre_tienda;
                    }

                    const idPromotor = props.id_promotor;
                    if (!promotores[idPromotor]) {
                        promotores[idPromotor] = {
                            nombre: props.nombre_promotor,
                            tipo: props.tipo_trabajo,
                            dias: [],
                            diaDescanso: null
                        };
                    }

                    promotores[idPromotor].dias.push({
                        fecha: new Date(event.start),
                        esDescanso: false,
                        esTrabajo: true
                    });
                });

                // OBTENER D√çAS DE DESCANSO DE PROMOTORESDATA
                Object.keys(promotores).forEach(idPromotor => {
                    const promotorData = promotoresData.find(p => p.id_promotor == idPromotor);
                    if (promotorData && promotorData.dia_descanso) {
                        promotores[idPromotor].diaDescanso = promotorData.dia_descanso.toUpperCase();
                    }
                });

                // GENERAR D√çAS DE DESCANSO PARA EL RANGO
                Object.keys(promotores).forEach(idPromotor => {
                    const promotor = promotores[idPromotor];

                    if (!promotor.diaDescanso) return;

                    const diasSemana = {
                        'LUNES': 1, 'MARTES': 2, 'MI√âRCOLES': 3, 'MIERCOLES': 3,
                        'JUEVES': 4, 'VIERNES': 5, 'S√ÅBADO': 6, 'SABADO': 6, 'DOMINGO': 0
                    };

                    const diaDescansoNum = diasSemana[promotor.diaDescanso];
                    if (diaDescansoNum === undefined) return;

                    const fechaActual = new Date(fechaInicio);
                    while (fechaActual <= fechaFin) {
                        if (fechaActual.getDay() === diaDescansoNum) {
                            const yaExiste = promotor.dias.some(d =>
                                d.fecha.toDateString() === fechaActual.toDateString()
                            );

                            if (!yaExiste) {
                                promotor.dias.push({
                                    fecha: new Date(fechaActual),
                                    esDescanso: true,
                                    esTrabajo: false
                                });
                            }
                        }
                        fechaActual.setDate(fechaActual.getDate() + 1);
                    }
                });

                // ORDENAR D√çAS
                Object.values(promotores).forEach(p => {
                    p.dias.sort((a, b) => a.fecha - b.fecha);
                });

                // GENERAR HTML
                let html = `
        <div style="background: linear-gradient(135deg, #26c6da, #00acc1); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <h2 style="margin: 0;"><i class="fas fa-store"></i> ${tiendaNombre}</h2>
            <p style="margin: 5px 0 0 0;">
                ${Object.keys(promotores).length} promotor(es) ‚Ä¢ 
                Per√≠odo: ${fechaInicio.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - 
                ${fechaFin.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}
            </p>
        </div>
    `;

                Object.values(promotores).forEach(promotor => {
                    const diasTrabajo = promotor.dias.filter(d => d.esTrabajo).length;
                    const diasDescanso = promotor.dias.filter(d => d.esDescanso).length;

                    html += `
            <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid var(--primary-color);">
                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                    <h3 style="margin: 0 0 8px 0;">${promotor.nombre}</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <span style="font-size: 0.9rem; color: #666;">
                            <i class="fas fa-briefcase" style="color: var(--success-color);"></i> 
                            ${diasTrabajo} d√≠a(s) de trabajo
                        </span>
                        <span style="font-size: 0.9rem; color: #666;">
                            <i class="fas fa-bed" style="color: var(--danger-color);"></i> 
                            ${diasDescanso} d√≠a(s) de descanso
                        </span>
                        ${promotor.diaDescanso ? `
                        <span style="font-size: 0.9rem; color: var(--info-color); font-weight: 600;">
                            <i class="fas fa-calendar-day"></i> 
                            Descansa: ${promotor.diaDescanso}
                        </span>
                        ` : ''}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
        `;

                    promotor.dias.forEach(dia => {
                        const esDescanso = dia.esDescanso;
                        const nombreDia = dia.fecha.toLocaleDateString('es-ES', { weekday: 'short' });

                        // Determinar per√≠odo temporal
                        const periodo = determinarPeriodoTemporal(dia.fecha);
                        let bordeTemporal = '';
                        let emojiTemporal = '';

                        if (periodo === 'present') {
                            bordeTemporal = 'border: 3px solid #4CAF50; box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);';
                            emojiTemporal = '‚ñ∂Ô∏è ';
                        } else {
                            // Pasado (historial)
                            bordeTemporal = 'border: 3px solid #9e9e9e;';
                            emojiTemporal = '‚èÆÔ∏è ';
                        }

                        html += `
                <div style="
                    padding: 12px 8px;
                    border-radius: 10px;
                    text-align: center;
                    transition: transform 0.2s;
                    ${bordeTemporal}
                    ${esDescanso ?
                                'background: linear-gradient(135deg, #ffebee, #ffcdd2); color: #c62828;' :
                                'background: linear-gradient(135deg, #e8f5e8, #c8e6c9); color: #2e7d32;'}
                " onmouseover="this.style.transform='translateY(-2px) scale(1.05)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                    <div style="font-size: 0.7rem; margin-bottom: 3px;">${emojiTemporal}</div>
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 3px;">${dia.fecha.getDate()}</div>
                    <div style="font-size: 0.7rem; text-transform: capitalize; opacity: 0.9; margin-bottom: 5px;">
                        ${nombreDia}
                    </div>
                    <div style="
                        padding: 4px 8px;
                        border-radius: 6px;
                        font-size: 0.65rem;
                        font-weight: 700;
                        ${esDescanso ? 'background: #c62828; color: white;' : 'background: #2e7d32; color: white;'}
                    ">
                        ${esDescanso ? 'DESCANSO' : 'TRABAJO'}
                    </div>
                </div>
            `;
                    });

                    html += `</div></div>`;
                });

                assignmentsList.innerHTML = html;
            }

            // ===== FUNCIONES DE MODAL COMPLETAS - CORREGIDAS =====
            function openEventModal(event = null, startDate = null, endDate = null) {
                const modal = document.getElementById('modal-evento-horas');
                if (!modal) return;

                console.log('üìù Abriendo modal de evento');
                currentEvent = event;

                // LIMPIAR MODAL SIEMPRE AL ABRIR
                limpiarModal();

                // Si es un evento existente, llenar datos
                if (event) {
                    console.log('‚úèÔ∏è Editando evento existente');
                    llenarDatosEvento(event);
                    document.getElementById('btn-eliminar-horas').style.display = 'block';
                } else {
                    console.log('‚ûï Creando nuevo evento');
                    // Si hay fecha de inicio, setearla
                    if (startDate) {
                        document.getElementById('event-fecha-horas').value = startDate.toISOString().split('T')[0];
                    }
                    document.getElementById('btn-eliminar-horas').style.display = 'none';
                }

                modal.style.display = 'block';
            }

            function limpiarModal() {
                // Limpiar todos los campos del formulario
                document.getElementById('event-promotor-horas').value = '';
                document.getElementById('event-tienda-horas').value = '';
                document.getElementById('event-tipo-horas').value = 'fijo-principal';
                document.getElementById('event-horario-horas').value = '6-14';
                document.getElementById('event-fecha-horas').value = '';
                document.getElementById('event-notas-horas').value = '';

                // Limpiar selector de asignaci√≥n m√∫ltiple
                document.getElementById('assignment-type-selector').value = 'single';
                document.getElementById('fecha-inicio-multiple').value = '';
                document.getElementById('fecha-fin-multiple').value = '';

                // Limpiar checkboxes de d√≠as
                document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });

                // Mostrar/ocultar secciones correctas
                document.getElementById('single-date-group').style.display = 'block';
                document.getElementById('multiple-assignment-group').style.display = 'none';
                document.getElementById('assignment-preview').style.display = 'none';

                console.log('üßπ Modal limpiado correctamente');
            }

            function llenarDatosEvento(event) {
                const props = event.extendedProps;

                if (props.id_promotor) {
                    document.getElementById('event-promotor-horas').value = props.id_promotor;
                }
                if (props.id_tienda) {
                    document.getElementById('event-tienda-horas').value = props.id_tienda;
                }
                if (event.start) {
                    document.getElementById('event-fecha-horas').value = event.start.toISOString().split('T')[0];
                }
                if (props.motivo_asignacion) {
                    document.getElementById('event-notas-horas').value = props.motivo_asignacion;
                }
            }

            function closeModal() {
                const modal = document.getElementById('modal-evento-horas');
                if (modal) modal.style.display = 'none';
                currentEvent = null;
                limpiarModal();
            }

            // ===== FUNCI√ìN: ACTUALIZAR EVENTO EXISTENTE =====
            async function actualizarEventoExistente(event, nuevosDatos) {
                try {
                    console.log('‚úèÔ∏è Actualizando evento existente...', nuevosDatos);

                    const cambioTienda = nuevosDatos.id_tienda != event.extendedProps.id_tienda;

                    if (cambioTienda) {
                        nuevosDatos.manejar_cambio_tienda = true;
                        nuevosDatos.id_tienda_nueva = nuevosDatos.id_tienda;
                    }

                    const response = await fetch(`${window.location.origin}/promotoria/api/hoja_horario.php?resource=asignaciones&id=${event.extendedProps.id_asignacion}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(nuevosDatos)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const resultado = await response.json();
                    if (!resultado.success) throw new Error(resultado.message);

                    // Actualizar evento en el array global
                    const index = todosLosEventos.findIndex(e => e.id === event.id);
                    if (index !== -1) {
                        const promotor = promotoresData.find(p => p.id_promotor == nuevosDatos.id_promotor);
                        const tienda = tiendasData.find(t => t.id_tienda == nuevosDatos.id_tienda);

                        if (promotor && tienda) {
                            todosLosEventos[index].title = `${promotor.nombre} ${promotor.apellido} - ${tienda.cadena} #${tienda.num_tienda}`;
                            todosLosEventos[index].start = nuevosDatos.fecha_inicio;
                            todosLosEventos[index].extendedProps.motivo_asignacion = nuevosDatos.motivo_asignacion;
                            todosLosEventos[index].extendedProps.id_tienda = nuevosDatos.id_tienda;
                        }
                    }

                    aplicarFiltroTienda();
                    actualizarDashboard();
                    console.log('‚úÖ Evento actualizado correctamente');

                } catch (error) {
                    console.error('‚ùå Error actualizando evento:', error);
                    throw error;
                }
            }

            // ===== FUNCI√ìN: ELIMINAR EVENTO =====
            async function eliminarEvento() {
                if (!currentEvent || !currentEvent.extendedProps.id_asignacion) {
                    alert('No se puede eliminar este evento');
                    return;
                }

                if (!confirm('¬øEst√°s seguro de que deseas eliminar esta asignaci√≥n?')) {
                    return;
                }

                try {
                    console.log('üóëÔ∏è Eliminando evento...');

                    const response = await fetch(`${window.location.origin}/promotoria/api/hoja_horario.php?resource=asignaciones&id=${currentEvent.extendedProps.id_asignacion}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const resultado = await response.json();
                    if (!resultado.success) throw new Error(resultado.message);

                    // Remover del array global
                    todosLosEventos = todosLosEventos.filter(e => e.id !== currentEvent.id);

                    aplicarFiltroTienda();
                    actualizarDashboard();
                    closeModal();

                    console.log('‚úÖ Evento eliminado correctamente');

                } catch (error) {
                    console.error('‚ùå Error eliminando evento:', error);
                    alert('Error eliminando el evento: ' + error.message);
                }
            }

            // ===== HELPER: DETERMINAR CLASE CSS DEL EVENTO =====
            function determinarClaseEvento(tipo) {
                switch (tipo) {
                    case 'fijo-principal': return 'event-fijo-principal';
                    case 'fijo-rotacion': return 'event-fijo-rotacion';
                    case 'cubredescansos-apoyo': return 'event-cubredescansos-apoyo';
                    case 'cubredescansos-otros': return 'event-cubredescansos-otros';
                    case 'descanso': return 'event-descanso';
                    default: return 'event-fijo-principal';
                }
            }

            // ===== FUNCI√ìN: MANEJAR SELECTOR DE TIPO DE ASIGNACI√ìN =====
            function manejarSelectorTipoAsignacion() {
                const selector = document.getElementById('assignment-type-selector');
                const singleGroup = document.getElementById('single-date-group');
                const multipleGroup = document.getElementById('multiple-assignment-group');

                if (!selector || !singleGroup || !multipleGroup) return;

                selector.addEventListener('change', function () {
                    if (this.value === 'multiple') {
                        singleGroup.style.display = 'none';
                        multipleGroup.style.display = 'block';
                    } else {
                        singleGroup.style.display = 'block';
                        multipleGroup.style.display = 'none';
                    }
                });
            }

            // ===== FUNCTION: CONFIGURAR EVENT LISTENERS DEL MODAL =====
            function configurarEventListenersModal() {
                console.log('üéØ Configurando event listeners del modal...');

                // Bot√≥n Guardar
                const btnGuardar = document.getElementById('btn-guardar-horas');
                if (btnGuardar) {
                    btnGuardar.replaceWith(btnGuardar.cloneNode(true));
                    const newBtnGuardar = document.getElementById('btn-guardar-horas');
                    newBtnGuardar.addEventListener('click', guardarEvento);
                }

                // Bot√≥n Cancelar
                const btnCancelar = document.getElementById('btn-cancelar-horas');
                if (btnCancelar) {
                    btnCancelar.replaceWith(btnCancelar.cloneNode(true));
                    const newBtnCancelar = document.getElementById('btn-cancelar-horas');
                    newBtnCancelar.addEventListener('click', closeModal);
                }

                // Bot√≥n Eliminar
                const btnEliminar = document.getElementById('btn-eliminar-horas');
                if (btnEliminar) {
                    btnEliminar.replaceWith(btnEliminar.cloneNode(true));
                    const newBtnEliminar = document.getElementById('btn-eliminar-horas');
                    newBtnEliminar.addEventListener('click', eliminarEvento);
                }

                // Bot√≥n X (cerrar)
                const btnCerrar = document.querySelector('.close-horas');
                if (btnCerrar) {
                    btnCerrar.replaceWith(btnCerrar.cloneNode(true));
                    const newBtnCerrar = document.querySelector('.close-horas');
                    newBtnCerrar.addEventListener('click', closeModal);
                }

                // Configurar selector de tipo de asignaci√≥n
                manejarSelectorTipoAsignacion();

                // Event listener para selecci√≥n de d√≠as
                configurarSelectoresDias();

                console.log('üéâ Todos los event listeners del modal configurados');
            }

            // ===== FUNCI√ìN: CONFIGURAR SELECTORES DE D√çAS =====
            function configurarSelectoresDias() {
                // Bot√≥n "Todos"
                const btnTodos = document.getElementById('select-all-days');
                if (btnTodos) {
                    btnTodos.addEventListener('click', function () {
                        document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => {
                            cb.checked = true;
                        });
                    });
                }

                // Bot√≥n "L-V"
                const btnSemana = document.getElementById('select-weekdays');
                if (btnSemana) {
                    btnSemana.addEventListener('click', function () {
                        document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => {
                            const day = parseInt(cb.value);
                            cb.checked = day >= 1 && day <= 5;
                        });
                    });
                }

                // Bot√≥n "Fin de semana"
                const btnFinSemana = document.getElementById('select-weekend');
                if (btnFinSemana) {
                    btnFinSemana.addEventListener('click', function () {
                        document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => {
                            const day = parseInt(cb.value);
                            cb.checked = day === 0 || day === 6;
                        });
                    });
                }

                // Bot√≥n "Limpiar"
                const btnLimpiar = document.getElementById('clear-days');
                if (btnLimpiar) {
                    btnLimpiar.addEventListener('click', function () {
                        document.querySelectorAll('#days-selector input[type="checkbox"]').forEach(cb => {
                            cb.checked = false;
                        });
                    });
                }
            }

            // ===== EVENT LISTENERS =====
            function initializeEventListeners() {
                console.log('üéØ Configurando event listeners...');

                // Navegaci√≥n por pesta√±as
                document.querySelectorAll('.tab-item').forEach(tab => {
                    addListener(tab, 'click', function () {
                        switchTab(this.dataset.tab);
                    });
                });

                // Botones principales
                const btnNueva = document.getElementById('btn-nueva-asignacion');
                if (btnNueva) addListener(btnNueva, 'click', () => openEventModal());

                const btnGenerar = document.getElementById('btn-generar-horarios');
                if (btnGenerar) {
                    addListener(btnGenerar, 'click', () => {
                        const totalEvents = todosLosEventos.length;
                        alert(`INFORMACI√ìN DE CARGA AUTOM√ÅTICA:\n\n‚úÖ Los datos reales ya est√°n cargados autom√°ticamente desde la base de datos\n\nüìä Total asignaciones activas: ${totalEvents}\n\nüí° Este bot√≥n ahora sirve para generar horarios adicionales basados en fechas de ingreso o para recargar datos.\n\nESTADO: ${datosAutomaticosExitosos ? 'DATOS REALES CARGADOS' : 'SIN ASIGNACIONES EN BD'}`);
                    });
                }

                const btnDashboard = document.getElementById('btn-dashboard-horas');
                if (btnDashboard) addListener(btnDashboard, 'click', () => switchTab('dashboard'));

                // Controles de vista del calendario
                document.querySelectorAll('.view-btn').forEach(btn => {
                    addListener(btn, 'click', function () {
                        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        if (calendar) calendar.changeView(this.dataset.view);
                    });
                });

                // Cerrar modal al hacer clic fuera
                addListener(window, 'click', function (event) {
                    const modal = document.getElementById('modal-evento-horas');
                    if (event.target === modal) closeModal();
                });

                // Configurar event listeners del modal
                configurarEventListenersModal();

                console.log('‚úÖ Event listeners configurados');
            }

            // ===== FUNCIONES GLOBALES PARA COMPATIBILIDAD =====
            window.actualizarListaAsignaciones = function () {
                cargarListaAsignaciones();
            };

            window.generarReporte = function () {
                const reportOutput = document.getElementById('report-output');
                if (!reportOutput) return;

                const events = todosLosEventos || [];
                const totalHoras = events.length * 8;

                const reportContent = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-color);">üìä Reporte Autom√°tico del Sistema (Historial y Presente)</h2>
                        <p style="color: ${datosAutomaticosExitosos ? 'var(--success-color)' : 'var(--warning-color)'};">
                            ${datosAutomaticosExitosos ? '‚úÖ Datos cargados autom√°ticamente desde la base de datos' : '‚ö†Ô∏è Datos de ejemplo o sin conexi√≥n a BD'}
                        </p>
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid var(--border-color);">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #1976d2;">Total Asignaciones</h4>
                            <div style="font-size: 2rem; font-weight: bold;">${events.length}</div>
                            <small>${datosAutomaticosExitosos ? 'Desde base de datos' : 'Datos de ejemplo'}</small>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: var(--success-color);">Horas Programadas</h4>
                            <div style="font-size: 2rem; font-weight: bold;">${totalHoras}h</div>
                            <small>Estimado (8h por asignaci√≥n)</small>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: var(--warning-color);">Estado del Sistema</h4>
                            <div style="font-size: 1.2rem; font-weight: bold;">${datosAutomaticosExitosos ? '‚úÖ CONECTADO' : '‚ö†Ô∏è SIN DATOS'}</div>
                            <small>${datosAutomaticosExitosos ? 'BD Activa' : 'Revisar conexi√≥n'}</small>
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: var(--secondary-color);">Promotores</h4>
                            <div style="font-size: 2rem; font-weight: bold;">${promotoresData.length}</div>
                            <small>Registrados en BD</small>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                        ${datosAutomaticosExitosos ?
                        `<h3 style="color: var(--success-color);">‚úÖ M√≥dulo Completo (Historial y Presente)</h3>
                            <ul style="line-height: 1.8;">
                                <li>üöÄ Datos cargados autom√°ticamente al inicializar el sistema</li>
                                <li>üìä ${events.length} asignaciones activas desde BD</li>
                                <li>üë• ${promotoresData.length} promotores ‚Ä¢ üè™ ${tiendasData.length} tiendas</li>
                                <li>üîç <strong>Filtro de tienda activo en calendario</strong></li>
                                <li>‚èÆÔ∏è‚ñ∂Ô∏è <strong>Indicadores temporales: Historial (pasado) / Trabajando hoy (presente)</strong></li>
                                <li>üéØ Vista espec√≠fica por tienda con promotores asignados</li>
                                <li>üîÑ Sincronizaci√≥n autom√°tica con base de datos</li>
                            </ul>` :
                        `<h3 style="color: var(--warning-color);">‚ö†Ô∏è Sin Datos Autom√°ticos</h3>
                            <ul style="line-height: 1.8;">
                                <li>üìä No se encontraron asignaciones activas en la base de datos</li>
                                <li>üîç Revisa la configuraci√≥n de la API y base de datos</li>
                                <li>üí° Puedes agregar asignaciones manualmente</li>
                            </ul>`
                    }
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                        <small>
                            üìÖ Reporte generado el ${new Date().toLocaleString('es-ES')}<br>
                            üîß Estado: ${datosAutomaticosExitosos ? '‚úÖ SISTEMA COMPLETO (HISTORIAL Y PRESENTE)' : '‚ö†Ô∏è SISTEMA SIN CONEXI√ìN'}
                        </small>
                    </div>
                `;

                reportOutput.innerHTML = reportContent;
            };

            // ===== INICIAR M√ìDULO =====
            console.log('üèÅ Preparando para inicializar m√≥dulo (solo historial y presente)...');
            initModule();

        })();
    </script>

</body>

</html>