<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Zonas y Regiones - Sistema de Promotoría</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ===== RESET Y ESTILOS GENERALES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ===== VARIABLES CSS ===== */
        :root {
            --zone-primary: #667eea;
            --zone-primary-hover: #5a67d8;
            --zone-secondary: #764ba2;
            --zone-light: #e0e7ff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        /* ===== MÓDULO PRINCIPAL ===== */
        .zonas-module {
            padding: 0;
            max-width: 100%;
        }

        /* ===== HEADER DEL MÓDULO ===== */
        .module-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--zone-primary) 0%, var(--zone-secondary) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .header-title h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ===== CONTROLES DE BÚSQUEDA ===== */
        .search-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-select,
        .search-input {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-select {
            min-width: 200px;
            background: white;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .search-select:focus,
        .search-input:focus {
            border-color: var(--zone-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input:disabled {
            background: #f8f9fa;
            color: #666;
            cursor: not-allowed;
        }

        /* ===== BOTONES ===== */
        .btn-primary,
        .btn-secondary,
        .btn-danger,
        .btn-search,
        .btn-clear,
        .btn-action,
        .btn-pagination {
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--zone-primary) 0%, var(--zone-secondary) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-search {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
            padding: 12px 16px;
        }

        .btn-search:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-clear {
            background: #6c757d;
            color: white;
            padding: 12px 16px;
        }

        .btn-clear:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-action {
            padding: 8px 12px;
            font-size: 0.8rem;
            margin: 0 2px;
        }

        .btn-action.view {
            background: var(--info-color);
            color: white;
        }

        .btn-action.view:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-action.edit {
            background: var(--warning-color);
            color: white;
        }

        .btn-action.edit:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-action.delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-action.delete:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== TABLA ===== */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .zonas-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .zonas-table th {
            background: linear-gradient(135deg, var(--zone-primary) 0%, var(--zone-secondary) 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .zonas-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .zonas-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .zonas-table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            vertical-align: middle;
        }

        .zonas-table tbody tr {
            transition: all 0.3s ease;
        }

        .zonas-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .zonas-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== BADGES Y ESTADOS ===== */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.activo {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-badge.inactivo {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .count-badge {
            background: var(--zone-light);
            color: var(--zone-primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ===== LISTAS DE ASIGNACIONES ===== */
        .asignacion-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .asignacion-container .form-group {
            flex: 1;
            min-width: 250px;
            margin-bottom: 0;
        }

        .select-asignacion {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .select-asignacion:focus {
            border-color: var(--zone-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .lista-asignados,
        .lista-asignaciones {
            background: #f8fafc;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .lista-asignados.empty::after,
        .lista-asignaciones.empty::after {
            content: "No hay elementos asignados";
            color: var(--text-secondary);
            font-style: italic;
            width: 100%;
            text-align: center;
            padding: 1rem 0;
        }

        .asignado-badge {
            background: white;
            border: 2px solid var(--zone-primary);
            color: var(--zone-primary);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .asignado-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .asignado-remove {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            transition: all 0.2s ease;
        }

        .asignado-remove:hover {
            color: #c0392b;
            transform: scale(1.2);
        }

        /* ===== 🆕 AUTOCOMPLETE MEJORADO (FLECHA DENTRO) ===== */
        .autocomplete-container {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        /* 🆕 INPUT CON ESPACIO PARA LA FLECHA */
        .autocomplete-container .form-input,
        .autocomplete-input {
            width: 100%;
            padding: 10px 45px 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
            color: var(--text-primary);
            box-sizing: border-box;
        }

        .autocomplete-container .form-input:focus,
        .autocomplete-input:focus {
            border-color: var(--zone-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .autocomplete-container .form-input::placeholder,
        .autocomplete-input::placeholder {
            color: #999;
        }

        /* 🆕 BOTÓN DE FLECHA DENTRO DEL INPUT */
        .autocomplete-dropdown-btn {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            z-index: 1;
            border-radius: 0 8px 8px 0;
        }

        .autocomplete-dropdown-btn:hover {
            color: var(--zone-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .autocomplete-dropdown-btn:active {
            background: rgba(102, 126, 234, 0.1);
        }

        .autocomplete-dropdown-btn:focus {
            outline: none;
        }

        .autocomplete-dropdown-btn.active {
            color: var(--zone-primary);
            background: rgba(102, 126, 234, 0.08);
        }

        .autocomplete-dropdown-btn i {
            font-size: 14px;
            pointer-events: none;
            transition: transform 0.3s ease;
        }

        .autocomplete-dropdown-btn.active i {
            transform: rotate(180deg);
        }

        /* 🆕 DROPDOWN DE SUGERENCIAS */
        .autocomplete-suggestions {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--zone-primary);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.2s ease;
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 🆕 CADA SUGERENCIA */
        .autocomplete-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }

        .autocomplete-suggestion:first-child {
            border-radius: 8px 8px 0 0;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.selected {
            background: var(--zone-light);
        }

        .autocomplete-suggestion:active {
            background: rgba(102, 126, 234, 0.15);
        }

        /* 🆕 NOMBRE DEL ITEM */
        .autocomplete-suggestion-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .autocomplete-suggestion-name i {
            color: var(--zone-primary);
            font-size: 14px;
            flex-shrink: 0;
        }

        /* 🆕 DETALLES ADICIONALES */
        .autocomplete-suggestion-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .autocomplete-suggestion-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .autocomplete-suggestion-details i {
            font-size: 12px;
            color: #999;
        }

        /* 🆕 BADGES EN SUGERENCIAS */
        .autocomplete-suggestion-badge {
            background: #e0e7ff;
            color: var(--zone-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* 🆕 MENSAJE SIN RESULTADOS */
        .autocomplete-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .autocomplete-no-results i {
            font-size: 16px;
        }

        .autocomplete-loading {
            padding: 12px 15px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* 🆕 SCROLLBAR PERSONALIZADO PARA DROPDOWN */
        .autocomplete-suggestions::-webkit-scrollbar {
            width: 8px;
        }

        .autocomplete-suggestions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .autocomplete-suggestions::-webkit-scrollbar-thumb {
            background: var(--zone-primary);
            border-radius: 4px;
        }

        .autocomplete-suggestions::-webkit-scrollbar-thumb:hover {
            background: var(--zone-primary-hover);
        }

        /* 🆕 ESTADOS ESPECIALES */
        .autocomplete-container .form-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            color: #999;
        }

        .autocomplete-container .form-input.error {
            border-color: var(--danger-color);
        }

        .autocomplete-container .form-input.success {
            border-color: var(--success-color);
        }

        /* ===== LOADING Y EMPTY STATES ===== */
        .table-loading,
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top-color: var(--zone-primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--border-color);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* ===== PAGINACIÓN ===== */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pagination-pages {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .btn-pagination {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-pagination:hover:not(:disabled) {
            background: var(--zone-primary);
            color: white;
            border-color: var(--zone-primary);
            transform: translateY(-2px);
        }

        /* ===== MODALES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-container.modal-large {
            max-width: 900px;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--zone-primary) 0%, var(--zone-secondary) 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-form {
            padding: 2rem;
        }

        /* ===== MODO VISTA ===== */
        .view-mode {
            display: block;
        }

        .info-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: var(--radius);
            border-left: 4px solid var(--zone-primary);
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .info-item:hover {
            border-color: var(--zone-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .info-item label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            word-break: break-word;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }

        /* ===== MODO EDICIÓN ===== */
        .edit-mode {
            display: none;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: var(--radius);
            border-left: 4px solid var(--zone-primary);
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section h3 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--zone-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-helper {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .modal-actions {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ===== NOTIFICACIONES ===== */
        .notifications-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 4px solid;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: notificationSlideIn 0.3s ease;
            position: relative;
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .notification.success .notification-icon {
            color: var(--success-color);
        }

        .notification.error .notification-icon {
            color: var(--danger-color);
        }

        .notification.warning .notification-icon {
            color: var(--warning-color);
        }

        .notification.info .notification-icon {
            color: var(--info-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-content h4 {
            margin: 0 0 5px 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notification-content p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1rem;
            color: #999;
            cursor: pointer;
            padding: 2px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .notification-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* ===== PROMOTORES EN TIENDAS ===== */
        .tienda-badge-wrapper {
            position: relative;
            display: inline-block;
        }

        .tienda-badge-with-promotores {
            cursor: help;
        }

        .promotores-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: white;
            border: 2px solid var(--zone-primary);
            border-radius: 8px;
            padding: 0.75rem;
            min-width: 200px;
            max-width: 300px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            animation: tooltipFadeIn 0.2s ease;
        }

        .tienda-badge-wrapper:hover .promotores-tooltip {
            display: block;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(-5px);
            }
        }

        .promotores-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--zone-primary);
        }

        .promotores-tooltip h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.85rem;
            color: var(--zone-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .promotores-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .promotores-list li {
            padding: 0.25rem 0;
            font-size: 0.8rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .promotores-list li i {
            color: var(--zone-primary);
            font-size: 0.7rem;
        }

        .promotor-count {
            background: var(--zone-primary);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.25rem;
        }

        .no-promotores {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* ===== 🆕 ESTILOS PARA RESTAURACIÓN DE ZONAS ===== */
        .restore-suggestion {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--info-color);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .restore-suggestion.active {
            opacity: 1;
            transform: translateY(0);
        }

        .restore-suggestion-header {
            background: linear-gradient(135deg, var(--info-color) 0%, #2563eb 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .restore-suggestion-header i {
            font-size: 1rem;
        }

        .restore-suggestion-content {
            padding: 16px;
        }

        .restore-suggestion-name {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .restore-suggestion-name strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .restore-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }

        .restore-suggestion-details {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .restore-suggestion-details div {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .restore-suggestion-details i {
            color: var(--info-color);
            font-size: 0.9rem;
        }

        .restore-suggestion-date {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 8px 12px;
            background: #fef3c7;
            border-left: 3px solid var(--warning-color);
            border-radius: 4px;
        }

        .restore-suggestion-date i {
            color: var(--warning-color);
        }

        .restore-suggestion-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f8fafc;
        }

        .btn-restore-ignore,
        .btn-restore-apply {
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .btn-restore-ignore {
            background: #e5e7eb;
            color: var(--text-secondary);
        }

        .btn-restore-ignore:hover {
            background: #d1d5db;
            transform: translateY(-2px);
        }

        .btn-restore-apply {
            background: linear-gradient(135deg, var(--info-color) 0%, #2563eb 100%);
            color: white;
        }

        .btn-restore-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-restore-ignore i,
        .btn-restore-apply i {
            font-size: 0.9rem;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-title {
                flex-direction: column;
            }

            .search-box {
                flex-direction: column;
                align-items: stretch;
            }

            .search-select,
            .search-input {
                min-width: auto;
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .modal-container {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .pagination-container {
                flex-direction: column;
                text-align: center;
            }

            .asignacion-container {
                flex-direction: column;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions button {
                width: 100%;
            }

            .notifications-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }

            .table-wrapper {
                overflow-x: scroll;
            }

            .zonas-table {
                min-width: 800px;
            }

            .autocomplete-container {
                min-width: auto;
            }

            .restore-suggestion-details {
                flex-direction: column;
                gap: 8px;
            }

            .restore-suggestion-actions {
                flex-direction: column;
            }

            .btn-restore-ignore,
            .btn-restore-apply {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .module-header {
                padding: 1rem;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .modal-form {
                padding: 1rem;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            .modal-actions {
                padding: 1rem;
            }

            .info-section,
            .form-section {
                padding: 1rem;
            }
        }

        /* ===== SCROLLBAR PERSONALIZADO ===== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--zone-primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--zone-primary-hover);
        }
    </style>
</head>

<body>
    <div class="zonas-module">
        <div class="module-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-map-marked-alt header-icon"></i>
                    <h1>Gestión de Zonas y Regiones</h1>
                </div>
                <button class="btn-primary" id="btn-nueva-zona">
                    <i class="fas fa-plus"></i> Nueva Zona
                </button>
            </div>
        </div>

        <div class="search-controls">
            <div class="search-box">
                <select id="search-field" class="search-select">
                    <option value="">Seleccionar campo...</option>
                    <option value="nombre_zona">Nombre Zona</option>
                    <option value="numero_region">Número de Región</option>
                    <option value="supervisor">Supervisor Asignado</option>
                    <option value="tienda">Tienda Asignada</option>
                </select>
                <input type="text" id="search-value" placeholder="Valor a buscar..." class="search-input" disabled>
                <button id="btn-buscar" class="btn-search" disabled>
                    <i class="fas fa-search"></i>
                </button>
                <button id="btn-limpiar" class="btn-clear">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-wrapper">
                <table class="zonas-table" id="zonas-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre Zona</th>
                            <th>Región</th>
                            <th>Descripción</th>
                            <th>Supervisores</th>
                            <th>Tiendas</th>
                            <th>Estado</th>
                            <th>Fecha Creación</th>
                            <th>Acciones</th>
                            
                        </tr>
                    </thead>
                    <tbody id="zonas-tbody">
                    </tbody>
                </table>
            </div>

            <div class="table-loading" id="table-loading">
                <div class="loading-spinner"></div>
                <p>Cargando zonas...</p>
            </div>

            <div class="empty-state" id="empty-state" style="display: none;">
                <i class="fas fa-map-slash"></i>
                <h3>No se encontraron zonas</h3>
                <p>No hay zonas que coincidan con los criterios de búsqueda.</p>
            </div>
        </div>

        <div class="pagination-container" id="pagination-container">
            <div class="pagination-info">
                <span id="pagination-info">Cargando...</span>
            </div>
            <div class="pagination-controls">
                <button id="btn-prev" class="btn-pagination" disabled>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-pages" id="pagination-pages"></span>
                <button id="btn-next" class="btn-pagination" disabled>
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-zona">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2 id="modal-title">
                    <i class="fas fa-map-marked-alt"></i> Información de Zona
                </h2>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form class="modal-form" id="form-zona">
                <input type="hidden" id="zona-id">

                <!-- MODO VISTA -->
                <div class="view-mode" id="view-mode">
                    <div class="info-section">
                        <h3><i class="fas fa-info-circle"></i> Información General</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Nombre de la Zona</label>
                                <div class="info-value" id="view-nombre-zona">-</div>
                            </div>
                            <div class="info-item">
                                <label>Región</label>
                                <div class="info-value" id="view-region">-</div>
                            </div>
                            <div class="info-item full-width">
                                <label>Descripción</label>
                                <div class="info-value" id="view-descripcion">-</div>
                            </div>
                            <div class="info-item">
                                <label>Estado</label>
                                <div class="info-value">
                                    <span class="status-badge" id="view-estado-badge">-</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <label>Fecha de Creación</label>
                                <div class="info-value" id="view-fecha-creacion">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3><i class="fas fa-user-tie"></i> Supervisores Asignados</h3>
                        <div id="view-supervisores-list" class="lista-asignaciones">
                        </div>
                    </div>

                    <div class="info-section">
                        <h3><i class="fas fa-store"></i> Tiendas Asignadas</h3>
                        <div id="view-tiendas-list" class="lista-asignaciones">
                        </div>
                    </div>
                </div>

                <!-- MODO EDICIÓN -->
                <div class="edit-mode" id="edit-mode" style="display: none;">
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Información General</h3>

                        <div class="form-group">
                            <label for="zona-nombre">Nombre de la Zona *</label>
                            <input type="text" id="zona-nombre" maxlength="100" required
                                placeholder="Ej: Zona Centro-Norte">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="zona-region">Región *</label>
                                <select id="zona-region" required>
                                    <option value="">Seleccionar región...</option>
                                </select>
                                <small class="form-helper">Región a la que pertenece la zona</small>
                            </div>
                            <div class="form-group">
                                <label for="zona-estado">Estado *</label>
                                <select id="zona-estado" required>
                                    <option value="1">Activo</option>
                                    <option value="0">Inactivo</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="zona-descripcion">Descripción</label>
                            <textarea id="zona-descripcion" rows="3"
                                placeholder="Descripción de la zona, municipios incluidos, etc."></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-user-tie"></i> Asignar Supervisores</h3>

                        <div class="form-group">
                            <label class="form-label">Seleccionar Supervisor</label>

                            <div class="autocomplete-container">
                                <input type="text" class="form-input" id="supervisor-input"
                                    placeholder="Escribe el nombre o haz clic en la flecha para ver todos..."
                                    autocomplete="off">
                                <button type="button" class="autocomplete-dropdown-btn" id="supervisor-dropdown-btn"
                                    title="Ver todos los supervisores">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-suggestions" id="supervisor-suggestions"></div>
                            </div>
                        </div>

                        <div id="supervisores-asignados-list" class="asignados-list empty">
                            <p class="empty-message">No hay supervisores asignados</p>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-store"></i> Asignar Tiendas</h3>

                        <div class="form-group">
                            <label for="tienda-input">Buscar o Seleccionar Tienda</label>
                            <div class="autocomplete-container">
                                <input type="text" id="tienda-input" class="form-input"
                                    placeholder="Escribe el nombre o haz clic en la flecha..." autocomplete="off">
                                <button type="button" id="tienda-dropdown-btn" class="autocomplete-dropdown-btn"
                                    title="Ver todas las tiendas disponibles">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="tienda-suggestions" class="autocomplete-suggestions"></div>
                            </div>
                            <small class="form-helper">Escribe para buscar o haz clic en la flecha para ver
                                todas</small>
                        </div>

                        <div class="lista-asignados" id="tiendas-asignadas-list">
                        </div>
                        <input type="hidden" id="tiendas-asignadas-json">
                    </div>
                </div>

                <div class="modal-actions">
                    <div class="view-actions" id="view-actions">
                        <button type="button" class="btn-secondary" id="btn-cerrar-vista">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                        <button type="button" class="btn-primary" id="btn-editar-zona">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>

                    <div class="edit-actions" id="edit-actions" style="display: none;">
                        <button type="button" class="btn-secondary" id="btn-cancelar-edicion">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-primary" id="btn-guardar">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>

                    <div class="new-actions" id="new-actions" style="display: none;">
                        <button type="button" class="btn-secondary" id="btn-cancelar-nuevo">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-primary" id="btn-crear">
                            <i class="fas fa-save"></i> Crear Zona
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="notifications-container" id="notifications-container"></div>

    <script>
        window.API_CONFIG = {
            baseURL: '/promotoria/api/zonas.php',
            endpoints: {
                list: '?action=list',
                getOne: '?action=get_one',
                create: '?action=create',
                update: '?action=update',
                delete: '?action=delete',
                supervisores: '?action=get_supervisores',
                tiendas: '?action=get_tiendas',
                regiones: '?action=get_regiones'
            }
        };

        console.log('========================================');
        console.log('🔧 CONFIGURACIÓN API ZONAS');
        console.log('========================================');
        console.log('📍 URL Base:', window.API_CONFIG.baseURL);
        console.log('========================================');
    </script>

    <script>
        class ZonasModule {
            constructor() {
                console.log('🏗️ Inicializando módulo de zonas...');

                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.totalItems = 0;
                this.totalPages = 0;
                this.searchField = '';
                this.searchValue = '';
                this.editMode = false;
                this.isNewZona = false;
                this.supervisoresAsignados = [];
                this.tiendasAsignadas = [];
                this.currentZona = null;
                this.supervisoresData = [];
                this.tiendasData = [];
                this.regionesData = [];
                this.selectedRegionId = null;
                this.promotoresPorTienda = {};
                
                // 🆕 SISTEMA DE RESTAURACIÓN
                this.zonasEliminadas = this.loadZonasEliminadas();
                this.justRestoredZona = false; // Flag para evitar que reaparezca el modal

                this.init();
            }

            init() {
                console.log('📌 Vinculando eventos...');
                this.bindEvents();
                console.log('📊 Cargando datos iniciales...');
                this.loadInitialData();
            }

            bindEvents() {
                const btnNuevaZona = document.getElementById('btn-nueva-zona');

                if (!btnNuevaZona) {
                    console.error('❌ ERROR: No se encontró el botón #btn-nueva-zona');
                    return;
                }

                document.getElementById('search-field').addEventListener('change', () => this.handleSearchFieldChange());
                document.getElementById('search-value').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSearch();
                });
                document.getElementById('btn-buscar').addEventListener('click', () => this.handleSearch());
                document.getElementById('btn-limpiar').addEventListener('click', () => this.handleClearSearch());
                document.getElementById('btn-prev').addEventListener('click', () => this.changePage(this.currentPage - 1));
                document.getElementById('btn-next').addEventListener('click', () => this.changePage(this.currentPage + 1));

                btnNuevaZona.addEventListener('click', () => {
                    console.log('🆕 Clic en botón Nueva Zona');
                    this.openNewZonaModal();
                });

                document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
                document.getElementById('btn-cerrar-vista').addEventListener('click', () => this.closeModal());
                document.getElementById('btn-editar-zona').addEventListener('click', () => this.enableEditMode());
                document.getElementById('btn-cancelar-edicion').addEventListener('click', () => this.cancelEdit());
                document.getElementById('btn-cancelar-nuevo').addEventListener('click', () => this.closeModal());
                document.getElementById('form-zona').addEventListener('submit', (e) => this.handleSubmit(e));
                document.getElementById('zona-region').addEventListener('change', (e) => this.handleRegionChange(e));

                // 🆕 Event listener para nombre de zona (con sugerencias de restauración)
                const nombreZonaInput = document.getElementById('zona-nombre');
                if (nombreZonaInput) {
                    nombreZonaInput.addEventListener('input', (e) => this.handleNombreZonaInput(e));
                    nombreZonaInput.addEventListener('focus', (e) => this.handleNombreZonaInput(e));
                }

                // Event listeners para autocomplete de TIENDAS
                const tiendaInput = document.getElementById('tienda-input');
                const tiendaSuggestions = document.getElementById('tienda-suggestions');
                const tiendaDropdownBtn = document.getElementById('tienda-dropdown-btn');

                tiendaInput.addEventListener('input', (e) => this.handleTiendaSearch(e.target.value));
                tiendaInput.addEventListener('focus', (e) => {
                    if (e.target.value && e.target.value.length >= 2) {
                        this.handleTiendaSearch(e.target.value);
                    }
                });
                tiendaDropdownBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.toggleTiendasDropdown();
                });
                tiendaInput.addEventListener('keydown', (e) => this.handleTiendaKeyboard(e));

                // Event listeners para autocomplete de SUPERVISORES
                const supervisorInput = document.getElementById('supervisor-input');
                const supervisorSuggestions = document.getElementById('supervisor-suggestions');
                const supervisorDropdownBtn = document.getElementById('supervisor-dropdown-btn');

                supervisorInput.addEventListener('input', (e) => this.handleSupervisorSearch(e.target.value));
                supervisorInput.addEventListener('focus', (e) => {
                    if (e.target.value && e.target.value.length >= 2) {
                        this.handleSupervisorSearch(e.target.value);
                    }
                });
                supervisorDropdownBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.toggleSupervisoresDropdown();
                });
                supervisorInput.addEventListener('keydown', (e) => this.handleSupervisorKeyboard(e));

                // Cerrar sugerencias al hacer click fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.autocomplete-container')) {
                        tiendaSuggestions.classList.remove('active');
                        tiendaDropdownBtn.classList.remove('active');
                        supervisorSuggestions.classList.remove('active');
                        supervisorDropdownBtn.classList.remove('active');
                    }
                });

                document.getElementById('modal-zona').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-zona') this.closeModal();
                });

                console.log('✅ Todos los eventos vinculados correctamente');
            }

            handleRegionChange(e) {
                const regionId = parseInt(e.target.value);
                console.log('🗺️ Región seleccionada:', regionId);

                this.selectedRegionId = regionId;

                // Limpiar input de búsqueda de tiendas
                const tiendaInput = document.getElementById('tienda-input');
                if (tiendaInput) {
                    tiendaInput.value = '';
                    document.getElementById('tienda-suggestions').classList.remove('active');
                    document.getElementById('tienda-dropdown-btn').classList.remove('active');
                }
            }

            async loadInitialData() {
                console.log('📥 Cargando datos iniciales...');
                await this.loadZonas();
            }

            async apiRequest(endpoint, options = {}) {
                const fullUrl = window.API_CONFIG.baseURL + endpoint;
                console.log('🌐 API Request:', fullUrl);

                try {
                    const response = await fetch(fullUrl, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Error en la solicitud');
                    }

                    return data;
                } catch (error) {
                    console.error('❌ Error en API request:', error);
                    throw error;
                }
            }

            async loadZonas() {
                console.log('📋 === INICIO loadZonas() ===');
                this.showTableLoading();

                try {
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        limit: this.itemsPerPage
                    });

                    if (this.searchField && this.searchValue) {
                        params.append('search_field', this.searchField);
                        params.append('search_value', this.searchValue);
                    }

                    const fullUrl = API_CONFIG.baseURL + '?' + params.toString();

                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.totalItems = data.pagination.total;
                        this.totalPages = data.pagination.total_pages;

                        this.hideTableLoading();

                        if (data.data.length === 0) {
                            this.showEmptyState();
                        } else {
                            this.renderTable(data.data);
                        }

                        this.updatePagination();
                    } else {
                        this.hideTableLoading();
                        this.showNotification('error', 'Error', data.message || 'Error al cargar zonas');
                    }
                } catch (error) {
                    console.error('❌ Error:', error);
                    this.hideTableLoading();
                    this.showNotification('error', 'Error de Conexión',
                        'No se pudieron cargar las zonas. Detalles: ' + error.message);
                }
            }

            renderTable(data) {
                const tbody = document.getElementById('zonas-tbody');

                if (!tbody) {
                    console.error('❌ No se encontró el elemento #zonas-tbody');
                    return;
                }

                tbody.innerHTML = '';

                if (data.length === 0) {
                    this.showEmptyState();
                    return;
                }

                data.forEach((zona) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${zona.id_zona}</td>
                    <td><strong>${zona.nombre_zona}</strong></td>
                    <td>Región ${zona.numero_region} </td>
                    <td>${zona.descripcion || '-'}</td>
                    <td><span class="count-badge">${zona.total_supervisores || 0}</span></td>
                    <td><span class="count-badge">${zona.total_tiendas || 0}</span></td>
                    <td>
                        <span class="status-badge ${zona.activa ? 'activo' : 'inactivo'}">
                            ${zona.activa ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>${zona.fecha_creacion_formatted || '-'}</td>
                    <td>
                        <button class="btn-action view" onclick="zonasModule.viewZona(${zona.id_zona})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action edit" onclick="zonasModule.editZona(${zona.id_zona})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action delete" onclick="zonasModule.deleteZona(${zona.id_zona})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                    tbody.appendChild(row);
                });
            }

            async loadPromotoresDeTiendas() {
                if (this.tiendasAsignadas.length === 0) {
                    this.promotoresPorTienda = {};
                    return;
                }

                try {
                    const tiendasIds = this.tiendasAsignadas.map(t => t.id_tienda);
                    console.log('👥 Cargando promotores para tiendas:', tiendasIds);

                    const response = await this.apiRequest(
                        `?action=get_promotores_tiendas&tiendas=${encodeURIComponent(JSON.stringify(tiendasIds))}`
                    );

                    if (response.success) {
                        this.promotoresPorTienda = response.data;
                        console.log('✅ Promotores cargados:', this.promotoresPorTienda);

                        this.renderTiendasAsignadas();
                    }
                } catch (error) {
                    console.error('❌ Error al cargar promotores:', error);
                    this.promotoresPorTienda = {};
                }
            }

            async viewZona(id) {
                console.log('👁️ Viendo zona:', id);
                try {
                    const response = await this.apiRequest(`?action=get_one&id=${id}`);

                    if (response.success) {
                        this.currentZona = response.data;
                        this.isNewZona = false;
                        this.editMode = false;

                        this.tiendasAsignadas = this.currentZona.tiendas || [];

                        await this.loadPromotoresDeTiendas();

                        this.showViewMode();
                        this.populateViewMode(this.currentZona);
                        this.openModal();
                    }
                } catch (error) {
                    console.error('❌ Error al ver zona:', error);
                    this.showNotification('error', 'Error', 'No se pudo cargar la zona');
                }
            }

            async editZona(id) {
                console.log('✏️ Editando zona:', id);
                try {
                    const response = await this.apiRequest(`?action=get_one&id=${id}`);

                    if (response.success) {
                        this.currentZona = response.data;
                        this.isNewZona = false;
                        this.editMode = true;
                        this.showEditMode();
                        await this.loadCatalogos();
                        await this.populateEditMode(this.currentZona);
                        this.openModal();
                    }
                } catch (error) {
                    console.error('❌ Error al editar zona:', error);
                    this.showNotification('error', 'Error', 'No se pudo cargar la zona');
                }
            }

            // 🆕 FUNCIÓN MODIFICADA - Guardar info antes de eliminar
            async deleteZona(id) {
                console.log('🗑️ Eliminando zona:', id);
                if (!confirm('¿Está seguro de que desea eliminar esta zona?')) {
                    return;
                }

                try {
                    // 🆕 PRIMERO obtener la info completa de la zona antes de eliminarla
                    const zonaResponse = await this.apiRequest(`?action=get_one&id=${id}`);
                    
                    if (zonaResponse.success) {
                        const zonaCompleta = zonaResponse.data;
                        
                        // 🆕 Guardar en historial de eliminadas
                        this.zonasEliminadas.unshift({
                            ...zonaCompleta,
                            fecha_eliminacion: new Date().toISOString(),
                            id_original: zonaCompleta.id_zona
                        });
                        
                        this.saveZonasEliminadas();
                        console.log('💾 Zona guardada en historial de eliminadas');
                    }

                    // LUEGO eliminar la zona
                    const response = await this.apiRequest(``, {
                        method: 'DELETE',
                        body: JSON.stringify({ id: id, action: 'delete' })
                    });

                    if (response.success) {
                        this.showNotification('success', 'Éxito', 'Zona eliminada. Puedes restaurarla al crear una nueva zona.');
                        this.loadZonas();
                    }
                } catch (error) {
                    console.error('❌ Error al eliminar zona:', error);
                    this.showNotification('error', 'Error', 'No se pudo eliminar la zona');
                }
            }

            async openNewZonaModal() {
                console.log('🆕 Abriendo modal Nueva Zona');

                try {
                    this.currentZona = null;
                    this.isNewZona = true;
                    this.editMode = true;
                    this.supervisoresAsignados = [];
                    this.tiendasAsignadas = [];
                    this.selectedRegionId = null;

                    // 🆕 Limpiar sugerencias y resetear flag
                    this.hideRestoreSuggestion();
                    this.justRestoredZona = false;

                    document.getElementById('modal-title').innerHTML = '<i class="fas fa-plus"></i> Nueva Zona';
                    document.getElementById('form-zona').reset();

                    this.showEditMode();

                    console.log('📚 Cargando catálogos...');
                    await this.loadCatalogos();

                    this.renderSupervisoresAsignados();
                    this.renderTiendasAsignadas();

                    document.getElementById('view-actions').style.display = 'none';
                    document.getElementById('edit-actions').style.display = 'none';
                    document.getElementById('new-actions').style.display = 'flex';

                    this.openModal();

                } catch (error) {
                    console.error('❌ Error al abrir modal:', error);
                    this.showNotification('error', 'Error', 'No se pudo abrir el formulario: ' + error.message);
                }
            }

            async loadCatalogos() {
                console.log('📚 Cargando catálogos...');
                try {
                    console.log('🗺️ Cargando regiones...');
                    const regionesResponse = await this.apiRequest('?action=get_regiones');
                    if (regionesResponse.success) {
                        this.regionesData = regionesResponse.data;
                        console.log('✅ Regiones cargadas:', this.regionesData.length);
                        this.loadRegionesSelect();
                    }

                    console.log('👥 Cargando supervisores...');
                    const supervisoresResponse = await this.apiRequest('?action=get_supervisores');
                    if (supervisoresResponse.success) {
                        this.supervisoresData = supervisoresResponse.data;
                        console.log('✅ Supervisores cargados:', this.supervisoresData.length);
                    }

                    console.log('🏪 Cargando tiendas...');
                    const tiendasResponse = await this.apiRequest('?action=get_tiendas');
                    if (tiendasResponse.success) {
                        this.tiendasData = tiendasResponse.data;
                        console.log('✅ Tiendas cargadas:', this.tiendasData.length);
                    }
                } catch (error) {
                    console.error('❌ Error al cargar catálogos:', error);
                    this.showNotification('error', 'Error', 'No se pudieron cargar los catálogos: ' + error.message);
                    throw error;
                }
            }

            loadRegionesSelect() {
                const regionSelect = document.getElementById('zona-region');
                regionSelect.innerHTML = '<option value="">Seleccionar región...</option>';

                this.regionesData.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id_region;
                    option.textContent = `${region.nombre_region}`;
                    regionSelect.appendChild(option);
                });

                console.log('✅ Select de regiones poblado');
            }

            // ===== FUNCIONES PARA AUTOCOMPLETADO DE TIENDAS =====

            toggleTiendasDropdown() {
                const suggestionsContainer = document.getElementById('tienda-suggestions');
                const dropdownBtn = document.getElementById('tienda-dropdown-btn');
                const tiendaInput = document.getElementById('tienda-input');

                console.log('🔽 Toggle dropdown de tiendas');

                if (suggestionsContainer.classList.contains('active')) {
                    suggestionsContainer.classList.remove('active');
                    dropdownBtn.classList.remove('active');
                    return;
                }

                let tiendasDisponibles = this.tiendasData;

                if (this.selectedRegionId) {
                    const regionSeleccionada = this.regionesData.find(r => r.id_region === this.selectedRegionId);
                    if (regionSeleccionada) {
                        const numeroRegion = regionSeleccionada.numero_region;
                        tiendasDisponibles = tiendasDisponibles.filter(tienda => tienda.region == numeroRegion);
                        console.log(`🗺️ Filtrando por región ${numeroRegion}:`, tiendasDisponibles.length, 'tiendas');
                    }
                }

                tiendasDisponibles = tiendasDisponibles.filter(tienda =>
                    !this.tiendasAsignadas.find(t => t.id_tienda === tienda.id_tienda)
                );

                console.log('✅ Tiendas disponibles para dropdown:', tiendasDisponibles.length);

                if (!tiendaInput.value || tiendaInput.value.length === 0) {
                    this.renderTiendaSuggestions(tiendasDisponibles, true);
                    dropdownBtn.classList.add('active');
                } else {
                    this.handleTiendaSearch(tiendaInput.value);
                }

                tiendaInput.focus();
            }

            handleTiendaSearch(searchTerm) {
                console.log('🔍 Buscando tiendas:', searchTerm);

                const suggestionsContainer = document.getElementById('tienda-suggestions');

                if (!searchTerm || searchTerm.length < 2) {
                    suggestionsContainer.classList.remove('active');
                    return;
                }

                let tiendasFiltradas = this.tiendasData;

                if (this.selectedRegionId) {
                    const regionSeleccionada = this.regionesData.find(r => r.id_region === this.selectedRegionId);
                    if (regionSeleccionada) {
                        const numeroRegion = regionSeleccionada.numero_region;
                        tiendasFiltradas = tiendasFiltradas.filter(tienda => tienda.region == numeroRegion);
                    }
                }

                tiendasFiltradas = tiendasFiltradas.filter(tienda =>
                    !this.tiendasAsignadas.find(t => t.id_tienda === tienda.id_tienda)
                );

                const searchLower = searchTerm.toLowerCase();
                tiendasFiltradas = tiendasFiltradas.filter(tienda => {
                    return tienda.nombre_tienda.toLowerCase().includes(searchLower) ||
                        (tienda.cadena && tienda.cadena.toLowerCase().includes(searchLower)) ||
                        (tienda.ciudad && tienda.ciudad.toLowerCase().includes(searchLower)) ||
                        (tienda.num_tienda && tienda.num_tienda.toString().includes(searchLower));
                });

                console.log('✅ Tiendas encontradas:', tiendasFiltradas.length);

                this.renderTiendaSuggestions(tiendasFiltradas, false);
            }

            renderTiendaSuggestions(tiendas, showAll = false) {
                const suggestionsContainer = document.getElementById('tienda-suggestions');

                if (tiendas.length === 0) {
                    suggestionsContainer.innerHTML = '<div class="autocomplete-no-results">No se encontraron tiendas disponibles</div>';
                    suggestionsContainer.classList.add('active');
                    return;
                }

                suggestionsContainer.innerHTML = '';

                const limite = showAll ? 50 : 10;
                const tiendasToShow = tiendas.slice(0, limite);

                console.log(`📋 Mostrando ${tiendasToShow.length} de ${tiendas.length} tiendas`);

                tiendasToShow.forEach((tienda, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'autocomplete-suggestion';
                    suggestion.dataset.index = index;
                    suggestion.dataset.tiendaId = tienda.id_tienda;

                    suggestion.innerHTML = `
                        <div class="autocomplete-suggestion-name">${tienda.nombre_tienda}</div>
                        <div class="autocomplete-suggestion-details">
                            <span class="autocomplete-suggestion-badge">${tienda.cadena || 'Sin cadena'}</span>
                            <span>${tienda.ciudad || 'Sin ciudad'}</span>
                            ${tienda.num_tienda ? `<span>#${tienda.num_tienda}</span>` : ''}
                            ${tienda.region ? `<span>Región ${tienda.region}</span>` : ''}
                        </div>
                    `;

                    suggestion.addEventListener('click', () => {
                        this.selectTiendaFromAutocomplete(tienda);
                    });

                    suggestionsContainer.appendChild(suggestion);
                });

                if (tiendas.length > limite) {
                    const moreInfo = document.createElement('div');
                    moreInfo.className = 'autocomplete-no-results';
                    moreInfo.style.borderTop = '2px solid var(--border-color)';
                    moreInfo.style.fontWeight = '600';
                    moreInfo.innerHTML = `<i class="fas fa-info-circle"></i> Mostrando ${limite} de ${tiendas.length} tiendas. Escribe para filtrar más.`;
                    suggestionsContainer.appendChild(moreInfo);
                }

                suggestionsContainer.classList.add('active');
            }

            async selectTiendaFromAutocomplete(tienda) {
                console.log('✅ Tienda seleccionada:', tienda.nombre_tienda);

                if (this.selectedRegionId) {
                    const regionSeleccionada = this.regionesData.find(r => r.id_region === this.selectedRegionId);
                    if (regionSeleccionada && tienda.region != regionSeleccionada.numero_region) {
                        this.showNotification('warning', 'Atención', 'La tienda no pertenece a la región seleccionada');
                        return;
                    }
                }

                if (this.tiendasAsignadas.find(t => t.id_tienda === tienda.id_tienda)) {
                    this.showNotification('warning', 'Atención', 'Esta tienda ya está asignada');
                    return;
                }

                this.tiendasAsignadas.push(tienda);

                await this.loadPromotoresDeTiendas();
                this.renderTiendasAsignadas();

                document.getElementById('tienda-input').value = '';
                document.getElementById('tienda-suggestions').classList.remove('active');
                document.getElementById('tienda-dropdown-btn').classList.remove('active');
                document.getElementById('tienda-input').focus();

                this.showNotification('success', 'Éxito', `Tienda "${tienda.nombre_tienda}" asignada`);
            }

            async removeTienda(id) {
                this.tiendasAsignadas = this.tiendasAsignadas.filter(t => t.id_tienda !== id);
                await this.loadPromotoresDeTiendas();
                this.renderTiendasAsignadas();
            }

            handleTiendaKeyboard(e) {
                const suggestionsContainer = document.getElementById('tienda-suggestions');
                const suggestions = suggestionsContainer.querySelectorAll('.autocomplete-suggestion');

                if (suggestions.length === 0) return;

                const currentSelected = suggestionsContainer.querySelector('.autocomplete-suggestion.selected');
                let currentIndex = currentSelected ? parseInt(currentSelected.dataset.index) : -1;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentIndex = Math.min(currentIndex + 1, suggestions.length - 1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentIndex = Math.max(currentIndex - 1, 0);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentIndex >= 0) {
                            const tiendaId = parseInt(suggestions[currentIndex].dataset.tiendaId);
                            const tienda = this.tiendasData.find(t => t.id_tienda === tiendaId);
                            if (tienda) this.selectTiendaFromAutocomplete(tienda);
                        }
                        return;
                    case 'Escape':
                        suggestionsContainer.classList.remove('active');
                        document.getElementById('tienda-dropdown-btn').classList.remove('active');
                        return;
                    default:
                        return;
                }

                suggestions.forEach((s, i) => {
                    if (i === currentIndex) {
                        s.classList.add('selected');
                        s.scrollIntoView({ block: 'nearest' });
                    } else {
                        s.classList.remove('selected');
                    }
                });
            }

            // ===== FUNCIONES PARA AUTOCOMPLETADO DE SUPERVISORES =====

            toggleSupervisoresDropdown() {
                const suggestionsContainer = document.getElementById('supervisor-suggestions');
                const dropdownBtn = document.getElementById('supervisor-dropdown-btn');
                const supervisorInput = document.getElementById('supervisor-input');

                console.log('🔽 Toggle dropdown de supervisores');

                if (suggestionsContainer.classList.contains('active')) {
                    suggestionsContainer.classList.remove('active');
                    dropdownBtn.classList.remove('active');
                    return;
                }

                const supervisoresDisponibles = this.supervisoresData.filter(sup =>
                    !this.supervisoresAsignados.find(s => s.id === sup.id)
                );

                console.log('✅ Supervisores disponibles para dropdown:', supervisoresDisponibles.length);

                if (!supervisorInput.value || supervisorInput.value.length === 0) {
                    this.renderSupervisorSuggestions(supervisoresDisponibles, true);
                    dropdownBtn.classList.add('active');
                } else {
                    this.handleSupervisorSearch(supervisorInput.value);
                }

                supervisorInput.focus();
            }

            handleSupervisorSearch(searchTerm) {
                console.log('🔍 Buscando supervisores:', searchTerm);

                const suggestionsContainer = document.getElementById('supervisor-suggestions');

                if (!searchTerm || searchTerm.length < 2) {
                    suggestionsContainer.classList.remove('active');
                    return;
                }

                let supervisoresFiltrados = this.supervisoresData.filter(sup =>
                    !this.supervisoresAsignados.find(s => s.id === sup.id)
                );

                const searchLower = searchTerm.toLowerCase();
                supervisoresFiltrados = supervisoresFiltrados.filter(sup => {
                    const nombreCompleto = `${sup.nombre} ${sup.apellido}`.toLowerCase();
                    const email = (sup.email || '').toLowerCase();

                    return nombreCompleto.includes(searchLower) || email.includes(searchLower);
                });

                console.log('✅ Supervisores encontrados:', supervisoresFiltrados.length);

                this.renderSupervisorSuggestions(supervisoresFiltrados, false);
            }

            renderSupervisorSuggestions(supervisores, showAll = false) {
                const suggestionsContainer = document.getElementById('supervisor-suggestions');

                if (supervisores.length === 0) {
                    suggestionsContainer.innerHTML = '<div class="autocomplete-no-results">No se encontraron supervisores disponibles</div>';
                    suggestionsContainer.classList.add('active');
                    return;
                }

                suggestionsContainer.innerHTML = '';

                const limite = showAll ? 50 : 10;
                const supervisoresToShow = supervisores.slice(0, limite);

                console.log(`📋 Mostrando ${supervisoresToShow.length} de ${supervisores.length} supervisores`);

                supervisoresToShow.forEach((supervisor, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'autocomplete-suggestion';
                    suggestion.dataset.index = index;
                    suggestion.dataset.supervisorId = supervisor.id;

                    const nombreCompleto = supervisor.nombre_completo || `${supervisor.nombre} ${supervisor.apellido}`;

                    suggestion.innerHTML = `
                        <div class="autocomplete-suggestion-name">
                            <i class="fas fa-user-tie"></i> ${nombreCompleto}
                        </div>
                        ${supervisor.email ? `
                            <div class="autocomplete-suggestion-details">
                                <span><i class="fas fa-envelope"></i> ${supervisor.email}</span>
                            </div>
                        ` : ''}
                    `;

                    suggestion.addEventListener('click', () => {
                        this.selectSupervisorFromAutocomplete(supervisor);
                    });

                    suggestionsContainer.appendChild(suggestion);
                });

                if (supervisores.length > limite) {
                    const moreInfo = document.createElement('div');
                    moreInfo.className = 'autocomplete-no-results';
                    moreInfo.style.borderTop = '2px solid var(--border-color)';
                    moreInfo.style.fontWeight = '600';
                    moreInfo.innerHTML = `<i class="fas fa-info-circle"></i> Mostrando ${limite} de ${supervisores.length} supervisores. Escribe para filtrar más.`;
                    suggestionsContainer.appendChild(moreInfo);
                }

                suggestionsContainer.classList.add('active');
            }

            selectSupervisorFromAutocomplete(supervisor) {
                console.log('✅ Supervisor seleccionado:', supervisor.nombre_completo || `${supervisor.nombre} ${supervisor.apellido}`);

                if (this.supervisoresAsignados.find(s => s.id === supervisor.id)) {
                    this.showNotification('warning', 'Atención', 'Este supervisor ya está asignado');
                    return;
                }

                this.supervisoresAsignados.push({
                    id: supervisor.id,
                    nombre: supervisor.nombre,
                    apellido: supervisor.apellido,
                    nombre_completo: supervisor.nombre_completo || `${supervisor.nombre} ${supervisor.apellido}`
                });

                this.renderSupervisoresAsignados();

                document.getElementById('supervisor-input').value = '';
                document.getElementById('supervisor-suggestions').classList.remove('active');
                document.getElementById('supervisor-dropdown-btn').classList.remove('active');
                document.getElementById('supervisor-input').focus();

                this.showNotification('success', 'Éxito', `Supervisor "${supervisor.nombre_completo || `${supervisor.nombre} ${supervisor.apellido}`}" asignado`);
            }

            handleSupervisorKeyboard(e) {
                const suggestionsContainer = document.getElementById('supervisor-suggestions');
                const suggestions = suggestionsContainer.querySelectorAll('.autocomplete-suggestion');

                if (suggestions.length === 0) return;

                const currentSelected = suggestionsContainer.querySelector('.autocomplete-suggestion.selected');
                let currentIndex = currentSelected ? parseInt(currentSelected.dataset.index) : -1;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentIndex = Math.min(currentIndex + 1, suggestions.length - 1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentIndex = Math.max(currentIndex - 1, 0);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentIndex >= 0) {
                            const supervisorId = parseInt(suggestions[currentIndex].dataset.supervisorId);
                            const supervisor = this.supervisoresData.find(s => s.id === supervisorId);
                            if (supervisor) this.selectSupervisorFromAutocomplete(supervisor);
                        }
                        return;
                    case 'Escape':
                        suggestionsContainer.classList.remove('active');
                        document.getElementById('supervisor-dropdown-btn').classList.remove('active');
                        return;
                    default:
                        return;
                }

                suggestions.forEach((s, i) => {
                    if (i === currentIndex) {
                        s.classList.add('selected');
                        s.scrollIntoView({ block: 'nearest' });
                    } else {
                        s.classList.remove('selected');
                    }
                });
            }

            // 🆕 ===== FUNCIONES PARA RESTAURACIÓN DE ZONAS =====

            loadZonasEliminadas() {
                try {
                    const stored = localStorage.getItem('zonas_eliminadas');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error al cargar zonas eliminadas:', error);
                    return [];
                }
            }

            saveZonasEliminadas() {
                try {
                    const toSave = this.zonasEliminadas.slice(0, 10);
                    localStorage.setItem('zonas_eliminadas', JSON.stringify(toSave));
                } catch (error) {
                    console.error('Error al guardar zonas eliminadas:', error);
                }
            }

            handleNombreZonaInput(e) {
                const input = e.target;
                const value = input.value.trim().toLowerCase();
                
                // 🆕 Si acabamos de restaurar, no mostrar sugerencias
                if (this.justRestoredZona) {
                    return;
                }
                
                if (value.length < 2) {
                    this.hideRestoreSuggestion();
                    return;
                }
                
                const coincidencias = this.zonasEliminadas.filter(zona => 
                    zona.nombre_zona.toLowerCase().includes(value)
                );
                
                if (coincidencias.length > 0) {
                    this.showRestoreSuggestion(input, coincidencias[0]);
                } else {
                    this.hideRestoreSuggestion();
                }
            }

            showRestoreSuggestion(input, zona) {
                this.hideRestoreSuggestion();
                
                const suggestion = document.createElement('div');
                suggestion.id = 'restore-suggestion';
                suggestion.className = 'restore-suggestion';
                
                const fechaEliminacion = new Date(zona.fecha_eliminacion);
                const fechaFormateada = fechaEliminacion.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                suggestion.innerHTML = `
                    <div class="restore-suggestion-header">
                        <i class="fas fa-history"></i>
                        <span>Restaurar zona eliminada</span>
                    </div>
                    <div class="restore-suggestion-content">
                        <div class="restore-suggestion-name">
                            <strong>${zona.nombre_zona}</strong>
                            <span class="restore-badge">Último uso</span>
                        </div>
                        <div class="restore-suggestion-details">
                            <div><i class="fas fa-map-marker-alt"></i> Región ${zona.numero_region} - ${zona.nombre_region}</div>
                            <div><i class="fas fa-user-tie"></i> ${zona.supervisores?.length || 0} supervisor(es)</div>
                            <div><i class="fas fa-store"></i> ${zona.tiendas?.length || 0} tienda(s)</div>
                        </div>
                        <div class="restore-suggestion-date">
                            <i class="fas fa-clock"></i> Eliminada: ${fechaFormateada}
                        </div>
                    </div>
                    <div class="restore-suggestion-actions">
                        <button type="button" class="btn-restore-ignore">
                            <i class="fas fa-times"></i> Ignorar
                        </button>
                        <button type="button" class="btn-restore-apply">
                            <i class="fas fa-undo"></i> Restaurar
                        </button>
                    </div>
                `;
                
                input.parentElement.style.position = 'relative';
                input.parentElement.appendChild(suggestion);
                
                setTimeout(() => suggestion.classList.add('active'), 10);
                
                suggestion.querySelector('.btn-restore-ignore').addEventListener('click', () => {
                    this.hideRestoreSuggestion();
                });
                
                suggestion.querySelector('.btn-restore-apply').addEventListener('click', () => {
                    this.restoreZona(zona);
                    this.hideRestoreSuggestion();
                });
            }

            hideRestoreSuggestion() {
                const existing = document.getElementById('restore-suggestion');
                if (existing) {
                    existing.classList.remove('active');
                    setTimeout(() => {
                        if (existing.parentNode) {
                            existing.remove();
                        }
                    }, 200);
                }
            }

            async restoreZona(zona) {
                console.log('🔄 Restaurando zona:', zona.nombre_zona);
                
                try {
                    // 🆕 PRIMERO: Cerrar el modal de sugerencia inmediatamente
                    this.hideRestoreSuggestion();
                    
                    // 🆕 SEGUNDO: Activar flag para evitar que reaparezca
                    this.justRestoredZona = true;
                    
                    // TERCERO: Autocompletar todos los campos
                    document.getElementById('zona-nombre').value = zona.nombre_zona;
                    document.getElementById('zona-descripcion').value = zona.descripcion || '';
                    document.getElementById('zona-estado').value = zona.activa ? '1' : '0';
                    
                    if (zona.id_region) {
                        document.getElementById('zona-region').value = zona.id_region;
                        this.selectedRegionId = zona.id_region;
                    }
                    
                    if (zona.supervisores && zona.supervisores.length > 0) {
                        this.supervisoresAsignados = zona.supervisores.map(sup => ({
                            id: sup.id,
                            nombre: sup.nombre,
                            apellido: sup.apellido,
                            nombre_completo: `${sup.nombre} ${sup.apellido}`
                        }));
                        this.renderSupervisoresAsignados();
                    }
                    
                    if (zona.tiendas && zona.tiendas.length > 0) {
                        this.tiendasAsignadas = [...zona.tiendas];
                        await this.loadPromotoresDeTiendas();
                    }
                    
                    this.showNotification('success', 'Restaurado', `Zona "${zona.nombre_zona}" restaurada con todos sus datos`);
                    
                    // 🆕 CUARTO: Después de 500ms, desactivar el flag para que pueda volver a funcionar en el futuro
                    setTimeout(() => {
                        this.justRestoredZona = false;
                    }, 500);
                    
                    // Enfocar el siguiente campo (descripción) en lugar del nombre
                    document.getElementById('zona-descripcion').focus();
                    
                } catch (error) {
                    console.error('❌ Error al restaurar zona:', error);
                    this.showNotification('error', 'Error', 'No se pudo restaurar la zona completamente');
                    this.justRestoredZona = false; // 🆕 Desactivar flag en caso de error
                }
            }

            // ===== FIN FUNCIONES DE RESTAURACIÓN =====

            populateViewMode(zona) {
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-map-marked-alt"></i> Información de Zona';
                document.getElementById('view-nombre-zona').textContent = zona.nombre_zona;
                document.getElementById('view-region').textContent = `Región ${zona.numero_region} - ${zona.nombre_region}`;
                document.getElementById('view-descripcion').textContent = zona.descripcion || 'Sin descripción';

                const estadoBadge = document.getElementById('view-estado-badge');
                estadoBadge.textContent = zona.activa ? 'Activo' : 'Inactivo';
                estadoBadge.className = 'status-badge ' + (zona.activa ? 'activo' : 'inactivo');

                document.getElementById('view-fecha-creacion').textContent = zona.fecha_creacion_formatted || '-';

                const supervisoresList = document.getElementById('view-supervisores-list');
                supervisoresList.innerHTML = '';
                if (zona.supervisores && zona.supervisores.length > 0) {
                    zona.supervisores.forEach(sup => {
                        const badge = document.createElement('span');
                        badge.className = 'asignado-badge';
                        badge.innerHTML = `<i class="fas fa-user-tie"></i> ${sup.nombre} ${sup.apellido}`;
                        supervisoresList.appendChild(badge);
                    });
                    supervisoresList.classList.remove('empty');
                } else {
                    supervisoresList.classList.add('empty');
                }

                const tiendasList = document.getElementById('view-tiendas-list');
                tiendasList.innerHTML = '';
                if (zona.tiendas && zona.tiendas.length > 0) {
                    zona.tiendas.forEach(tienda => {
                        const promotores = this.promotoresPorTienda[tienda.id_tienda] || [];
                        const hasPromotores = promotores.length > 0;

                        const wrapper = document.createElement('div');
                        wrapper.className = 'tienda-badge-wrapper';

                        const badge = document.createElement('span');
                        badge.className = `asignado-badge ${hasPromotores ? 'tienda-badge-with-promotores' : ''}`;

                        badge.innerHTML = `
                            <i class="fas fa-store"></i> 
                            ${tienda.nombre_tienda}
                            ${hasPromotores ? `<span class="promotor-count" title="${promotores.length} promotor(es)">${promotores.length}</span>` : ''}
                        `;

                        if (hasPromotores) {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'promotores-tooltip';
                            tooltip.innerHTML = `
                                <h5><i class="fas fa-users"></i> Promotores en esta tienda</h5>
                                <ul class="promotores-list">
                                    ${promotores.map(p => `
                                        <li><i class="fas fa-user"></i> ${p.nombre_completo}</li>
                                    `).join('')}
                                </ul>
                            `;
                            wrapper.appendChild(badge);
                            wrapper.appendChild(tooltip);
                        } else {
                            wrapper.appendChild(badge);
                        }

                        tiendasList.appendChild(wrapper);
                    });
                    tiendasList.classList.remove('empty');
                } else {
                    tiendasList.classList.add('empty');
                }
            }

            async populateEditMode(zona) {
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Zona';
                document.getElementById('zona-id').value = zona.id_zona;
                document.getElementById('zona-nombre').value = zona.nombre_zona;
                document.getElementById('zona-region').value = zona.id_region;
                document.getElementById('zona-estado').value = zona.activa ? '1' : '0';
                document.getElementById('zona-descripcion').value = zona.descripcion || '';

                this.selectedRegionId = zona.id_region;

                this.supervisoresAsignados = (zona.supervisores || []).map(sup => ({
                    id: sup.id,
                    nombre: sup.nombre,
                    apellido: sup.apellido,
                    nombre_completo: `${sup.nombre} ${sup.apellido}`
                }));

                this.tiendasAsignadas = zona.tiendas || [];

                this.renderSupervisoresAsignados();

                await this.loadPromotoresDeTiendas();
            }

            removeSupervisor(id) {
                this.supervisoresAsignados = this.supervisoresAsignados.filter(s => s.id !== id);
                this.renderSupervisoresAsignados();
            }

            renderSupervisoresAsignados() {
                const list = document.getElementById('supervisores-asignados-list');
                list.innerHTML = '';

                if (this.supervisoresAsignados.length > 0) {
                    this.supervisoresAsignados.forEach(sup => {
                        const badge = document.createElement('span');
                        badge.className = 'asignado-badge';
                        badge.innerHTML = `
                            <i class="fas fa-user-tie"></i>
                            ${sup.nombre_completo || `${sup.nombre} ${sup.apellido}`}
                            <button type="button" class="asignado-remove" onclick="zonasModule.removeSupervisor(${sup.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(badge);
                    });
                    list.classList.remove('empty');
                } else {
                    list.classList.add('empty');
                }
            }

            renderTiendasAsignadas() {
                const list = document.getElementById('tiendas-asignadas-list');
                list.innerHTML = '';

                if (this.tiendasAsignadas.length > 0) {
                    this.tiendasAsignadas.forEach(tienda => {
                        const promotores = this.promotoresPorTienda[tienda.id_tienda] || [];
                        const hasPromotores = promotores.length > 0;

                        const wrapper = document.createElement('div');
                        wrapper.className = 'tienda-badge-wrapper';

                        const badge = document.createElement('span');
                        badge.className = `asignado-badge ${hasPromotores ? 'tienda-badge-with-promotores' : ''}`;
                        badge.innerHTML = `
                            <i class="fas fa-store"></i>
                            ${tienda.nombre_tienda}
                            ${hasPromotores ? `<span class="promotor-count" title="${promotores.length} promotor(es)">${promotores.length}</span>` : ''}
                            <button type="button" class="asignado-remove" onclick="zonasModule.removeTienda(${tienda.id_tienda})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;

                        if (hasPromotores) {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'promotores-tooltip';
                            tooltip.innerHTML = `
                                <h5><i class="fas fa-users"></i> Promotores en esta tienda</h5>
                                <ul class="promotores-list">
                                    ${promotores.map(p => `
                                        <li><i class="fas fa-user"></i> ${p.nombre_completo}</li>
                                    `).join('')}
                                </ul>
                            `;
                            wrapper.appendChild(badge);
                            wrapper.appendChild(tooltip);
                        } else {
                            wrapper.appendChild(badge);
                        }

                        list.appendChild(wrapper);
                    });
                    list.classList.remove('empty');
                } else {
                    list.classList.add('empty');
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                console.log('💾 Guardando zona...');

                const formData = {
                    nombre_zona: document.getElementById('zona-nombre').value.trim(),
                    id_region: parseInt(document.getElementById('zona-region').value),
                    activa: parseInt(document.getElementById('zona-estado').value),
                    descripcion: document.getElementById('zona-descripcion').value.trim(),
                    supervisores: this.supervisoresAsignados.map(s => s.id),
                    tiendas: this.tiendasAsignadas.map(t => t.id_tienda)
                };

                try {
                    if (this.isNewZona) {
                        const response = await this.apiRequest('', {
                            method: 'POST',
                            body: JSON.stringify({ ...formData, action: 'create' })
                        });

                        if (response.success) {
                            this.showNotification('success', 'Éxito', 'Zona creada correctamente');
                            this.closeModal();
                            this.loadZonas();
                        }
                    } else {
                        formData.id_zona = parseInt(document.getElementById('zona-id').value);

                        const response = await this.apiRequest('', {
                            method: 'PUT',
                            body: JSON.stringify({ ...formData, action: 'update' })
                        });

                        if (response.success) {
                            this.showNotification('success', 'Éxito', 'Zona actualizada correctamente');
                            this.closeModal();
                            this.loadZonas();
                        }
                    }
                } catch (error) {
                    console.error('❌ Error al guardar zona:', error);
                    this.showNotification('error', 'Error', error.message || 'No se pudo guardar la zona');
                }
            }

            handleSearchFieldChange() {
                const searchField = document.getElementById('search-field').value;
                const searchInput = document.getElementById('search-value');
                const btnBuscar = document.getElementById('btn-buscar');

                if (searchField) {
                    searchInput.disabled = false;
                    btnBuscar.disabled = false;
                    searchInput.focus();
                } else {
                    searchInput.disabled = true;
                    btnBuscar.disabled = true;
                    searchInput.value = '';
                }
            }

            handleSearch() {
                this.searchField = document.getElementById('search-field').value;
                this.searchValue = document.getElementById('search-value').value.trim();

                if (!this.searchField || !this.searchValue) {
                    this.showNotification('warning', 'Atención', 'Seleccione un campo y valor de búsqueda');
                    return;
                }

                this.currentPage = 1;
                this.loadZonas();
            }

            handleClearSearch() {
                document.getElementById('search-field').value = '';
                document.getElementById('search-value').value = '';
                document.getElementById('search-value').disabled = true;
                document.getElementById('btn-buscar').disabled = true;

                this.searchField = '';
                this.searchValue = '';
                this.currentPage = 1;
                this.loadZonas();
            }

            changePage(page) {
                if (page < 1 || page > this.totalPages) return;

                this.currentPage = page;
                this.loadZonas();
            }

            updatePagination() {
                const startItem = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endItem = Math.min(this.currentPage * this.itemsPerPage, this.totalItems);

                document.getElementById('pagination-info').textContent =
                    `Mostrando ${startItem} - ${endItem} de ${this.totalItems} zonas`;

                document.getElementById('pagination-pages').textContent =
                    `Página ${this.currentPage} de ${this.totalPages || 1}`;

                document.getElementById('btn-prev').disabled = this.currentPage === 1;
                document.getElementById('btn-next').disabled = this.currentPage === this.totalPages || this.totalPages === 0;
            }

            openModal() {
                document.getElementById('modal-zona').classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                document.getElementById('modal-zona').classList.remove('active');
                document.body.style.overflow = '';
                document.getElementById('form-zona').reset();
                this.supervisoresAsignados = [];
                this.tiendasAsignadas = [];
                this.selectedRegionId = null;
                this.hideRestoreSuggestion();
                this.justRestoredZona = false; // 🆕 Resetear flag
            }

            showViewMode() {
                document.getElementById('view-mode').style.display = 'block';
                document.getElementById('edit-mode').style.display = 'none';
                document.getElementById('view-actions').style.display = 'flex';
                document.getElementById('edit-actions').style.display = 'none';
                document.getElementById('new-actions').style.display = 'none';
            }

            showEditMode() {
                document.getElementById('view-mode').style.display = 'none';
                document.getElementById('edit-mode').style.display = 'block';

                if (this.isNewZona) {
                    document.getElementById('view-actions').style.display = 'none';
                    document.getElementById('edit-actions').style.display = 'none';
                    document.getElementById('new-actions').style.display = 'flex';
                } else {
                    document.getElementById('view-actions').style.display = 'none';
                    document.getElementById('edit-actions').style.display = 'flex';
                    document.getElementById('new-actions').style.display = 'none';
                }
            }

            async enableEditMode() {
                this.editMode = true;
                this.showEditMode();
                await this.loadCatalogos();
                await this.populateEditMode(this.currentZona);
            }

            cancelEdit() {
                if (this.currentZona) {
                    this.editMode = false;
                    this.showViewMode();
                    this.populateViewMode(this.currentZona);
                }
            }

            showTableLoading() {
                document.getElementById('table-loading').style.display = 'block';
                document.querySelector('.table-wrapper').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
            }

            hideTableLoading() {
                document.getElementById('table-loading').style.display = 'none';
                document.querySelector('.table-wrapper').style.display = 'block';
            }

            showEmptyState() {
                document.querySelector('.table-wrapper').style.display = 'none';
                document.getElementById('empty-state').style.display = 'block';
            }

            showNotification(type, title, message) {
                const container = document.getElementById('notifications-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;

                const icon = this.getNotificationIcon(type);

                notification.innerHTML = `
                    <i class="fas ${icon} notification-icon"></i>
                    <div class="notification-content">
                        <h4>${title}</h4>
                        <p>${message}</p>
                    </div>
                    <button class="notification-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'notificationSlideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);

                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.style.animation = 'notificationSlideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                });
            }

            getNotificationIcon(type) {
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-times-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                return icons[type] || icons.info;
            }
        }

        (function () {
            console.log('📦 Script del módulo zonas cargado');

            let zonasModuleInstance = null;

            function initZonasModule() {
                console.log('🔄 initZonasModule() llamado');

                if (zonasModuleInstance) {
                    console.log('⚠️ Módulo ya inicializado');
                    return zonasModuleInstance;
                }

                const tabla = document.getElementById('zonas-table');
                const btnNueva = document.getElementById('btn-nueva-zona');

                if (!tabla || !btnNueva) {
                    console.error('❌ Elementos del módulo no encontrados');
                    setTimeout(initZonasModule, 100);
                    return null;
                }

                console.log('✅ Elementos encontrados, inicializando...');

                try {
                    zonasModuleInstance = new ZonasModule();
                    window.zonasModule = zonasModuleInstance;
                    return zonasModuleInstance;
                } catch (error) {
                    console.error('❌ Error al inicializar:', error);
                    return null;
                }
            }

            window.initZonasModule = initZonasModule;

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initZonasModule);
            } else {
                initZonasModule();
            }

            setTimeout(() => {
                if (!zonasModuleInstance) {
                    initZonasModule();
                }
            }, 100);
        })();
    </script>
</body>

</html>