<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Tiendas → Promotores + EXPEDIENTES</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <!-- ===== MÓDULO REPORTES TIENDAS → PROMOTORES ===== -->
    <div class="reportes-module">
        <!-- HEADER DEL MÓDULO -->
        <div class="module-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-store header-icon"></i>
                    <h1>Reportes Tiendas → Promotores</h1>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" id="btn-descargar-excel">
                        <i class="fas fa-file-excel"></i> Descargar Excel
                    </button>
                    <button class="btn-primary" id="btn-descargar-pdf">
                        <i class="fas fa-download"></i> Descargar PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTROLES DE FILTROS -->
        <div class="filters-container">
            <div class="filters-content">
                <h3><i class="fas fa-filter"></i> Filtros de Consulta</h3>

                <!-- RANGO DE FECHAS -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Inicio *</label>
                            <input type="date" id="fecha-inicio" required>
                            <small class="text-muted">Fecha de inicio del período a consultar</small>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Fin *</label>
                            <input type="date" id="fecha-fin" required>
                            <small class="text-muted">Fecha de fin del período a consultar</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <small class="text-muted">Período seleccionado: <span id="rango-fechas-texto">Seleccione
                                    fechas</span></small>
                        </div>
                    </div>
                </div>

                <!-- FILTROS ADICIONALES -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filtro-promotor">Promotor Específico</label>
                            <select id="filtro-promotor">
                                <option value="">Todos los promotores</option>
                            </select>
                            <small class="text-muted" id="promotor-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Cargando promotores...
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="filtro-tienda">Tienda Específica</label>
                            <select id="filtro-tienda">
                                <option value="">Todas las tiendas</option>
                            </select>
                            <small class="text-muted" id="tienda-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Cargando tiendas...
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ACCIONES -->
                <div class="filter-actions">
                    <button type="button" class="btn-secondary" id="btn-limpiar-filtros">
                        <i class="fas fa-broom"></i> Limpiar Filtros
                    </button>
                    <button type="button" class="btn-primary" id="btn-consultar">
                        <i class="fas fa-search"></i> Consultar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- RESUMEN ESTADÍSTICO -->
        <div class="stats-container" id="stats-container" style="display: block;">
            <div class="stats-content">
                <h3><i class="fas fa-chart-pie"></i> Resumen Estadístico - <span id="periodo-seleccionado">Seleccione un
                        período</span></h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="stat-tiendas">0</h4>
                            <p>Tiendas con Cobertura</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="stat-promotores">0</h4>
                            <p>Promotores Activos</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="stat-dias">0</h4>
                            <p>Días del Período</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="stat-dias-trabajados">0</h4>
                            <p>Asignaciones Total</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTADOS DEL REPORTE -->
        <div class="reporte-container" id="reporte-container">
            <!-- LOADING REPORTE -->
            <div class="reporte-loading" id="reporte-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Generando reporte...</p>
            </div>

            <!-- CONTENIDO DEL REPORTE -->
            <div class="reporte-content" id="reporte-content" style="display: none;">
                <div class="reporte-header">
                    <div class="reporte-title">
                        <h3>Reporte Tiendas → Promotores</h3>
                        <p id="reporte-subtitulo" class="text-secondary">Seleccione fechas y haga clic en Consultar
                            Reporte</p>
                    </div>
                </div>

                <!-- TABLA TIENDAS → PROMOTORES -->
                <div class="table-wrapper">
                    <table class="reporte-table">
                        <thead>
                            <tr>
                                <th>Tienda</th>
                                <th>Información</th>
                                <th>Promotores Asignados</th>
                                <th>Días con Cobertura</th>
                                <th>Total Días Cubiertos</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-tiendas">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- EMPTY STATE -->
            <div class="empty-state" id="reporte-empty" style="display: none;">
                <i class="fas fa-store"></i>
                <h3>No hay datos para mostrar</h3>
                <p>No se encontraron asignaciones para el período y filtros seleccionados.</p>
                <p><small>Intente con un rango de fechas diferente o quite algunos filtros.</small></p>
                <button class="btn-primary" onclick="limpiarFiltros()">
                    <i class="fas fa-broom"></i> Limpiar Filtros
                </button>
            </div>
        </div>

        <!-- ESTADO INICIAL -->
        <div class="initial-state" id="initial-state" style="display: block;">
            <div
                style="text-align: center; padding: 40px; background: var(--surface); border-radius: var(--radius); margin-bottom: 2rem; border: 1px solid var(--border-color);">
                <i class="fas fa-play-circle"
                    style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                <h3>Reporte Tiendas → Promotores</h3>
                <p class="text-muted">Seleccione fechas y filtros, luego haga clic en "Consultar Reporte" para generar
                    los datos.</p>
                <p><small>Por defecto se muestran las fechas de la semana actual.</small></p>
            </div>
        </div>
    </div>

    <!-- ===== MODAL DETALLE DE ASIGNACIONES ===== -->
    <div class="modal-overlay" id="modal-detalle">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2 id="detalle-title">
                    <i class="fas fa-info-circle"></i> Detalle de Asignaciones
                </h2>
                <button class="modal-close" id="modal-close-detalle">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-content">
                <div class="detalle-info" id="detalle-info">
                    <!-- Se llenará dinámicamente -->
                </div>

                <div class="detalle-timeline" id="detalle-timeline">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- 🆕 ===== MODAL EXPEDIENTE DE PROMOTOR ===== -->
    <div class="modal-overlay" id="modal-expediente">
        <div class="modal-container modal-expediente">
            <div class="modal-header modal-header-expediente">
                <h2 id="expediente-title">
                    <i class="fas fa-id-card"></i> Expediente del Promotor
                </h2>
                <button class="btn-primary" id="btn-descargar-expediente" style="margin-left: auto; margin-right: 15px;">
                    <i class="fas fa-download"></i> Descargar Expediente
                </button>
                <button class="modal-close" id="modal-close-expediente">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-content" id="expediente-content">
                <!-- LOADING -->
                <div id="expediente-loading" style="display: none; text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                    <p>Cargando expediente...</p>
                </div>

                <!-- CONTENIDO DEL EXPEDIENTE -->
                <div id="expediente-data" style="display: none;">
                    
                    <!-- CABECERA CON FOTO Y DATOS PRINCIPALES -->
                    <div class="expediente-header">
                        <div class="expediente-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="expediente-header-info">
                            <h3 id="exp-nombre">Nombre del Promotor</h3>
                            <div class="expediente-badges">
                                <span class="exp-badge exp-badge-primary" id="exp-estatus">Activo</span>
                                <span class="exp-badge exp-badge-secondary" id="exp-rfc">RFC</span>
                            </div>
                            <div class="expediente-quick-info">
                                <div class="quick-info-item">
                                    <i class="fas fa-phone"></i>
                                    <span id="exp-telefono">-</span>
                                </div>
                                <div class="quick-info-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="exp-correo">-</span>
                                </div>
                                <div class="quick-info-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="exp-region">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ESTADÍSTICAS RÁPIDAS -->
                    <div class="expediente-stats-grid">
                        <div class="exp-stat-card">
                            <div class="exp-stat-icon" style="background: #e8f5e9;">
                                <i class="fas fa-calendar-check" style="color: #27ae60;"></i>
                            </div>
                            <div class="exp-stat-info">
                                <h4 id="exp-stat-antiguedad">0</h4>
                                <p>Antigüedad</p>
                            </div>
                        </div>
                        <div class="exp-stat-card">
                            <div class="exp-stat-icon" style="background: #e3f2fd;">
                                <i class="fas fa-store" style="color: #2196f3;"></i>
                            </div>
                            <div class="exp-stat-info">
                                <h4 id="exp-stat-tiendas">0</h4>
                                <p>Tiendas Asignadas</p>
                            </div>
                        </div>
                        <div class="exp-stat-card">
                            <div class="exp-stat-icon" style="background: #fff3e0;">
                                <i class="fas fa-briefcase" style="color: #ff9800;"></i>
                            </div>
                            <div class="exp-stat-info">
                                <h4 id="exp-stat-asignaciones">0</h4>
                                <p>Total Asignaciones</p>
                            </div>
                        </div>
                        <div class="exp-stat-card">
                            <div class="exp-stat-icon" style="background: #fce4ec;">
                                <i class="fas fa-exclamation-triangle" style="color: #e91e63;"></i>
                            </div>
                            <div class="exp-stat-info">
                                <h4 id="exp-stat-incidencias">0</h4>
                                <p>Incidencias</p>
                            </div>
                        </div>
                    </div>

                    <!-- TABS DE NAVEGACIÓN -->
                    <div class="expediente-tabs">
                        <button class="exp-tab active" data-tab="informacion">
                            <i class="fas fa-info-circle"></i> Información Personal
                        </button>
                        <button class="exp-tab" data-tab="estadisticas">
                            <i class="fas fa-chart-bar"></i> Estadísticas
                        </button>
                        <button class="exp-tab" data-tab="asignaciones">
                            <i class="fas fa-clipboard-list"></i> Asignaciones
                        </button>
                        <button class="exp-tab" data-tab="incidencias">
                            <i class="fas fa-exclamation-circle"></i> Incidencias
                        </button>
                        <button class="exp-tab" data-tab="historial">
                            <i class="fas fa-history"></i> Historial
                        </button>
                    </div>

                    <!-- CONTENIDO DE LAS TABS -->
                    <div class="expediente-tab-content">
                        
                        <!-- TAB: INFORMACIÓN PERSONAL (🔥 CORREGIDA PARA COINCIDIR CON LA BASE DE DATOS) -->
                        <div class="exp-tab-pane active" id="tab-informacion">
                            <div class="info-grid">
                                <!-- DATOS PERSONALES -->
                                <div class="info-section">
                                    <h4><i class="fas fa-user"></i> Datos Personales</h4>
                                    <div class="info-row">
                                        <span class="info-label">Nombre Completo:</span>
                                        <span class="info-value" id="exp-info-nombre">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">RFC:</span>
                                        <span class="info-value" id="exp-info-rfc">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">NSS:</span>
                                        <span class="info-value" id="exp-info-nss">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Fecha Ingreso:</span>
                                        <span class="info-value" id="exp-info-fingreso">-</span>
                                    </div>
                                </div>

                                <!-- UBICACIÓN -->
                                <div class="info-section">
                                    <h4><i class="fas fa-map-marker-alt"></i> Ubicación</h4>
                                    <div class="info-row">
                                        <span class="info-label">Región:</span>
                                        <span class="info-value" id="exp-info-region">-</span>
                                    </div>
                                </div>

                                <!-- CONTACTO -->
                                <div class="info-section">
                                    <h4><i class="fas fa-phone"></i> Contacto</h4>
                                    <div class="info-row">
                                        <span class="info-label">Teléfono:</span>
                                        <span class="info-value" id="exp-info-tel">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Correo:</span>
                                        <span class="info-value" id="exp-info-email">-</span>
                                    </div>
                                </div>

                                <!-- DATOS BANCARIOS -->
                                <div class="info-section">
                                    <h4><i class="fas fa-university"></i> Datos Bancarios</h4>
                                    <div class="info-row">
                                        <span class="info-label">Banco:</span>
                                        <span class="info-value" id="exp-info-banco">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Número de Cuenta:</span>
                                        <span class="info-value" id="exp-info-cuenta">-</span>
                                    </div>
                                </div>

                                <!-- INFORMACIÓN LABORAL -->
                                <div class="info-section">
                                    <h4><i class="fas fa-briefcase"></i> Información Laboral</h4>
                                    <div class="info-row">
                                        <span class="info-label">Fecha Alta:</span>
                                        <span class="info-value" id="exp-info-falta">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Antigüedad:</span>
                                        <span class="info-value" id="exp-info-antiguedad">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Estatus:</span>
                                        <span class="info-value" id="exp-info-estatus">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Tipo Trabajo:</span>
                                        <span class="info-value" id="exp-info-tipo-trabajo">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Día Descanso:</span>
                                        <span class="info-value" id="exp-info-descanso">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Vacaciones:</span>
                                        <span class="info-value" id="exp-info-vacaciones">-</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Claves Asistencia:</span>
                                        <span class="info-value" id="exp-info-claves">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: ESTADÍSTICAS -->
                        <div class="exp-tab-pane" id="tab-estadisticas">
                            <div class="stats-section">
                                <h4><i class="fas fa-chart-line"></i> Estadísticas del Período</h4>
                                <p class="text-muted" id="exp-periodo-texto">Período seleccionado</p>
                                
                                <div class="stats-grid-full">
                                    <div class="stat-box">
                                        <div class="stat-box-header">
                                            <i class="fas fa-calendar-day"></i>
                                            <span>Días con Asignación</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-dias-asig">0</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-box-header">
                                            <i class="fas fa-store-alt"></i>
                                            <span>Tiendas Visitadas</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-tiendas-vis">0</div>
                                    </div>
                                    <div class="stat-box stat-box-danger">
                                        <div class="stat-box-header">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Total Incidencias</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-total-inc">0</div>
                                    </div>
                                </div>

                                <h4 style="margin-top: 2rem;"><i class="fas fa-exclamation-triangle"></i> Desglose de Incidencias</h4>
                                <div class="stats-grid-full">
                                    <div class="stat-box stat-box-warning">
                                        <div class="stat-box-header">
                                            <i class="fas fa-user-slash"></i>
                                            <span>Faltas</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-faltas">0</div>
                                    </div>
                                    <div class="stat-box stat-box-info">
                                        <div class="stat-box-header">
                                            <i class="fas fa-clock"></i>
                                            <span>Retardos</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-retardos">0</div>
                                    </div>
                                    <div class="stat-box stat-box-danger">
                                        <div class="stat-box-header">
                                            <i class="fas fa-hospital"></i>
                                            <span>Incapacidades</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-incapacidades">0</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-box-header">
                                            <i class="fas fa-calendar-times"></i>
                                            <span>Total Días Incidencia</span>
                                        </div>
                                        <div class="stat-box-value" id="exp-stat-dias-inc">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: ASIGNACIONES -->
                        <div class="exp-tab-pane" id="tab-asignaciones">
                            <h4><i class="fas fa-clipboard-list"></i> Asignaciones en el Período</h4>
                            <div id="exp-asignaciones-lista">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>

                        <!-- TAB: INCIDENCIAS -->
                        <div class="exp-tab-pane" id="tab-incidencias">
                            <h4><i class="fas fa-exclamation-circle"></i> Incidencias Registradas</h4>
                            <div id="exp-incidencias-lista">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>

                        <!-- TAB: HISTORIAL -->
                        <div class="exp-tab-pane" id="tab-historial">
                            <h4><i class="fas fa-history"></i> Historial Completo de Asignaciones</h4>
                            <p class="text-muted">Últimas 100 asignaciones registradas</p>
                            <div id="exp-historial-lista">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SISTEMA DE NOTIFICACIONES -->
    <div class="notifications-container" id="notifications-container"></div>

    <style>
        /* ===== ESTILOS MÓDULO REPORTES TIENDAS → PROMOTORES ===== */
        .reportes-module {
            padding: 0;
            max-width: 100%;
        }

        /* ===== VARIABLES CSS - TEMA VERDE ===== */
        :root {
            --primary-color: #27ae60;
            --primary-hover: #229954;
            --primary-light: #d5f4e6;
            --secondary-color: #6c757d;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --background: #f8fafc;
            --surface: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
            --radius: 12px;
        }

        /* ===== RESET Y BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        /* ===== HEADER DEL MÓDULO ===== */
        .module-header {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .header-title h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* ===== CONTROLES DE FILTROS ===== */
        .filters-container {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
        }

        .filters-content {
            padding: 2rem;
        }

        .filters-content h3 {
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-section {
            margin-bottom: 1.2rem;
            padding: 1.2rem;
            background: #f8fafc;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .form-group small {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* ===== BOTONES ===== */
        .btn-primary,
        .btn-secondary,
        .btn-danger {
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-container {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
        }

        .stats-content {
            padding: 2rem;
        }

        .stats-content h3 {
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-light);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .stat-info h4 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-info p {
            margin: 0;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* ===== CONTENEDOR DE REPORTE ===== */
        .reporte-container {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .reporte-loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(39, 174, 96, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .reporte-content {
            padding: 2rem;
        }

        .reporte-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .reporte-title h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        /* ===== TABLAS DE REPORTE ===== */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .reporte-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .reporte-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .reporte-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .reporte-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .reporte-table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            vertical-align: top;
        }

        .reporte-table tbody tr {
            transition: all 0.3s ease;
        }

        .reporte-table tbody tr:hover {
            background: rgba(39, 174, 96, 0.05);
        }

        .reporte-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== BADGES Y ELEMENTOS ===== */
        .tienda-info {
            margin-bottom: 0.5rem;
        }

        .tienda-info strong {
            color: var(--text-primary);
        }

        .promotor-badge,
        .fecha-badge,
        .dia-badge {
            display: inline-block;
            background: var(--primary-light);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.2rem 0.2rem 0.2rem 0;
        }

        .fecha-badge {
            background: var(--info-color);
            color: white;
            border: 1px solid var(--info-color);
        }

        .dia-descanso-badge {
            display: inline-block;
            background: var(--danger-color);
            color: white;
            border: 1px solid var(--danger-color);
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.2rem 0.2rem 0.2rem 0;
        }

        .dia-incidencia-badge {
            display: inline-block;
            background: #ef4444 !important;
            color: white !important;
            border: 1px solid #ef4444 !important;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.2rem 0.2rem 0.2rem 0;
        }

        .btn-detalle {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-detalle:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        /* 🆕 Botón para ver expediente */
        .btn-expediente {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }

        .btn-expediente:hover {
            background: #ea580c;
            transform: translateY(-2px);
        }

        /* ===== CLASES ESPECÍFICAS PARA DÍAS DE SEMANA ===== */
        .dias-cobertura {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .promotor-dia {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0.5rem;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .promotor-nombre {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .dias-trabajados {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .dias-cobertura-detalle {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .promotor-cobertura {
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .promotor-cobertura:hover {
            background: #f1f5f9;
            border-left-color: var(--primary-hover);
        }

        .promotor-cobertura .promotor-nombre {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            display: block;
        }

        .promotor-cobertura .fecha-badge {
            font-size: 0.7rem !important;
            padding: 0.2rem 0.4rem !important;
            margin: 0.1rem 0.1rem 0.1rem 0;
            background: var(--info-color);
            color: white;
            border: 1px solid var(--info-color);
            border-radius: 12px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .promotor-cobertura .fecha-badge:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .resumen-total {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--primary-light);
            border-radius: 6px;
            text-align: center;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--border-color);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        /* ===== INITIAL STATE ===== */
        .initial-state {
            transition: all 0.3s ease;
        }

        .initial-state.hide {
            display: none;
        }

        /* ===== MODALES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-container.modal-large {
            max-width: 900px;
        }

        /* 🆕 Modal de Expediente (Extra Grande) */
        .modal-container.modal-expediente {
            max-width: 1200px;
            max-height: 95vh;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 🆕 Header especial para expediente */
        .modal-header-expediente {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-content {
            padding: 2rem;
        }

        /* ===== TIMELINE DE DETALLE ===== */
        .detalle-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .detalle-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-left: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2.25rem;
            top: 1.5rem;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px var(--primary-color);
        }

        /* 🆕 ===== ESTILOS ESPECÍFICOS PARA EXPEDIENTE ===== */
        
        /* HEADER DEL EXPEDIENTE CON FOTO */
        .expediente-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: var(--radius);
            margin-bottom: 2rem;
        }

        .expediente-avatar {
            width: 120px;
            height: 120px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
            flex-shrink: 0;
        }

        .expediente-header-info {
            flex: 1;
        }

        .expediente-header-info h3 {
            margin: 0 0 1rem 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .expediente-badges {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .exp-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .exp-badge-primary {
            background: var(--primary-color);
            color: white;
        }

        .exp-badge-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .expediente-quick-info {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .quick-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .quick-info-item i {
            color: var(--primary-color);
        }

        /* ESTADÍSTICAS DEL EXPEDIENTE */
        .expediente-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .exp-stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .exp-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .exp-stat-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .exp-stat-info h4 {
            margin: 0 0 0.3rem 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .exp-stat-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* TABS DE NAVEGACIÓN */
        .expediente-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .exp-tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .exp-tab:hover {
            color: var(--primary-color);
        }

        .exp-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* CONTENIDO DE LAS TABS */
        .expediente-tab-content {
            min-height: 400px;
        }

        .exp-tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .exp-tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* INFO GRID - INFORMACIÓN PERSONAL */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .info-section {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 2px solid var(--border-color);
        }

        .info-section h4 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .info-value {
            font-weight: 500;
            color: var(--text-primary);
            text-align: right;
            font-size: 0.9rem;
        }

        /* ESTADÍSTICAS DETALLADAS */
        .stats-section {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            border: 2px solid var(--border-color);
        }

        .stats-section h4 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid-full {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-box {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-box-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .stat-box-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-box-danger {
            border-left-color: var(--danger-color);
        }

        .stat-box-danger .stat-box-value {
            color: var(--danger-color);
        }

        .stat-box-warning {
            border-left-color: var(--warning-color);
        }

        .stat-box-warning .stat-box-value {
            color: var(--warning-color);
        }

        .stat-box-info {
            border-left-color: var(--info-color);
        }

        .stat-box-info .stat-box-value {
            color: var(--info-color);
        }

        /* LISTAS DE ASIGNACIONES E INCIDENCIAS */
        .asignacion-item,
        .incidencia-item,
        .historial-item {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .asignacion-item:hover,
        .incidencia-item:hover,
        .historial-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .asignacion-header,
        .incidencia-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .asignacion-title,
        .incidencia-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .asignacion-badge,
        .incidencia-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-activo {
            background: var(--success-color);
            color: white;
        }

        .badge-inactivo {
            background: var(--secondary-color);
            color: white;
        }

        .badge-falta {
            background: #ef4444;
            color: white;
        }

        .badge-retardo {
            background: #f59e0b;
            color: white;
        }

        .badge-salud {
            background: #3b82f6;
            color: white;
        }

        .asignacion-details,
        .incidencia-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .detail-value {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        /* ===== NOTIFICACIONES ===== */
        .notifications-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: notificationSlideIn 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            font-size: 1.2rem;
        }

        .notification.success .notification-icon {
            color: var(--success-color);
        }

        .notification.error .notification-icon {
            color: var(--danger-color);
        }

        .notification.warning .notification-icon {
            color: var(--warning-color);
        }

        .notification.info .notification-icon {
            color: var(--info-color);
        }

        .notification-content h4 {
            margin: 0 0 5px 0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .notification-content p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1rem;
            color: #999;
            cursor: pointer;
            padding: 2px;
        }

        .notification-close:hover {
            color: var(--text-primary);
        }

        /* Indicadores de carga */
        .text-muted i.fa-spinner {
            margin-right: 5px;
            color: var(--primary-color);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-actions {
                flex-direction: column;
            }

            .reporte-header {
                flex-direction: column;
                text-align: center;
            }

            .modal-container {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .table-wrapper {
                font-size: 0.8rem;
            }

            .reporte-table th,
            .reporte-table td {
                padding: 10px 8px;
            }

            /* 🆕 Responsive para expediente */
            .expediente-header {
                flex-direction: column;
                text-align: center;
            }

            .expediente-avatar {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }

            .expediente-quick-info {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
            }

            .expediente-stats-grid {
                grid-template-columns: 1fr;
            }

            .expediente-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid-full {
                grid-template-columns: 1fr;
            }

            .asignacion-details,
            .incidencia-details {
                grid-template-columns: 1fr;
            }

            .modal-header {
                flex-wrap: wrap;
            }

            #btn-descargar-expediente {
                order: 3;
                width: 100%;
                margin-left: 0 !important;
                margin-right: 0 !important;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .modal-content {
                padding: 1rem;
            }

            .modal-header {
                padding: 1rem;
            }

            .filters-content {
                padding: 1rem;
            }

            .stats-content {
                padding: 1rem;
            }

            .reporte-content {
                padding: 1rem;
            }

            .filter-section {
                padding: 1rem;
            }

            .stat-card {
                flex-direction: column;
                text-align: center;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
            }
        }

        /* ===== UTILIDADES ===== */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        .fw-bold {
            font-weight: 700;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .d-none {
            display: none;
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 1rem;
        }
    </style>

    <!-- ===== SCRIPTS ===== -->
    <!-- ExcelJS para generar Excel con colores -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <!-- FileSaver para descargar archivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- jsPDF para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        // ===== VARIABLES GLOBALES =====
        let reporteActual = null;
        let promotoresListaGlobal = [];
        let expedienteActual = null;
        let filtrosAplicados = {
            fecha_inicio: null,
            fecha_fin: null
        };

        // Mapeo de días de la semana en español a números (0 = Domingo, 1 = Lunes, ...)
        const DIAS_SEMANA_MAP = {
            'domingo': 0,
            'lunes': 1,
            'martes': 2,
            'miércoles': 3,
            'miercoles': 3,
            'jueves': 4,
            'viernes': 5,
            'sábado': 6,
            'sabado': 6
        };

        // ===== ELEMENTOS DOM =====
        const fechaInicio = document.getElementById('fecha-inicio');
        const fechaFin = document.getElementById('fecha-fin');
        const filtroPromotor = document.getElementById('filtro-promotor');
        const filtroTienda = document.getElementById('filtro-tienda');

        const btnConsultar = document.getElementById('btn-consultar');
        const btnLimpiarFiltros = document.getElementById('btn-limpiar-filtros');
        const btnDescargarExcel = document.getElementById('btn-descargar-excel');
        const btnDescargarPdf = document.getElementById('btn-descargar-pdf');
        const btnDescargarExpediente = document.getElementById('btn-descargar-expediente');

        const statsContainer = document.getElementById('stats-container');
        const reporteContainer = document.getElementById('reporte-container');
        const reporteLoading = document.getElementById('reporte-loading');
        const reporteContent = document.getElementById('reporte-content');
        const reporteEmpty = document.getElementById('reporte-empty');
        const initialState = document.getElementById('initial-state');

        const modalDetalle = document.getElementById('modal-detalle');
        const modalExpediente = document.getElementById('modal-expediente');

        // ===== FUNCIÓN PARA OBTENER FECHAS DINÁMICAS =====
        function obtenerFechasSemanaActual() {
            const hoy = new Date();
            const diaSemana = hoy.getDay();

            const lunes = new Date(hoy);
            lunes.setDate(hoy.getDate() - (diaSemana === 0 ? 6 : diaSemana - 1));

            const domingo = new Date(lunes);
            domingo.setDate(lunes.getDate() + 6);

            return {
                inicio: lunes.toISOString().split('T')[0],
                fin: domingo.toISOString().split('T')[0]
            };
        }

        // ===== FUNCIÓN PARA ESTABLECER FECHAS POR DEFECTO =====
        function establecerFechasPorDefecto() {
            const fechasSemana = obtenerFechasSemanaActual();

            fechaInicio.value = fechasSemana.inicio;
            fechaFin.value = fechasSemana.fin;

            filtrosAplicados.fecha_inicio = fechasSemana.inicio;
            filtrosAplicados.fecha_fin = fechasSemana.fin;

            console.log(`Fechas por defecto establecidas: ${fechasSemana.inicio} al ${fechasSemana.fin}`);
        }

        // ===== FUNCIÓN AUXILIAR: Obtener día de la semana de una fecha =====
        function obtenerDiaSemanaNumero(fechaString) {
            const fecha = new Date(fechaString + 'T00:00:00');
            return fecha.getDay();
        }

        // ===== FUNCIÓN AUXILIAR: Verificar si una fecha es día de descanso =====
        function esDiaDescanso(fechaString, diaDescansoPromotor) {
            if (!diaDescansoPromotor) return false;

            const diaDescansoNormalizado = diaDescansoPromotor.toLowerCase().trim();
            const numeroDiaDescanso = DIAS_SEMANA_MAP[diaDescansoNormalizado];

            if (numeroDiaDescanso === undefined) {
                console.warn(`Día de descanso no reconocido: ${diaDescansoPromotor}`);
                return false;
            }

            const numeroDiaFecha = obtenerDiaSemanaNumero(fechaString);
            return numeroDiaFecha === numeroDiaDescanso;
        }

        // ===== INICIALIZACIÓN =====
        function init() {
            console.log('Inicializando módulo Reportes Tiendas → Promotores + EXPEDIENTES...');

            establecerFechasPorDefecto();
            configurarEventListeners();
            actualizarRangoFechas();

            cargarPromotores();
            cargarTiendas();

            console.log('Sistema iniciado con módulo de EXPEDIENTES ✅');
        }

        // ===== CARGA DINÁMICA DE DATOS =====
        async function cargarPromotores() {
            const promotorLoading = document.getElementById('promotor-loading');

            try {
                promotorLoading.style.display = 'block';

                const response = await fetch('../../api/reportes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tipo_reporte: 'promotores'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const resultado = await response.json();

                if (resultado.success && resultado.data.promotores) {
                    const promotores = resultado.data.promotores;
                    promotoresListaGlobal = promotores;

                    filtroPromotor.innerHTML = '<option value="">Todos los promotores</option>';

                    promotores.forEach(promotor => {
                        const option = document.createElement('option');
                        option.value = promotor.id_promotor;
                        option.textContent = `${promotor.nombre_completo} (${promotor.rfc || 'Sin RFC'})`;
                        filtroPromotor.appendChild(option);
                    });

                    console.log(`${promotores.length} promotores cargados dinámicamente`);
                } else {
                    console.warn('No se pudieron cargar los promotores:', resultado.message);
                    mostrarNotificacion('No se pudieron cargar los promotores', 'warning');
                }

            } catch (error) {
                console.error('Error cargando promotores:', error);
                mostrarNotificacion('Error al cargar promotores', 'error');
            } finally {
                promotorLoading.style.display = 'none';
            }
        }

        async function cargarTiendas() {
            const tiendaLoading = document.getElementById('tienda-loading');

            try {
                tiendaLoading.style.display = 'block';

                const response = await fetch('../../api/reportes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tipo_reporte: 'tiendas'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const resultado = await response.json();

                if (resultado.success && resultado.data.tiendas) {
                    const tiendas = resultado.data.tiendas;

                    filtroTienda.innerHTML = '<option value="">Todas las tiendas</option>';

                    tiendas.forEach(tienda => {
                        const option = document.createElement('option');
                        option.value = tienda.id;
                        option.textContent = `${tienda.nombre} (${tienda.numero || 'Sin número'}) - ${tienda.region}`;
                        filtroTienda.appendChild(option);
                    });

                    console.log(`${tiendas.length} tiendas cargadas dinámicamente`);
                } else {
                    console.warn('No se pudieron cargar las tiendas:', resultado.message);
                    mostrarNotificacion('No se pudieron cargar las tiendas', 'warning');
                }

            } catch (error) {
                console.error('Error cargando tiendas:', error);
                mostrarNotificacion('Error al cargar tiendas', 'error');
            } finally {
                tiendaLoading.style.display = 'none';
            }
        }

        function configurarEventListeners() {
            fechaInicio.addEventListener('change', actualizarRangoFechas);
            fechaFin.addEventListener('change', actualizarRangoFechas);

            btnConsultar.addEventListener('click', consultarReporte);
            btnLimpiarFiltros.addEventListener('click', limpiarFiltros);
            btnDescargarExcel.addEventListener('click', descargarExcel);
            btnDescargarPdf.addEventListener('click', descargarPDF);
            btnDescargarExpediente.addEventListener('click', descargarExpedientePDF);

            document.getElementById('modal-close-detalle').addEventListener('click', cerrarModalDetalle);
            modalDetalle.addEventListener('click', (e) => {
                if (e.target === modalDetalle) cerrarModalDetalle();
            });

            document.getElementById('modal-close-expediente').addEventListener('click', cerrarModalExpediente);
            modalExpediente.addEventListener('click', (e) => {
                if (e.target === modalExpediente) cerrarModalExpediente();
            });

            document.querySelectorAll('.exp-tab').forEach(tab => {
                tab.addEventListener('click', () => cambiarTabExpediente(tab.dataset.tab));
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cerrarModalDetalle();
                    cerrarModalExpediente();
                }
            });
        }

        // ===== MANEJO DE RANGO DE FECHAS =====
        function actualizarRangoFechas() {
            const rangoTexto = document.getElementById('rango-fechas-texto');

            if (!fechaInicio || !fechaFin || !rangoTexto) return;

            if (!fechaInicio.value || !fechaFin.value) {
                rangoTexto.textContent = 'Seleccione fechas válidas';
                return;
            }

            const fechaInicioSeleccionada = new Date(fechaInicio.value + 'T00:00:00');
            const fechaFinSeleccionada = new Date(fechaFin.value + 'T00:00:00');

            if (fechaFinSeleccionada < fechaInicioSeleccionada) {
                fechaFin.value = fechaInicio.value;
                mostrarNotificacion('La fecha fin no puede ser anterior a la fecha inicio', 'warning');
                return;
            }

            const opciones = { day: 'numeric', month: 'short', year: 'numeric' };
            const fechaInicioTexto = fechaInicioSeleccionada.toLocaleDateString('es-ES', opciones);
            const fechaFinTexto = fechaFinSeleccionada.toLocaleDateString('es-ES', opciones);

            rangoTexto.textContent = `${fechaInicioTexto} al ${fechaFinTexto}`;

            filtrosAplicados.fecha_inicio = fechaInicio.value;
            filtrosAplicados.fecha_fin = fechaFin.value;

            const periodoSeleccionado = document.getElementById('periodo-seleccionado');
            if (periodoSeleccionado) {
                const diferenciaMs = fechaFinSeleccionada - fechaInicioSeleccionada;
                const diasPeriodo = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24)) + 1;
                periodoSeleccionado.textContent = `Período del ${fechaInicioTexto} al ${fechaFinTexto} (${diasPeriodo} días)`;
            }
        }

        // ===== CONSULTA DE REPORTE =====
        async function consultarReporte() {
            console.log('Iniciando consulta de reporte...');

            if (!fechaInicio.value || !fechaFin.value) {
                mostrarNotificacion('Por favor seleccione un rango de fechas válido', 'warning');
                return;
            }

            if (initialState) {
                initialState.style.display = 'none';
            }

            filtrosAplicados = {
                fecha_inicio: fechaInicio.value,
                fecha_fin: fechaFin.value
            };

            mostrarLoading();

            try {
                const datosConsulta = {
                    tipo_reporte: 'asignaciones',
                    fecha_inicio: filtrosAplicados.fecha_inicio,
                    fecha_fin: filtrosAplicados.fecha_fin
                };

                if (filtroPromotor.value && filtroPromotor.value.trim() !== '') {
                    datosConsulta.filtro_promotor = parseInt(filtroPromotor.value);
                }

                if (filtroTienda.value && filtroTienda.value.trim() !== '') {
                    datosConsulta.filtro_tienda = parseInt(filtroTienda.value);
                }

                console.log('Enviando consulta con datos:', datosConsulta);

                const response = await fetch('../../api/reportes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datosConsulta)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }

                const resultado = await response.json();
                console.log('Respuesta del servidor:', resultado);

                if (!resultado.success) {
                    throw new Error(resultado.message || 'Error desconocido en la respuesta del servidor');
                }

                const asignacionesAPI = resultado.data.asignaciones || [];
                const estadisticasAPI = resultado.data.estadisticas || {};

                console.log(`Asignaciones encontradas: ${asignacionesAPI.length}`);

                if (asignacionesAPI.length === 0) {
                    mostrarEstadoVacio();
                    mostrarNotificacion(
                        `No se encontraron asignaciones para el período ${filtrosAplicados.fecha_inicio} al ${filtrosAplicados.fecha_fin}`,
                        'info'
                    );
                } else {
                    reporteActual = asignacionesAPI;
                    mostrarEstadisticas(estadisticasAPI);
                    mostrarContenido();
                    renderizarTablaTiendasCorregida(reporteActual);
                    actualizarSubtituloReporte();

                    mostrarNotificacion(
                        `Reporte generado exitosamente: ${asignacionesAPI.length} asignaciones encontradas en ${estadisticasAPI.total_tiendas} tiendas`,
                        'success'
                    );
                }

            } catch (error) {
                console.error('Error consultando reporte:', error);
                mostrarNotificacion(`Error al consultar el reporte: ${error.message}`, 'error');
                mostrarEstadoVacio();
            }
        }

        // ===== RENDERIZAR TABLA TIENDAS =====
        function renderizarTablaTiendasCorregida(asignaciones) {
            const tbody = document.getElementById('tbody-tiendas');
            tbody.innerHTML = '';

            console.log('Renderizando tabla con', asignaciones.length, 'asignaciones');

            const tiendasGroup = new Map();

            asignaciones.forEach((asignacion) => {
                const tiendaId = asignacion.tienda_id;

                if (!tiendasGroup.has(tiendaId)) {
                    tiendasGroup.set(tiendaId, {
                        tienda: {
                            id: asignacion.tienda_id,
                            nombre: asignacion.tienda_nombre || 'Tienda Sin Nombre',
                            numero: asignacion.tienda_numero || 'S/N',
                            region: asignacion.tienda_region || 0,
                            cadena: asignacion.tienda_cadena || 'N/A',
                            ciudad: asignacion.tienda_ciudad || 'N/A',
                            estado: asignacion.tienda_estado || 'N/A'
                        },
                        asignaciones: []
                    });
                }
                tiendasGroup.get(tiendaId).asignaciones.push(asignacion);
            });

            console.log(`Se encontraron ${tiendasGroup.size} tiendas únicas`);

            for (const [tiendaId, data] of tiendasGroup) {
                const tienda = data.tienda;
                const asignacionesTienda = data.asignaciones;

                const promotoresGroup = new Map();
                asignacionesTienda.forEach(asignacion => {
                    const promotorId = asignacion.promotor_id;

                    if (!promotoresGroup.has(promotorId)) {
                        promotoresGroup.set(promotorId, {
                            promotor: {
                                id: asignacion.promotor_id,
                                nombre: asignacion.promotor_nombre || 'Promotor Sin Nombre',
                                rfc: asignacion.promotor_rfc || 'N/A',
                                telefono: asignacion.promotor_telefono || 'N/A',
                                correo: asignacion.promotor_correo || 'N/A',
                                dia_descanso: asignacion.promotor_dia_descanso || null
                            },
                            dias: []
                        });
                    }
                    promotoresGroup.get(promotorId).dias.push({
                        fecha: asignacion.fecha,
                        dia_semana: asignacion.dia_semana,
                        claves: asignacion.claves || [],
                        tiene_incidencia: asignacion.tiene_incidencia || false,
                        info_incidencia: asignacion.info_incidencia || null
                    });
                });

                let totalDiasTrabajados = 0;
                let totalDiasDescanso = 0;
                let totalIncidencias = 0;
                let totalAsignaciones = 0;

                let promotoresHTML = '';
                for (const [promotorId, promotorData] of promotoresGroup) {
                    const diasConAsignacion = promotorData.dias.length;
                    totalAsignaciones += diasConAsignacion;

                    let diasEnDescanso = 0;
                    if (promotorData.promotor.dia_descanso) {
                        diasEnDescanso = promotorData.dias.filter(dia =>
                            esDiaDescanso(dia.fecha, promotorData.promotor.dia_descanso)
                        ).length;
                    }

                    let diasConIncidencia = promotorData.dias.filter(dia => dia.tiene_incidencia).length;

                    const diasTrabajadosReales = diasConAsignacion - diasEnDescanso - diasConIncidencia;

                    totalDiasTrabajados += diasTrabajadosReales;
                    totalDiasDescanso += diasEnDescanso;
                    totalIncidencias += diasConIncidencia;

                    const infoDescanso = diasEnDescanso > 0
                        ? `<span style="color: #f59e0b; font-size: 0.7rem; margin-left: 5px;">(-${diasEnDescanso} descanso${diasEnDescanso > 1 ? 's' : ''})</span>`
                        : '';

                    const infoIncidencias = diasConIncidencia > 0
                        ? `<span style="color: #ef4444; font-size: 0.7rem; margin-left: 5px;">(-${diasConIncidencia} incidencia${diasConIncidencia > 1 ? 's' : ''})</span>`
                        : '';

                    promotoresHTML += `
                        <div class="promotor-dia" style="margin-bottom: 0.3rem;">
                            <span class="promotor-nombre">${promotorData.promotor.nombre}</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span class="dias-trabajados">${diasTrabajadosReales} días ${infoDescanso}${infoIncidencias}</span>
                                <button class="btn-expediente" onclick="verExpedientePromotor(${promotorData.promotor.id})" title="Ver Expediente">
                                    <i class="fas fa-id-card"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }

                let diasCoberturaHTML = '';
                for (const [promotorId, promotorData] of promotoresGroup) {
                    const promotor = promotorData.promotor;
                    const diasNormales = [];
                    const diasEnDescanso = [];
                    const diasConIncidencias = [];

                    promotorData.dias
                        .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
                        .forEach(dia => {
                            const fechaObj = new Date(dia.fecha + 'T00:00:00');
                            const diaCorto = fechaObj.toLocaleDateString('es-ES', { weekday: 'short' });
                            const diaFormateado = `${diaCorto} ${fechaObj.getDate()}`;

                            const esDescanso = esDiaDescanso(dia.fecha, promotor.dia_descanso);
                            const tieneIncidencia = dia.tiene_incidencia;

                            if (tieneIncidencia) {
                                const tipoIncidencia = dia.info_incidencia?.tipo || 'incidencia';
                                diasConIncidencias.push({
                                    dia: diaFormateado,
                                    tipo: tipoIncidencia
                                });
                            } else if (esDescanso) {
                                diasEnDescanso.push(diaFormateado);
                            } else {
                                diasNormales.push(diaFormateado);
                            }
                        });

                    const diaDescansoInfo = promotor.dia_descanso
                        ? `<span style="font-size: 0.7rem; color: #6c757d;">(Descanso: ${promotor.dia_descanso})</span>`
                        : '';

                    diasCoberturaHTML += `
                        <div class="promotor-cobertura">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.8rem; margin-bottom: 0.2rem;">
                                ${promotorData.promotor.nombre} ${diaDescansoInfo}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.2rem;">
                                ${diasNormales.map(dia => `<span class="fecha-badge">${dia}</span>`).join('')}
                                ${diasEnDescanso.map(dia => `<span style="font-size: 0.7rem; padding: 0.2rem 0.4rem; background: #f59e0b; color: white; border: 1px solid #f59e0b; border-radius: 12px; display: inline-block; margin: 0.1rem;">⏸️ ${dia}</span>`).join('')}
                                ${diasConIncidencias.map(item => `<span style="font-size: 0.7rem; padding: 0.2rem 0.4rem; background: #ef4444; color: white; border: 1px solid #ef4444; border-radius: 12px; display: inline-block; margin: 0.1rem;">❌ ${item.dia}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                const resumenTexto = (totalDiasDescanso > 0 || totalIncidencias > 0)
                    ? `<div style="font-weight: 700; font-size: 0.95rem;">${totalDiasTrabajados} días laborables</div>
                       <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.3rem;">
                           (${totalAsignaciones} asignaciones${totalDiasDescanso > 0 ? ` - ${totalDiasDescanso} descanso${totalDiasDescanso > 1 ? 's' : ''}` : ''}${totalIncidencias > 0 ? ` - ${totalIncidencias} incidencia${totalIncidencias > 1 ? 's' : ''}` : ''})
                       </div>`
                    : `<div style="font-weight: 700; font-size: 0.95rem;">${totalDiasTrabajados} días laborables</div>`;

                const row = `
                    <tr>
                        <td>
                            <strong>${tienda.nombre}</strong><br>
                            <small>Número: ${tienda.numero}</small><br>
                            <small>Región: ${tienda.region}</small><br>
                            <small>Cadena: ${tienda.cadena}</small>
                        </td>
                        <td>
                            <div class="tienda-info">
                                <strong>Ciudad:</strong> ${tienda.ciudad}<br>
                                <strong>Estado:</strong> ${tienda.estado}
                            </div>
                        </td>
                        <td>
                            <div class="dias-cobertura">
                                ${promotoresHTML}
                            </div>
                        </td>
                        <td>
                            <div class="dias-cobertura-detalle">
                                ${diasCoberturaHTML}
                            </div>
                        </td>
                        <td>
                            <div class="resumen-total">
                                ${resumenTexto}
                            </div>
                        </td>
                        <td>
                            <button class="btn-detalle" onclick="verDetalleTienda(${tiendaId})">
                                <i class="fas fa-eye"></i> Ver Detalle
                            </button>
                        </td>
                    </tr>
                `;

                tbody.innerHTML += row;
            }

            console.log(`Tabla renderizada con ${tiendasGroup.size} tiendas`);
        }

        // ===== FUNCIONES AUXILIARES =====
        function actualizarSubtituloReporte() {
            if (!filtrosAplicados.fecha_inicio || !filtrosAplicados.fecha_fin) return;

            const fechaInicioSeleccionada = new Date(filtrosAplicados.fecha_inicio + 'T00:00:00');
            const fechaFinSeleccionada = new Date(filtrosAplicados.fecha_fin + 'T00:00:00');

            const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
            const fechaInicioTexto = fechaInicioSeleccionada.toLocaleDateString('es-ES', opciones);
            const fechaFinTexto = fechaFinSeleccionada.toLocaleDateString('es-ES', opciones);

            const subtitulo = document.getElementById('reporte-subtitulo');
            if (subtitulo) {
                subtitulo.textContent = `Período del ${fechaInicioTexto} al ${fechaFinTexto}`;
            }
        }

        function mostrarEstadisticas(estadisticasAPI) {
            const totalTiendas = estadisticasAPI.total_tiendas || 0;
            const totalPromotores = estadisticasAPI.total_promotores || 0;
            const totalAsignaciones = estadisticasAPI.total_asignaciones || 0;
            const diasPeriodo = estadisticasAPI.dias_periodo || calcularDiasPeriodo(filtrosAplicados.fecha_inicio, filtrosAplicados.fecha_fin);

            document.getElementById('stat-tiendas').textContent = totalTiendas;
            document.getElementById('stat-promotores').textContent = totalPromotores;
            document.getElementById('stat-dias').textContent = diasPeriodo;
            document.getElementById('stat-dias-trabajados').textContent = totalAsignaciones;

            console.log(`Estadísticas mostradas: ${totalTiendas} tiendas, ${totalPromotores} promotores, ${totalAsignaciones} asignaciones`);
        }

        function calcularDiasPeriodo(fechaInicio, fechaFin) {
            if (!fechaInicio || !fechaFin) return 0;
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            const diferencia = fin - inicio;
            return Math.floor(diferencia / (1000 * 60 * 60 * 24)) + 1;
        }

        function mostrarLoading() {
            reporteLoading.style.display = 'block';
            reporteContent.style.display = 'none';
            reporteEmpty.style.display = 'none';
            statsContainer.style.display = 'none';
        }

        function mostrarContenido() {
            reporteLoading.style.display = 'none';
            reporteContent.style.display = 'block';
            reporteEmpty.style.display = 'none';
            statsContainer.style.display = 'block';
        }

        function mostrarEstadoVacio() {
            reporteLoading.style.display = 'none';
            reporteContent.style.display = 'none';
            reporteEmpty.style.display = 'block';

            document.getElementById('stat-tiendas').textContent = '0';
            document.getElementById('stat-promotores').textContent = '0';
            document.getElementById('stat-dias').textContent = filtrosAplicados.fecha_inicio && filtrosAplicados.fecha_fin ?
                calcularDiasPeriodo(filtrosAplicados.fecha_inicio, filtrosAplicados.fecha_fin) : '0';
            document.getElementById('stat-dias-trabajados').textContent = '0';
            statsContainer.style.display = 'block';
        }

        // ===== DETALLES =====
        function verDetalleTienda(idTienda) {
            if (!reporteActual || reporteActual.length === 0) {
                mostrarNotificacion('No hay datos disponibles', 'warning');
                return;
            }

            const asignacionesTienda = reporteActual.filter(a => a.tienda_id == idTienda);

            if (asignacionesTienda.length > 0) {
                const tiendaInfo = {
                    id: asignacionesTienda[0].tienda_id,
                    nombre: asignacionesTienda[0].tienda_nombre,
                    numero: asignacionesTienda[0].tienda_numero || 'N/A',
                    region: asignacionesTienda[0].tienda_region,
                    cadena: asignacionesTienda[0].tienda_cadena || 'N/A',
                    ciudad: asignacionesTienda[0].tienda_ciudad || 'N/A',
                    estado: asignacionesTienda[0].tienda_estado || 'N/A',
                    asignaciones: asignacionesTienda
                };

                mostrarModalDetalle('Tienda', tiendaInfo);
            } else {
                mostrarNotificacion('No hay detalles disponibles para esta tienda en el período seleccionado', 'info');
            }
        }

        function mostrarModalDetalle(tipo, data) {
            document.getElementById('detalle-title').innerHTML = `<i class="fas fa-info-circle"></i> Detalle de ${tipo}`;

            const infoHtml = `
                <h4><i class="fas fa-store"></i> ${data.nombre}</h4>
                <p><strong>Número:</strong> ${data.numero}</p>
                <p><strong>Cadena:</strong> ${data.cadena}</p>
                <p><strong>Ciudad:</strong> ${data.ciudad}</p>
                <p><strong>Estado:</strong> ${data.estado}</p>
                <p><strong>Región:</strong> ${data.region}</p>
            `;

            document.getElementById('detalle-info').innerHTML = infoHtml;

            renderizarTimelineDetalle(data.asignaciones);

            modalDetalle.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function renderizarTimelineDetalle(asignaciones) {
            const timeline = document.getElementById('detalle-timeline');
            timeline.innerHTML = '';

            const asignacionesPorFecha = {};
            asignaciones.forEach(asignacion => {
                if (!asignacionesPorFecha[asignacion.fecha]) {
                    asignacionesPorFecha[asignacion.fecha] = [];
                }
                asignacionesPorFecha[asignacion.fecha].push(asignacion);
            });

            const fechasOrdenadas = Object.keys(asignacionesPorFecha).sort((a, b) => new Date(b) - new Date(a));

            fechasOrdenadas.forEach(fecha => {
                const asignacionesFecha = asignacionesPorFecha[fecha];
                const fechaObj = new Date(fecha + 'T00:00:00');
                const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                let promotoresHTML = '';
                asignacionesFecha.forEach(asignacion => {
                    const clavesHTML = asignacion.claves && asignacion.claves.length > 0
                        ? asignacion.claves.map(clave => `<span class="promotor-badge">${clave}</span>`).join('')
                        : '<span class="text-muted">Sin claves</span>';

                    promotoresHTML += `
                        <div style="margin-bottom: 1rem; padding: 0.8rem; background: #f8fafc; border-radius: 8px;">
                            <strong style="color: var(--primary-color);">${asignacion.promotor_nombre}</strong><br>
                            <small>RFC: ${asignacion.promotor_rfc || 'N/A'}</small><br>
                            <div style="margin-top: 0.5rem;">
                                <strong>Claves:</strong> ${clavesHTML}
                            </div>
                        </div>
                    `;
                });

                const timelineItem = `
                    <div class="timeline-item">
                        <h4>${fechaFormateada}</h4>
                        ${promotoresHTML}
                    </div>
                `;

                timeline.innerHTML += timelineItem;
            });
        }

        function cerrarModalDetalle() {
            modalDetalle.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 🆕 ===== FUNCIONES PARA EXPEDIENTE DE PROMOTOR =====
        
        async function verExpedientePromotor(idPromotor) {
            console.log(`Ver expediente del promotor ID: ${idPromotor}`);
            
            modalExpediente.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            document.getElementById('expediente-loading').style.display = 'block';
            document.getElementById('expediente-data').style.display = 'none';
            
            try {
                const fechaInicioPeriodo = filtrosAplicados.fecha_inicio || document.getElementById('fecha-inicio').value;
                const fechaFinPeriodo = filtrosAplicados.fecha_fin || document.getElementById('fecha-fin').value;
                
                const response = await fetch('../../api/reportes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tipo_reporte: 'expediente',
                        id_promotor: idPromotor,
                        fecha_inicio: fechaInicioPeriodo,
                        fecha_fin: fechaFinPeriodo
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const resultado = await response.json();
                console.log('Expediente recibido:', resultado);
                
                if (resultado.success && resultado.data) {
                    expedienteActual = resultado.data;
                    renderizarExpediente(resultado.data);
                    mostrarNotificacion('Expediente cargado exitosamente', 'success');
                } else {
                    throw new Error(resultado.message || 'Error al cargar expediente');
                }
                
            } catch (error) {
                console.error('Error cargando expediente:', error);
                mostrarNotificacion('Error al cargar expediente: ' + error.message, 'error');
                cerrarModalExpediente();
            }
        }
        
        // 🔥 FUNCIÓN CORREGIDA PARA RENDERIZAR EXPEDIENTE (SOLO CAMPOS REALES DE LA BD)
        function renderizarExpediente(expediente) {
            console.log('Renderizando expediente:', expediente);
            
            const promotor = expediente.promotor;
            const stats = expediente.estadisticas_generales;
            const statsPeriodo = expediente.estadisticas_periodo;
            const asignaciones = expediente.asignaciones;
            const incidencias = expediente.incidencias;
            const historial = expediente.historial_completo;
            const periodo = expediente.periodo;
            
            // HEADER
            document.getElementById('exp-nombre').textContent = promotor.nombre_completo;
            document.getElementById('exp-estatus').textContent = promotor.estatus || 'ACTIVO';
            document.getElementById('exp-rfc').textContent = promotor.rfc || 'Sin RFC';
            document.getElementById('exp-telefono').textContent = promotor.telefono || 'No disponible';
            document.getElementById('exp-correo').textContent = promotor.correo || 'No disponible';
            document.getElementById('exp-region').textContent = `Región ${promotor.region || '0'}`;
            
            // ESTADÍSTICAS RÁPIDAS
            document.getElementById('exp-stat-antiguedad').textContent = promotor.antiguedad_texto || 'N/A';
            document.getElementById('exp-stat-tiendas').textContent = stats.total_tiendas_asignadas || 0;
            document.getElementById('exp-stat-asignaciones').textContent = stats.total_periodos_asignacion || 0;
            document.getElementById('exp-stat-incidencias').textContent = statsPeriodo.total_incidencias || 0;
            
            // TAB: INFORMACIÓN PERSONAL (🔥 SOLO CAMPOS REALES)
            document.getElementById('exp-info-nombre').textContent = promotor.nombre_completo;
            document.getElementById('exp-info-rfc').textContent = promotor.rfc || 'N/A';
            document.getElementById('exp-info-nss').textContent = promotor.nss || 'N/A';
            
            // Fecha de ingreso
            document.getElementById('exp-info-fingreso').textContent = promotor.fecha_ingreso ? 
                new Date(promotor.fecha_ingreso).toLocaleDateString('es-ES') : 'N/A';
            
            // Región
            document.getElementById('exp-info-region').textContent = promotor.region || '0';
            
            // Contacto
            document.getElementById('exp-info-tel').textContent = promotor.telefono || 'N/A';
            document.getElementById('exp-info-email').textContent = promotor.correo || 'N/A';
            
            // Datos Bancarios
            document.getElementById('exp-info-banco').textContent = promotor.banco || 'N/A';
            document.getElementById('exp-info-cuenta').textContent = promotor.numero_cuenta || 'N/A';
            
            // Información Laboral
            document.getElementById('exp-info-falta').textContent = promotor.fecha_alta ? 
                new Date(promotor.fecha_alta).toLocaleDateString('es-ES') : 'N/A';
            document.getElementById('exp-info-antiguedad').textContent = promotor.antiguedad_texto || 'N/A';
            document.getElementById('exp-info-estatus').textContent = promotor.estatus || 'ACTIVO';
            document.getElementById('exp-info-tipo-trabajo').textContent = promotor.tipo_trabajo || 'fijo';
            document.getElementById('exp-info-descanso').textContent = promotor.dia_descanso_nombre || 'No definido';
            document.getElementById('exp-info-vacaciones').textContent = promotor.vacaciones ? 'Sí' : 'No';
            
            const clavesHTML = promotor.claves_array && promotor.claves_array.length > 0 ?
                promotor.claves_array.map(c => `<span class="promotor-badge">${c}</span>`).join(' ') :
                'Sin claves';
            document.getElementById('exp-info-claves').innerHTML = clavesHTML;
            
            // TAB: ESTADÍSTICAS
            const fechaInicioPeriodo = new Date(periodo.fecha_inicio).toLocaleDateString('es-ES');
            const fechaFinPeriodo = new Date(periodo.fecha_fin).toLocaleDateString('es-ES');
            document.getElementById('exp-periodo-texto').textContent = `Del ${fechaInicioPeriodo} al ${fechaFinPeriodo} (${periodo.dias_totales} días)`;
            
            document.getElementById('exp-stat-dias-asig').textContent = statsPeriodo.dias_con_asignacion || 0;
            document.getElementById('exp-stat-tiendas-vis').textContent = statsPeriodo.tiendas_visitadas || 0;
            document.getElementById('exp-stat-total-inc').textContent = statsPeriodo.total_incidencias || 0;
            
            document.getElementById('exp-stat-faltas').textContent = statsPeriodo.faltas || 0;
            document.getElementById('exp-stat-retardos').textContent = statsPeriodo.retardos || 0;
            document.getElementById('exp-stat-incapacidades').textContent = statsPeriodo.incapacidades || 0;
            document.getElementById('exp-stat-dias-inc').textContent = statsPeriodo.total_dias_incidencia || 0;
            
            // TAB: ASIGNACIONES
            renderizarAsignacionesExpediente(asignaciones);
            
            // TAB: INCIDENCIAS
            renderizarIncidenciasExpediente(incidencias);
            
            // TAB: HISTORIAL
            renderizarHistorialExpediente(historial);
            
            // Ocultar loading y mostrar datos
            document.getElementById('expediente-loading').style.display = 'none';
            document.getElementById('expediente-data').style.display = 'block';
            
            // Resetear a la primera tab
            cambiarTabExpediente('informacion');
        }
        
        function renderizarAsignacionesExpediente(asignaciones) {
            const container = document.getElementById('exp-asignaciones-lista');
            
            if (!asignaciones || asignaciones.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay asignaciones en este período</p>';
                return;
            }
            
            let html = '';
            asignaciones.forEach(asig => {
                const fechaInicio = new Date(asig.fecha_inicio).toLocaleDateString('es-ES');
                const fechaFin = asig.fecha_fin ? new Date(asig.fecha_fin).toLocaleDateString('es-ES') : 'Actual';
                const badgeClass = asig.activo ? 'badge-activo' : 'badge-inactivo';
                
                html += `
                    <div class="asignacion-item">
                        <div class="asignacion-header">
                            <div class="asignacion-title">${asig.nombre_tienda}</div>
                            <span class="asignacion-badge ${badgeClass}">${asig.activo ? 'Activa' : 'Inactiva'}</span>
                        </div>
                        <div class="asignacion-details">
                            <div class="detail-item">
                                <span class="detail-label">Número de Tienda</span>
                                <span class="detail-value">${asig.num_tienda || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ciudad</span>
                                <span class="detail-value">${asig.ciudad}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Estado</span>
                                <span class="detail-value">${asig.estado}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Región</span>
                                <span class="detail-value">${asig.region}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Cadena</span>
                                <span class="detail-value">${asig.cadena}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fecha Inicio</span>
                                <span class="detail-value">${fechaInicio}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fecha Fin</span>
                                <span class="detail-value">${fechaFin}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderizarIncidenciasExpediente(incidencias) {
            const container = document.getElementById('exp-incidencias-lista');
            
            if (!incidencias || incidencias.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay incidencias registradas en este período</p>';
                return;
            }
            
            let html = '';
            incidencias.forEach(inc => {
                const fechaInicio = new Date(inc.fecha_incidencia).toLocaleDateString('es-ES');
                const fechaFin = inc.fecha_fin ? new Date(inc.fecha_fin).toLocaleDateString('es-ES') : 'N/A';
                
                let badgeClass = 'badge-falta';
                if (inc.tipo_incidencia === 'retardo') badgeClass = 'badge-retardo';
                if (inc.tipo_incidencia === 'salud') badgeClass = 'badge-salud';
                
                const tipoTexto = inc.tipo_incidencia.charAt(0).toUpperCase() + inc.tipo_incidencia.slice(1);
                
                html += `
                    <div class="incidencia-item">
                        <div class="incidencia-header">
                            <div class="incidencia-title">${tipoTexto}</div>
                            <span class="incidencia-badge ${badgeClass}">${inc.dias_totales || 1} día${inc.dias_totales > 1 ? 's' : ''}</span>
                        </div>
                        <div class="incidencia-details">
                            <div class="detail-item">
                                <span class="detail-label">Fecha Inicio</span>
                                <span class="detail-value">${fechaInicio}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fecha Fin</span>
                                <span class="detail-value">${fechaFin}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Estatus</span>
                                <span class="detail-value">${inc.estatus || 'N/A'}</span>
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">Descripción</span>
                                <span class="detail-value">${inc.descripcion || 'Sin descripción'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderizarHistorialExpediente(historial) {
            const container = document.getElementById('exp-historial-lista');
            
            if (!historial || historial.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay historial disponible</p>';
                return;
            }
            
            let html = '';
            historial.forEach(item => {
                const fechaInicio = new Date(item.fecha_inicio).toLocaleDateString('es-ES');
                const fechaFin = item.fecha_fin ? new Date(item.fecha_fin).toLocaleDateString('es-ES') : 'Actual';
                const badgeClass = item.activo ? 'badge-activo' : 'badge-inactivo';
                
                html += `
                    <div class="historial-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <strong style="font-size: 1rem;">${item.nombre_tienda}</strong>
                            <span class="asignacion-badge ${badgeClass}" style="font-size: 0.75rem;">${item.activo ? 'Activa' : 'Finalizada'}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.85rem;">
                            <div>
                                <span style="color: var(--text-secondary);">Número:</span>
                                <strong>${item.num_tienda || 'N/A'}</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Ciudad:</span>
                                <strong>${item.ciudad}</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Estado:</span>
                                <strong>${item.estado}</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Inicio:</span>
                                <strong>${fechaInicio}</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Fin:</span>
                                <strong>${fechaFin}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function cambiarTabExpediente(tabName) {
            document.querySelectorAll('.exp-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.exp-tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.querySelector(`.exp-tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        function cerrarModalExpediente() {
            modalExpediente.classList.remove('active');
            document.body.style.overflow = 'auto';
            expedienteActual = null;
        }

        // 🆕 ===== FUNCIÓN PARA DESCARGAR EXPEDIENTE EN PDF =====
        async function descargarExpedientePDF() {
            if (!expedienteActual) {
                mostrarNotificacion('No hay expediente cargado para descargar', 'warning');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const promotor = expedienteActual.promotor;
                const periodo = expedienteActual.periodo;
                
                // ENCABEZADO
                doc.setFillColor(39, 174, 96);
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('EXPEDIENTE DEL PROMOTOR', 105, 15, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text(promotor.nombre_completo, 105, 25, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`RFC: ${promotor.rfc || 'N/A'} | Estatus: ${promotor.estatus || 'N/A'}`, 105, 33, { align: 'center' });
                
                // RESTABLECER COLOR DE TEXTO
                doc.setTextColor(0, 0, 0);
                
                let yPos = 50;
                
                // INFORMACIÓN BÁSICA
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(39, 174, 96);
                doc.text('Información Personal', 15, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const infoBasica = [
                    ['Teléfono:', promotor.telefono || 'N/A'],
                    ['Correo:', promotor.correo || 'N/A'],
                    ['Región:', `Región ${promotor.region || '0'}`],
                    ['RFC:', promotor.rfc || 'N/A'],
                    ['NSS:', promotor.nss || 'N/A'],
                    ['Fecha Ingreso:', promotor.fecha_ingreso ? new Date(promotor.fecha_ingreso).toLocaleDateString('es-ES') : 'N/A']
                ];
                
                infoBasica.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 15, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 60, yPos);
                    yPos += 6;
                });
                
                yPos += 5;
                
                // ESTADÍSTICAS DEL PERÍODO
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(39, 174, 96);
                doc.text('Estadísticas del Período', 15, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.text(`Período: ${new Date(periodo.fecha_inicio).toLocaleDateString('es-ES')} al ${new Date(periodo.fecha_fin).toLocaleDateString('es-ES')}`, 15, yPos);
                yPos += 8;
                
                const statsPeriodo = expedienteActual.estadisticas_periodo;
                const estadisticas = [
                    ['Días con Asignación:', statsPeriodo.dias_con_asignacion || 0],
                    ['Tiendas Visitadas:', statsPeriodo.tiendas_visitadas || 0],
                    ['Total Incidencias:', statsPeriodo.total_incidencias || 0],
                    ['Faltas:', statsPeriodo.faltas || 0],
                    ['Retardos:', statsPeriodo.retardos || 0],
                    ['Incapacidades:', statsPeriodo.incapacidades || 0]
                ];
                
                estadisticas.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 15, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(String(value), 70, yPos);
                    yPos += 6;
                });
                
                // NUEVA PÁGINA PARA ASIGNACIONES
                doc.addPage();
                yPos = 20;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(39, 174, 96);
                doc.text('Asignaciones Actuales', 15, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 10;
                
                const asignaciones = expedienteActual.asignaciones || [];
                if (asignaciones.length > 0) {
                    doc.setFontSize(9);
                    asignaciones.forEach((asig, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${asig.nombre_tienda}`, 15, yPos);
                        yPos += 5;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`   Ciudad: ${asig.ciudad}, Estado: ${asig.estado}`, 15, yPos);
                        yPos += 5;
                        doc.text(`   Fecha Inicio: ${new Date(asig.fecha_inicio).toLocaleDateString('es-ES')}`, 15, yPos);
                        yPos += 5;
                        doc.text(`   Estatus: ${asig.activo ? 'Activa' : 'Inactiva'}`, 15, yPos);
                        yPos += 8;
                    });
                } else {
                    doc.setFont('helvetica', 'italic');
                    doc.text('No hay asignaciones en este período', 15, yPos);
                }
                
                // PIE DE PÁGINA
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Página ${i} de ${totalPages}`, 105, 290, { align: 'center' });
                    doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 105, 285, { align: 'center' });
                }
                
                // DESCARGAR
                const nombreArchivo = `expediente-${promotor.nombre_completo.replace(/ /g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nombreArchivo);
                
                mostrarNotificacion('Expediente descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando PDF del expediente:', error);
                mostrarNotificacion('Error al generar PDF del expediente: ' + error.message, 'error');
            }
        }

        // ===== LIMPIAR FILTROS =====
        function limpiarFiltros() {
            console.log('Limpiando filtros...');

            filtroPromotor.value = '';
            filtroTienda.value = '';

            establecerFechasPorDefecto();
            actualizarRangoFechas();

            reporteActual = null;
            mostrarEstadoVacio();

            if (initialState) {
                initialState.style.display = 'block';
            }

            mostrarNotificacion('Filtros limpiados', 'info');
        }

        // ===== GENERACIÓN DE EXCEL ===== 
        async function descargarExcel() {
            if (!reporteActual || reporteActual.length === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }

            try {
                const workbook = new ExcelJS.Workbook();
                workbook.creator = 'Sistema de Reportes';
                workbook.created = new Date();

                const worksheet = workbook.addWorksheet('Reporte Tiendas-Promotores');

                const headerRow = worksheet.addRow([
                    'Nombre Tienda',
                    'Número Tienda',
                    'Región',
                    'Nombre Promotor',
                    'Día Descanso',
                    'Total Asignaciones',
                    'Días Descanso',
                    'Incidencias',
                    'Días Laborables',
                    'Claves',
                    'Detalle Incidencias'
                ]);

                headerRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF27AE60' }
                    };
                    cell.font = {
                        bold: true,
                        color: { argb: 'FFFFFFFF' },
                        size: 12
                    };
                    cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell.border = {
                        top: { style: 'medium' },
                        left: { style: 'medium' },
                        bottom: { style: 'medium' },
                        right: { style: 'medium' }
                    };
                });
                headerRow.height = 30;

                const tiendasGroup = {};
                reporteActual.forEach(asignacion => {
                    const tiendaId = asignacion.tienda_id;
                    const promotorId = asignacion.promotor_id;

                    if (!tiendasGroup[tiendaId]) {
                        tiendasGroup[tiendaId] = {
                            nombre: asignacion.tienda_nombre,
                            numero: asignacion.tienda_numero || 'S/N',
                            region: asignacion.tienda_region,
                            promotores: {}
                        };
                    }

                    if (!tiendasGroup[tiendaId].promotores[promotorId]) {
                        tiendasGroup[tiendaId].promotores[promotorId] = {
                            nombre: asignacion.promotor_nombre,
                            dia_descanso: asignacion.promotor_dia_descanso || 'No definido',
                            fechas: [],
                            claves: new Set(),
                            incidencias: []
                        };
                    }

                    tiendasGroup[tiendaId].promotores[promotorId].fechas.push({
                        fecha: asignacion.fecha,
                        es_descanso: esDiaDescanso(asignacion.fecha, asignacion.promotor_dia_descanso),
                        tiene_incidencia: asignacion.tiene_incidencia || false,
                        info_incidencia: asignacion.info_incidencia || null
                    });

                    if (asignacion.claves && asignacion.claves.length > 0) {
                        asignacion.claves.forEach(clave => {
                            tiendasGroup[tiendaId].promotores[promotorId].claves.add(clave);
                        });
                    }

                    if (asignacion.tiene_incidencia && asignacion.info_incidencia) {
                        tiendasGroup[tiendaId].promotores[promotorId].incidencias.push({
                            fecha: asignacion.fecha,
                            tipo: asignacion.info_incidencia.tipo,
                            descripcion: asignacion.info_incidencia.descripcion
                        });
                    }
                });

                const coloresTienda = [
                    { fondo: 'FFE8F5E9', texto: 'FF1B5E20' },
                    { fondo: 'FFF3E5F5', texto: 'FF4A148C' },
                    { fondo: 'FFE1F5FE', texto: 'FF01579B' },
                    { fondo: 'FFFFF3E0', texto: 'FFE65100' },
                    { fondo: 'FFF1F8E9', texto: 'FF33691E' }
                ];

                let colorIndex = 0;
                Object.entries(tiendasGroup).forEach(([tiendaId, tiendaData]) => {
                    const colorTienda = coloresTienda[colorIndex % coloresTienda.length];
                    const cantidadPromotores = Object.keys(tiendaData.promotores).length;

                    Object.entries(tiendaData.promotores).forEach(([promotorId, promotorData], index) => {
                        const totalAsignaciones = promotorData.fechas.length;
                        const diasDescanso = promotorData.fechas.filter(f => f.es_descanso).length;
                        const cantidadIncidencias = promotorData.fechas.filter(f => f.tiene_incidencia).length;
                        const diasLaborables = totalAsignaciones - diasDescanso - cantidadIncidencias;
                        const clavesTexto = Array.from(promotorData.claves).join(', ') || 'Sin claves';

                        let detalleIncidencias = 'Sin incidencias';
                        if (promotorData.incidencias.length > 0) {
                            const incidenciasOrdenadas = [...promotorData.incidencias].sort((a, b) => 
                                new Date(a.fecha) - new Date(b.fecha)
                            );

                            const grupos = [];
                            let grupoActual = null;

                            incidenciasOrdenadas.forEach((inc, index) => {
                                const fechaActual = new Date(inc.fecha + 'T00:00:00');
                                
                                if (!grupoActual || grupoActual.tipo !== inc.tipo) {
                                    if (grupoActual) grupos.push(grupoActual);
                                    grupoActual = {
                                        tipo: inc.tipo,
                                        fechaInicio: inc.fecha,
                                        fechaFin: inc.fecha,
                                        dias: 1
                                    };
                                } else {
                                    const fechaAnterior = new Date(grupoActual.fechaFin + 'T00:00:00');
                                    const diffDias = Math.floor((fechaActual - fechaAnterior) / (1000 * 60 * 60 * 24));
                                    
                                    if (diffDias === 1) {
                                        grupoActual.fechaFin = inc.fecha;
                                        grupoActual.dias++;
                                    } else {
                                        grupos.push(grupoActual);
                                        grupoActual = {
                                            tipo: inc.tipo,
                                            fechaInicio: inc.fecha,
                                            fechaFin: inc.fecha,
                                            dias: 1
                                        };
                                    }
                                }
                                
                                if (index === incidenciasOrdenadas.length - 1) {
                                    grupos.push(grupoActual);
                                }
                            });

                            detalleIncidencias = grupos.map(grupo => {
                                const tipoEmoji = {
                                    'falta': '🚫',
                                    'retardo': '⏰',
                                    'abandono': '🏃',
                                    'salud': '🏥',
                                    'imprevisto': '⚠️',
                                    'otro': '📝'
                                };
                                const emoji = tipoEmoji[grupo.tipo] || '❌';
                                
                                if (grupo.dias === 1) {
                                    return `${emoji} ${grupo.fechaInicio}: ${grupo.tipo}`;
                                } else {
                                    return `📅 ${grupo.fechaInicio} al ${grupo.fechaFin}: ${grupo.tipo} (${grupo.dias} días)`;
                                }
                            }).join(' | ');
                        }

                        const row = worksheet.addRow([
                            tiendaData.nombre,
                            tiendaData.numero,
                            tiendaData.region,
                            promotorData.nombre,
                            promotorData.dia_descanso,
                            totalAsignaciones,
                            diasDescanso,
                            cantidadIncidencias,
                            diasLaborables,
                            clavesTexto,
                            detalleIncidencias
                        ]);

                        row.eachCell((cell, colNumber) => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: colorTienda.fondo }
                            };
                            cell.font = {
                                size: 11,
                                color: { argb: colorTienda.texto }
                            };
                            cell.alignment = {
                                vertical: 'middle',
                                horizontal: 'left',
                                wrapText: true
                            };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFDCDCDC' } },
                                left: { style: 'thin', color: { argb: 'FFDCDCDC' } },
                                bottom: { style: 'thin', color: { argb: 'FFDCDCDC' } },
                                right: { style: 'thin', color: { argb: 'FFDCDCDC' } }
                            };

                            if (colNumber === 8 && cantidadIncidencias > 0) {
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FFFECACA' }
                                };
                                cell.font = {
                                    bold: true,
                                    size: 11,
                                    color: { argb: 'FF991B1B' }
                                };
                            }

                            if (colNumber === 9) {
                                cell.font = {
                                    bold: true,
                                    size: 12,
                                    color: { argb: 'FF1B5E20' }
                                };
                            }
                        });

                        row.height = 22;
                    });

                    const totalAsignacionesTienda = Object.values(tiendaData.promotores).reduce(
                        (sum, p) => sum + p.fechas.length, 0
                    );
                    const totalDescansostienda = Object.values(tiendaData.promotores).reduce(
                        (sum, p) => sum + p.fechas.filter(f => f.es_descanso).length, 0
                    );
                    const totalIncidenciasTienda = Object.values(tiendaData.promotores).reduce(
                        (sum, p) => sum + p.fechas.filter(f => f.tiene_incidencia).length, 0
                    );
                    const totalLaborablesTienda = totalAsignacionesTienda - totalDescansostienda - totalIncidenciasTienda;

                    const subtotalRow = worksheet.addRow([
                        `SUBTOTAL - ${tiendaData.nombre}`,
                        '',
                        '',
                        `${cantidadPromotores} promotores`,
                        '',
                        totalAsignacionesTienda,
                        totalDescansostienda,
                        totalIncidenciasTienda,
                        totalLaborablesTienda,
                        '',
                        ''
                    ]);

                    subtotalRow.eachCell((cell) => {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFD5F4E6' }
                        };
                        cell.font = {
                            bold: true,
                            color: { argb: 'FF27AE60' },
                            size: 11
                        };
                        cell.alignment = { vertical: 'middle', horizontal: 'left' };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF27AE60' } },
                            left: { style: 'medium', color: { argb: 'FF27AE60' } },
                            bottom: { style: 'medium', color: { argb: 'FF27AE60' } },
                            right: { style: 'medium', color: { argb: 'FF27AE60' } }
                        };
                    });
                    subtotalRow.height = 25;

                    colorIndex++;
                });

                const totalGeneralAsignaciones = reporteActual.length;
                const totalGeneralDescansos = reporteActual.filter(a =>
                    esDiaDescanso(a.fecha, a.promotor_dia_descanso)
                ).length;
                const totalGeneralIncidencias = reporteActual.filter(a => a.tiene_incidencia).length;
                const totalGeneralLaborables = totalGeneralAsignaciones - totalGeneralDescansos - totalGeneralIncidencias;

                worksheet.addRow([]);

                const totalRow = worksheet.addRow([
                    'TOTALES GENERALES',
                    '',
                    '',
                    `${Object.keys(tiendasGroup).length} tiendas`,
                    '',
                    totalGeneralAsignaciones,
                    totalGeneralDescansos,
                    totalGeneralIncidencias,
                    totalGeneralLaborables,
                    '',
                    ''
                ]);

                totalRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF27AE60' }
                    };
                    cell.font = {
                        bold: true,
                        color: { argb: 'FFFFFFFF' },
                        size: 13
                    };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = {
                        top: { style: 'medium' },
                        left: { style: 'medium' },
                        bottom: { style: 'medium' },
                        right: { style: 'medium' }
                    };
                });
                totalRow.height = 28;

                worksheet.views = [
                    { state: 'frozen', xSplit: 0, ySplit: 1 }
                ];

                worksheet.autoFilter = {
                    from: 'A1',
                    to: 'K1'
                };

                worksheet.columns = [
                    { width: 35 },
                    { width: 15 },
                    { width: 10 },
                    { width: 35 },
                    { width: 15 },
                    { width: 12 },
                    { width: 12 },
                    { width: 12 },
                    { width: 15 },
                    { width: 40 },
                    { width: 60 }
                ];

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                const fechaInicioValor = fechaInicio.value;
                const fechaFinValor = fechaFin.value;
                const nombreArchivo = `reporte-tiendas-promotores-${fechaInicioValor}-${fechaFinValor}.xlsx`;

                saveAs(blob, nombreArchivo);

                mostrarNotificacion('Excel descargado exitosamente', 'success');

            } catch (error) {
                console.error('Error generando Excel:', error);
                mostrarNotificacion('Error al generar Excel: ' + error.message, 'error');
            }
        }

        // ===== GENERACIÓN DE PDF =====
        function descargarPDF() {
            if (!reporteActual || reporteActual.length === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Reporte Tiendas → Promotores', 20, 20);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const subtitulo = document.getElementById('reporte-subtitulo').textContent;
                doc.text(subtitulo, 20, 30);

                const stats = [
                    `Tiendas: ${document.getElementById('stat-tiendas').textContent}`,
                    `Promotores: ${document.getElementById('stat-promotores').textContent}`,
                    `Días trabajados: ${document.getElementById('stat-dias-trabajados').textContent}`
                ];
                doc.text(stats.join(' | '), 20, 40);

                const tiendasGroup = {};
                reporteActual.forEach(asignacion => {
                    if (!tiendasGroup[asignacion.tienda_id]) {
                        tiendasGroup[asignacion.tienda_id] = {
                            tienda: {
                                id: asignacion.tienda_id,
                                nombre: asignacion.tienda_nombre,
                                numero: asignacion.tienda_numero,
                                region: asignacion.tienda_region,
                                cadena: asignacion.tienda_cadena
                            },
                            promotores: {}
                        };
                    }

                    if (!tiendasGroup[asignacion.tienda_id].promotores[asignacion.promotor_id]) {
                        tiendasGroup[asignacion.tienda_id].promotores[asignacion.promotor_id] = {
                            nombre: asignacion.promotor_nombre,
                            dia_descanso: asignacion.promotor_dia_descanso,
                            fechas: []
                        };
                    }

                    tiendasGroup[asignacion.tienda_id].promotores[asignacion.promotor_id].fechas.push({
                        fecha: asignacion.fecha,
                        dia_semana: asignacion.dia_semana,
                        claves: asignacion.claves || []
                    });
                });

                const datosPDF = [];

                Object.entries(tiendasGroup).forEach(([tiendaId, tiendaData]) => {
                    const tienda = tiendaData.tienda;

                    datosPDF.push([
                        {
                            content: `${tienda.nombre} (${tienda.numero || 'N/A'}) - Región ${tienda.region}`,
                            colSpan: 5,
                            styles: {
                                fillColor: [39, 174, 96],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold',
                                fontSize: 10
                            }
                        }
                    ]);

                    Object.entries(tiendaData.promotores).forEach(([promotorId, promotorData]) => {
                        const fechasOrdenadas = promotorData.fechas
                            .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

                        const diasTrabajados = fechasOrdenadas.map(fecha => {
                            const fechaObj = new Date(fecha.fecha + 'T00:00:00');
                            const diaCorto = fechaObj.toLocaleDateString('es-ES', { weekday: 'short' });
                            return `${diaCorto} ${fechaObj.getDate()}`;
                        }).join(', ');

                        const clavesPromotor = [...new Set(
                            fechasOrdenadas.flatMap(fecha => fecha.claves || [])
                        )];

                        datosPDF.push([
                            `  • ${promotorData.nombre}`,
                            diasTrabajados,
                            `${fechasOrdenadas.length} días`,
                            `${fechasOrdenadas[0].fecha} al ${fechasOrdenadas[fechasOrdenadas.length - 1].fecha}`,
                            clavesPromotor.join(', ') || 'Sin claves'
                        ]);
                    });

                    const totalDiasTienda = Object.values(tiendaData.promotores)
                        .reduce((total, promotor) => total + promotor.fechas.length, 0);
                    const totalPromotores = Object.keys(tiendaData.promotores).length;

                    datosPDF.push([
                        {
                            content: `TOTAL TIENDA: ${totalPromotores} promotores, ${totalDiasTienda} días trabajados`,
                            colSpan: 5,
                            styles: {
                                fillColor: [213, 244, 230],
                                textColor: [39, 174, 96],
                                fontStyle: 'bold',
                                fontSize: 8
                            }
                        }
                    ]);

                    datosPDF.push(['', '', '', '', '']);
                });

                doc.autoTable({
                    head: [['Promotor / Tienda', 'Días Trabajados', 'Total Días', 'Período', 'Claves']],
                    body: datosPDF,
                    startY: 50,
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [39, 174, 96],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 50 },
                        1: { cellWidth: 65 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 45 },
                        4: { cellWidth: 35 }
                    },
                    margin: { left: 20, right: 20 }
                });

                const fechaGeneracion = new Date().toLocaleString('es-MX');
                doc.setFontSize(8);
                doc.text(`Generado el ${fechaGeneracion}`, 20, doc.internal.pageSize.height - 10);

                const fechaInicioValor = fechaInicio.value;
                const fechaFinValor = fechaFin.value;
                const nombreArchivo = `reporte-tiendas-promotores-${fechaInicioValor}-${fechaFinValor}.pdf`;
                doc.save(nombreArchivo);

                mostrarNotificacion('PDF descargado exitosamente', 'success');

            } catch (error) {
                console.error('Error generando PDF:', error);
                mostrarNotificacion('Error al generar PDF', 'error');
            }
        }

        // ===== NOTIFICACIONES =====
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.className = `notification ${tipo}`;

            const iconos = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const titulos = {
                success: 'Éxito',
                error: 'Error',
                warning: 'Advertencia',
                info: 'Información'
            };

            notificacion.innerHTML = `
                <i class="${iconos[tipo]} notification-icon"></i>
                <div class="notification-content">
                    <h4>${titulos[tipo]}</h4>
                    <p>${mensaje}</p>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;

            notificacion.querySelector('.notification-close').addEventListener('click', () => {
                notificacion.remove();
            });

            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 5000);

            document.getElementById('notifications-container').appendChild(notificacion);
        }

        // ===== EXPONER FUNCIONES GLOBALES =====
        window.verDetalleTienda = verDetalleTienda;
        window.verExpedientePromotor = verExpedientePromotor;
        window.limpiarFiltros = limpiarFiltros;

        // ===== INICIALIZACIÓN FINAL =====
        console.log('🎉 Módulo Tiendas → Promotores + EXPEDIENTES iniciado ✅');

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

</body>

</html>