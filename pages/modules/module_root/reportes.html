<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Tiendas ‚Üí Promotores CORREGIDO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<!-- ===== M√ìDULO REPORTES TIENDAS ‚Üí PROMOTORES ===== -->
<div class="reportes-module">
    <!-- HEADER DEL M√ìDULO -->
    <div class="module-header">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-store header-icon"></i>
                <h1>Reportes Tiendas ‚Üí Promotores</h1>
            </div>
            <div class="header-actions">
                <button class="btn-primary" id="btn-descargar-excel">
                    <i class="fas fa-file-excel"></i> Descargar Excel
                </button>
                <button class="btn-primary" id="btn-descargar-pdf">
                    <i class="fas fa-download"></i> Descargar PDF
                </button>
            </div>
        </div>
    </div>

    <!-- CONTROLES DE FILTROS -->
    <div class="filters-container">
        <div class="filters-content">
            <h3><i class="fas fa-filter"></i> Filtros de Consulta</h3>
            
            <!-- RANGO DE FECHAS -->
            <div class="filter-section">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Inicio *</label>
                        <input type="date" id="fecha-inicio" required>
                        <small class="text-muted">Fecha de inicio del per√≠odo a consultar</small>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Fin *</label>
                        <input type="date" id="fecha-fin" required>
                        <small class="text-muted">Fecha de fin del per√≠odo a consultar</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <small class="text-muted">Per√≠odo seleccionado: <span id="rango-fechas-texto">Seleccione fechas</span></small>
                    </div>
                </div>
            </div>

            <!-- FILTROS ADICIONALES -->
            <div class="filter-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="filtro-promotor">Promotor Espec√≠fico</label>
                        <select id="filtro-promotor">
                            <option value="">Todos los promotores</option>
                        </select>
                        <small class="text-muted" id="promotor-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando promotores...
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="filtro-tienda">Tienda Espec√≠fica</label>
                        <select id="filtro-tienda">
                            <option value="">Todas las tiendas</option>
                        </select>
                        <small class="text-muted" id="tienda-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando tiendas...
                        </small>
                    </div>
                </div>
            </div>

            <!-- ACCIONES -->
            <div class="filter-actions">
                <button type="button" class="btn-secondary" id="btn-limpiar-filtros">
                    <i class="fas fa-broom"></i> Limpiar Filtros
                </button>
                <button type="button" class="btn-primary" id="btn-consultar">
                    <i class="fas fa-search"></i> Consultar Reporte
                </button>
            </div>
        </div>
    </div>

    <!-- RESUMEN ESTAD√çSTICO -->
    <div class="stats-container" id="stats-container" style="display: block;">
        <div class="stats-content">
            <h3><i class="fas fa-chart-pie"></i> Resumen Estad√≠stico - <span id="periodo-seleccionado">Seleccione un per√≠odo</span></h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="stat-tiendas">0</h4>
                        <p>Tiendas con Cobertura</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="stat-promotores">0</h4>
                        <p>Promotores Activos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="stat-dias">0</h4>
                        <p>D√≠as del Per√≠odo</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="stat-dias-trabajados">0</h4>
                        <p>Asignaciones Total</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTADOS DEL REPORTE -->
    <div class="reporte-container" id="reporte-container">
        <!-- LOADING REPORTE -->
        <div class="reporte-loading" id="reporte-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Generando reporte...</p>
        </div>

        <!-- CONTENIDO DEL REPORTE -->
        <div class="reporte-content" id="reporte-content" style="display: none;">
            <div class="reporte-header">
                <div class="reporte-title">
                    <h3>Reporte Tiendas ‚Üí Promotores</h3>
                    <p id="reporte-subtitulo" class="text-secondary">Seleccione fechas y haga clic en Consultar Reporte</p>
                </div>
            </div>

            <!-- TABLA TIENDAS ‚Üí PROMOTORES -->
            <div class="table-wrapper">
                <table class="reporte-table">
                    <thead>
                        <tr>
                            <th>Tienda</th>
                            <th>Informaci√≥n</th>
                            <th>Promotores Asignados</th>
                            <th>D√≠as con Cobertura</th>
                            <th>Total D√≠as Cubiertos</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-tiendas">
                        <!-- Se llenar√° din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- EMPTY STATE -->
        <div class="empty-state" id="reporte-empty" style="display: none;">
            <i class="fas fa-store"></i>
            <h3>No hay datos para mostrar</h3>
            <p>No se encontraron asignaciones para el per√≠odo y filtros seleccionados.</p>
            <p><small>Intente con un rango de fechas diferente o quite algunos filtros.</small></p>
            <button class="btn-primary" onclick="limpiarFiltros()">
                <i class="fas fa-broom"></i> Limpiar Filtros
            </button>
        </div>
    </div>

    <!-- ESTADO INICIAL -->
    <div class="initial-state" id="initial-state" style="display: block;">
        <div style="text-align: center; padding: 40px; background: var(--surface); border-radius: var(--radius); margin-bottom: 2rem; border: 1px solid var(--border-color);">
            <i class="fas fa-play-circle" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
            <h3>Reporte Tiendas ‚Üí Promotores</h3>
            <p class="text-muted">Seleccione fechas y filtros, luego haga clic en "Consultar Reporte" para generar los datos.</p>
            <p><small>Por defecto se muestran las fechas de la semana actual.</small></p>
        </div>
    </div>
</div>

<!-- ===== MODAL DETALLE DE ASIGNACIONES ===== -->
<div class="modal-overlay" id="modal-detalle">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <h2 id="detalle-title">
                <i class="fas fa-info-circle"></i> Detalle de Asignaciones
            </h2>
            <button class="modal-close" id="modal-close-detalle">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-content">
            <div class="detalle-info" id="detalle-info">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <div class="detalle-timeline" id="detalle-timeline">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>
</div>

<!-- SISTEMA DE NOTIFICACIONES -->
<div class="notifications-container" id="notifications-container"></div>

<style>
/* ===== ESTILOS M√ìDULO REPORTES TIENDAS ‚Üí PROMOTORES ===== */
.reportes-module {
    padding: 0;
    max-width: 100%;
}

/* ===== VARIABLES CSS - TEMA VERDE ===== */
:root {
    --primary-color: #27ae60;
    --primary-hover: #229954;
    --primary-light: #d5f4e6;
    --secondary-color: #6c757d;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
    --background: #f8fafc;
    --surface: rgba(255, 255, 255, 0.95);
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --border-color: #e2e8f0;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
    --radius: 12px;
}

/* ===== RESET Y BASE ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: var(--background);
    color: var(--text-primary);
    line-height: 1.6;
    padding: 20px;
}

/* ===== HEADER DEL M√ìDULO ===== */
.module-header {
    background: var(--surface);
    backdrop-filter: blur(20px);
    border-radius: var(--radius);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: var(--shadow);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-icon {
    width: 50px;
    height: 50px;
    background: var(--primary-color);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
}

.header-title h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

/* ===== CONTROLES DE FILTROS ===== */
.filters-container {
    background: var(--surface);
    backdrop-filter: blur(20px);
    border-radius: var(--radius);
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: var(--shadow);
}

.filters-content {
    padding: 2rem;
}

.filters-content h3 {
    margin: 0 0 1.5rem 0;
    color: var(--text-primary);
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-section {
    margin-bottom: 1.2rem;
    padding: 1.2rem;
    background: #f8fafc;
    border-radius: var(--radius);
    border-left: 4px solid var(--primary-color);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-row:last-child {
    margin-bottom: 0;
}

.form-group {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.85rem;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.85rem;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus, .form-group select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
}

.form-group small {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 0.25rem;
    font-style: italic;
}

.filter-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

/* ===== BOTONES ===== */
.btn-primary, .btn-secondary, .btn-danger {
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    font-size: 0.9rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
}

.btn-secondary {
    background: var(--secondary-color);
    color: white;
}

.btn-secondary:hover:not(:disabled) {
    background: #5a6268;
    transform: translateY(-2px);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

/* ===== ESTAD√çSTICAS ===== */
.stats-container {
    background: var(--surface);
    backdrop-filter: blur(20px);
    border-radius: var(--radius);
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: var(--shadow);
}

.stats-content {
    padding: 2rem;
}

.stats-content h3 {
    margin: 0 0 1.5rem 0;
    color: var(--text-primary);
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    background: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(39, 174, 96, 0.1);
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: var(--primary-light);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 1.5rem;
}

.stat-info h4 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-info p {
    margin: 0;
    color: var(--text-secondary);
    font-weight: 600;
}

/* ===== CONTENEDOR DE REPORTE ===== */
.reporte-container {
    background: var(--surface);
    backdrop-filter: blur(20px);
    border-radius: var(--radius);
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.reporte-loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(39, 174, 96, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.reporte-content {
    padding: 2rem;
}

.reporte-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.reporte-title h3 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 700;
}

.text-secondary {
    color: var(--text-secondary);
}

/* ===== TABLAS DE REPORTE ===== */
.table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
}

.reporte-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
}

.reporte-table th {
    background: var(--primary-color);
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
}

.reporte-table th:first-child {
    border-radius: 8px 0 0 0;
}

.reporte-table th:last-child {
    border-radius: 0 8px 0 0;
}

.reporte-table td {
    padding: 15px 12px;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9rem;
    vertical-align: top;
}

.reporte-table tbody tr {
    transition: all 0.3s ease;
}

.reporte-table tbody tr:hover {
    background: rgba(39, 174, 96, 0.05);
}

.reporte-table tbody tr:last-child td {
    border-bottom: none;
}

/* ===== BADGES Y ELEMENTOS ===== */
.tienda-info {
    margin-bottom: 0.5rem;
}

.tienda-info strong {
    color: var(--text-primary);
}

.promotor-badge, .fecha-badge, .dia-badge {
    display: inline-block;
    background: var(--primary-light);
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
    padding: 0.3rem 0.6rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0.2rem 0.2rem 0.2rem 0;
}

.fecha-badge {
    background: var(--info-color);
    color: white;
    border: 1px solid var(--info-color);
}

.btn-detalle {
    background: var(--info-color);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-detalle:hover {
    background: #2563eb;
    transform: translateY(-2px);
}

/* ===== CLASES ESPEC√çFICAS PARA D√çAS DE SEMANA ===== */
.dias-cobertura {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.promotor-dia {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.3rem 0.5rem;
    background: #f8fafc;
    border-radius: 6px;
    border-left: 3px solid var(--primary-color);
}

.promotor-nombre {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.8rem;
}

.dias-trabajados {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* ===== D√çAS DE COBERTURA DETALLADA ===== */
.dias-cobertura-detalle {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    max-height: 200px;
    overflow-y: auto;
}

.promotor-cobertura {
    margin-bottom: 0.5rem;
    padding: 0.4rem;
    background: #f8fafc;
    border-radius: 6px;
    border-left: 3px solid var(--primary-color);
    transition: all 0.3s ease;
}

.promotor-cobertura:hover {
    background: #f1f5f9;
    border-left-color: var(--primary-hover);
}

.promotor-cobertura .promotor-nombre {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
    display: block;
}

.promotor-cobertura .fecha-badge {
    font-size: 0.7rem !important;
    padding: 0.2rem 0.4rem !important;
    margin: 0.1rem 0.1rem 0.1rem 0;
    background: var(--info-color);
    color: white;
    border: 1px solid var(--info-color);
    border-radius: 12px;
    display: inline-block;
    transition: all 0.3s ease;
}

.promotor-cobertura .fecha-badge:hover {
    background: #2563eb;
    transform: scale(1.05);
}

.resumen-total {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: var(--primary-light);
    border-radius: 6px;
    text-align: center;
    font-weight: 700;
    color: var(--primary-color);
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 4rem;
    color: var(--border-color);
    margin-bottom: 1rem;
}

.empty-state h3 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
}

/* ===== INITIAL STATE ===== */
.initial-state {
    transition: all 0.3s ease;
}

.initial-state.hide {
    display: none;
}

/* ===== MODALES ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
}

.modal-overlay.active {
    display: flex;
}

.modal-container {
    background: white;
    border-radius: var(--radius);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

.modal-container.modal-large {
    max-width: 900px;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    background: var(--primary-color);
    color: white;
    padding: 1.5rem 2rem;
    border-radius: var(--radius) var(--radius) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-content {
    padding: 2rem;
}

/* ===== TIMELINE DE DETALLE ===== */
.detalle-timeline {
    position: relative;
    padding-left: 2rem;
}

.detalle-timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--primary-color);
    border-radius: 2px;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
    background: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-left: 1.5rem;
    border: 1px solid var(--border-color);
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -2.25rem;
    top: 1.5rem;
    width: 12px;
    height: 12px;
    background: var(--primary-color);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 3px var(--primary-color);
}

/* ===== NOTIFICACIONES ===== */
.notifications-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 3000;
    max-width: 400px;
}

.notification {
    background: white;
    border-radius: var(--radius);
    padding: 1rem 1.5rem;
    margin-bottom: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: notificationSlideIn 0.3s ease;
    position: relative;
    overflow: hidden;
}

.notification.success { border-left-color: var(--success-color); }
.notification.error { border-left-color: var(--danger-color); }
.notification.warning { border-left-color: var(--warning-color); }
.notification.info { border-left-color: var(--info-color); }

@keyframes notificationSlideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-icon {
    font-size: 1.2rem;
}

.notification.success .notification-icon { color: var(--success-color); }
.notification.error .notification-icon { color: var(--danger-color); }
.notification.warning .notification-icon { color: var(--warning-color); }
.notification.info .notification-icon { color: var(--info-color); }

.notification-content h4 {
    margin: 0 0 5px 0;
    font-size: 0.95rem;
    font-weight: 600;
}

.notification-content p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.notification-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1rem;
    color: #999;
    cursor: pointer;
    padding: 2px;
}

.notification-close:hover {
    color: var(--text-primary);
}

/* Indicadores de carga */
.text-muted i.fa-spinner {
    margin-right: 5px;
    color: var(--primary-color);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        text-align: center;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .filter-actions {
        flex-direction: column;
    }

    .reporte-header {
        flex-direction: column;
        text-align: center;
    }

    .modal-container {
        margin: 10px;
        max-width: calc(100% - 20px);
    }

    .table-wrapper {
        font-size: 0.8rem;
    }

    .reporte-table th, .reporte-table td {
        padding: 10px 8px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    
    .modal-content {
        padding: 1rem;
    }

    .modal-header {
        padding: 1rem;
    }

    .filters-content {
        padding: 1rem;
    }

    .stats-content {
        padding: 1rem;
    }

    .reporte-content {
        padding: 1rem;
    }

    .filter-section {
        padding: 1rem;
    }

    .stat-card {
        flex-direction: column;
        text-align: center;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
    }
}

/* ===== UTILIDADES ===== */
.text-center { text-align: center; }
.text-muted { color: var(--text-secondary); }
.fw-bold { font-weight: 700; }
.mb-0 { margin-bottom: 0; }
.mt-1 { margin-top: 0.25rem; }
.d-none { display: none; }
.d-flex { display: flex; }
.align-items-center { align-items: center; }
.justify-content-between { justify-content: space-between; }
.gap-2 { gap: 0.5rem; }
.gap-3 { gap: 1rem; }
</style>

<!-- ===== SCRIPTS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
// ===== VARIABLES GLOBALES CORREGIDAS =====
let reporteActual = null;
let filtrosAplicados = {
    fecha_inicio: null,
    fecha_fin: null
};

// ===== ELEMENTOS DOM =====
const fechaInicio = document.getElementById('fecha-inicio');
const fechaFin = document.getElementById('fecha-fin');
const filtroPromotor = document.getElementById('filtro-promotor');
const filtroTienda = document.getElementById('filtro-tienda');

const btnConsultar = document.getElementById('btn-consultar');
const btnLimpiarFiltros = document.getElementById('btn-limpiar-filtros');
const btnDescargarExcel = document.getElementById('btn-descargar-excel');
const btnDescargarPdf = document.getElementById('btn-descargar-pdf');

const statsContainer = document.getElementById('stats-container');
const reporteContainer = document.getElementById('reporte-container');
const reporteLoading = document.getElementById('reporte-loading');
const reporteContent = document.getElementById('reporte-content');
const reporteEmpty = document.getElementById('reporte-empty');
const initialState = document.getElementById('initial-state');

const modalDetalle = document.getElementById('modal-detalle');

// ===== FUNCI√ìN PARA OBTENER FECHAS DIN√ÅMICAS =====
function obtenerFechasSemanaActual() {
    const hoy = new Date();
    const diaSemana = hoy.getDay(); // 0 = domingo, 1 = lunes, etc.
    
    // Calcular el lunes de esta semana
    const lunes = new Date(hoy);
    lunes.setDate(hoy.getDate() - (diaSemana === 0 ? 6 : diaSemana - 1));
    
    // Calcular el domingo de esta semana
    const domingo = new Date(lunes);
    domingo.setDate(lunes.getDate() + 6);
    
    return {
        inicio: lunes.toISOString().split('T')[0],
        fin: domingo.toISOString().split('T')[0]
    };
}

// ===== FUNCI√ìN PARA ESTABLECER FECHAS POR DEFECTO =====
function establecerFechasPorDefecto() {
    const fechasSemana = obtenerFechasSemanaActual();
    
    fechaInicio.value = fechasSemana.inicio;
    fechaFin.value = fechasSemana.fin;
    
    filtrosAplicados.fecha_inicio = fechasSemana.inicio;
    filtrosAplicados.fecha_fin = fechasSemana.fin;
    
    console.log(`üìÖ Fechas por defecto establecidas: ${fechasSemana.inicio} al ${fechasSemana.fin}`);
}

// ===== INICIALIZACI√ìN CORREGIDA =====
function init() {
    console.log('‚úÖ Inicializando m√≥dulo CORREGIDO Reportes Tiendas ‚Üí Promotores...');
    
    establecerFechasPorDefecto();
    configurarEventListeners();
    actualizarRangoFechas();
    
    cargarPromotores();
    cargarTiendas();
    
    console.log('‚úÖ Sistema iniciado. Haga clic en "Consultar Reporte" para cargar datos.');
}

// ===== CARGA DIN√ÅMICA DE DATOS =====
async function cargarPromotores() {
    const promotorLoading = document.getElementById('promotor-loading');
    
    try {
        promotorLoading.style.display = 'block';
        
        const response = await fetch('../../api/reportes.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tipo_reporte: 'promotores'
            })
        });
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success && resultado.data.promotores) {
            const promotores = resultado.data.promotores;
            
            filtroPromotor.innerHTML = '<option value="">Todos los promotores</option>';
            
            promotores.forEach(promotor => {
                const option = document.createElement('option');
                option.value = promotor.id_promotor;
                option.textContent = `${promotor.nombre_completo} (${promotor.rfc || 'Sin RFC'})`;
                filtroPromotor.appendChild(option);
            });
            
            console.log(`‚úÖ ${promotores.length} promotores cargados din√°micamente`);
        } else {
            console.warn('‚ö†Ô∏è No se pudieron cargar los promotores:', resultado.message);
            mostrarNotificacion('No se pudieron cargar los promotores', 'warning');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando promotores:', error);
        mostrarNotificacion('Error al cargar promotores', 'error');
    } finally {
        promotorLoading.style.display = 'none';
    }
}

async function cargarTiendas() {
    const tiendaLoading = document.getElementById('tienda-loading');
    
    try {
        tiendaLoading.style.display = 'block';
        
        const response = await fetch('../../api/reportes.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tipo_reporte: 'tiendas'
            })
        });
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success && resultado.data.tiendas) {
            const tiendas = resultado.data.tiendas;
            
            filtroTienda.innerHTML = '<option value="">Todas las tiendas</option>';
            
            tiendas.forEach(tienda => {
                const option = document.createElement('option');
                option.value = tienda.id;
                option.textContent = `${tienda.nombre} (${tienda.numero || 'Sin n√∫mero'}) - ${tienda.region}`;
                filtroTienda.appendChild(option);
            });
            
            console.log(`‚úÖ ${tiendas.length} tiendas cargadas din√°micamente`);
        } else {
            console.warn('‚ö†Ô∏è No se pudieron cargar las tiendas:', resultado.message);
            mostrarNotificacion('No se pudieron cargar las tiendas', 'warning');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando tiendas:', error);
        mostrarNotificacion('Error al cargar tiendas', 'error');
    } finally {
        tiendaLoading.style.display = 'none';
    }
}

function configurarEventListeners() {
    // Cambio en fechas
    fechaInicio.addEventListener('change', actualizarRangoFechas);
    fechaFin.addEventListener('change', actualizarRangoFechas);
    
    // Botones principales
    btnConsultar.addEventListener('click', consultarReporte);
    btnLimpiarFiltros.addEventListener('click', limpiarFiltros);
    btnDescargarExcel.addEventListener('click', descargarExcel);
    btnDescargarPdf.addEventListener('click', descargarPDF);
    
    // Modal
    document.getElementById('modal-close-detalle').addEventListener('click', cerrarModalDetalle);
    modalDetalle.addEventListener('click', (e) => {
        if (e.target === modalDetalle) cerrarModalDetalle();
    });
    
    // ESC para cerrar modales
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            cerrarModalDetalle();
        }
    });
}

// ===== MANEJO DE RANGO DE FECHAS MEJORADO =====
function actualizarRangoFechas() {
    const rangoTexto = document.getElementById('rango-fechas-texto');
    
    if (!fechaInicio || !fechaFin || !rangoTexto) return;
    
    if (!fechaInicio.value || !fechaFin.value) {
        rangoTexto.textContent = 'Seleccione fechas v√°lidas';
        return;
    }
    
    const fechaInicioSeleccionada = new Date(fechaInicio.value + 'T00:00:00');
    const fechaFinSeleccionada = new Date(fechaFin.value + 'T00:00:00');
    
    // Validar que la fecha fin no sea menor que la fecha inicio
    if (fechaFinSeleccionada < fechaInicioSeleccionada) {
        fechaFin.value = fechaInicio.value;
        mostrarNotificacion('La fecha fin no puede ser anterior a la fecha inicio', 'warning');
        return;
    }
    
    const opciones = { day: 'numeric', month: 'short', year: 'numeric' };
    const fechaInicioTexto = fechaInicioSeleccionada.toLocaleDateString('es-ES', opciones);
    const fechaFinTexto = fechaFinSeleccionada.toLocaleDateString('es-ES', opciones);
    
    rangoTexto.textContent = `${fechaInicioTexto} al ${fechaFinTexto}`;
    
    filtrosAplicados.fecha_inicio = fechaInicio.value;
    filtrosAplicados.fecha_fin = fechaFin.value;
    
    // Actualizar texto del per√≠odo en estad√≠sticas
    const periodoSeleccionado = document.getElementById('periodo-seleccionado');
    if (periodoSeleccionado) {
        const diferenciaMs = fechaFinSeleccionada - fechaInicioSeleccionada;
        const diasPeriodo = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24)) + 1;
        periodoSeleccionado.textContent = `Per√≠odo del ${fechaInicioTexto} al ${fechaFinTexto} (${diasPeriodo} d√≠as)`;
    }
}

// ===== CONSULTA DE REPORTE CORREGIDA =====
async function consultarReporte() {
    console.log('üîç Iniciando consulta de reporte CORREGIDA...');
    
    if (!fechaInicio.value || !fechaFin.value) {
        mostrarNotificacion('Por favor seleccione un rango de fechas v√°lido', 'warning');
        return;
    }
    
    if (initialState) {
        initialState.style.display = 'none';
    }
    
    filtrosAplicados = {
        fecha_inicio: fechaInicio.value,
        fecha_fin: fechaFin.value
    };
    
    mostrarLoading();
    
    try {
        const datosConsulta = {
            tipo_reporte: 'asignaciones',
            fecha_inicio: filtrosAplicados.fecha_inicio,
            fecha_fin: filtrosAplicados.fecha_fin
        };
        
        if (filtroPromotor.value && filtroPromotor.value.trim() !== '') {
            datosConsulta.filtro_promotor = parseInt(filtroPromotor.value);
            console.log(`üîç Filtro por promotor: ${filtroPromotor.value}`);
        }
        
        if (filtroTienda.value && filtroTienda.value.trim() !== '') {
            datosConsulta.filtro_tienda = parseInt(filtroTienda.value);
            console.log(`üîç Filtro por tienda: ${filtroTienda.value}`);
        }
        
        console.log('üì§ Enviando consulta CORREGIDA con datos:', datosConsulta);
        
        const response = await fetch('../../api/reportes.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datosConsulta)
        });
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
        }
        
        const resultado = await response.json();
        console.log('üì• Respuesta del servidor CORREGIDA:', resultado);
        
        if (!resultado.success) {
            throw new Error(resultado.message || 'Error desconocido en la respuesta del servidor');
        }
        
        const asignacionesAPI = resultado.data.asignaciones || [];
        const estadisticasAPI = resultado.data.estadisticas || {};
        
        console.log(`üìä Asignaciones encontradas: ${asignacionesAPI.length}`);
        console.log('üìà Estad√≠sticas:', estadisticasAPI);
        
        // Mostrar informaci√≥n de debug si est√° disponible
        if (resultado.data.debug_info) {
            console.log('üîß Debug info:', resultado.data.debug_info);
            console.log('üéØ Estrategia usada:', resultado.data.estrategia_usada);
        }
        
        if (asignacionesAPI.length === 0) {
            mostrarEstadoVacio();
            mostrarNotificacion(
                `No se encontraron asignaciones para el per√≠odo ${filtrosAplicados.fecha_inicio} al ${filtrosAplicados.fecha_fin}`, 
                'info'
            );
            
            // Mostrar informaci√≥n adicional si hay datos de debug
            if (resultado.data.debug_info && resultado.data.debug_info.tiendas_muestra) {
                console.log('üè™ Tiendas disponibles en BD:', resultado.data.debug_info.tiendas_muestra);
            }
        } else {
            reporteActual = asignacionesAPI;
            mostrarEstadisticas(estadisticasAPI);
            mostrarContenido();
            renderizarTablaTiendasCorregida(reporteActual);
            actualizarSubtituloReporte();
            
            mostrarNotificacion(
                `‚úÖ Reporte generado exitosamente: ${asignacionesAPI.length} asignaciones encontradas en ${estadisticasAPI.total_tiendas} tiendas`, 
                'success'
            );
        }
        
    } catch (error) {
        console.error('‚ùå Error consultando reporte:', error);
        mostrarNotificacion(`Error al consultar el reporte: ${error.message}`, 'error');
        mostrarEstadoVacio();
    }
}

// ===== RENDERIZAR TABLA TIENDAS CORREGIDA =====
function renderizarTablaTiendasCorregida(asignaciones) {
    const tbody = document.getElementById('tbody-tiendas');
    tbody.innerHTML = '';
    
    console.log('üé® Renderizando tabla con', asignaciones.length, 'asignaciones');
    
    // Agrupar datos por tienda de forma m√°s robusta
    const tiendasGroup = new Map();
    
    asignaciones.forEach((asignacion, index) => {
        console.log(`Procesando asignaci√≥n ${index}:`, asignacion);
        
        const tiendaId = asignacion.tienda_id;
        
        if (!tiendasGroup.has(tiendaId)) {
            tiendasGroup.set(tiendaId, {
                tienda: {
                    id: asignacion.tienda_id,
                    nombre: asignacion.tienda_nombre || 'Tienda Sin Nombre',
                    numero: asignacion.tienda_numero || 'S/N',
                    region: asignacion.tienda_region || 0,
                    cadena: asignacion.tienda_cadena || 'N/A',
                    ciudad: asignacion.tienda_ciudad || 'N/A',
                    estado: asignacion.tienda_estado || 'N/A'
                },
                asignaciones: []
            });
        }
        tiendasGroup.get(tiendaId).asignaciones.push(asignacion);
    });
    
    console.log(`üè™ Se encontraron ${tiendasGroup.size} tiendas √∫nicas`);
    
    // Generar filas para cada tienda
    for (const [tiendaId, data] of tiendasGroup) {
        const tienda = data.tienda;
        const asignacionesTienda = data.asignaciones;
        
        console.log(`Procesando tienda ${tienda.nombre} con ${asignacionesTienda.length} asignaciones`);
        
        // Agrupar por promotor dentro de la tienda
        const promotoresGroup = new Map();
        asignacionesTienda.forEach(asignacion => {
            const promotorId = asignacion.promotor_id;
            
            if (!promotoresGroup.has(promotorId)) {
                promotoresGroup.set(promotorId, {
                    promotor: {
                        id: asignacion.promotor_id,
                        nombre: asignacion.promotor_nombre || 'Promotor Sin Nombre',
                        rfc: asignacion.promotor_rfc || 'N/A',
                        telefono: asignacion.promotor_telefono || 'N/A',
                        correo: asignacion.promotor_correo || 'N/A'
                    },
                    dias: []
                });
            }
            promotoresGroup.get(promotorId).dias.push({
                fecha: asignacion.fecha,
                dia_semana: asignacion.dia_semana,
                claves: asignacion.claves || []
            });
        });
        
        const totalDias = asignacionesTienda.length;
        
        // Generar HTML para promotores asignados
        let promotoresHTML = '';
        for (const [promotorId, promotorData] of promotoresGroup) {
            promotoresHTML += `
                <div class="promotor-dia" style="margin-bottom: 0.3rem;">
                    <span class="promotor-nombre">${promotorData.promotor.nombre}</span>
                    <span class="dias-trabajados">${promotorData.dias.length} d√≠as</span>
                </div>
            `;
        }
        
        // Generar HTML para d√≠as con cobertura espec√≠ficos por promotor
        let diasCoberturaHTML = '';
        for (const [promotorId, promotorData] of promotoresGroup) {
            const diasFormateados = promotorData.dias
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
                .map(dia => {
                    const fechaObj = new Date(dia.fecha + 'T00:00:00');
                    const diaCorto = fechaObj.toLocaleDateString('es-ES', { weekday: 'short' });
                    return `${diaCorto} ${fechaObj.getDate()}`;
                });
            
            diasCoberturaHTML += `
                <div class="promotor-cobertura" style="margin-bottom: 0.5rem; padding: 0.4rem; background: #f8fafc; border-radius: 6px; border-left: 3px solid var(--primary-color);">
                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.8rem; margin-bottom: 0.2rem;">
                        ${promotorData.promotor.nombre}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.2rem;">
                        ${diasFormateados.map(dia => `<span class="fecha-badge" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${dia}</span>`).join('')}
                    </div>
                </div>
            `;
        }
        
        const row = `
            <tr>
                <td>
                    <strong>${tienda.nombre}</strong><br>
                    <small>N√∫mero: ${tienda.numero}</small><br>
                    <small>Regi√≥n: ${tienda.region}</small><br>
                    <small>Cadena: ${tienda.cadena}</small>
                </td>
                <td>
                    <div class="tienda-info">
                        <strong>Ciudad:</strong> ${tienda.ciudad}<br>
                        <strong>Estado:</strong> ${tienda.estado}
                    </div>
                </td>
                <td>
                    <div class="dias-cobertura">
                        ${promotoresHTML}
                    </div>
                </td>
                <td>
                    <div class="dias-cobertura-detalle">
                        ${diasCoberturaHTML}
                    </div>
                </td>
                <td>
                    <div class="resumen-total">
                        ${totalDias} d√≠as cubiertos
                    </div>
                </td>
                <td>
                    <button class="btn-detalle" onclick="verDetalleTienda(${tiendaId})">
                        <i class="fas fa-eye"></i> Ver Detalle
                    </button>
                </td>
            </tr>
        `;
        
        tbody.innerHTML += row;
    }
    
    console.log(`‚úÖ Tabla renderizada con ${tiendasGroup.size} tiendas`);
}

// ===== FUNCIONES AUXILIARES =====
function actualizarSubtituloReporte() {
    if (!filtrosAplicados.fecha_inicio || !filtrosAplicados.fecha_fin) return;
    
    const fechaInicioSeleccionada = new Date(filtrosAplicados.fecha_inicio + 'T00:00:00');
    const fechaFinSeleccionada = new Date(filtrosAplicados.fecha_fin + 'T00:00:00');
    
    const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
    const fechaInicioTexto = fechaInicioSeleccionada.toLocaleDateString('es-ES', opciones);
    const fechaFinTexto = fechaFinSeleccionada.toLocaleDateString('es-ES', opciones);
    
    const subtitulo = document.getElementById('reporte-subtitulo');
    if (subtitulo) {
        subtitulo.textContent = `Per√≠odo del ${fechaInicioTexto} al ${fechaFinTexto}`;
    }
}

function mostrarEstadisticas(estadisticasAPI) {
    const totalTiendas = estadisticasAPI.total_tiendas || 0;
    const totalPromotores = estadisticasAPI.total_promotores || 0;
    const totalAsignaciones = estadisticasAPI.total_asignaciones || 0;
    const diasPeriodo = estadisticasAPI.dias_periodo || calcularDiasPeriodo(filtrosAplicados.fecha_inicio, filtrosAplicados.fecha_fin);
    
    document.getElementById('stat-tiendas').textContent = totalTiendas;
    document.getElementById('stat-promotores').textContent = totalPromotores;
    document.getElementById('stat-dias').textContent = diasPeriodo;
    document.getElementById('stat-dias-trabajados').textContent = totalAsignaciones;
    
    console.log(`üìä Estad√≠sticas mostradas: ${totalTiendas} tiendas, ${totalPromotores} promotores, ${totalAsignaciones} asignaciones`);
}

function calcularDiasPeriodo(fechaInicio, fechaFin) {
    if (!fechaInicio || !fechaFin) return 0;
    const inicio = new Date(fechaInicio);
    const fin = new Date(fechaFin);
    const diferencia = fin - inicio;
    return Math.floor(diferencia / (1000 * 60 * 60 * 24)) + 1;
}

// ===== ESTADOS DE UI =====
function mostrarLoading() {
    reporteLoading.style.display = 'block';
    reporteContent.style.display = 'none';
    reporteEmpty.style.display = 'none';
    statsContainer.style.display = 'none';
}

function mostrarContenido() {
    reporteLoading.style.display = 'none';
    reporteContent.style.display = 'block';
    reporteEmpty.style.display = 'none';
    statsContainer.style.display = 'block';
}

function mostrarEstadoVacio() {
    reporteLoading.style.display = 'none';
    reporteContent.style.display = 'none';
    reporteEmpty.style.display = 'block';
    
    // Mostrar estad√≠sticas vac√≠as
    document.getElementById('stat-tiendas').textContent = '0';
    document.getElementById('stat-promotores').textContent = '0';
    document.getElementById('stat-dias').textContent = filtrosAplicados.fecha_inicio && filtrosAplicados.fecha_fin ? 
        calcularDiasPeriodo(filtrosAplicados.fecha_inicio, filtrosAplicados.fecha_fin) : '0';
    document.getElementById('stat-dias-trabajados').textContent = '0';
    statsContainer.style.display = 'block';
}

// ===== DETALLES =====
function verDetalleTienda(idTienda) {
    if (!reporteActual || reporteActual.length === 0) {
        mostrarNotificacion('No hay datos disponibles', 'warning');
        return;
    }
    
    const asignacionesTienda = reporteActual.filter(a => a.tienda_id == idTienda);
    
    if (asignacionesTienda.length > 0) {
        const tiendaInfo = {
            id: asignacionesTienda[0].tienda_id,
            nombre: asignacionesTienda[0].tienda_nombre,
            numero: asignacionesTienda[0].tienda_numero || 'N/A',
            region: asignacionesTienda[0].tienda_region,
            cadena: asignacionesTienda[0].tienda_cadena || 'N/A',
            ciudad: asignacionesTienda[0].tienda_ciudad || 'N/A',
            estado: asignacionesTienda[0].tienda_estado || 'N/A',
            asignaciones: asignacionesTienda
        };
        
        mostrarModalDetalle('Tienda', tiendaInfo);
    } else {
        mostrarNotificacion('No hay detalles disponibles para esta tienda en el per√≠odo seleccionado', 'info');
    }
}

function mostrarModalDetalle(tipo, data) {
    document.getElementById('detalle-title').innerHTML = `<i class="fas fa-info-circle"></i> Detalle de ${tipo}`;
    
    const infoHtml = `
        <h4><i class="fas fa-store"></i> ${data.nombre}</h4>
        <p><strong>N√∫mero:</strong> ${data.numero}</p>
        <p><strong>Cadena:</strong> ${data.cadena}</p>
        <p><strong>Ciudad:</strong> ${data.ciudad}</p>
        <p><strong>Estado:</strong> ${data.estado}</p>
        <p><strong>Regi√≥n:</strong> ${data.region}</p>
    `;
    
    document.getElementById('detalle-info').innerHTML = infoHtml;
    
    renderizarTimelineDetalle(data.asignaciones);
    
    modalDetalle.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function renderizarTimelineDetalle(asignaciones) {
    const timeline = document.getElementById('detalle-timeline');
    timeline.innerHTML = '<h4><i class="fas fa-history"></i> Asignaciones del Per√≠odo</h4>';
    
    if (!asignaciones || asignaciones.length === 0) {
        timeline.innerHTML += '<p class="text-center text-muted">No hay asignaciones en el per√≠odo consultado</p>';
        return;
    }
    
    const asignacionesOrdenadas = asignaciones.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    asignacionesOrdenadas.forEach(asignacion => {
        const fechaObj = new Date(asignacion.fecha + 'T00:00:00');
        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        const clavesTexto = (asignacion.claves && asignacion.claves.length > 0) 
            ? asignacion.claves.join(', ') 
            : 'Sin claves registradas';
        
        timeline.innerHTML += `
            <div class="timeline-item">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">
                        ${fechaFormateada}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">
                        ${asignacion.dia_semana}
                    </div>
                </div>
                <div>
                    <p><strong>Promotor:</strong> ${asignacion.promotor_nombre}</p>
                    <p><strong>Tienda:</strong> ${asignacion.tienda_nombre}</p>
                    <p><strong>Claves:</strong> ${clavesTexto}</p>
                </div>
            </div>
        `;
    });
}

function cerrarModalDetalle() {
    modalDetalle.classList.remove('active');
    document.body.style.overflow = 'auto';
}

// ===== LIMPIAR FILTROS =====
function limpiarFiltros() {
    console.log('üßπ Limpiando filtros...');
    
    filtroPromotor.value = '';
    filtroTienda.value = '';
    
    establecerFechasPorDefecto();
    actualizarRangoFechas();
    
    reporteActual = null;
    mostrarEstadoVacio();
    
    if (initialState) {
        initialState.style.display = 'block';
    }
    
    mostrarNotificacion('Filtros limpiados. Haga clic en "Consultar Reporte" para cargar nuevos datos.', 'info');
}

// ===== GENERACI√ìN DE EXCEL =====
function descargarExcel() {
    if (!reporteActual || reporteActual.length === 0) {
        mostrarNotificacion('No hay datos para exportar', 'warning');
        return;
    }
    
    try {
        // Crear libro de trabajo
        const wb = XLSX.utils.book_new();
        
        // Preparar datos para Excel
        const datosExcel = [];
        
        // Encabezados
        datosExcel.push([
            'Tienda',
            'N√∫mero',
            'Regi√≥n',
            'Cadena',
            'Ciudad',
            'Estado',
            'Promotor',
            'RFC Promotor',
            'Fecha',
            'D√≠a Semana',
            'Claves'
        ]);
        
        // Agrupar por tienda
        const tiendasGroup = {};
        reporteActual.forEach(asignacion => {
            if (!tiendasGroup[asignacion.tienda_id]) {
                tiendasGroup[asignacion.tienda_id] = [];
            }
            tiendasGroup[asignacion.tienda_id].push(asignacion);
        });
        
        // Agregar datos
        Object.entries(tiendasGroup).forEach(([tiendaId, asignaciones]) => {
            asignaciones.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            asignaciones.forEach(asignacion => {
                const fechaObj = new Date(asignacion.fecha + 'T00:00:00');
                const fechaFormateada = fechaObj.toLocaleDateString('es-MX');
                const clavesTexto = (asignacion.claves && asignacion.claves.length > 0) 
                    ? asignacion.claves.join(', ') 
                    : '';
                
                datosExcel.push([
                    asignacion.tienda_nombre || '',
                    asignacion.tienda_numero || '',
                    asignacion.tienda_region || '',
                    asignacion.tienda_cadena || '',
                    asignacion.tienda_ciudad || '',
                    asignacion.tienda_estado || '',
                    asignacion.promotor_nombre || '',
                    asignacion.promotor_rfc || '',
                    fechaFormateada,
                    asignacion.dia_semana || '',
                    clavesTexto
                ]);
            });
        });
        
        // Crear hoja de trabajo
        const ws = XLSX.utils.aoa_to_sheet(datosExcel);
        
        // Ajustar ancho de columnas
        const columnWidths = [
            { wch: 30 },  // Tienda
            { wch: 10 },  // N√∫mero
            { wch: 10 },  // Regi√≥n
            { wch: 15 },  // Cadena
            { wch: 20 },  // Ciudad
            { wch: 15 },  // Estado
            { wch: 25 },  // Promotor
            { wch: 15 },  // RFC
            { wch: 12 },  // Fecha
            { wch: 12 },  // D√≠a
            { wch: 30 }   // Claves
        ];
        ws['!cols'] = columnWidths;
        
        // Agregar hoja al libro
        XLSX.utils.book_append_sheet(wb, ws, 'Reporte Tiendas-Promotores');
        
        // Crear hoja de resumen
        const resumenData = [
            ['RESUMEN ESTAD√çSTICO'],
            [''],
            ['Tiendas con Cobertura', document.getElementById('stat-tiendas').textContent],
            ['Promotores Activos', document.getElementById('stat-promotores').textContent],
            ['D√≠as del Per√≠odo', document.getElementById('stat-dias').textContent],
            ['Asignaciones Total', document.getElementById('stat-dias-trabajados').textContent],
            [''],
            ['Per√≠odo Consultado', document.getElementById('reporte-subtitulo').textContent],
            ['Fecha de Generaci√≥n', new Date().toLocaleString('es-MX')]
        ];
        
        const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
        wsResumen['!cols'] = [{ wch: 25 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');
        
        // Generar nombre de archivo
        const fechaInicioValor = fechaInicio.value;
        const fechaFinValor = fechaFin.value;
        const nombreArchivo = `reporte-tiendas-promotores-${fechaInicioValor}-${fechaFinValor}.xlsx`;
        
        // Descargar archivo
        XLSX.writeFile(wb, nombreArchivo);
        
        mostrarNotificacion('Excel descargado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error generando Excel:', error);
        mostrarNotificacion('Error al generar Excel', 'error');
    }
}

// ===== GENERACI√ìN DE PDF =====
function descargarPDF() {
    if (!reporteActual || reporteActual.length === 0) {
        mostrarNotificacion('No hay datos para exportar', 'warning');
        return;
    }
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Reporte Tiendas ‚Üí Promotores', 20, 20);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        const subtitulo = document.getElementById('reporte-subtitulo').textContent;
        doc.text(subtitulo, 20, 30);
        
        const stats = [
            `Tiendas: ${document.getElementById('stat-tiendas').textContent}`,
            `Promotores: ${document.getElementById('stat-promotores').textContent}`,
            `D√≠as trabajados: ${document.getElementById('stat-dias-trabajados').textContent}`
        ];
        doc.text(stats.join(' | '), 20, 40);
        
        // Agrupar datos por tienda para el PDF
        const tiendasGroup = {};
        reporteActual.forEach(asignacion => {
            if (!tiendasGroup[asignacion.tienda_id]) {
                tiendasGroup[asignacion.tienda_id] = {
                    tienda: {
                        id: asignacion.tienda_id,
                        nombre: asignacion.tienda_nombre,
                        numero: asignacion.tienda_numero,
                        region: asignacion.tienda_region,
                        cadena: asignacion.tienda_cadena
                    },
                    promotores: {}
                };
            }
            
            if (!tiendasGroup[asignacion.tienda_id].promotores[asignacion.promotor_id]) {
                tiendasGroup[asignacion.tienda_id].promotores[asignacion.promotor_id] = {
                    nombre: asignacion.promotor_nombre,
                    fechas: []
                };
            }
            
            tiendasGroup[asignacion.tienda_id].promotores[asignacion.promotor_id].fechas.push({
                fecha: asignacion.fecha,
                dia_semana: asignacion.dia_semana,
                claves: asignacion.claves || []
            });
        });
        
        const datosPDF = [];
        
        Object.entries(tiendasGroup).forEach(([tiendaId, tiendaData]) => {
            const tienda = tiendaData.tienda;
            
            datosPDF.push([
                {
                    content: `${tienda.nombre} (${tienda.numero || 'N/A'}) - Regi√≥n ${tienda.region}`,
                    colSpan: 5,
                    styles: { 
                        fillColor: [39, 174, 96], 
                        textColor: [255, 255, 255], 
                        fontStyle: 'bold',
                        fontSize: 10
                    }
                }
            ]);
            
            Object.entries(tiendaData.promotores).forEach(([promotorId, promotorData]) => {
                const fechasOrdenadas = promotorData.fechas
                    .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                
                const diasFormateados = fechasOrdenadas.map(fecha => {
                    const fechaObj = new Date(fecha.fecha + 'T00:00:00');
                    const diaCorto = fechaObj.toLocaleDateString('es-ES', { weekday: 'short' });
                    return `${diaCorto} ${fechaObj.getDate()}`;
                }).join(', ');
                
                const clavesPromotor = [...new Set(
                    fechasOrdenadas.flatMap(fecha => fecha.claves || [])
                )];
                
                datosPDF.push([
                    `  ‚Ä¢ ${promotorData.nombre}`,
                    diasFormateados,
                    `${fechasOrdenadas.length} d√≠as`,
                    `${fechasOrdenadas[0].fecha} al ${fechasOrdenadas[fechasOrdenadas.length - 1].fecha}`,
                    clavesPromotor.join(', ') || 'Sin claves'
                ]);
            });
            
            const totalDiasTienda = Object.values(tiendaData.promotores)
                .reduce((total, promotor) => total + promotor.fechas.length, 0);
            const totalPromotores = Object.keys(tiendaData.promotores).length;
            
            datosPDF.push([
                {
                    content: `TOTAL TIENDA: ${totalPromotores} promotores, ${totalDiasTienda} d√≠as trabajados`,
                    colSpan: 5,
                    styles: { 
                        fillColor: [213, 244, 230], 
                        textColor: [39, 174, 96], 
                        fontStyle: 'bold',
                        fontSize: 8
                    }
                }
            ]);
            
            datosPDF.push(['', '', '', '', '']);
        });
        
        doc.autoTable({
            head: [['Promotor / Tienda', 'D√≠as Trabajados', 'Total D√≠as', 'Per√≠odo', 'Claves']],
            body: datosPDF,
            startY: 50,
            styles: { 
                fontSize: 8,
                cellPadding: 2
            },
            headStyles: { 
                fillColor: [39, 174, 96],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 50 },
                1: { cellWidth: 65 },
                2: { cellWidth: 20 },
                3: { cellWidth: 45 },
                4: { cellWidth: 35 }
            },
            margin: { left: 20, right: 20 }
        });
        
        const fechaGeneracion = new Date().toLocaleString('es-MX');
        doc.setFontSize(8);
        doc.text(`Generado el ${fechaGeneracion}`, 20, doc.internal.pageSize.height - 10);
        
        const fechaInicioValor = fechaInicio.value;
        const fechaFinValor = fechaFin.value;
        const nombreArchivo = `reporte-tiendas-promotores-${fechaInicioValor}-${fechaFinValor}.pdf`;
        doc.save(nombreArchivo);
        
        mostrarNotificacion('PDF descargado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error generando PDF:', error);
        mostrarNotificacion('Error al generar PDF', 'error');
    }
}

// ===== NOTIFICACIONES =====
function mostrarNotificacion(mensaje, tipo = 'info') {
    const notificacion = document.createElement('div');
    notificacion.className = `notification ${tipo}`;
    
    const iconos = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    const titulos = {
        success: '√âxito',
        error: 'Error',
        warning: 'Advertencia',
        info: 'Informaci√≥n'
    };
    
    notificacion.innerHTML = `
        <i class="${iconos[tipo]} notification-icon"></i>
        <div class="notification-content">
            <h4>${titulos[tipo]}</h4>
            <p>${mensaje}</p>
        </div>
        <button class="notification-close">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    notificacion.querySelector('.notification-close').addEventListener('click', () => {
        notificacion.remove();
    });
    
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.remove();
        }
    }, 5000);
    
    document.getElementById('notifications-container').appendChild(notificacion);
}

// ===== EXPONER FUNCIONES GLOBALES =====
window.verDetalleTienda = verDetalleTienda;
window.limpiarFiltros = limpiarFiltros;

// ===== INICIALIZACI√ìN FINAL =====
console.log('‚úÖ M√≥dulo CORREGIDO Tiendas ‚Üí Promotores iniciado');
console.log('üîß Correcciones aplicadas para m√∫ltiples tiendas:');
console.log('  ‚Ä¢ Consultas SQL m√°s flexibles y menos restrictivas');
console.log('  ‚Ä¢ Mejor agrupamiento de datos por tienda');
console.log('  ‚Ä¢ M√∫ltiples estrategias de consulta como fallback');
console.log('  ‚Ä¢ Logging mejorado para debugging');
console.log('  ‚Ä¢ Eliminaci√≥n de duplicados');
console.log('  ‚Ä¢ Validaciones de datos m√°s robustas');
console.log('  ‚Ä¢ Exportaci√≥n a Excel agregada');

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>

</body>
</html>